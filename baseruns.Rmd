---
title: "baseruns"
output: html_document
---
```{r}
library(dplyr, quietly = TRUE)
library(streamgraph)
library(readr)
library(stringr)
library(ggplot2)
library(plotly)
knitr::opts_chunk$set(echo = TRUE)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato", size=36),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  axis.title.y = element_text(size = 26),
  axis.title.x = element_text(size = 26),
  axis.text.x = element_text(size = 20),
  axis.text.y = element_text(size = 20),
  update_geom_defaults("bar",   list(fill = "#336699"))
  )


#axis.title.x = element_text(colour="grey20",size=12,angle=0,hjust=.5,vjust=0,face="plain"),
 #       axis.title.y = element_text(colour="grey20",size=12,angle=90,hjust=.5,vjust=.5,face="plain")

```


How do you construct a team like the Rangers?

Is there some characteristic of teams that overperform by 5 runs? 10 runs?

(Break into RS and RA components)

Weights of batting components vs. pitching components?

### Load and Clean Data

```{r}
#load baseruns data
baseruns_data <- read_csv("baseruns-2002-2016.csv")

#load batting data
team_data <- read_csv("fg-team-bat-data-2002-2016.csv")
team_data %<>%
  select(-matches("#")) #remove the 'Rank' column from the data
colnames(team_data)[1] <- "season"
colnames(team_data)[2] <- "ShortName"
team_data[["BB_perc_bat"]] <- as.numeric(sub("%", "", team_data[["BB_perc_bat"]]))/100
team_data[["K_perc_bat"]] <- as.numeric(sub("%", "", team_data[["K_perc_bat"]]))/100

#load pitching data
team_pitching_data <- read_csv("fg-pitching-data-2002-2016.csv")
colnames(team_pitching_data)[1] <- "season"
team_pitching_data[["BB_perc_pit"]] <- as.numeric(sub("%", "", team_pitching_data[["BB_perc_pit"]]))/100
team_pitching_data[["K_perc_pit"]] <- as.numeric(sub("%", "", team_pitching_data[["K_perc_pit"]]))/100
team_pitching_data[["K_minus_BB_perc_pit"]] <- as.numeric(sub("%", "", team_pitching_data[["K_minus_BB_perc_pit"]]))/100
team_pitching_data[["LOB_pit"]] <- as.numeric(sub("%", "", team_pitching_data[["LOB_pit"]]))/100
team_pitching_data[["HR_per_FB_pit"]] <- as.numeric(sub("%", "", team_pitching_data[["HR_per_FB_pit"]]))/100

#load plate discipline data
team_discipline_data_bat <- read_csv("fg-plate-disc-data-2002-2016.csv")
colnames(team_discipline_data_bat)[1] <- "season"
colnames(team_discipline_data_bat)[2] <- "ShortName"
for(i in names(team_discipline_data_bat)){
    if(is.na(grep("%", i, value = TRUE)[1]) == FALSE | i == "HR/FB"){
      team_discipline_data_bat[[i]] <- as.numeric(sub("%", "", team_discipline_data_bat[[i]]))/100
    }
}
colnames(team_discipline_data_bat) <- gsub("%", "_perc", colnames(team_discipline_data_bat))
colnames(team_discipline_data_bat) <- gsub("-", "_", colnames(team_discipline_data_bat))
```


### Combine Derived Statistics and Join Datasets Together 

```{r}
team_and_league_data <- team_data %>%
  inner_join(baseruns_data, by=c("season", "ShortName")) %>%
  inner_join(team_pitching_data, by=c("season", "ShortName")) %>%
  inner_join(team_discipline_data_bat, by=c("season", "ShortName")) %>%
  group_by(season) %>%
  mutate(team_season = sprintf("%s %s", season, ShortName),
         lg_R = mean(Bat_R),
         R_plus = round(100* (Bat_R / lg_R), 0),
         lg_K_bat = mean(K_perc_bat),
         K_plus_bat = round(100 * (K_perc_bat / lg_K_bat), 0),
         lg_BB_bat = mean(BB_perc_bat),
         BB_plus_bat = round(100 * (BB_perc_bat / lg_BB_bat), 0),
         lg_BABIP_bat = mean(BABIP_bat),
         BABIP_plus_bat = round(100 * (BABIP_bat / lg_BABIP_bat), 0), 
         lg_K_minus_BB_pit = mean(K_minus_BB_perc_pit),
         K_BB_plus_pit = round(100 * (K_minus_BB_perc_pit / lg_K_minus_BB_pit), 0),
         lg_LOB = mean(LOB_pit),
         LOB_plus = round(100 * (LOB_pit / lg_LOB), 0),
         lg_ISO = mean(ISO_bat),
         ISO_plus_bat = round(100 * (ISO_bat / lg_ISO), 0),
         lg_Contact = mean(Contact_perc),
         Contact_plus = as.integer(round(100 * (Contact_perc / lg_Contact), 0)),
         lg_K_pit = mean(K_perc_pit),
         K_plus_pit = round(100 * (K_perc_pit / lg_K_pit), 0),
         lg_GB_FB = mean(GB_per_FB_pit),
         GB_FB_plus = round(100* (GB_per_FB_pit / lg_GB_FB), 0),
         lg_BABIP_pit = mean(BABIP_pit),
         BABIP_plus_pit = round(100* (BABIP_pit / lg_BABIP_pit), 0),
         lg_BB_pit = mean(BB_perc_pit),
         BB_plus_pit = round(100 * (BB_perc_pit / lg_BB_pit), 0),
         lg_HR_FB = mean(HR_per_FB_pit),
         HR_FB_plus = round(100 * (HR_per_FB_pit / lg_HR_FB), 0),
         baseruns_overperformance_PCT = round(WP - bsrWP, 3),
         baseruns_overperformance_wins = round(baseruns_overperformance_PCT * 162, 0),
         Bat_overperform_runs = Bat_R - badjbr,      #positive numbers are better
         Pit_overperform_runs = Pit_R - padjbr,      #negative numbers here are better
         combined_overperformance_runs = Bat_overperform_runs - Pit_overperform_runs,
         LOB_category = ifelse(LOB_plus > 100, "High-LOB Teams",
                                  ifelse(LOB_plus < 100, "Low-LOB Teams", "Average-LOB Teams")),
         K_plus_category = ifelse(K_plus_bat > 100, "High-Strikeout Teams",
                                  ifelse(K_plus_bat < 100, "Low-Strikeout Teams", "Average-Strikeout Teams")),
         K_BB_category = ifelse(K_BB_plus_pit > 100, "High-K-BB Teams",
                                  ifelse(K_BB_plus_pit < 100, "Low-K-BB Teams", "Average-K-BB Teams")),
         overall_category = ifelse(baseruns_overperformance_wins < 0, "underperform", 
                      ifelse(baseruns_overperformance_wins > 0, "overperform", "neither")),
         bat_category = ifelse(Bat_overperform_runs < 0, "underperform", 
                      ifelse(Bat_overperform_runs > 0, "overperform", "neither")),
         pit_category = ifelse(Pit_overperform_runs < 0, "overperform", 
                      ifelse(Pit_overperform_runs > 0, "underperform", "neither")),
         baserun_overperform_per_k = Bat_overperform_runs / K_plus_bat) %>%
  ungroup()

pitching_stats <- team_and_league_data %>%
  select(baseruns_overperformance_wins, GB_FB_plus, K_BB_plus_pit, LOB_plus, K_plus_pit, BB_plus_pit, BABIP_plus_pit, HR_FB_plus)

splom(pitching_stats)

```

```{r}
runs_scored_plot <- ggplot(data=team_and_league_data, aes(x=K_plus_bat, y=R_plus)) + geom_point() + geom_smooth(method="lm")

runs_scored_model <- lm(R_plus ~ K_plus_bat, data=team_and_league_data)

runs_scored_plot
```

```{r}

this_year <- team_and_league_data %>%
  filter(season == 2016) %>%
  select(ShortName, K_plus_bat, Bat_overperform_runs, Pit_overperform_runs, bat_category, pit_category, overall_category)

ggplot(data=this_year, aes(x=K_plus_bat, y=Bat_overperform_runs)) + geom_point() + fgt +   geom_text(aes(label=ShortName),hjust=0,vjust=0) + geom_smooth(method = "lm")

brewers_padres <- this_year %>%
  filter(ShortName == "Rangers" |
           ShortName == "Rays")

```


### Is the angle that the Brewers and Padres had nearly identical K+ but wildly differed in BaseRuns Batting -- Brewers massively underperformed while Padres massively overperformed?

### Relationship between K- and BaseRuns overperformance. LINEAR MODEL


#data frames for splom

```{r}
batting_stats <- team_and_league_data %>%
  select(Bat_overperform_runs, K_plus_bat, BB_plus_bat, BABIP_plus_bat, BsR_bat, Contact_plus)

splom(batting_stats)

ggplot(data=batting_stats, aes(x=Contact_plus, y=Bat_overperform_runs)) + geom_point()


#Rangers have K- of 94, so we'd expect  


```


In the previous article I examined the role between strikeouts and batting BaseRuns overperformance, particularly as it related to the Baltimore Orioles and their recent history of overperforming BaseRuns. I also n




 * * * * *
 
-- CHOOSE BETWEEN 'PREVENT MORE RUNS' AND 'ALLOW FEWER RUNS'. BE CONSISTENT. IF 'PREVENT MORE', MAKE POSITIVE VALUES BETTER VS. NEGATIVE VALUES. 
 
 
-- Orioles are a high-K team but are underperforming on offense. Take a look at their batting BaseRuns overperformance since 2002:

```{r}
orioles_batting_performance <- team_and_league_data %>%
  filter(ShortName=="Orioles") %>%
  select(season, Bat_overperform_runs) %>%
  write_csv("orioles-batting-baseruns.csv")

ggplot(data=orioles_batting_performance, aes(x=season, y=Bat_overperform_runs)) + geom_point() + geom_line() + labs(x="Season", y="Batting BaseRuns Overperformance (Runs Scored)") + fgt

```



The team consistently underperforms its batting runs. Yet it consistently wins more games than BaseRuns predicts:

```{r}
orioles_overall_performance <- team_and_league_data %>%
  filter(ShortName=="Orioles") %>%
  select(season, baseruns_overperformance_wins) %>%
  write_csv("orioles-baseruns-overall.csv")

ggplot(data=orioles_overall_performance, aes(x=season, y=baseruns_overperformance_wins)) + geom_point() + geom_line() + labs(x="Season", y="BaseRuns Overperformance (Wins)") + fgt
```

Why? Run prevention. The Orioles consistently prevent more runs than BaseRuns predicts:

```{r}
orioles_pitching_performance <- team_and_league_data %>%
  filter(ShortName=="Orioles") %>%
  select(season, Pit_overperform_runs) %>%
  write_csv("orioles-pitching-baseruns.csv")

ggplot(data=orioles_pitching_performance, aes(x=season, y=Pit_overperform_runs)) + geom_point() + geom_line() + labs(x="Season", y="Pitching BaseRuns Overperformance (Lower is Better)") + fgt
```

Run prevention drives BaseRuns overperformance moreso than run scoring. Using Bayes' Rule shows that improving run prevention increases a team's chance of overperforming its BaseRuns by 35.7%, whereas improving run scoring increases the same chance by 21%. The following table shows this information:

```{r}
col1 <- c("Run Prevention", "Run Scoring")
col2 <- c(27.8, 34.2)
col3 <- c(63.5, 55.2)
col4 <- c(63.5-27.8, 55.2-34.2)

probs_split <- data.frame(col1, col2, col3, col4)
colnames(probs_split)[1] <- "Area of Performance"
colnames(probs_split)[2] <- "Probability of Overperforming BaseRuns Given Worse-than-Average Performance in Metric (%)"
colnames(probs_split)[3] <- "Probability of Overperforming BaseRuns Given Better-than-Average Performance in Metric (%)"
colnames(probs_split)[4] <- "Increase in Probability of Overperforming in BaseRuns (percentage points)"

write_csv(probs_split, "pitching-vs-batting_baseruns.csv")
```

<div class="table-container" style="max-width: 600px; background-color: white; margin-top: 0px; margin-right: auto; margin-left: auto;"><div id="FG" style="background: url(&quot;http://www.fangraphs.com/blogs/wp-content/uploads/2015/08/FG_logo_transparency.png&quot;) 0% 0% / 100% no-repeat; position: absolute; height: 30px; width: 30px; margin-top: 3px; margin-left: 5px;"></div><div class="table-title" id="title-FG" style="min-height: 22px; text-align: center; vertical-align: middle; padding: 7px 50px; font-family: Lato, Arial; color: white; background-color: rgb(82, 174, 38); font-size: 18px; word-wrap: break-word; line-height: 1;">Effects of Run Prevention vs. Run Scoring on BaseRuns Overperformance</div><table border="1" class="fg-table" style="font-family: Lato, Arial; max-width: 600px; width: 100%; border: 1px solid black; border-collapse: collapse; text-align: center; margin-bottom: 0px;"><tr class="table-header" style="text-align: center; background-color: rgb(80, 80, 80); color: white;"><td class="d3-th" column="0">Area of Performance</td><td class="d3-th" column="1">Probability of Overperforming BaseRuns Given Worse-than-Average Performance (%)</td><td class="d3-th" column="2" style="border: 1px solid black;">Probability of Overperforming BaseRuns Given Better-than-Average Performance (%)</td><td class="d3-th" column="3" style="border: 1px solid black;">Increase in Probability of Overperforming in BaseRuns (percentage points)</td></tr><tr class="table-rows" id="row-0" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" bgcolor="#FFFFFF" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">Run Prevention</td><td column="1" class="d3-td">27.8</td><td column="2" class="d3-td">63.5</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">35.7</td></tr><tr class="table-rows" id="row-1" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" bgcolor="#FFFFFF" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">Run Scoring</td><td column="1" class="d3-td">34.2</td><td column="2" class="d3-td">55.2</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">21</td></tr></table><div class="source" style="min-height: 12px; text-align: right; padding: 3px 10px; font-family: Lato, Arial; color: white; background-color: rgb(82, 174, 38); font-size: 10px; border: 1px solid black;">SOURCE: 2002-2016 Team Data</div></div>


```{r}

p(e|b) = p(b) * p (b|e) / p(e)

#p(b) = prob. a team will overperform its baseruns win total.
overperform_baseruns <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0)
#203 / 450

#p(b|e) = prob. a team overperformed its pitching runs given it overperformed baseruns wins
overperform_baseruns_and_pitching <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         Pit_overperform_runs < 0)
#139 / 203

#p(e) = prob. a team overperforms its pitching Wins.
overperform_pitching <- team_and_league_data %>%
  filter(Pit_overperform_runs < 0)
#219 / 450

((203 / 450) * (139/203)) / (219/450)
#######.635 probability a team that overperforms its pitching runs will overperform its BaseRuns wins


overperform_baseruns_underperform_pitching <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         Pit_overperform_runs > 0)

underperform_pit <- team_and_league_data %>%
  filter(Pit_overperform_runs > 0)

((203 / 450) * (64/203)) / (230/450)
#.278





#p(b|e) = prob. a team overperformed its batting runs given it overperformed baseruns wins
overperform_baseruns_and_batting <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         Bat_overperform_runs > 0)
#127 / 203

#p(e) = prob. a team overperforms its pitching Wins.
overperform_batting <- team_and_league_data %>%
  filter(Bat_overperform_runs > 0)
#230 / 450

((203 / 450) * (127/203)) / (230/450)

####### .552 probability a team that overperforms its batting runs will overperform its BaseRuns wins

overperform_baseruns_underperform_batting <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         Bat_overperform_runs < 0)

underperform_bat <- team_and_league_data %>%
  filter(Bat_overperform_runs < 0)

((203 / 450) * (75/203)) / (219/450)
#.342






##underperformance

underperform_baseruns <- team_and_league_data %>%
  filter(baseruns_overperformance_wins < 0)

```


Now the next question: what run-prevention metrics drive BaseRuns overperformance? To answer this, I re-framed the question as: how much can a team increase its probability of overperforming its BaseRuns by driving a particular pitching from metric from below-average to above-average?

I examined the effect of the major pitching-side metrics, relative to league average, on BaseRuns overperformance: 
- K+
- BB+
- BABIP+
- HR/FB+
- GB/FB+
- LOB+

For each metric, I calculated the probability increase in BaseRuns overperformance a team could expect from driving each metric from worse-than-average to better-than-average. The larger the available probability increase, the more effect the metric has on BaseRuns overperformance. 

For example: take K+. If a team has a below-average K rate, the probability it overperforms its BaseRuns wins is 43.3%. If a team has an above-average K rate, the probability it overperforms its BaseRuns is 46.9%. The 3.6 percentage point increase is the increase in probability if a team solely focuses on striking out more batters. Good information to have, but how does that 3.6-point swing compare to focusing on other metrics?
 
The following table shows the answers:

```{r}
col1 <- c("K+", "BB+", "BABIP+", "HR/FB+", "GB/FB+", "LOB+")
col2 <- c(43.3, 37.6, 42.2, 42.1, 48.3, 28.8)
col3 <- c(46.9, 53.4, 45.7, 47.6, 41.4, 62.0)
col4 <- c(46.9-43.3, 53.4-38.6, 45.7-42.2, 47.6-42.1, 41.4-48.3, 62.0-28.8)

probs <- data.frame(col1, col2, col3, col4)
colnames(probs)[1] <- "Metric"
colnames(probs)[2] <- "Probability of Overperforming BaseRuns Given Worse-than-Average Performance (%)"
colnames(probs)[3] <- "Probability of Overperforming BaseRuns Given Better-than-Average Performance (%)"
colnames(probs)[4] <- "Increase in Probability of Overperforming in BaseRuns (percentage points)"

write_csv(probs, "pitching-baseruns.csv")

```

<div class="table-container" style="max-width: 600px; background-color: white; margin-top: 0px; margin-right: auto; margin-left: auto;"><div id="FG" style="background: url(&quot;http://www.fangraphs.com/blogs/wp-content/uploads/2015/08/FG_logo_transparency.png&quot;) 0% 0% / 100% no-repeat; position: absolute; height: 30px; width: 30px; margin-top: 3px; margin-left: 5px;"></div><div class="table-title" id="title-FG" style="min-height: 22px; text-align: center; vertical-align: middle; padding: 7px 50px; font-family: Lato, Arial; color: white; background-color: rgb(82, 174, 38); font-size: 18px; word-wrap: break-word; line-height: 1;">Effects of Run Prevention Metrics on BaseRuns Overperformance</div><table border="1" class="fg-table" style="font-family: Lato, Arial; max-width: 600px; width: 100%; border: 1px solid black; border-collapse: collapse; text-align: center; margin-bottom: 0px;"><tr class="table-header" style="text-align: center; background-color: rgb(80, 80, 80); color: white;"><td class="d3-th" column="0">Metric</td><td class="d3-th" column="1" style="border: 1px solid black;">Probability of Overperforming BaseRuns Given Worse-than-Average Performance (%)</td><td class="d3-th" column="2" style="border: 1px solid black;">Probability of Overperforming BaseRuns Given Better-than-Average Performance (%)</td><td class="d3-th" column="3" style="border: 1px solid black;">Increase in Probability of Overperforming in BaseRuns (percentage points)</td></tr><tr class="table-rows" id="row-0" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">K+</td><td column="1" class="d3-td">43.3</td><td column="2" class="d3-td">46.9</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">3.6</td></tr><tr class="table-rows" id="row-1" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">BB+</td><td column="1" class="d3-td">37.6</td><td column="2" class="d3-td">53.4</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">14.8</td></tr><tr class="table-rows" id="row-2" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">BABIP+</td><td column="1" class="d3-td">42.2</td><td column="2" class="d3-td">45.7</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">3.5</td></tr><tr class="table-rows" id="row-3" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">HR/FB+</td><td column="1" class="d3-td">42.1</td><td column="2" class="d3-td">47.6</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">5.5</td></tr><tr class="table-rows" id="row-4" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">GB/FB+</td><td column="1" class="d3-td">48.3</td><td column="2" class="d3-td">41.4</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">-6.9</td></tr><tr class="table-rows" id="row-5" onmouseover="this.bgColor='#FDC60D'" onmouseout="this.bgColor=&quot;#FFFFFF&quot;" style="border: 1px solid black;"><td column="0" class="d3-td" style="padding-left: 5px; text-align: left;">LOB+</td><td column="1" class="d3-td">28.8</td><td column="2" class="d3-td">62</td><td column="3" class="d3-td" style="background-color: rgb(253, 198, 13);">33.2</td></tr></table><div class="source" style="min-height: 12px; text-align: right; padding: 3px 10px; font-family: Lato, Arial; color: white; background-color: rgb(82, 174, 38); font-size: 10px; border: 1px solid black;">SOURCE: 2002-2016 Team Data</div></div>

A team looking to overperform its BaseRuns should focus on stranding runners. Moving from a below-average strand rate to an above-average one increases its chances of overperforming BaseRuns by a whopping 33.2%!

That's nice to know, but this knowledge may have limited practical applications. Stranding runners is not really a skill [http://www.fangraphs.com/library/pitching/lob/]. High-strikeout pitchers can control it somewhat, but in general, high and low strand rates will regress to the mean. Further, teams don't vary much in their ability to strand runners; the standard deviation of LOB+ in this dataset is 3%.

The next-most important pitching factor is walk rate. Although not as impactful as strand rate, pitchers have much more control over how often they walk batters. General managers can select for pitchers with with a lower walk rate as well as catcher who frame strikes better than others. The range of skill here is also wider: the standard deviation of BB+ is about 10%.  

Getting back to the Orioles: they've certainly raised their strand rates in recent years:

```{r}
orioles_lob_plus <- team_and_league_data %>%
  filter(ShortName=="Orioles") %>%
  select(season, LOB_plus) %>%
  write_csv("orioles-lob.csv")

ggplot(data=orioles_lob_plus, aes(season, LOB_plus)) + geom_line() + geom_point() + fgt
```

Note their high-water marks in 2012 and 2014. The team made the playoffs both years; whereas in 2013, 2015, and 2016, the team's strand rate regressed to the mean.

Now look at the Orioles' walk rates each year:

```{r}
orioles_bb_rate <- team_and_league_data %>%
  filter(ShortName == "Orioles") %>%
  select(season, BB_plus_pit) %>%
  write_csv("orioles-bb.csv")

ggplot(data=orioles_bb_rate, aes(season, BB_plus_pit)) + geom_point() + geom_line() + fgt

##get reliever-only data

bb_rate_2016 <- team_and_league_data %>%
  filter(season=="2016") %>%
  select(ShortName, BB_plus_pit) %>%
  arrange(desc(BB_plus_pit))
  
```

2012 was the team's best walk rate year in a long time. The team's walk rate has risen since then, fueled mostly by the delicate mechanics of Ubaldo Jimenez. But because walk rate matters less than strand rate, the Orioles have stayed afloat in playoff races.

```{r}
lob_bb_mdl <- lm(team_and_league_data$baseruns_overperformance_wins ~ team_and_league_data$LOB_plus + team_and_league_data$BB_plus_pit)
summary(lob_bb_mdl)
```

```{r}
lob_and_bb <- team_and_league_data %>%
  select(baseruns_overperformance_wins, LOB_plus, BB_plus_pit)

plotmatrix(lob_and_bb)

splom(lob_and_bb)

```

* * * * * * * * * *

```{r}
overperform_br_and_high_lob_and_low_bb <- team_and_league_data %>%
  filter(LOB_plus > 100, BB_plus_pit < 100, baseruns_overperformance_wins > 0) %>%
  select(team_season, baseruns_overperformance_wins)

high_lob_and_low_bb <- team_and_league_data %>%
  filter(LOB_plus > 100, BB_plus_pit < 100)

((203 / 405) * (70/203)) / (107/405)
  
```



But look at walk rate. There's a 14.8 point increase in probability just there for the taking. This information has far more practical implications; pitchers control their walk rate moreso than their strand rate. 

```{r}

```


But is stranding runners something you can control? 

This relationship may sound obvious. But as a general manager, manager, or even a pitcher, knowing that stranding runners improves your chances of outperforming your projections knowing how much you can 


But the practical effects of this knowledge may be minimal. Don't you think that if a team could suddenly start stranding more baserunners, they would?  

But what about outliers? 


underperforms its K-BB rate


.386

following probabilities:
- Overperformance in the metric leading to overperformance in BaseRuns wins
- Underperformance in the metric leading to overperformance in BaseRuns wins

I then looked at the effect of overpermance vs. underperformnace by subtracting the latter from the former. How much can a team gain by driving one metric from underperformance to overperformance?


By far, LOB+ has the most effect on BaseRuns overperformance.



The answer is strand rate relative to league average (LOB+), as the following boxplot shows:
```{r}
lob_boxplot <- ggplot(team_and_league_data, aes(factor(LOB_category), baseruns_overperformance_wins)) + stat_boxplot(geom="errorbar") + geom_boxplot() + fgt + labs(y="BaseRuns Overperformance (Wins)", x="") + coord_flip() + ggtitle("Teams' LOB+ vs. BaseRuns Overperformance, 2002-2016")
lob_boxplot
```

Low-LOB teams tend to underperform their BaseRuns wins, whereas average- and high-LOB teams tend to equal or exceed their BaseRuns record. 

Model-wise, LOB+ explains a healthy amount of BaseRuns overperformance:
```{r}
lob_model <- lm(baseruns_overperformance_wins ~ LOB_plus, data=team_and_league_data)
lob_plt <- ggplot(data = team_and_league_data, aes(LOB_plus, baseruns_overperformance_wins)) + geom_point() + fgt + geom_smooth(method="lm") + labs(y="BaseRuns Overperformance (Wins)", x="") + ggtitle("Teams' LOB+ vs. BaseRuns Overperformance, 2002-2016")
lob_plt

```

The plot of residuals vs. fitted values shows no particular bias in the model: 

```{r}
lob_aug <- augment(lob_model)
resid_plt <- ggplot(lob_aug, aes(x=.fitted, y=.resid)) + geom_point() + fgt + labs(x="Fitted Values (baseruns_overperformance_wins ~ LOB+)", y="Residuals")
resid_plt
```

LOB+ explains 3.4 wins of BaseRuns overperformance. That's an R^2 of .13, or 13% of the 26.6-win variance. Again: plenty of teams could've used three wins.

The regression equation of -61.73 + 0.61 * LOB+ indicates that every percentage point of strand rate gains a team almost 2/3 of a win. The practical impact of this finding? STRAND RUNNERS. Derrrr. In other news, water is wet ... 

```{r}
#bayes prob. of high-strand teams overperforming their baseruns_data

#overperform BR = #203 / 450

overperform_baseruns_and_strand <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         LOB_plus > 100)

high_strand <- team_and_league_data %>%
  filter(LOB_plus > 100)

((203 / 450) * (121/203)) / (195/450)

#= .620


#low-strand teams overperforming their baseruns

overperform_baseruns_and_low_strand <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         LOB_plus < 100)

low_strand <- team_and_league_data %>%
  filter(LOB_plus < 100)

((203/450) * (56/203)) / (195/450)


#.288 chance of low-strand teams overperforming baseruns

### probability diff of 33.2 pp

```


#HR/FB+
```{r}
overperform_baseruns_and_high_hr_fb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         HR_FB_plus > 100)

high_hr_fb <- team_and_league_data %>%
  filter(HR_FB_plus > 100)

((203/450) * (83/203)) / (197/450)
#.421


overperform_baseruns_and_low_hr_fb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         HR_FB_plus < 100)

low_hr_fb <- team_and_league_data %>%
  filter(HR_FB_plus < 100)

((203/450) * (111/203)) / (233/450)
#.476


```

#BABIP_allowed

```{r}
overperform_baseruns_and_high_babip <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BABIP_plus_pit > 100)

high_babip <- team_and_league_data %>%
  filter(BABIP_plus_pit > 100)

((203/450) * (85/203)) / (201/450)

#.422



overperform_baseruns_and_low_babip <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BABIP_plus_pit < 100)

low_babip <- team_and_league_data %>%
  filter(BABIP_plus_pit < 100)

((203/450) * (91/203)) / (199/450)
#.457



```

## === K and BB? ##

```{r}
#prob. of high k-bb overperforming baseruns?
overperform_baseruns_and_high_k_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         K_BB_plus_pit > 100)

high_k_bb <- team_and_league_data %>%
  filter(K_BB_plus_pit > 100)

((203/450) * (114/203)) / (215/450)
#.53

#prob. of low-k-bb overperforming baseruns
overperform_baseruns_and_low_k_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         K_BB_plus_pit < 100)

low_k_bb <- team_and_league_data %>%
  filter(K_BB_plus_pit < 100)

((203/450) * (85/203)) / (220/450)
#.386

#prob diff. of 14.4% pp


```

## GB / FB rate

```{r}
#prob. of high-GB teams overperforming baseruns?
overperform_baseruns_and_high_gb_fb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         GB_FB_plus > 100)

high_gb_fb <- team_and_league_data %>%
  filter(GB_FB_plus > 100)

((203/450) * (84/203)) / (203/450)
#.414 for more GB than FB

overperform_baseruns_and_low_gb_fb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         GB_FB_plus < 100)

low_gb_fb <- team_and_league_data %>%
  filter(GB_FB_plus < 100)

((203/450) * (112/203)) / (232/450)
#.483 for fewer GB than FB

#swing of 7%

```


```{r}
blah <- read_csv("stuff.csv")

ggplot(data=blah, aes(x=reorder(Metric, derp), y=derp)) + geom_bar(stat="identity") + fgt + coord_flip() + labs(y="Potential Increase in Probability of Overperforming BaseRuns (%)", x="Metric") + ggtitle("Effects of Metrics on BaseRuns Overperformance")

```

#K rate (pitching) by itself

```{r}
#prob. of low-K teams overperforming baseruns?
overperform_baseruns_and_low_k <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         K_plus_pit < 100)

low_k <- team_and_league_data %>%
  filter(K_plus_pit < 100)

((203/450) * (97/203)) / (224/450)
#.433


#prob. of high-K teams overperforming baserun?


overperform_baseruns_and_high_k <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         K_plus_pit > 100)

high_k <- team_and_league_data %>%
  filter(K_plus_pit > 100)

((203/450) * (99/203)) / (211/450)
#.469

```


#BB rate (pitching) by itself
```{r}
#prob. of low-BB teams overperforming baseruns?
overperform_baseruns_and_low_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BB_plus_pit < 100)

low_bb <- team_and_league_data %>%
  filter(BB_plus_pit < 100)

((203/450) * (108/203)) / (202/450)
#.534


#prob. of high-BB teams overperforming baserun?
overperform_baseruns_and_high_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BB_plus_pit > 100)

high_bb <- team_and_league_data %>%
  filter(BB_plus_pit > 100)

((203/450) * (85/203)) / (226/450)
#.376
```





## Outliers: Given overperform LOB%, what's chance of overperforming BR wins by at least seven wins?
```{r}

#prob. overperform by 7 wins or more given high-lob
overperform_br_outlier <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7)

overperform_br_outlier_and_high_strand <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7,
         LOB_plus > 100)

((43 / 450) * (31/43)) / (232/450)

#13.3%

#prob. overperform by 7 wins or more given low-lob

overperform_br_outlier_low_strand <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7,
         LOB_plus < 100)

((43/450) * (7/43)) / (195/450)

#3.5%
```

#K-BB effect on outlier performance

```{r}
overperform_br_outlier_and_high_k_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7,
         K_BB_plus_pit > 100)

((43/450) * (24/43)) / (215/450)

#11.1%

overperform_br_outlier_and_low_k_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7,
         K_BB_plus_pit < 100)

((43/450) * (19/43)) / (220/450)
#8.6%

```

#GB/FB ration effect on outlier performance
```{r}
overperform_br_outlier_and_high_gb_fb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7,
         GB_FB_plus > 100)

((43/450) * (14/43)) / (203/450)
#6.9%

overperform_br_outlier_and_low_gb_fb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 7,
         GB_FB_plus < 100)

((43/450) * (27/43)) / (232/450)
#11.6%

```

#batting stat effects on baseruns overperformance
```{r}

prob_overperform <- nrow(overperform_baseruns) / nrow(team_and_league_data) 

#K+ batting

overperform_batting_and_low_k_bat <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         K_plus_bat < 100)

low_k_bat <- team_and_league_data %>%
  filter(K_plus_bat < 100)

(prob_overperform * nrow(overperform_batting_and_low_k_bat)) / nrow(low_k_bat)
#0.229


overperform_baseruns_and_high_k_bat <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         K_plus_bat > 100)

high_k_bat <- team_and_league_data %>%
  filter(K_plus_bat > 100)

(prob_overperform * nrow(overperform_baseruns_and_high_k_bat)) / nrow(high_k_bat)
#.176


#BB+ batting

overperform_batting_and_low_bb_bat <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BB_plus_bat < 100)

low_bb_bat <- team_and_league_data %>%
  filter(BB_plus_bat < 100)

(prob_overperform * nrow(overperform_batting_and_low_bb_bat)) / nrow(low_bb_bat)
#0.203


overperform_baseruns_and_high_bb <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BB_plus_bat > 100)

high_bb_bat <- team_and_league_data %>%
  filter(BB_plus_bat > 100)

(prob_overperform * nrow(overperform_baseruns_and_high_bb)) / nrow(high_bb_bat)
#.205


#ISO+ batting
overperform_batting_and_low_iso <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         ISO_plus_bat < 100)

low_iso <- team_and_league_data %>%
  filter(ISO_plus_bat < 100)

(prob_overperform * nrow(overperform_batting_and_low_iso)) / nrow(low_iso)
#0.210

overperform_baseruns_and_high_iso <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         ISO_plus_bat > 100)

high_iso_bat <- team_and_league_data %>%
  filter(ISO_plus_bat > 100)

(prob_overperform * nrow(overperform_baseruns_and_high_iso)) / nrow(high_iso_bat)
#.205


#BABIP+ batting
overperform_batting_and_low_babip <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BABIP_plus_bat < 100)

low_babip <- team_and_league_data %>%
  filter(BABIP_plus_bat < 100)

(prob_overperform * nrow(overperform_batting_and_low_babip)) / nrow(low_babip)
#0.238

overperform_baseruns_and_high_babip <- team_and_league_data %>%
  filter(baseruns_overperformance_wins > 0,
         BABIP_plus_bat > 100)

high_babip <- team_and_league_data %>%
  filter(BABIP_plus_bat > 100)

(prob_overperform * nrow(overperform_baseruns_and_high_babip)) / nrow(high_babip)
#0.183


```

```{r}
col1_bat <- c("K+", "BB+", "ISO+", "BABIP+")
col2_bat <- c(17.6, 20.3, 21.0, 23.8)
col3_bat <- c(22.9, 20.5, 20.0, 18.4)
col4_bat <- c(22.9-17.6, 20.5-20.3, 20.0-21.0, 18.4-23.8)

probs_bat <- data.frame(col1_bat, col2_bat, col3_bat, col4_bat)
colnames(probs_bat)[1] <- "Metric"
colnames(probs_bat)[2] <- "Probability of Overperforming BaseRuns Given Worse-than-Average Performance (%)"
colnames(probs_bat)[3] <- "Probability of Overperforming BaseRuns Given Better-than-Average Performance (%)"
colnames(probs_bat)[4] <- "Increase in Probability of Overperforming in BaseRuns (percentage points)"

write_csv(probs_bat, "batting-baseruns-overperform.csv")
```


Strike out more batters and walk fewer. K-BB 

```{r}
k_bb_plus_plt <- ggplot(data=team_and_league_data, aes(K_BB_plus_pit, baseruns_overperformance_wins)) + geom_point() + stat_smooth(method="lm")
k_bb_model <- lm(baseruns_overperformance_wins ~ K_BB_plus_pit, data=team_and_league_data)

```





R2 = .13 of 26.6 wins or 3.4 wins
#bsr_win_overperformance = -61.73 + .61 * LOB+


Final question: Examine outliers, teams with + or - 10 BR wins

```{r}
baseruns_outliers <- team_and_league_data %>%
  filter(baseruns_overperformance_wins >= 10 |
           baseruns_overperformance_wins <= -10)


```







overperform more BR wins often than teams who 


In its division title year of 2014, the team prevented more than 50 more runs from scoring than BaseRuns projected. That's five wins in the standings; curiously enough, that's exactly the amount by which the Orioles outperformed their BaseRuns. But wait, you say. Of course that year the Orioles _underperformed_ their batting BaseRuns by 32 runs or about three wins. This fact indicates that when it comes to outperforming your BaseRuns win total, run prevention matters more than run scoring.

We can prove this by turning to Bayes' Rule again. Given a team that outperforms its run prevention, what are the chances it'll outperform its BaseRuns? And how is this probability different from knowing only that a team outperforms its BaseRuns _run scoring_ ?

(describe Bayesian variables)



Pitching overperformance is about 8 percentage points more helpful than batting overperformance when wondering whether a team will outperform its BaseRuns wins. If all you know is that a team will outperform its BaseRuns prevention, that team has a 63.5% chance of overperforming its BaseRuns. But if all you know a team will outperform its BaseRuns scoring, that team has only a 55.2% chance of overperforming its BaseRuns.

Teams seeking an edge should focus more on run prevention (pitching and defense) than offense. 

So: How do you overperform your pitching Baseruns!?!?!?

The answer is by stranding runners. Of all the pitching stats I examined, strand rate relative to league average (LOB+) explained the most amount of overperformance.

```{r}

```

If you look at the Orioles you'll see that around 2010, when they began overperforming their BaseRuns wins, their LOB+ crept up:













```{r}
pitching_stats <- team_and_league_data %>%
  select(baseruns_overperformance_wins, LOB_plus, K_perc_pit, BB_perc_pit, BABIP_pit, ERA_minus_pit, FIP_minus_pit, xFIP_minus_pit, SIERA_pit, GB_per_FB_pit, HR_per_FB_pit, K_BB_plus_pit)

lob_pit_plt <- ggplot(data=team_and_league_data, aes(x=LOB_plus, y=Pit_overperform_runs)) + geom_point() + geom_smooth(method = "lm") + labs(y="Pitching Overperformance (Runs, lower is better)", x="LOB+") + fgt
lob_pit_plt

lob_model <- lm(Pit_overperform_runs ~ LOB_plus, data=team_and_league_data)
lob_aug <- augment(lob_model)
resid_plt <- ggplot(lob_aug, aes(x=.fitted, y=.resid)) + geom_point() + fgt
resid_plt


mu <- mean(team_and_league_data$Pit_overperform_runs)
sigma2 <- var(team_and_league_data$Pit_overperform_runs)
alpha0 <- ((1 - mu) / sigma2 - 1 / mu) * mu^2
beta0 <- alpha0 * (1 / mu - 1)
plt <- ggplot(team_and_league_data) + geom_histogram(aes(Pit_overperform_runs, y=..density..),
                                              binwidth=5, alpha=0.8)

plt + stat_function(fun = dbeta, args=list(x=team_and_league_data$Pit_overperform_runs, shape1 = alpha0, shape2 = beta0), color="red")




orioles_aug <- augment(lob_model)



orioles_lob_plus <- team_and_league_data %>%
  filter(ShortName=="Orioles") %>%
  select(team_season, season, LOB_plus, Pit_overperform_runs)


both_mdl <- lm(team_and_league_data$baseruns_overperformance_wins ~ team_and_league_data$Bat_overperform_runs + team_and_league_data$Pit_overperform_runs)


m <- fitdistr(team_and_league_data$Pit_overperform_runs, densfun="normal")
alpha0 <- m$estimate[1]  #mean
beta0 <- m$estimate[2]   #std. errors

ggplot(team_and_league_data) + geom_histogram(aes(Pit_overperform_runs, y=..density..)) + stat_function(fun = function(x) norm(x), color="red", size="1")


orioles_lob_plot <- ggplot(data=orioles_lob_plus, aes(x=season, y=LOB_plus)) + geom_line() + geom

#R2 = .40, which is quite high. This means LOB+ explains 40% of the variance in pitching run overperformance. This variance is 529 runs.
#So LOB% explains 211 runs or 21 wins of variance and teams' overperformance.

#Of course pitching runs themselves explain only 
```


```{r}
#pitching overperformance is more important than batting overperformance

#variance in overperformance = 26 wins

bat_model <- lm(team_and_league_data$baseruns_overperformance_wins ~ team_and_league_data$Bat_overperform_runs)

#R2 = .157 or 4 wins
#y = -0.044 + .093x

pit_model <- lm(team_and_league_data$baseruns_overperformance_wins ~ team_and_league_data$Pit_overperform_runs)

#R2 = .248 or 6.4 wins
#y = -.044 - .111x
```


```{r}
for_graphs <- team_and_league_data %>%
  select(K_plus_bat, Bat_overperform_runs) %>%
  write_csv("2016-teams.csv")

```


### Show that focus should be on BaseRuns Runs, not BaseRuns Wins. 

```{r}
# EVEN BASERUNS OVERPERFORMANCE ITSELF CAN VARY WILDLY -- LIKE 10 WINS OR SO!!!
overperformance_plt <- ggplot(team_and_league_data, aes(x=combined_overperformance_runs, y=baseruns_overperformance_wins)) + geom_point() + geom_smooth(method="lm") + fgt

baseruns_runs_wins_model <- lm(baseruns_overperformance_wins ~ combined_overperformance_runs, data=team_and_league_data)
summary(baseruns_runs_wins_model)

ggplotly(overperformance_plt)
```

=== 

OUTLINE?



Teams can over- and under-perform in one category, both, or neither. Using 2016's teams as an example:

```{r}
prove_my_point <- team_and_league_data %>%
  filter(season==2016) %>%
  select(ShortName, Bat_overperform_runs, Pit_overperform_runs) %>% #be sure to mention that for pitching, negative numbers are overperformance
  arrange(ShortName)

```

-- First -- Orioles K+ this year was 103, of 9th in baseball. That's not great but it's not terrible.
-- Second -- the Orioles DID underperform their baseruns record this year. Well -- that's not entirely true.
-- FG's BaseRuns page notes they overperformed their W/L by (HOW MUCH??!) But most of this overperformance came from their pitching staff. If you're asking whether the O's _offense_ struck out too much, you don't want to look at things their pitchers did. And inded when you focus on batting run overperformance, you see they they underperformed by a little over nine runs ... so not quite a win.
-- Given how the Orioles finished the season ... they really could've used that win!
-- Now, throwing a bit of mud in the waters ... the Blue Jays ALSO had a K+ of 103. So naturally they underperformed their baseruns offense too, right?
-- Wrong. The Jays OVERPERFORMED their offense by about six runs. That's not a lot by itself, but again, for the Blue Jays this year, every win had a lot of meaning. Consider also that +6 runs is about 1.5 wins away from 9 runs, and you start to see how important this piece is to both teams ... given that they're in the same division.


!!!...need a transition .... !!!





-- I do believe that strikeout rate affects whether a team outperforms its batting BaseRuns.

Why? Because based on data from 2002-2016, given a team has an above-average K rate, it has a 56% chance of underperforming its offensive BaseRuns. 

(explain Bayes; show math)

```{r}
underperform_batting_baseruns <- team_and_league_data %>%
  filter(bat_category == "underperform")

underperform_batting_and_high_k <- team_and_league_data %>%
  filter(bat_category == "underperform",
         K_plus_bat > 100)

high_k <- team_and_league_data %>%
  filter(K_plus_bat > 100)

#P(b) = A team will underperform their batting baseruns.  
p_b_u <- nrow(underperform_batting_baseruns) / nrow(team_and_league_data)
#p(e|b) = Given a team has underperformed their batting baseruns, what's the prob. they are a high-K team? 
p_e_given_b_u <- nrow(underperform_batting_and_high_k) / nrow(underperform_batting_baseruns) 
#p(e) = The probability a team will be a high-K team regardless of whether they underperform their baseruns. 
p_e_u <- nrow(high_k) / nrow(team_and_league_data)

bayes_high_k_underperform <- (p_b_u * p_e_given_b_u) / p_e_u
#55.76%
```

56% isn't an overwhelming tilt to one side or the other, but it is _a_ tilt. It's more of a tilt than, say, being the home team, which confers a 5% advantage to the home team.

Now, I'm not saying high-K teams will score _few_ runs. I'm saying there's a better-than-even chance those teams will score _fewer runs than BaseRuns predicts_. If you continually bet on high-strikeout teams to underperform their offensive BaseRuns, in the long run you'd win some money. More money than visiting a casino, at least.

The inverse case provides supporting evidence. If a team's K rate is _below_ average, there's a 58% chance it'll _overperform_ its BaseRuns.

Probabilities are great






NEW OUTLINE!

As an Orioles fan, I cared when the team signed Pedro Alvarez before last season. I also cared when Dave asked whether the team would strike out too much, where by "too much" he meant "causing them to score fewer runs than their BaseRuns would suggest."









-- So we've determined K+ has an effect on Batting BaseRuns overperformance. Does this affect all teams equally?
-- 
-- Boxplot --  

Being an Orioles 

What's the imapct of strikeout rate on batting BaseRuns overperformance? Linear regression shows a small but non-trivial relationship between the two variables:

```{r}
k_minus_and_baseruns_model <- lm(Bat_overperform_runs ~ K_plus_bat, data=team_and_league_data)

k_minus_and_baseruns_plt <- ggplot(team_and_league_data, aes(x=K_plus_bat, y=Bat_overperform_runs)) + geom_point() + geom_smooth(method = "lm") + fgt + labs(y="Batting BaseRuns Overperformance (Runs)", x="K+") + ggtitle("Teams' K+ vs. Batting BaseRuns Overperformance, 2002-2016")

k_minus_and_baseruns_plt
```

The effect is small but visible. The downward slope of the regression line shows that as relative strikeout rate increases, offensive baseruns overperformance decreases. The r2 of this line is .0693, meaning K+ explains about 7% of the variance in batting BaseRuns overperformance. This variance is 481 runs, meaning K+ explains about 33 runs or a little over three wins of batting overperformance.

Three wins! That's enough to raise some eyebrows. The Orioles could've used three wins this year. The Toronto Blue Jays, Detroit Tigers, Seattle Mariners, Houston Astros, New York Yankees, New York Mets, San Francisco Giants, St. Louis Cardinals, and Miami Marlins could have as well. These teams all fought down to the wire for a playoff spot.

The predictive impact of K+ is similar. The regression equation is: BaseRuns Overperformance = 58.88 - 0.59 * K+. For every 1 point decrease in K+, a team can expect to overperform its Batting BaseRuns by 0.59 runs. That may sound infinitesimal, but teams' K+ varies widely. In this sample, the lowest K+ is 75 (the 2015 Kansas City Royals, naturally) and the highest is 134 (2010 Arizona Diamondbacks). That's a swing of 35.4 runs (59 * .059) or about three wins.

Is K+ as important for all kinds of teams? Perhaps lower-strikeout teams benefit less from changes in K+. We can analyze this by breaking the teams into three categories of K+: above-average, average, and below-average.

The first way to do this is a boxplot, which shows the range of possibilities for each group:

```{r}
k_plus_boxplot <- ggplot(team_and_league_data, aes(factor(K_plus_category), Bat_overperform_runs)) + stat_boxplot(geom="errorbar") + geom_boxplot() + fgt + labs(y="Batting BaseRuns Overperformance (Runs)", x="") + coord_flip() + ggtitle("Teams' K+ vs. Batting BaseRuns Overperformance, 2002-2016")

k_plus_boxplot
```


AAAH REWRITE THE FOLLOWING:





Next, we'll look at scatterplots for each bucket of teams:

```{r}

faceted_plt <- k_minus_and_baseruns_plt + facet_grid(K_plus_category ~ ., scales = "free") + ggtitle("Teams' K+ vs. Batting BaseRuns Overperformance, 2002-2016")
faceted_plt
```

Let's look at the R2 values:
```{r}

high_k <- team_and_league_data %>%
  filter(K_plus_bat > 100)

high_k_model <- lm(Bat_overperform_runs ~ K_plus_bat, data=high_k)
# R2 = .026 * 456 runs = 11.8 runs or about 1 win
#equation: 90 - 0.51 x

low_k <- team_and_league_data %>%
  filter(K_plus_bat < 100)

low_k_model <- lm(Bat_overperform_runs ~ K_plus_bat, data=low_k)
# R2 = .05 * 473 runs = 23.65 runs or 2.3 wins
#equation: y = 56.2 - 0.56 x

avg_k <- team_and_league_data %>%
  filter(K_plus_bat == 100)

avg_k_model <- lm(Bat_overperform_runs ~ K_plus_bat, data=avg_k)
```

Notes:
-- Because all the K+ values are the same for average teams, there's no regression to explore, hence no line to examine.
-- In terms of runs score relative to offensive BaseRuns, strikeout rate matters less to high-strikeout teams than it does to low-strikeout teams. For high-K teams, one point of K+ subtracts 0.51 runs, whereas it subtracts 0.56 runs for low-strikeout teams.
-- And for high-K teams, strikeout rate explains 1 win of variance, whereas it explains 2.3 wins of variance for low-K teams.


-- Overall though, 


less, by about a win, than if you're a low-K team. K+ explains 1 win of variance for high-K teams vs. 2.3 wins of variance for low-K teams. 
-- If you're a high-K team, one point of K+ costs you 0.51 runs. If you're a low-K team, one point of K+ costs you 0.56 runs. 


-- So, if you're a high-K team like the Rays, Brewers, or Padres this year -- feel free to load up on some more high-K sluggers. If you're a low-strikeout team, beware adding more whiffs into your lineup.




--- Your baseruns overperformance ceiling is 60 runs lower, and your floor is about 10 runs lower, than if you were a low-K team. So your variance is (RELATE TO GRAPH)
--- But strikeout rate explains half of the variance here

you have less variance in Batting BaseRuns overperformance to work with: 456 runs vs. 473 runs for low-K teams. 
-- The slopes of the regression lines are almost exactly the same. This fact indicates that K+ predicts offensive BaseRuns performance about as equally for each category of team. 
-- There's about two wins' worth of variance between high-K and low-K teams. 
-- From these R2 values, we see that for low-strikeout teams, K+ explains twice as much of the variance in Batting BaseRuns overperformance as it does for high-strikeout teams.

Cconclusions:

-- Across the board, as K+ increases, batting baseruns overperformance decreases. 
-- Generally there's about three wins to be had as you strike less often.
-- This relationship matters twice as much for low-strikeout teams as it does for high-strikeout teams. For the 2015 Royals ... for the 2010 Diamondbacks ... 







more of the low-strikeout teams benefit more from being low-strikeout than high-strikeout teams benefit from being high-strikeout. 

low_k_plot <- ggplot(low_k, aes(x=K_plus_bat, y=Bat_overperform_runs)) + geom_point() + geom_smooth(method = "lm") + fgt



avg_k_plot <- ggplot(avg_k, aes(x=K_plus_bat, y=Bat_overperform_runs)) + geom_point() + geom_smooth(method = "lm") + fgt



high_k_plot <- ggplot(high_k, aes(x=K_plus_bat, y=Bat_overperform_runs)) + geom_point() + geom_smooth(method = "lm") + fgt

```




Remember: I'm not talking about absolute runs scored here. I'm talking about runs scored relative to expectations as defined by BaseRuns. High-contact teams can still score few runs, and low-contact teams can still score many runs. I'm also omitting the run prevention part of BaseRuns, which is why I'm not talking about wins.

But: the evidence is mounting that a high-strikeout approach to baseball hurts your chances to outperform expectations. 








's hardly anything, especially considering teams vary in K+ from 75 to 134.

### Add in regression equation here & analyze it.



Let's contrast the effect of K+ by looking at the effect of relative BABIP (BABIP+) on a team's offensive BaseRuns underperformance. 

```{r}
underperform_batting_baseruns <- team_and_league_data %>%
  filter(bat_category == "underperform")

underperform_batting_and_low_babip <- team_and_league_data %>%
  filter(bat_category == "underperform",
         BABIP_plus_bat < 100)

low_babip <- team_and_league_data %>%
  filter(BABIP_plus_bat < 100)

#P(b) = A team will underperform their batting baseruns.  
p_b_babip <- nrow(underperform_batting_baseruns) / nrow(team_and_league_data)
#p(e|b) = Given a team has underperformed their batting baseruns, what's the prob. they are a high-K team? 
p_e_given_b_babip <- nrow(underperform_batting_and_low_babip) / nrow(underperform_batting_baseruns) 
#p(e) = The probability a team will be a high-K team regardless of whether they underperform their baseruns. 
p_e_babip <- nrow(low_babip) / nrow(team_and_league_data)

bayes_low_babip_underperform <- (p_b_babip * p_e_given_b_babip) / p_e_babip
bayes_low_babip_underperform
```

Given a team has below-average BABIP, it has a 52% chance of under-performing its baseruns. That's less of an effect than strikeout rate.

What about the inverse case?

```{r}
overperform_batting_baseruns <- team_and_league_data %>%
  filter(bat_category == "overperform")

overperform_batting_and_high_babip <- team_and_league_data %>%
  filter(bat_category == "overperform",
         BABIP_plus_bat > 100)

high_babip <- team_and_league_data %>%
  filter(BABIP_plus_bat > 100)

#P(b) = A team will underperform their batting baseruns.  
p_b_high_babip <- nrow(overperform_batting_baseruns) / nrow(team_and_league_data)
#p(e|b) = Given a team has underperformed their batting baseruns, what's the prob. they are a high-K team? 
p_e_given_b_high_babip <- nrow(overperform_batting_and_high_babip) / nrow(overperform_batting_baseruns) 
#p(e) = The probability a team will be a high-BABIP team regardless of whether they underperform their baseruns. 
p_e_high_babip <- nrow(high_babip) / nrow(team_and_league_data)

bayes_high_babip_overperform <- (p_b_high_babip * p_e_given_b_high_babip) / p_e_high_babip
bayes_high_babip_overperform
```

54%. These probabilities show BABIP impact's a team's offensive BaseRuns overperformance less frequently than strikeout rate does.

The picture becomes clearer if we dig into strikeout rate to reach contact rate. After all, strikeouts are a result, and at FanGraphs we are focused less on results and more on process. I examined our plate discipline data for its relations to Offensive baseruns overperformance. I indexed contact rate to league average to create Contact+, with Baseball Info Solutions plate discipline data because PITCHF/X goes back to only 2007

```{r}
underperform_batting_and_low_contact <- team_and_league_data %>%
  filter(bat_category == "underperform",
         Contact_plus < 100)

low_contact <- team_and_league_data %>%
  filter(Contact_plus < 100)

#P(b) = A team will underperform their batting baseruns.  
p_b_contact <- nrow(underperform_batting_baseruns) / nrow(team_and_league_data)
#p(e|b) = Given a team has underperformed their batting baseruns, what's the prob. they are a low-contact? 
p_e_given_b_u_contact <- nrow(underperform_batting_and_low_contact) / nrow(underperform_batting_baseruns) 
#p(e) = The probability a team will be a high-K team regardless of whether they underperform their baseruns. 
p_e_u_contact <- nrow(low_contact) / nrow(team_and_league_data)

bayes_low_contact_underperform <- (p_b_contact * p_e_given_b_u_contact) / p_e_u_contact
bayes_low_contact_underperform
```

Teams with a below-average contact rate have a 58% chance of under-performing their offensive BaseRuns. That's two points higher than if looking at strikeout rate, and given contact is less of a result than strikeout rate, I'm inclined to 

The linear relationship looks like this:

```{r}
contact_vs_overperformance_plt <- ggplot(data=team_and_league_data, aes(x=(Contact_plus), y=Bat_overperform_runs)) + geom_point() + geom_smooth(method = "lm") + fgt
contact_vs_overperformance_plt

contact_baseruns_model <- lm(Bat_overperform_runs ~ Contact_plus, data=team_and_league_data)
summary(contact_baseruns_model)
```

The line's now flipped because a low contact rate equates to a higher strikeout rate. 

The R2 here is a bit higher at .074, So Contact+ explains 7.4% of the variance in batting baseruns overperformance, or 35 runs / 3.5 wins. That's not much different from looking just at strikeout rate.

The regression equation is BaseRunsOverPerform = -265.53 + 2.66 * Contact+. For every point of improvement in Contact+ you gain 2.66 runs of overperformance. 










Since I had the data, I thought I'd re-visit the effect that Baserunning Runs (BsR) has on offensive BaseRuns overperformance. BsR is already indexed to league average so there's no need to transform it. Going back to the Orioles, they ... [reference Sheehan's newsletter, maybe if he says it's okay, about.]

```{r}
bsr_plot <- ggplot(data=team_and_league_data, aes(x=BsR_bat, y=Bat_overperform_runs)) + geom_point() + geom_smooth(method="lm")
bsr_plot
```



====



In his article Dave also noted that teams often accept a lot of strikeouts in exchange for an increase in power. I ran the same probabilities for ISO+

58% and 56% aren't high probabilities, but they're more certain than a coin flip, and every edge counts in baseball. Still, outcomes can vary wildly. Take the Brewers and the Padres; they are separated by only 1% in K+. But the Brewers underperformed their batting runs by about 32 runs, whereas the padres _overperformed_ their batting runs by nearl 48 wins. That's a swing of eight wins! 

[[table]]

The following scatterplot, using team data from 2002-2016, shows this relationship:




In the two-wild card era, three wins over the course of a season can be meaningful. Just ask any of the Wild Card teams or near-miss Wild Card teams. (**which teams finished 3 wins or fewer out of a playoff spot!?!?!*)

This regression line, in addition to the Bayesian inference calculations above, give more evidence that higher-strikeout teams underperform their baseruns.

What about power? Dave noted that he looked at ISO as well. Interestingly, the plot for ISO+ is similar to the plot for K+ -- the more power a team has, the more it will underperform its BaseRuns on offense.

[[graph]]

I found this surprising, but on further reflection, it shouldn't be. Strikeouts and power are highly correlated. 

We now have evidence that a high-strikeout/high-power offense ... which tends to be the same thing, but it never hurts to emphasize these kinds of things ... such as the Orioles ... will underperform its offensive BaseRuns.


### Maybe I can do the Bayes of High K AND High ISO underperforming offense. 

AH -- but we're talking only about battins baseruns here. The other term is runs ALLOWED ... 

PADRES THE EXCEPTION. No team since 2002 has had that high of a strikeout rate + such a high BASE RUNS OFFENSE OVERPERFORMANCE!

--- THEN SEGUE INTO LOB% AFFECTING PITCHING RUNS!


#K- explains 3 offensive wins of baseruns overperformance.

#Batting Overperformance Runs = 58.88 -.59 * K_plus_bat


-- Let's look more at the AL East, which was apparently a high-strikeout division this year. The Rays finished dead last

... how to segue to the 


### Prob. that, given a team has a below-average K rate, they overperform their baseruns batting runs:
Can't just look at Baseruns PCT. That includes runs allowed. So we focus here solely on baseruns batting runs.

```{r}
overperform_batting_baseruns <- team_and_league_data %>%
  filter(bat_category == "overperform")

overperform_batting_and_high_k <- team_and_league_data %>%
  filter(bat_category == "overperform",
         K_plus_bat < 100)

low_k <- team_and_league_data %>%
  filter(K_plus_bat < 100)

#P(b) = A team will underperform their batting baseruns.  215 / 420 = .512
p_b <- nrow(overperform_batting_baseruns) / nrow(team_and_league_data)
#p(e|b) = Given a team has underperformed their batting baseruns, what's the prob. they are a high-K team?  = 90 / 215 = .419
p_e_given_b <- nrow(overperform_batting_and_high_k) / nrow(overperform_batting_baseruns) 
#p(e) = The probability a team will be a high-K team regardless of whether they underperform their baseruns.   204 / 420 = .486
p_e <- nrow(low_k) / nrow(team_and_league_data)

bayes_low_k_overperform <- (p_b * p_e_given_b) / p_e
# 0.5779 or about 58%

####



```




### What about the Rangers? Given they are a low-K team, what's the probability they will overperform baseruns? by how much?

### Teams in 2016? Rangers? They are indeed a low-K team: K+ of 94. 

### Now have to do the pitching side.



if a team overperforms baseruns, is it more likely due to pitching or batting overperformance?
if a team underperforms baseruns, is it more likely due to pitching or batting overperformance?


prob. of high-K team overperforming Batting BaseRuns?






prob. of low-K team overperforming baseRuns?


```{r}
#see how well the team did relative to baseRuns expectations
plt_data <- baseruns_data %>%
  mutate(team_season = sprintf("%s %s", season, ShortName),
    baseruns_overperformance_PCT = round(WP - bsrWP, 3),
    baseruns_overperformance_wins = round(baseruns_overperformance_PCT * 162, 0),
         Bat_overperform_runs = Bat_R - badjbr,      #positive numbers are better
         Pit_overperform_runs = Pit_R - padjbr,      #negative numbers here are better
         combined_overperformance_runs = Bat_overperform_runs - Pit_overperform_runs,
    category = ifelse(baseruns_overperformance_wins < 0, "underperform", 
                      ifelse(baseruns_overperformance_wins > 0, "overperform", "neither"))) %>%
  select(team_season, ShortName, season, Bat_overperform_runs, Pit_overperform_runs, combined_overperformance_runs, baseruns_overperformance_wins, category)

#geom_text(aes(label=ifelse(PTS>24,as.character(Name),'')),hjust=0,vjust=0)


plt <- ggplot(plt_data, aes(x=Bat_overperform_runs, y=Pit_overperform_runs, color=baseruns_overperformance_wins, text=team_season)) + geom_point() + labs(x="Runs Scored Above BaseRuns (Positive = Better than BR)", y="Runs Allowed Fewer than than BaseRuns (Negative Numbers = Better than BR)") + scale_color_gradient(limits=c(-20,20), low="red", high="green")
plt

#ggplotly(plt)




baseruns_model <- lm(plt_data$baseruns_overperformance_wins ~ plt_data$Bat_overperform_runs + plt_data$Pit_overperform_runs)

#+ ggtitle("Teams Who Outperformed BaseRuns by 5 or More Wins") + geom_text(aes(label=ifelse(baseruns_overperformance_wins >= 5, as.character(team_season), ''),hjust=0, vjust=0)) 

#ggplotly(plt, tooltip = "plt_data$team_season")

```

### Batting/Pitching Over/Underperformance Categorized by Over/Under Performance
It seems pitching has more of an effect than batting.

```{r}
grouped <- plt_data %>%
  group_by(category) %>%
  summarize(mean_bat_overperform_runs = mean(Bat_overperform_runs),
            mean_pit_overperform_runs = mean(Pit_overperform_runs))
  
```



it seems that baseruns underperformance is driven by pitching ...

and it seems that baseruns overperformance is driven by batting ...


```{r}
both_bat_and_pit_overperformers <- baseruns_data %>%
  filter(Bat_overperform_runs > 0, Pit_overperform_runs < 0)

overperform_plt <- ggplot(both_bat_and_pit_overperformers, aes(x=Bat_overperform_runs, y=Pit_overperform_runs, size=baseruns_overperformance_wins, color=baseruns_overperformance_wins, text=team_season)) + geom_point() + labs(x="Runs Scored Above BaseRuns (Positive = Better than BR)", y="Runs Allowed Fewer than than BaseRuns (Negative Numbers = Better than BR)") + scale_color_gradient(limits=c(-20,20), low="red", high="green") + scale_size(range=c(-20,20))

ggplotly(overperform_plt)

  
```