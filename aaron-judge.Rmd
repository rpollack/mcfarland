```{r setup, include=FALSE, echo=FALSE}


library(tidyverse)
library(rvest)
library(stringr)
library(plotly)
library(lubridate)
library(RMySQL)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))

estBetaParams <- function(mu, var) {
  alpha <- ((1 - mu) / var - 1 / mu) * mu ^ 2
  beta <- alpha * (1 / mu - 1)
  return(params = list(alpha = alpha, beta = beta))
}



```

### get HR/PA by righties in the past 7 years for batters with at least 80 PA in season

```{r}

judge_compares <- fg_db %>%
  tbl("player_info") %>%
  filter(!BISPosition %in% c("SP", "RP"),
         BISPosition != "",
         Bats == "R") %>%
  #select(PlayerId, FirstName, LastName) %>%
  collect(n=Inf)

hr_pa <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0,
         playerid %in% judge_compares$PlayerId,
         Season %in% c(2015, 2016, 2017),
         PA >= 80) %>%
  collect(n=Inf) %>%
  inner_join(judge_compares, by=c("playerid" = "PlayerId")) %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  dplyr::select(Name, Season, HR, PA) %>%
  mutate(hr_pa = HR / PA) %>%
  filter(!is.na(hr_pa))

mu <- mean(hr_pa$hr_pa)
var <- var(hr_pa$hr_pa)

alpha0 <- ((1 - mu) / var - 1 / mu) * mu ^ 2
beta0 <- alpha0 * (1 / mu - 1)



# formerly: 23 / 283

#since then: 13 / 210 or .061

```

### estimate shape parameters for beta prior for right-handed hitters with at least 80 PA in a season 2010 - 2016



### Data

```{r}
ggplot(hr_pa, aes(hr_pa)) + geom_histogram(binwidth = 0.009, aes(y=..density..))+ 
  xlim(0, .15) + labs(x="HR/PA") +
  scale_color_brewer(palette="Set1", direction= -1) +
  labs(color = "Distributions") +
  ggtitle("In-Season HR/PA Rates, 2015 - 2017, RHB >= 80 PA/Season")
```


### compare prior curve with data



```{r}
ggplot(hr_pa, aes(hr_pa)) + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = alpha0, shape2 = beta0),
                lwd=2,
                aes(color = "Right-handed Batters 2015 - 2017\n>= 80 PA/Season")) +
  xlim(0, .15) + labs(x="HR/PA") +
  scale_color_brewer(palette="Set1") +
  labs(color = "Distributions") +
  ggtitle("Probability Distribution for HR/PA")
```

### calculate likelihood, compute posterior curve, and draw

```{r}
#judge's current totals for PA with HR (successes) and PA w/o HR (failures)

judge_hr <-  36
judge_pa <- 493
judge_pa_wo_hr <- judge_pa - judge_hr

alpha1 = judge_hr + alpha0
beta1 = judge_pa_wo_hr + beta0


ggplot(hr_pa, aes(hr_pa)) + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = alpha0, shape2 = beta0),
                lwd=1.5,
                aes(color = "Right-handed Batters 2015 - 2017\n>= 80 PA/Season")) +
  stat_function(fun = dbeta,
                args=list(shape1 = alpha1, shape2 = beta1),
                lwd=1.5,
                aes(color="Aaron Judge, 2017")) +
  xlim(0, .15) + labs(x="HR/PA") + 
  ggtitle("Probability Distributions for HR/PA") +
  scale_color_brewer(palette="Set1", direction = -1) +
  labs(color = "Distributions")

```

### find expected hr/pa value by simulating 10,000 seasons using the posterior curve

```{r}

est_judge_hr_rate <- ((judge_hr + alpha0) - 1) / ((judge_pa + alpha0 + beta0) -2)
est_judge_hr_rate <- round(est_judge_hr_rate, 3)


judge_sim <- as_tibble(rbeta(10000, alpha1, beta1))

ggplot(judge_sim, aes(value, y = ..density..)) + geom_histogram(binwidth = .001) +
  annotate("text", x = .11, y = 27, label=sprintf("Expected HR/PA in 2017: %s", est_judge_hr_rate)) +
  labs(x="Simulated HR/PA") + ggtitle("10,000 Simulated Aaron Judge Seasons") +
  scale_fill_brewer(palette="Set1", direction = -1) + xlim(0, .15)

# 95% confidence interval
quantile(judge_sim$value, c(.025, .975))

```

### compute expected HR total given remaining PA

```{r}
judge_total_hr_given_pa <- function (total_pa) {
  string <- sprintf("In %s PA Judge will likely hit %s HR", total_pa, )
  print(string)
}

pa <- as_tibble(seq(650, 744))
pa <- pa %>%
  mutate(hr = ceiling(((value-judge_pa) * est_judge_hr_rate) + judge_hr))


#find HR/PA rate needed to hit 55 HR
#367 * x = 32



ggplot(pa, aes(value, hr)) + geom_point() + geom_line() +
  ggtitle("Aaron Judge's 2017 HR Total Depends on how many PA he Gets") +
  labs(x="PA", y="Expected HR Total")


```

```{r}

judge_estimate_hr_pa <- (23 + 2.50) / (272 + 2.50 + 93.67)
judge_estimate_hr_pa

eckstein_estimate_hr_pa <- (35 + 2.50) / (272 + 2.50 + 93.67)


mean_beta_posterior = (2.50 + 23) / (2.50 + 23 + 93.67 + 250)
mean_beta_posterior



#judge now has 23 HR in 272 PA
# 23 + 0.59 is 23.59 est. HR in
# 272 + 14.98 = 286.98 PA

#is an HR/PA rate of 


```

HOW MANY HOME RUNS WILL AARON JUDGE HIT?


judge is a monster ...

he's hit a billion home runs already ...

but it's best to not get too excited. he's not about to set the all-time single-season record or anything like that. he may not even be the best right-handed home run hitter of the past seven years; at season's end that honor will likely still belong to Jose Bautista's 54-HR season in 2010.

how can I say this with confidence? Judge has hit 23 HR in 273 PA this year, good for a rate of .084 HR per plate appearance. If you extrapolate this rate out to a full season of 650 PA, which many writers do when they talk about him being "on pace" for a certain number of HR, Judge will hit 32 more dingers for a grand total of 55. That would be the most by a right-handed hitter since Alex Rodriguez banged 57 in 2002.

Anytime someone is "on pace" to set a 15-year record, you should probably bet against them. Records are meaningful for a reason; they don't get broken that often. And indeed, when we look at the HR/PA rates for right-handed hitters with at least 80 PA in a season since 2010, we can see how rare it is to hit .050 dingers per plate appearance, let alone .080:

```{r}
ggplot(over_80, aes(hr_pa)) + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  xlim(0, .15)
```

The correct way to approach these problems is to regress Judge's HR/PA rate to the mean (really, his true talent level). While we have _some_ evidence that suggests Judge's true talent for hitting HRs, we don't have a lot. How can we regress to the mean if we don't know what mean to regress to?

We can use Bayesian analysis to look at recent seasonal HR/PA rates for right-handed hitters and mix that information with the information we _do_ have. Combining this information gives us an estimate of Judge's true HR/PA rate, which we can use to better understand how many home runs he's on "pace" to hit. 

The following graph shows the same curve as above, with a curve fitted. This curve represents our prior beliefs about Judge's HR/PA abilities. It fits pretty well; not great, perhaps, but I played around with the numbers and couldn't get anything better:



We use Bayesian analysis to combine this curve, which represents our prior assumptions about Judge's HR/PA talent, along with our observations: the fact that he's hit home runs at a .084 pace so far this year.

The result is yet another curve, which represents our updated beliefs about Judge's HR-hitting talents. The following graph shows the data that produced the prior curve, the prior curve itself, and the new/updated curve:




```{r}




# Construct a histogram of the simulated values
#hist(judge_sim, freq = FALSE)

```



Note that the blue curve, which represents our beliefs about Judge after considering both our prior beliefs and what we've seen him do, is shifted to the right. This shift indicates Judge's on-field prowess shows us his HR/PA ability is towards the upper end of what we've seen right-handed hitters do over the last six years. If Judge were, say, David Eckstein (35 HR in 5,705 career PA), the blue curve would be shifted way towards the left, indicating a lower HR/PA talent. 

In fact, let's add Eckstein's curve to the graph:

```{r}
ggplot(hr_pa, aes(hr_pa)) + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 2.50, shape2 = 93.67),
                lwd=2,
                col="red") +
  stat_function(fun = dbeta,
                args=list(shape1 = 2.50 + judge_hr, shape2 = 93.67 + judge_pa),
                lwd=2,
                col="blue") +
  stat_function(fun = dbeta,
                args=list(shape1 = 2.50 + 35, shape2 = 93.67 + 5670),
                lwd=2,
                col="green") + labs(x="HR/PA")
```




The high, narrow peak of Eckstein's curve shows we're _much_ more certain about the probability of Eckstein's HR/PA rate than we are about Judge's. This makes sense: Eckstein has 5,705 PA whereas Judge has just a few hundred. Eckstein's curve also has a much lower mean, at .006 HR/PA, which is also equal to his 35 HR in 5,705 PA. This low mean makes sense as well: Eckstein was not a power hitter.

Back to Judge. When predicting the future, you always want to use true talent instead of past performance. Look at the graph above and you'll see that on the x-axis, the peak of this curve lies at .069. This peak corresponds to our best guess about Judge's true-talent HR/PA rate. There is a 50% chance his rate is higher than that and a 50% chance his rate is lower than that.

Now here's what you came for: how many dingers will Judge swat this year? Obviously that depends on how many plate appearances he gets, but let's say he gets 650 PA, which represents a typical full season. Consider that Judge has already banked 23 home runs in 273 PA. If he finished the season with 650 PA, we'd expect him to hit 26 more: 377 remaining PA at a rate of .069 home runs per PA, rounded up. 

This would leave him with 49 long balls. It's not the magic number 50, and it's not the 55 home runs that most writers will say he's "on pace" for. But it would likely lead the big leagues.

Also consider that this season Judge is just 25 years old. 49 bombs would put him second on the all-time list among 25-year-old right-handed hitters. The guy above him? A-Rod, who hit 52 home runs in 2001 at the height of the PED era (and while on PEDs himself).

As Judge continues through his monster rookie season, the math above still holds. But over time his on-field performance would drown out the initial curve provided by all other hitters. This change represents the idea that the more Judge plays, the more confident we are about whatever abilities he shows on the field.



NEED A CONCLUSION





No 25-year-old right-hander has hit that many home runs since A-Rod hit 52 in 2001, during the height of the PED era. Before that you have to go back to   

His HR/PA rate then would be .075. Note that this is exactly halfway between his current .084 HR/PA rate and his true-talent .069 rate. That's what regression to the mean looks like.

What would it take for Judge to hit 50 HR? By my calculations he'll need 657 PA to hit 50, which is only another six PA. That's easily within his reach. The next five HR will take him awhile though; to get to 55 home runs he'd need 730 PA. 










Over a full season of at least 650 PA in the past 5 years, no right-handed hitter has beaten Jose Bautista's 2010 season in terms of HR/PA. That Year Bautista hit 54 dingers in 683 PA for a HR/PA rate of .079 HR per PA.

yet over his first 273 PA this year, aaron judge has hit 23 HR for an astonishing .085 HR per PA rate.

will he beat Bautista's home run rate?

given his monster start to the 2017 season, there's every reason to think he will. bayesian analysis shows that right now, the best guess of his true HR/PA talent is just a notch below, at .089 HR / PA.

{{{show analysis}}}

HOW MANY WILL HE HIT?

Assuming a total of 650 PA for the season, Judge will swat an additional 34 dingers this year for a total of 57. To reach this PA threshold he'll have an additional 377 PA. .089 homers per PA gives us 33.5, which we can round up to 34 for the purposes of this exercise.

If he reaches 683 PA like Bautista did in 2010, we'd expect him to hit 37 more for an even 60 dingers.

If he for some reason reaches 744 PA, which George Springer did last year, we'd expect his HR total to reach the dizzying height of 65. To hit this often Judge would probably have to bat leadoff, and given his high power output that's probably not a good idea. Most of his dingers would be solo shots as the bottom of the Yankees' lineup doesn't get on base as much as the top does.

Judge's body type and power remind many of a young Giancarlo Stanton, who in 2012 swatted 37 dingers in 501 PA for a rate of .074 HR per PA. Just 22 at the time, many assumed he'd get only better, but while his HR rates are nearly double those of the average righty, Stanton's struggled to stay on the field, reaching 630 PA only once in his career. He did mash 27 taters in 318 PA in 2015, but he played his last game in June to a hand injury. 


if he continues this would be 



