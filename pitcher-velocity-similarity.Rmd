

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(stringr)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

### Get data for starting pitchers

Starting pitchers are defined as those who started at least 25% of games they appeared in that year.

```{r}
player_lookups <- fg_db %>%
  tbl("player_info") %>%
  select(PlayerId, FirstName, LastName) %>%
  collect(n=Inf)
  
team_lookups <- fg_db %>%
  tbl("season_team") %>%
  filter(Season >= 2008) %>%
  select(TeamId, AbbName, Season) %>%
  collect(n=Inf)


pitcher_data <- fg_db %>%
  tbl("stats_pitching_master_pfx") %>%
  filter(Type >= 0,
         Type < 900,
         Season >= 2008,
         G / GS >= .25) %>%
  select(PlayerId, TeamId, Season, ValueW, `RA9-Wins`, contains("pfxvF")) %>%
  collect(n=Inf)
```  

### Combine datasets and compute team-season info

```{r}
pitcher_tbl <- pitcher_data %>%
  inner_join(player_lookups, by="PlayerId") %>%
  mutate(Name = sprintf("%s %s", FirstName, LastName)) %>%
  inner_join(team_lookups, by=c("TeamId", "Season")) %>%
  select(Name, Season, Team = AbbName, ValueW, `RA9-Wins`, contains("pfxvF"))

team_tbl <- pitcher_tbl %>%
  group_by(Team, Season) %>%
  summarize(sd_fb_vel = sd(pfxvFA, na.rm = TRUE),
            mad_fb_vel = mad(pfxvFA, na.rm = TRUE),
            iqr_fb_vel = IQR(pfxvFA, na.rm = TRUE),
            mean_war = mean(ValueW),
            mean_ra9 = mean(`RA9-Wins`))

## maybe examine relationship between sd_fb_vel and k%, bb%, hr.9, hr/fb ... 

## definitely do bayesian stuff instead of just linear relationship.
```

### Plot relationship between a rotation's fastball velocity variance and its average WAR

```{r}
ggplot(team_tbl, aes(mad_fb_vel, mean_war)) + geom_point() + geom_smooth(method="lm")

cor(team_tbl$mad_fb_vel, team_tbl$mean_war)

#r = -.0009 indicating no relationship between similarity and WAR


ggplot(team_tbl, aes(mad_fb_vel, mean_ra9)) + geom_point() + geom_smooth(method="lm")
cor(team_tbl$mad_fb_vel, team_tbl$mean_ra9)

#r = -.04, another awful one.
```


rosenthal's implied hypothesis is that similarity in a rotation is bad. that having pitchers with similar fastball velocities leads to everyone in the rotation performing more poorly than if the team had a more diverse set of arms. I can understand the logic; hitting is timing, and if in a three-game series you see three pitchers who average 93.5 MPH, hitters should be able to time these fastballs more effectively, square up the baseball better, and smack the pitcher around more. Contrast with a series when hitters are facing an 88 MPH thrower, a 93 MPH thrower, and a 97 MPH thrower. Hitters in this series should have difficulty adjusting day-to-day and should perform more poorly.

It sounds true. It feels true. But is it? I decided to investigate.

METHODOLOGY

As rotation fastball velocity similarity increases, the rotation's overall WAR decreases. put another way, as rotation similarity decreases (becomes more spread out), WAR increases. 

the data show the hypothesis is false: similarity in a rotation is, if anything, good. Rotations with lower values of MAD (higher similarity) have higher WARs than rotations with higher values of MAD (lower similarity). This relationship holds true for both FIP-base and RA9-based WAR.

more importantly, the data also show that the relationship between a rotation's fastball velocities and its performance is close to non-existent. if you're going to criticize a rotation for doing poorly, looking at how similar its pitchers' fastball velocities are isn't going to get you anywhere.


### Compute average rotation RA9-WAR for rotations in this time period, to see how FB velocity spread relates to it.

```{r}

mean_rotation_ra9 <- mean(team_tbl$mean_ra9)

#1.15
```

### Calculate P(Rotation's RA9-WAR >= 1.15 | MAD FB VEL <= 1)

```{r}



#P(B|E) = P(B) * P(E|B) / P(E)

#270 rotations in dataset

#P(B) = probability of rotation's mean ra9 equal to or exceeding 1.15
p_b <- team_tbl %>%
  filter(mean_ra9 >= 1.138461)

#135 / 270 = .5

#P(E|B) = probability of a rotation's MAD being <= 1, given its rotation's WAR exceeded 1.15

p_e_b <- p_b %>%
  filter(mad_fb_vel <= 1)

#16 / 133 = .12

#P(E) = MAD FB VEL between 0-1

p_e <- team_tbl %>%
  filter(mad_fb_vel <= 1)

#22 / 270 = .08

prob_above_avg_ra9_given_mad_fb_vel_lt_one <- (.5 * .12) / .08
prob_above_avg_ra9_given_mad_fb_vel_lt_one

#.738

```

### Calculate P(Rotation's RA9-WAR >= 1.15 | MAD FB VEL 1 > x >= 2)
```{r}
p_e_b_2 <- p_b %>%
  filter(mad_fb_vel > 1,
         mad_fb_vel <= 2)

#52 / 133 = .39

p_e_2 <- team_tbl %>%
  filter(mad_fb_vel > 1,
         mad_fb_vel <= 2)

#112 / 270 = .41

prob_above_avg_ra9_given_mad_fb_vel_bw_one_two <- (.5 * .39) / .41
prob_above_avg_ra9_given_mad_fb_vel_bw_one_two

#.468
```

### Calculate P(Rotation's RA9-WAR >= 1.15 | MAD FB VEL 2 > x >= 3)
```{r}
p_e_b_3 <- p_b %>%
  filter(mad_fb_vel > 2,
         mad_fb_vel <= 3)

#47 / 133 = .35

p_e_3 <- team_tbl %>%
  filter(mad_fb_vel > 2,
         mad_fb_vel <= 3)

#103 / 270 = .41

prob_above_avg_ra9_given_mad_fb_vel_bw_two_three <- (.5 * .35) / .38
prob_above_avg_ra9_given_mad_fb_vel_bw_two_three

#.453
```

### Calculate P(Rotation's RA9-WAR = 1 | MAD FB VEL 3 > x >= 4)


```{r}
p_e_b_4 <- p_b %>%
  filter(mad_fb_vel > 3,
         mad_fb_vel <= 4)

# 17 / 133 = .13

p_e_4 <- team_tbl %>%
  filter(mad_fb_vel > 3,
         mad_fb_vel <= 4)

#32 / 270 = .12

prob_above_avg_ra9_given_mad_fb_vel_bw_three_four <- (.5 * .13) / .12
prob_above_avg_ra9_given_mad_fb_vel_bw_three_four

#.533
```

### Create tibble of probabilites

Bayesian analysis confirms what linear regression shows us: in general, rotations featuring pitchers with with similar fastball velocities do better than more diverse rotations. If a rotation's MAD fastball velocity is less than 1 MPH, the probability this rotation will average 1.13 or more RA9-WAR is 75%. As the rotation's MAD fastball velocity increases, the probability of exceeding this threshold generally decreases, hovering between 45 - 50% for the remaining buckets. The following graph shows this relationship:

```{r}

#| MAD FB Vel. Range | Probability of RA9-WAR >= 1.15 


bayes_results <- frame_data(
  ~`MAD Fastball Velocity Range of Rotation`, ~`Probability Avg. Starter in Rotation Exceeds 1.13 RA9-WAR`,
  "<= 1", .75,
  "1 > x >= 2 ", .475,
  "2 > x >= 3", .460,
  "3 > x >= 4", .541
)

ggplot(bayes_results, aes(`MAD Fastball Velocity Range of Rotation`, `Probability Avg. Starter in Rotation Exceeds 1.13 RA9-WAR`)) + geom_bar(stat="identity") + fgt + ggtitle("A Diversity of Fastball Velocities Doesn't Help Rotations")
```

FWIW, I used average RA9-WAR of a rotation instead of sum, because teams use different amounts of pitchers.

Regardless Rosenthal's hypothesis seems to be false. 

### Compute and display outlier datasets, for giggles

```{r}

boxplot_tbl <- pitcher_tbl %>%
  filter(Team %in% c("LAD", "PHI"),
         Season == 2011) %>%
  mutate(group = sprintf("%s %s", Team, Season))

ggplot(boxplot_tbl, aes(group, pfxvFA)) + geom_boxplot() + coord_flip() + geom_jitter() + fgt +
  labs(x="", y="Pitcher's Avg. Four-Seam Fastball Velocity (MPH)") + ggtitle("Most and Least Similar Rotations by Four-Seam Fastball Velocity")

lad_2011 <- pitcher_tbl %>%
  filter(Team == "LAD",
         Season == "2011") %>%
  select(Name, pfxvFA) %>%
  arrange(desc(pfxvFA))

lad_2011

phi_2011 <- pitcher_tbl %>%
  filter(Team == "PHI",
         Season == "2011") %>%
  select(Name, pfxvFA) %>%
  arrange(desc(pfxvFA))

phi_2011



```

