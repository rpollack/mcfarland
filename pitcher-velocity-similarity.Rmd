

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(stringr)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

### Get data for starting pitchers

Starting pitchers are defined as those who started at least 25% of games they appeared in that year.

```{r, echo=FALSE}
player_lookups <- fg_db %>%
  tbl("player_info") %>%
  select(PlayerId, FirstName, LastName) %>%
  collect(n=Inf)
  
team_lookups <- fg_db %>%
  tbl("season_team") %>%
  filter(Season >= 2008) %>%
  select(TeamId, AbbName, Season) %>%
  collect(n=Inf)


pitcher_data <- fg_db %>%
  tbl("stats_pitching_master_pfx") %>%
  filter(Type >= 0,
         Type < 900,
         Season >= 2008,
         G / GS >= .25) %>%
  select(PlayerId, TeamId, Season, ValueW, `RA9-Wins`, contains("pfxvF")) %>%
  collect(n=Inf)
```  

### Combine datasets and compute team-season info

```{r, echo=FALSE}
pitcher_tbl <- pitcher_data %>%
  inner_join(player_lookups, by="PlayerId") %>%
  mutate(Name = sprintf("%s %s", FirstName, LastName)) %>%
  inner_join(team_lookups, by=c("TeamId", "Season")) %>%
  select(Name, Season, Team = AbbName, ValueW, `RA9-Wins`, contains("pfxvF")) %>%
  mutate(Name = ifelse(Season == 2016 & !Name %in% c("Dallas Keuchel",
                                     "Mike Fiers", 
                                     "Collin McHugh",
                                     "Scott Feldman", 
                                     "Doug Fister"), "REMOVEME", Name)) %>%
  filter(Name != "REMOVEME") #rosenthal was complaining b/c mccullers wasn't in the rotation yet (he was injured) 

team_tbl <- pitcher_tbl %>%
  group_by(Team, Season) %>%
  summarize(sd_fb_vel = sd(pfxvFA, na.rm = TRUE),
            mad_fb_vel = mad(pfxvFA, na.rm = TRUE),
            iqr_fb_vel = IQR(pfxvFA, na.rm = TRUE),
            mean_war = mean(ValueW),
            mean_ra9 = mean(`RA9-Wins`)) %>%
  ungroup() %>%
  mutate(mad_rank = percent_rank(desc(mad_fb_vel)) * 100)

## maybe examine relationship between sd_fb_vel and k%, bb%, hr.9, hr/fb ... 

## definitely do bayesian stuff instead of just linear relationship.
```

### Plot relationship between a rotation's fastball velocity variance and its average WAR


-- Astros' Woes Don't Include Similar Pitchers
-- No Variety in Fastaball Velocity? No problem.
-- 

... some kind of intro/tone-setting.

Last May, after the Astros had completed a miserable 7-17 April, Ken Rosenthal noted the sorry state of the team's starting rotation and proposed a reason the team was in  [http://www.foxsports.com/mlb/story/facts-and-fiction-from-the-first-month-of-the-mlb-season-050216]. He also hypothesized a cause.  I'll let him speak:

"The Astros’ starters ended April ranked last in the AL with a 5.10 ERA — and last in the majors in average fastball velocity at 89.3 mph, according to Fangraphs.

Velocity isn’t everything — the Astros’ starters were 25th last season, yet finished second in the AL in ERA. And the Rangers’ current starters are 29th in average fastball velocity but first in the AL in ERA.

Still, the Astros badly miss hard-throwing right-hander Lance McCullers, who is working his way back from a sore right shoulder.

Too many of their starters are similar.

One of them might turn it around, sure. But both? Seems doubtful."

The second-to-last line caught my eye: "Too many of their starters are similar." Because Rosenthal spent the first three paragraphs talking about fastball velocity, I took his implication to be "Too many of the Astros' starting pitchers throw fastballs at a similar velocity."

I saw this and I wondered: if a rotation has guys who throw similar heat, will that rotation perform worse than a rotation with a more diverse set of arms? The logic certainly _feels_ right. Hitting is timing. If, in a three-game series, batters see three starters who each average 93.5 MPH, hitters should be able to time fastballs from these guys more easily than they could if they were facing an 88 MPH thrower, a 93 MPH thrower, and a 97 MPH thrower. Hitters facing this more-diverse set of pitchers should have difficulty adjusting day-to-day and therefore will perform more poorly.

It sounds true. It feels true. But is Rosenthal correct to believe that having a rotation of similar fastball velocities is a bad thing? I decided to investigate.

METHODOLOGY

I tested the following, more precise, hypothesis: as the similaritiy of a starting rotation's fastball velocities increases, the rotation's average WAR decreases. Specifically:

-- In the PITCH F/X era, I searched for pitchers who started at least 25% of their games in a season.
-- For these pitchers I obtained their average four-seam fastball velocity as well as their FIP- and RA9-based WARs. A few pitchers were excluded because they didn't record a four-seam fastball velocity in that season.
-- I grouped the starters by team and season and computed the median absolute deviation (MAD) of each team-season's fastball velocities. I accounted for mid-season trades, meaning David Price shows up twice in 2014: once with Tampa Bay and once with Detroit.
-- For Houston in 2016, I looked at only their regular April rotation: Dallas Keuchel, Mike Fiers, Collin McHugh, Doug Fister, and Scott Feldman. When Rosenthal made his statement, he'd seen only starts by these guys and Christopher Devenski, whom I didn't count because he started only one game in April. 
-- I studied how these MADs related to the WAR of the average pitcher in that rotation. I used average WAR because each rotation has a different number of pitchers.

Let's take a tour through the outliers. By this method the 2011 Phillies had the most similar rotation in the dataset (MAD of 0.297 MPH); the 2011 Dodgers, the least similar (MAD of 4.862 MPH). The Phillies that year ranged from Joe Blanton's 89.3 MPH heater to Kyle Kendrick's 93 MPH fastball. Not a huge difference there. The Dodgers, on the other hand, featured Ted Lilly, Jon Ely, Dana Eveland, and Jon Garland all throwing 88 MPH or slower -- while also rostering Rubby de la Rosa and Nathan Eovaldi who threw 94 - 95 MPH.

Incidentally, Rosenthal was correct in thinking Houston's 2016 rotation was similar to itself. Houston's April 2016 rotation had a MAD of 0.941 MPH. That's much closer to the 2011 Phillies than the 2011 Dodgers. It ranks as more similar to itself than 92.5% of other teams in the dataset are to themselves.

The following boxplots show these rotations:

```{r, echo=FALSE}

boxplot_tbl <- pitcher_tbl %>%
  filter((Team == "HOU" & Season == 2016) | (Team == "LAD" & Season == "2011") | (Team == "PHI" & Season == 2011),
         Name != "Lance McCullers") %>%
  mutate(group = sprintf("%s %s", Team, Season),
         group = ifelse(group == "HOU 2016", "HOU 2016 (April only)", group))

ggplot(boxplot_tbl, aes(group, pfxvFA)) + geom_boxplot() + coord_flip() + geom_jitter() + fgt +
  labs(x="", y="Pitcher's Avg. Four-Seam Fastball Velocity (MPH)") + ggtitle("Fastball Velocities of Three Rotations")

# lad_2011 <- pitcher_tbl %>%
#   filter(Team == "LAD",
#          Season == "2011") %>%
#   select(Name, pfxvFA) %>%
#   arrange(desc(pfxvFA))
# 
# lad_2011
# 
# phi_2011 <- pitcher_tbl %>%
#   filter(Team == "PHI",
#          Season == "2011") %>%
#   select(Name, pfxvFA) %>%
#   arrange(desc(pfxvFA))
# 
# phi_2011



```

So, the Astros' 2016 rotation was very similar to itself. But is that a bad thing? If so, how bad? To answer this question I removed the April 2016 Astros from the dataset. Comparing just one month of its rotation to full seasons of other team's doesn't make sense.

I then plotted MAD fastball velocity against the average starter's WAR in that rotation:

ARE ROTATIONS WITH SIMILAR FASTBALLS WORSE THAN ROTATIONS WITH DISSIMILAR FASTBALLS?

The following graph is a linear regression of a rotation's fastball diversity and its FIP-based WAR:

```{r, echo=FALSE}
team_tbl <- team_tbl %>%
  mutate(Team = ifelse(Team == "HOU" & Season == 2016, "REMOVEME", Team)) %>%
  filter(Team != "REMOVEME")

#remove 2016 Astros from consideration, since we have only partial data for that season anyway.

```


```{r, echo=FALSE}
ggplot(team_tbl, aes(mad_fb_vel, mean_war)) + geom_point() + geom_smooth(method="lm") + labs(x="MAD Fastball Velocity of Rotation (MPH)", 
                                                                                             y="FIP WAR of Avg. Pitcher in Rotation") +
  ggtitle("Rotation Similarity has Little Effect on Starter WAR") + fgt

cor(team_tbl$mad_fb_vel, team_tbl$mean_war)

#r = .004 indicating no relationship between similarity and WAR

```

Both the scatterplot and regression line tell us no relationship is present. That's about a straight a horizontal line as you can get; the correlation of .004 says as much. If you want to find a victory, it's that the relationship is positive: Rosenthal appears correct that as rotation similarity decreases (e.g., as MAD increases), the average WAR of its starters increases. But the relationship is so faint as to be almost non-existent.

The same (lack of) relationship holds true for RA9-based WAR:

```{r, echo=FALSE}
ggplot(team_tbl, aes(mad_fb_vel, mean_ra9)) + geom_point() + geom_smooth(method="lm") + labs(x="MAD Fastball Velocity of Rotation (MPH)", 
                                                                                             y="RA9 WAR of Avg. Pitcher in Rotation") +
  ggtitle("Rotation Similarity has Little Effect on Starter WAR") + fgt
cor(team_tbl$mad_fb_vel, team_tbl$mean_ra9)

#r = -.039, another awful one.
```

The correlation coefficient of -.039 here not only is weak, but also opposes Rosenthal's hypothesis. The negative sign shows that as similarity decreases, RA9-WAR _decreases_. Recall that Rosenthal's hypothesis is the opposite. But again, the relationship is so weak as to be meaningless. 

In case linear regression was playing tricks on me, I turned Bayesian inference and asked: given a rotation with very similar fastball velocities (MAD less than 1 MPH), what's the probability the average starter in that rotation exceeds 1.13 (the median) RA9-WAR?

I calculated this probability for all similarity buckets in the dataset:

```{r, echo=FALSE}

#| MAD FB Vel. Range | Probability of RA9-WAR >= 1.15 


bayes_results <- frame_data(
  ~`MAD Fastball Velocity Range of Rotation`, ~`Probability Avg. Starter >= 1.13 RA9-WAR`,
  "1 MPH or less (More Similar)", .75,
  "Between 1.1 and 2 MPH", .475,
  "Between 2.1 and 3 MPH", .460,
  "Between 3.1 and 4 MPH", .541,
  "Above 4 MPH (Less Similar)", 1
)

bayes_results$`MAD Fastball Velocity Range of Rotation` <- factor(bayes_results$`MAD Fastball Velocity Range of Rotation`, levels = c("1 MPH or less (More Similar)", "Between 1.1 and 2 MPH", "Between 2.1 and 3 MPH", "Between 3.1 and 4 MPH", "Above 4 MPH (Less Similar)"))

ggplot(bayes_results, aes(`MAD Fastball Velocity Range of Rotation`, `Probability Avg. Starter >= 1.13 RA9-WAR`)) + geom_bar(stat="identity", fill="#8e001c") + fgt + ggtitle("How Similarity in Rotation Fastball Velocity Affects RA9 WAR of Starters") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

At first glance, the data vindicates Rosenthal's hypothesis. The least similar rotation in the dataset has the highest chance of its members exceeding 1.13 RA9-WAR. (This rotation is the 2011 Dodgers, whose members I described above.)

But consider this is only data point we have of such a diverse rotation. As you can see in the scatterplots above, no other rotation in the dataset has a MAD above 4 MPH. Are you comfortable making decisions based on one data point?

I'm not. I'd much rather look at multiple data points, meaning the three others bars in the chart. These bars tell me that pitchers in similar rotations have a much better chance of earning at least 1.13 RA9 WAR than pitchers in diverse rotations. This conclusion is another piece of evidence that Rosenthal's hypothesis is incorrect.

CONCLUSION

Why is Rosenthal wrong? Could be because velocity isn't everything; when it comes to fastballs, pitchers have different rhythms, motions, arm slots, and release points that all contribute to upsetting hitters' timing. Pitch location is also key. A grooved 93 MPH fastball will probably get smacked harder than a 88 MPH fastball down and away. Similarly, offspeed and breaking pitchers could matter more than fastball velocity does.

Or maybe Rosenthal isn't wrong. I didn't look at WAR in a three-game series, just WAR over an entire season. It could be that when broken down into three-game sets, rotations with similar fastball velocities indeed perform worse than rotations with diverse velocities. 

But ...







rotations whose starters have less-diverse average fastball velocities will have a lower average WAR than a rotation whose starters have more diverse 

Defining average four-seam fastball velocity is easy. Not all pitchers have four

As rotation fastball velocity similarity increases, the rotation's overall WAR decreases. put another way, as rotation similarity decreases (becomes more spread out), WAR increases. 

the data show the hypothesis is false: similarity in a rotation is, if anything, good. Rotations with lower values of MAD (higher similarity) have higher WARs than rotations with higher values of MAD (lower similarity). This relationship holds true for both FIP-base and RA9-based WAR.

more importantly, the data also show that the relationship between a rotation's fastball velocities and its performance is close to non-existent. if you're going to criticize a rotation for doing poorly, looking at how similar its pitchers' fastball velocities are isn't going to get you anywhere.


### Compute average rotation RA9-WAR for rotations in this time period, to see how FB velocity spread relates to it.

```{r, echo=FALSE}

mean_rotation_ra9 <- mean(team_tbl$mean_ra9)

#1.15
```

### Calculate P(Rotation's RA9-WAR >= 1.15 | MAD FB VEL <= 1)

```{r, echo=FALSE}



#P(B|E) = P(B) * P(E|B) / P(E)

#270 rotations in dataset

#P(B) = probability of rotation's mean ra9 equal to or exceeding 1.15
p_b <- team_tbl %>%
  filter(mean_ra9 >= 1.138461)

#135 / 270 = .5

#P(E|B) = probability of a rotation's MAD being <= 1, given its rotation's WAR exceeded 1.15

p_e_b <- p_b %>%
  filter(mad_fb_vel <= 1)

#16 / 133 = .12

#P(E) = MAD FB VEL between 0-1

p_e <- team_tbl %>%
  filter(mad_fb_vel <= 1)

#22 / 270 = .08

prob_above_avg_ra9_given_mad_fb_vel_lt_one <- (.5 * .12) / .08
prob_above_avg_ra9_given_mad_fb_vel_lt_one

#.738

```

### Calculate P(Rotation's RA9-WAR >= 1.15 | MAD FB VEL 1 > x >= 2)
```{r, echo=FALSE}
p_e_b_2 <- p_b %>%
  filter(mad_fb_vel > 1,
         mad_fb_vel <= 2)

#52 / 133 = .39

p_e_2 <- team_tbl %>%
  filter(mad_fb_vel > 1,
         mad_fb_vel <= 2)

#112 / 270 = .41

prob_above_avg_ra9_given_mad_fb_vel_bw_one_two <- (.5 * .39) / .41
prob_above_avg_ra9_given_mad_fb_vel_bw_one_two

#.468
```

### Calculate P(Rotation's RA9-WAR >= 1.15 | MAD FB VEL 2 > x >= 3)
```{r, echo=FALSE}
p_e_b_3 <- p_b %>%
  filter(mad_fb_vel > 2,
         mad_fb_vel <= 3)

#47 / 133 = .35

p_e_3 <- team_tbl %>%
  filter(mad_fb_vel > 2,
         mad_fb_vel <= 3)

#103 / 270 = .41

prob_above_avg_ra9_given_mad_fb_vel_bw_two_three <- (.5 * .35) / .38
prob_above_avg_ra9_given_mad_fb_vel_bw_two_three

#.453
```

### Calculate P(Rotation's RA9-WAR = 1 | MAD FB VEL 3 > x >= 4)


```{r, echo=FALSE}
p_e_b_4 <- p_b %>%
  filter(mad_fb_vel > 3,
         mad_fb_vel <= 4)

# 17 / 133 = .13

p_e_4 <- team_tbl %>%
  filter(mad_fb_vel > 3,
         mad_fb_vel <= 4)

#32 / 270 = .12

prob_above_avg_ra9_given_mad_fb_vel_bw_three_four <- (.5 * .13) / .12
prob_above_avg_ra9_given_mad_fb_vel_bw_three_four

#.533
```

```{r, echo=FALSE}
p_e_b_5 <- p_b %>%
  filter(mad_fb_vel > 4)

# 1 / 133 = .007

p_e_5 <- team_tbl %>%
  filter(mad_fb_vel > 4)

#1 / 270 = .003

prob_above_avg_ra9_given_mad_fb_vel_bw_three_five <- (.5 * .007) / .003
prob_above_avg_ra9_given_mad_fb_vel_bw_three_five

```


### Create tibble of probabilites

Bayesian analysis confirms what linear regression shows us: in general, rotations featuring pitchers with with similar fastball velocities do better than more diverse rotations. If a rotation's MAD fastball velocity is less than 1 MPH, the probability this rotation will average 1.13 or more RA9-WAR is 75%. As the rotation's MAD fastball velocity increases, the probability of exceeding this threshold generally decreases, hovering between 45 - 50% for the remaining buckets. The following graph shows this relationship:



FWIW, I used average RA9-WAR of a rotation instead of sum, because teams use different amounts of pitchers.

Regardless Rosenthal's hypothesis seems to be false. 

### Compute and display outlier datasets, for giggles



