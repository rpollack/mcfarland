# McFARLAND ⚾

**Machine-crafted Forecasting And Reasoning for Luck, Analytics, Narratives, and Data**

McFARLAND is a friendly baseball analytics companion that turns deep stats into plain English. It combs through player data so you can talk ball with confidence and a smile.

## Why you'll love it
- **Hitters and pitchers**: size up both sides of the plate
- **Year-over-year context**: compares 2025 numbers to 2022–2024 averages
- **Smart metrics**: highlights BABIP, xwOBA, barrel rate and more to separate skill from luck
- **Future peeks**: offers rest-of-season outlooks based on recent trends

## Pick your vibe
Choose how the story is told. Nine styles range from straight-laced to Shakespearean. The Straightforward vibe is the default, so you can always switch back to it:

- 1970s Fan
- Analytics Dork
- Gen Z
- Old Coot
- Rose-colored
- Rotisserie Expert
- Sensationalist
- Shakespeare
- Straightforward (default)

## Eye candy
- Player trend charts for quick comparisons
- Official MLB headshots with fallbacks
- Responsive design that looks good everywhere

## Architecture
### API (services/api)
- R + Plumber wrapper around the existing McFARLAND modules
- `/players`, `/players/{id}/statline`, `/players/{id}/analysis`, and `/compare` endpoints
- Respects `OPENAI_API_KEY` for personas and `MCFARLAND_DATA_URL` for overriding the CSV source

### Web (web/)
- Next.js 14, TypeScript, TailwindCSS, and SWR for data fetching
- Mirrors the Analyze, Compare, and About journeys from the original Shiny experience
- Uses `NEXT_PUBLIC_API_BASE_URL` to point at the Plumber service

### Analysis engine
- Natural-language writeups generated by a language model
- Memory-based caching for fast, cost-conscious responses

## Get started
### Prerequisites
```r
install.packages(c(
  "shiny", "dplyr", "readr", "purrr", "stringr",
  "httr", "jsonlite", "bslib", "commonmark",
  "shinybusy", "ggplot2", "htmltools", "digest",
  "tidyverse", "baseballr", "stringi", "janitor"
))
```

```
# Web client
node --version # Node.js 18+ recommended
```

### Environment variables
```bash
export OPENAI_API_KEY="your_api_key_here"
export MCFARLAND_DATA_URL="/absolute/path/to/local/csvs"   # optional override
export NEXT_PUBLIC_API_BASE_URL="http://localhost:8000"      # web client -> API
```

### Run the API locally
Open one terminal, change into the repository root, and start the Plumber service:
```bash
R -e "plumber::pr('services/api/plumber.R')$run(host='0.0.0.0', port=8000)"
```

### Run the web client
In a second terminal, launch the Next.js development server:
```bash
cd web
npm install
npm run dev
# visit http://localhost:3000 (defaults to the API at http://localhost:8000)
```

With both processes running you can browse the app at <http://localhost:3000>. Any
API changes hot-reload automatically, and the front end uses SWR caching to refresh
player data as soon as the API responds.

### Deploying to Render.com
The repository includes a `render.yaml` that provisions separate services for the API
and the web client:

1. Connect the repository to Render and enable the "Blueprint" deploy using `render.yaml`.
2. **API service (`mcfarland-api`)** – builds the Dockerfile in the repo, runs the
   Plumber server on Render's assigned `$PORT`, and reads environment variables for
   `OPENAI_API_KEY`, optional `MCFARLAND_DATA_URL`, and CORS overrides.
3. **Web service (`mcfarland-web`)** – installs the Next.js project in `web/`, builds
   the production bundle, and starts `next start`. The `NEXT_PUBLIC_API_BASE_URL`
   variable is wired to the deployed API URL automatically.

If you prefer to verify the container locally before deploying, run:
```bash
docker build -t mcfarland-api .
docker run --rm -p 8000:8000 -e OPENAI_API_KEY=your_key_here mcfarland-api
```

### Refresh the data
```r
source("refresh_data.R")
```

## Data pipeline
### Automated daily refresh
GitHub Actions pulls fresh stats every morning at 6 AM EST.

### Data processing
1. Hitter metrics: AVG, OBP, SLG, K%, BB%, Barrel%, BABIP, wOBA, xwOBA
2. Pitcher metrics: ERA, xERA, K%, BB%, CSW%, Barrel%, BABIP, LOB%
3. Difference calculation: current year vs three-year average
4. Player lookup table for dual-role players

## Key files
```
├── app/
│   └── app.R                 # Main Shiny application
├── .github/workflows/
│   └── refresh-data.yml      # Automated data refresh
├── refresh_data.R            # Data processing script
├── full_stats_hitters.csv    # Current hitter statistics
├── full_stats_pitchers.csv   # Current pitcher statistics
├── player_lookup.csv         # Player directory with IDs
├── fangraphs-leaderboards-*.csv  # Historical hitter data
└── pitcher-stats-*.csv       # Historical pitcher data
```

## Caching & writeups
- Stores recent responses for an hour
- Automatically keeps 25–50 entries
- Tracks cache hits vs. API calls to save time and money

## Using McFARLAND
1. Select a player from the dropdown
2. Pick your preferred vibe
3. Read an easy-to-digest breakdown with trends and context
4. Share the analysis by copying the URL – it updates with the current player and vibe and runs automatically when opened

### Reading the output
- Green trends indicate positive movement
- Larger sample sizes equal more reliable conclusions
- BABIP, LOB%, ERA–xERA gaps flag luck; K%, BB%, Barrel% highlight skill

## Contributing
### Data updates
- Historical data updated annually
- FanGraphs API handles current season
- Player ID mapping needs occasional tweaks

### Feature requests
Open an issue or use the in-app feedback form.

## Version history
- v0.8: smart API caching
- v0.7: MLB player headshots
- v0.6: pitcher analysis
- v0.5: notification signup
- v0.4: enhanced metrics (Barrels/PA, xwOBA gaps)
- v0.3: trend visualizations
- v0.2: Shakespeare mode
- v0.1: hitter-only debut

## Acknowledgments
- Data: [FanGraphs](https://www.fangraphs.com/)
- Photos: MLB official headshots
- Inspiration: [T.J. McFarland](https://www.fangraphs.com/players/tj-mcfarland/3237/stats?position=P) — the utility pitcher who inspired the name

## License
Educational and personal use only. Respect FanGraphs' terms of service and MLB's image policies.

---
Built with ❤️ and ⚾ by Ryan Pollack
