```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)
library(lubridate)
library(lazyeval)
library(rvest)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))

```


# Get Player Data

```{r}
#get seasonal pitching WAR for players
pitcher_stats <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId, WAR = ValueW, Age) %>%
  collect(n=Inf)

#get seasonal batting/fielding WAR for players
batter_stats <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId = playerid, WAR = ValueW, Age) %>%
  collect(n=Inf)

player_info <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, BirthDate, LastGame, Position) %>%
  collect(n=Inf)

# Get list of players in the HOF (who were voted in as players)

hof_url <- "https://www.baseball-reference.com/awards/hof.shtml"

hof_players <- read_html(hof_url) %>%
  html_nodes("table") %>%
    .[[1]] %>%
    html_table(header=TRUE)

names(hof_players)[3] <- "Years"

hof_players <- hof_players %>%
  filter(`Inducted As` == "Player") %>%
  mutate(birth_year = as.numeric(str_extract(Years, "^[0-9]{4}"))) %>%
  dplyr::select(Name, birth_year) %>%
  mutate(HOF = "Yes",
         
         #correct some discrepancies
         Name = str_replace(Name, "Ken Griffey", "Ken Griffey Jr."),
         birth_year = ifelse(Name == "Frankie Frisch", 1898, birth_year))

#combine batting & pitching WAR for all player-seasons    
seasonal_war <- player_info %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(last_year = year(ymd(LastGame)),
         Position = str_extract(Position, "^(P|C|1B|2B|3B|SS|OF|DH)"),    #extract primary position from dataset
         birth_year = year(ymd(BirthDate))) %>%   
  dplyr::select(PlayerId, Name, birth_year, last_year, Position) %>%
  full_join(batter_stats, by="PlayerId") %>%
  full_join(pitcher_stats, by=c("PlayerId", "Age"), suffix=c("_bat", "_pitch")) %>% 
  replace_na(list(WAR_bat = 0, WAR_pitch = 0)) %>%
  mutate(WAR = WAR_bat + WAR_pitch) %>%
  dplyr::select(-WAR_bat, -WAR_pitch) %>%
  left_join(hof_players, by=c("Name", "birth_year")) %>% #joining by birth year prevents mis-identifying players w/same name
  replace_na(list(HOF= "No"))

```

```{r}
seager_match <- hof_eligible_players %>%
    filter(Age == 23,
           Position == "SS",
           cumulative_war >= 14.6) %>%
    distinct(PlayerId, Name, cumulative_war, HOF)
  
  seager_num_players_at_position <- seager_match %>%
    nrow()
  
  seager_num_hof_players_at_position <- seager_match %>%
    filter(HOF == "Yes") %>%
    nrow()

  
seager_match
seager_num_hof_players_at_position
seager_num_players_at_position
  
```

```{r}
prob_war_thru_age <- function(age, war, position, floor, ceiling){
  #number of players (all-time HOF eligible and HOF inductees) who, at age X, 
  #have accumulated at most Y WAR at that position. only look at players who retired 5 years ago or earlier.
  #these are the players we should be comparing to.
  
  matching_players <- hof_eligible_players %>%
    filter(Age == age,
           Position == position,
           cumulative_war <= ceiling,
           cumulative_war >= floor) %>%
    distinct(PlayerId, HOF)
  
  num_players_at_position <- matching_players %>%
    nrow()
  
  num_hof_players_at_position <- matching_players %>%
    filter(HOF == "Yes") %>%
    nrow()
  
  result <- sprintf("%d %d", num_players_at_position, num_hof_players_at_position)
  return(result)
}
prob_war_thru_age <- Vectorize(prob_war_thru_age)
```

# compute Bayesian parameters

```{r}

#for each player-season, compute their total WAR through the age they were that season
#also mark which players are in HOF
war_through_age <- seasonal_war %>%
  group_by(PlayerId, Name, last_year, Position) %>%
  arrange(Age) %>%
  mutate(cumulative_war = round(cumsum(WAR), 1),
         num_seasons = seq(n()),
         war_ceiling = cumulative_war + (1.5 * num_seasons),
         war_floor = cumulative_war - (1.5 * num_seasons))

#last change to possibly make: instead of 

#compute HOF & non-HOF totals and probabilities at each position
current_year = 2017
hof_probabilities_by_position <- war_through_age %>% 
  ungroup() %>% 
  filter(last_year <= current_year - 6) %>%
  distinct(PlayerId, HOF, Position) %>%
  count(HOF, Position) %>% 
  spread(HOF, n) %>%
  dplyr::select(Position, non_hof_at_position = No, hof_at_position = Yes) %>%
  
  #replace computed totals with totals from HOF website: https://baseballhall.org/hall-of-famers/hall-of-famers-by-position
  mutate(hof_at_position = ifelse(Position == "1B", 24,
                                  ifelse(Position == "2B", 21,
                                         ifelse(Position == "3B", 17,
                                                ifelse(Position == "SS", 25,
                                                       ifelse(Position == "C", 18,
                                                              ifelse(Position == "OF", 71,
                                                                     ifelse(Position == "DH", 0,
                                                                            ifelse(Position == "P", 79, hof_at_position)))))))),
         total_eligible_players_at_position = hof_at_position + non_hof_at_position,
         p_hof_at_position = hof_at_position / total_eligible_players_at_position)


#find only HOF eligible players 
hof_eligible_players <- war_through_age %>%
  ungroup() %>%
  filter(last_year <= current_year - 6)

#for each age/WAR range (floor to ceiling) combination, find the number of players (HOF & non-HOF) with WAR in that range.
# then use totals to compute Bayesian parameters & finally the probability of that player reaching HOF
war_age_combinations <- war_through_age %>%
  ungroup() %>%
  dplyr::select(Age, cumulative_war, Position, war_floor, war_ceiling) %>%
  expand(nesting(Age, cumulative_war, Position, war_floor, war_ceiling)) %>%
  mutate(x = prob_war_thru_age(Age, cumulative_war, Position, war_floor, war_ceiling)) %>%
  separate(x, c("num_eligible_players_who_meet_criteria", 
                "num_hof_players_who_meet_criteria"), sep = " ") %>%
  mutate(num_eligible_players_who_meet_criteria = as.numeric(num_eligible_players_who_meet_criteria),
         num_hof_players_who_meet_criteria = as.numeric(num_hof_players_who_meet_criteria))

bayes_hof <- inner_join(war_through_age, war_age_combinations, 
                                by=c("Age", "cumulative_war", "Position")) %>%
  inner_join(hof_probabilities_by_position, by="Position") %>%
  filter(HOF == "No") %>%              #don't do this analysis for HOF inductees
  group_by(PlayerId, Name) %>%
  filter(Age == max(Age)) %>%
  mutate(p_b = p_hof_at_position,
         p_e_b = num_hof_players_who_meet_criteria / hof_at_position,
         p_e = num_eligible_players_who_meet_criteria / total_eligible_players_at_position,
         prob_hof = round(((p_b * p_e_b) / p_e) * 100, 1)) %>%
  dplyr::select(PlayerId, Name, Position, last_year, cumulative_war, Age, prob_hof, everything(), -WAR, 
                -HOF, -birth_year, -p_hof_at_position) %>%
  arrange(desc(prob_hof)) 
```

```{r}

votto_examples <- war_through_age %>%
  filter(Position == "1B",
         Age <= 33,
         cumulative_war >= 53.4)




top_5_by_position <- bayes_hof %>%
  group_by(Position) %>%
  arrange(desc(prob_hof)) %>%
  filter(row_number() <= 5) %>%
  arrange(Position, desc(prob_hof))

top_10_active_players <- bayes_hof %>%
  filter(last_year == 2017) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

top_10_20s_hof <- bayes_hof %>%
  filter(Age >= 20,
         Age <= 29,
         last_year == 2017) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

top_10_30s_hof <- bayes_hof %>%
  filter(Age >= 30,
         Age <= 39,
         last_year == 2017) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

top_10_inactive <- bayes_hof %>%
  filter(last_year < 2017) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

pet_causes <- bayes_hof %>%
  filter(Name %in% c("Kenny Lofton",
                     "Jim Edmonds", 
                     "Lou Whitaker",
                     "Larry Walker",
                     "Curt Schilling",
                     "Mike Mussina",
                     "Ted Simmons",
                     "Bobby Grich") |
           PlayerId == 642) %>%
  arrange(desc(prob_hof))


albies_comparables <- hof_eligible_players %>%
  filter(Position == "2B",
         Age == 20,
         cumulative_war <= 1.9)

```




