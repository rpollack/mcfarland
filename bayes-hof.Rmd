```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMariaDB)
library(Lahman)
library(doParallel)
library(rvest)
library(styler)
library(themis)
library(vip)
library(tidymodels)
library(glue)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)
```


# Get Player Data

```{r}
# get seasonal pitching WAR for players. remove relievers.
# use average of FIP-based and run-based WAR

con <-
  DBI::dbConnect(RMariaDB::MariaDB(),
    dbname = Sys.getenv("FG_DB"),
    host = Sys.getenv("FG_HOST"),
    user = Sys.getenv("FG_USER"),
    password = Sys.getenv("FG_PW"),
    port = 5001,
    ssl.ca = "~/Documents/skysql_fangraphs-db.pem"
  )

pitcher_stats_q <-
  dbSendQuery(con, "select PlayerId, ValueW, \`RA9-Wins\`, Age, GS, G
              from stats_pitching_master_pfx
              where Type = 0")

pitcher_stats <-
  dbFetch(pitcher_stats_q) %>%
  as_tibble() %>%
  mutate(WAR = round((ValueW + `RA9-Wins`) / 2, 1)) %>%
  group_by(PlayerId) %>%
  filter(sum(GS) / sum(G) >= 0.5) %>%
  ungroup() %>%
  dplyr::select(-G, -GS, -ValueW, -`RA9-Wins`)

dbClearResult(pitcher_stats_q)

batter_stats_q <-
  dbSendQuery(con, "select playerid AS PlayerId, ValueW as WAR, Age from stats_batting where Type = 0")

batter_stats <-
  dbFetch(batter_stats_q) %>%
  as_tibble()

dbClearResult(batter_stats_q)


player_info_q <-
  dbSendQuery(con, "select PlayerId, FirstName, LastName, BirthDate, LastGame, Position, BISPosition from player_info")

player_info <-
  dbFetch(player_info_q) %>%
  as_tibble() %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(
    last_year = year(ymd(LastGame)),
    Position = str_extract(Position, "^(P|C|1B|2B|3B|SS|OF|DH)"), # extract primary position from dataset
    birth_year = year(ymd(BirthDate))
  ) %>%
  dplyr::select(PlayerId, Name, birth_year, last_year, Position, BISPosition)

dbClearResult(player_info_q)

# gather fielding data. the main goal is to identify LF, RF, and CF separately
# so they can be compared correctly.
# we have 3 sources of data here:
# 1. detailed FG fielding info from innings compiled in the field
# 2. the Lahman DB
# 3. BIS Positional info
# get all the data from each source, then for each outfielder, examine them
# in descending order of priority for whether the "OF" truly is a LF, RF, or CF

# get ID looukps, used to join FG player info with LahmanDB info

id_q <-
  dbSendQuery(con, "select playerid, refid from playerid_lookup")

ids <-
  dbFetch(id_q) %>%
  as_tibble()

dbClearResult(id_q)

# get fielding data from detailed FG table

fielding_q <- dbSendQuery(con, "select PlayerId, Position, Season, Type, G, Inn from stats_fielding")

fielding_data_raw <-
  dbFetch(fielding_q) %>%
  as_tibble()

dbClearResult(fielding_q)
dbDisconnect(con)

fld <-
  fielding_data_raw %>%
  # omit stat lines that total up all outfield numbers. because we want more detailed positional info
  filter(Position != "OF") %>%
  group_by(PlayerId, Position) %>%
  summarize(total_innings = sum(Inn)) %>%
  group_by(PlayerId) %>%
  filter(total_innings == max(total_innings)) %>%
  dplyr::select(-total_innings)

# take player ID's, add in Lahman fielding data, and more detailed FG dielding data.
# see what we're left with

lahman_fielding_grouped <-
  FieldingOFsplit %>%
  as_tibble() %>%
  group_by(playerID, POS) %>%
  summarize(innings = sum(InnOuts)) %>%
  group_by(playerID) %>%
  filter(innings == max(innings)) %>%
  dplyr::select(refid = playerID, Position = POS)

# merge all 3 sources of positional data in the hopes that one will have a more specific
# designation than "OF"

# order of operations for delineating outfielders: prefer fg detail over lahman over BISposition
positional_info <-
  ids %>%
  left_join(lahman_fielding_grouped, by = "refid") %>%
  left_join(fld, by = c("playerid" = "PlayerId"), suffix = c("_lahman", "_fgdetail")) %>%
  left_join(player_info, by = c("playerid" = "PlayerId")) %>%
  mutate(real_position = case_when(
    Position == "OF" ~ case_when(
      Position_fgdetail %in% c("LF", "RF", "CF") ~ Position_fgdetail,
      Position_lahman %in% c("LF", "RF", "CF") ~ Position_lahman,
      BISPosition %in% c("LF", "RF", "CF") ~ BISPosition,
      TRUE ~ Position
    ),
    TRUE ~ Position
  )) %>%
  dplyr::select(PlayerId = playerid, Position = real_position)

# Get list of players in the HOF (who were voted in as players)

hof_url <- "https://www.baseball-reference.com/awards/hof.shtml"

hof_players <- read_html(hof_url) %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table(header = TRUE)

names(hof_players)[3] <- "Years"

hof_players <-
  hof_players %>%
  filter(`Inducted As` == "Player") %>%
  mutate(birth_year = as.numeric(str_extract(Years, "^[0-9]{4}"))) %>%
  dplyr::select(Name, birth_year) %>%
  mutate(
    HOF = "elected",

    # correct some discrepancies
    Name = str_replace(Name, "Cal Ripken Jr.", "Cal Ripken"),
    Name = str_replace(Name, "Henry Aaron", "Hank Aaron"),
    Name = str_replace(Name, "Old Hoss Radbourn", "Charley Radbourn"),
    birth_year = ifelse(Name == "Frankie Frisch", 1898, birth_year)
  )
```

```{r}

# the most recent season played
current_year <- 2021

# combine batting & pitching WAR for all player-seasons.
# add positional info where we can
# discard players whose position is "OF". there are about 1,200 of them and only 4-5 HOFers; not enough data,
# and no one is classified this way today, so not important.
war_through_age <-
  player_info %>%
  dplyr::select(-Position, -BISPosition) %>%
  full_join(batter_stats, by = "PlayerId") %>%
  full_join(pitcher_stats, by = c("PlayerId", "Age"), suffix = c("_bat", "_pitch")) %>%
  replace_na(list(WAR_bat = 0, WAR_pitch = 0)) %>%
  mutate(WAR = WAR_bat + WAR_pitch) %>%
  dplyr::select(-WAR_bat, -WAR_pitch) %>%
  left_join(hof_players, by = c("Name", "birth_year")) %>% # joining by birth year prevents mis-identifying players w/same name
  replace_na(list(HOF = "not_elected")) %>%
  group_by(PlayerId, Name, last_year) %>%
  arrange(Age) %>%
  mutate(
    num_seasons = n(),
    cumulative_war = round(cumsum(WAR), 1),
    considered_hof = if_else(last_year <= current_year - 6 & num_seasons >= 10, TRUE, FALSE),
  ) %>%
  dplyr::select(
    playerid = PlayerId, name = Name, last_year, age = Age,
    cumulative_war, considered_hof, hof = HOF
  ) %>%
  ungroup() %>%
  distinct() %>%
  na.omit() %>%
  mutate(scandal_type = case_when(
    name %in% c("Barry Bonds", "Roger Clemens", "Jose Canseco", "Rafael Palmeiro", "Jason Giambi", "Gary Sheffield", "Miguel Tejada", "Nelson Cruz", "Andy Pettite", "Ryan Braun", "Manny Ramirez", "Alex Rodriguez", "Mark McGwire", "Sammy Sosa", "Robinson Cano", "Starling Marte", "Melky Cabrera", "David Ortiz", "Dee Gordon") ~ "PED's",
    name %in% c("Joe Jackson", "Eddie Cicotte", "Buck Weaver", "Chick Gandil", "Fred McMullin", "Swede Risberg", "Lefty Williams", "Joe Gedeon", "Pete Rose") ~ "Gambling",
    name %in% c("Carlos Beltran", "Jose Altuve", "Alex Bregman", "Alex Cora", "Carlos Correa", "George Springer", "Gaylord Perry") ~ "Cheating",
    name %in% c("Curt Schilling") ~ "Misc.",
    name %in% c("Marcell Ozuna", "Roberto Osuna", "Jose Reyes", "Aroldis Chapman", "Omar Vizquel") ~ "Domestic Violence",
    TRUE ~ "None"
  )) %>%
  inner_join(positional_info, by = c("playerid" = "PlayerId")) %>%
  dplyr::select(playerid, name, position = Position, last_year, scandal_type, age, cumulative_war, considered_hof, hof) %>%
  # force some positions for some inductees. fielding positional data from bb-ref and BB HOF website. need to be more specific for averill as there are 2 guys with his name. really this should be done with player ID's.
  mutate(
    position = case_when(
      name %in% c(
        "Ty Cobb", "Earle Combs", "Edd Roush", "Hack Wilson", "Joe DiMaggio", "Lloyd Waner",
        "Max Carey", "Tris Speaker", "Joe Jackson"
      ) | (name == "Earl Averill" & position == "OF") ~ "CF",
      name %in% c(
        "Al Simmons", "Chick Hafey", "Ed Delahanty", "Fred Clarke", "Goose Goslin", "Heine Manush",
        "Jesse Burkett", "Joe Medwick", "Zack Wheat", "Jim O'Rourke", "Joe Kelley"
      ) ~ "LF",
      name %in% c(
        "Babe Ruth", "Chuck Klein", "Elmer Flick", "Harry Heilmann", "Harry Hooper",
        "Mel Ott", "Paul Waner", "Ross Youngs", "Sam Crawford", "Sam Rice", "Willie Keeler",
        "Kiki Cuyler", "Sam Thompson", "Tommy McCarthy"
      ) ~ "RF",
      TRUE ~ position
    )
  ) %>%
  filter(position != "OF") %>%
  mutate(hof = as_factor(if_else(hof == "elected", 1, 0)))

# no positional data for: billy hamilton, hugh duffy, willard brown
```


exploratory data analysis

```{r, fig.height = 3}
war_through_age %>%
  filter(considered_hof) %>%
  # group_by(age, position, hof) %>%
  # summarize(typical_cume_war = median(cumulative_war, na.rm = TRUE)) %>%
  ggplot(aes(age, cumulative_war, group = hof, color = hof)) +
  geom_point(size = 0.5) +
  facet_wrap(vars(position, scandal_type)) +
  ggtitle("Age vs. Typical WAR Trajectories, by HOF Inclusion Type") +
  labs(y = "Cumulative fWAR")

# position doesn't seem to matter too much except for DH (and probably relief pitcher, if I split those out). maybe can remove
```

build and evaluate a classification model using xgboost

```{r}


hof_split <-
  war_through_age %>%
  # train model only on players who have been considered for the HOF
  filter(considered_hof) %>%
  dplyr::select(-playerid, -name, -considered_hof, -last_year) %>%
  initial_split(strata = hof)

hof_train <- training(hof_split)
hof_test <- testing(hof_split)

xgb_spec <-
  boost_tree(
    trees = 100,
    tree_depth = tune(), min_n = tune(),
    loss_reduction = tune(),
    sample_size = tune(), mtry = tune(),
    learn_rate = tune()
  ) %>%
  set_engine("xgboost") %>%
  set_mode("classification")

xgb_grid <- grid_latin_hypercube(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), hof_train),
  learn_rate(),
  size = 50
)

xgb_recipe <-
  recipe(hof ~ ., data = hof_train) %>%
  step_dummy(position, scandal_type) %>%
  step_smote(hof)

xgb_wf <-
  workflow() %>%
  add_model(xgb_spec) %>%
  add_recipe(xgb_recipe)

# find the optimal values of tuning parameters using 10-fold cross validation
hof_folds <- vfold_cv(hof_train, strata = hof)

doParallel::registerDoParallel()

xgb_res <- tune_grid(
  xgb_wf,
  resamples = hof_folds,
  grid = xgb_grid,
  control = control_grid(save_pred = TRUE),
  metrics = metric_set(pr_auc)
)

# show how each parameter affects the model performance
xgb_res %>%
  collect_metrics() %>%
  filter(.metric == "pr_auc") %>%
  dplyr::select(mean, mtry:sample_size) %>%
  pivot_longer(mtry:sample_size,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "PR_AUC")

best_auc <- select_best(xgb_res, "pr_auc")

final_xgb <- finalize_workflow(
  xgb_wf,
  best_auc
)

# show the important of each variable
final_xgb %>%
  fit(data = hof_train) %>%
  extract_fit_parsnip() %>%
  vip(geom = "point")

# fit model to training set and evaluate on test set.
final_res <-
  last_fit(final_xgb, hof_split)

# extract final model and use it to predict MVP's
hof_mdl <- final_res$.workflow[[1]]
```

evaluate model using curves & area underneath it

```{r}

# compute area under ROC using class probabilities
area_under_curve <-
  final_res %>%
  collect_predictions() %>%
  pr_auc(truth = hof, .pred_1, event_level = "second") %>%
  dplyr::select(.estimate) %>%
  as.numeric() %>%
  round(2)

# draw  ROC using class probabilities
final_res %>%
  collect_predictions() %>%
  pr_curve(truth = hof, .pred_1, event_level = "second") %>%
  ggplot(aes(recall, precision)) +
  geom_path() + geom_hline(yintercept = 0.11, size = 1.1, color = "red", lty = "dashed") +
  ggtitle("Precision-Recall Curve, HOF Prediction Model",
    subtitle = glue("Area Under Curve: {area_under_curve}")
  )
```

predict hall of famers

```{r fig.height=3, fig.width=5}

# predict HOF chances for players who meet the following criteria:
# have not been considered for the HOF
# last played in the past 2 years (e.g. likely are still active) OR
# have at least 10 seasons in the majors (they are eligible at some point soon)
# this avoids predicting players like Brandon Webb and Josh Hamilton
# who are retired but didn't play 10 years so aren't eligible and will never be

year_threshold <- 2
num_players <- 10

war_through_age %>%
  add_count(playerid, name = "num_seasons") %>%
  filter(
    position != "OF",
    !considered_hof,
    between(last_year, current_year - year_threshold, current_year) | num_seasons >= 10
  ) %>%
  group_by(playerid) %>%
  filter(age == max(age)) %>%
  ungroup() %>%
  bind_cols(
    predict(hof_mdl, new_data = .),
    predict(hof_mdl, new_data = ., type = "prob")
  ) %>%
  mutate(prob_hof = 100 * (.pred_1)) %>%
  group_by(position) %>%
  slice_max(n = num_players, order_by = prob_hof) %>%
  ggplot(aes(reorder(name, prob_hof), prob_hof)) +
  geom_col() +
  coord_flip() +
  facet_wrap(vars(position), scales = "free_y") +
  labs(x = "", y = "HOF Probability (%)") +
  geom_hline(yintercept = 50, color = "red", lty = "dashed") +
geom_hline(yintercept = 75, color = "orange", lty = "dashed") +
  geom_hline(yintercept = 95, color = "green", lty = "dashed") +


  ggtitle(glue("Probability of HOF election"), subtitle = "Active or retired but not voted on yet")


year_threshold <- 2
num_players <- 10

war_through_age %>%
  add_count(playerid, name = "num_seasons") %>%
  filter(
    position != "OF",
    considered_hof,
    hof == 0
  ) %>%
  group_by(playerid) %>%
  filter(age == max(age)) %>%
  ungroup() %>%
  bind_cols(
    predict(hof_mdl, new_data = .),
    predict(hof_mdl, new_data = ., type = "prob")
  ) %>%
  mutate(prob_hof = 100 * (.pred_1)) %>%
  group_by(position) %>%
  slice_max(n = num_players, order_by = prob_hof) %>%
  ggplot(aes(reorder(name, prob_hof), prob_hof)) +
  geom_col() +
  coord_flip() +
  facet_wrap(vars(position), scales = "free_y") +
  labs(x = "", y = "HOF Probability (%)") +
  geom_hline(yintercept = 50, color = "red", lty = "dashed") +
  ggtitle(glue("Probability of HOF election"), subtitle = "Players already considered for the HOF, may be inducted as manager")
```
