```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(Lahman)
library(broom)
library(lubridate)
library(lazyeval)
library(doParallel)
library(xgboost)
library(rvest)
library(vip)
library(tidymodels)
library(keras)
library(glue)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)

fg_db <- dplyr::src_mysql(
  dbname = Sys.getenv("FG_DB"),
  host = Sys.getenv("FG_HOST"),
  user = Sys.getenv("FG_USER"),
  password = Sys.getenv("FG_PW")
)
```





# Get Player Data

```{r}
# get seasonal pitching WAR for players. remove relievers.
# use average of FIP-based and run-based WAR
pitcher_stats <- fg_db %>%
  tbl("stats_pitching_master_pfx") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId, ValueW, `RA9-Wins`, Age, GS, G) %>%
  collect(n = Inf) %>%
  mutate(WAR = round((ValueW + `RA9-Wins`) / 2, 1)) %>%
  group_by(PlayerId) %>% 
  filter(sum(GS) / sum(G) >= 0.5) %>% 
  ungroup() %>%
  dplyr::select(-G, -GS, -ValueW, -`RA9-Wins`)

# get seasonal batting/fielding WAR for players
batter_stats <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId = playerid, WAR = ValueW, Age) %>%
  collect(n = Inf)

player_info <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, BirthDate, LastGame, Position, BISPosition) %>%
  collect(n = Inf) %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(
    last_year = year(ymd(LastGame)),
    Position = str_extract(Position, "^(P|C|1B|2B|3B|SS|OF|DH)"), # extract primary position from dataset
    birth_year = year(ymd(BirthDate))
  ) %>%
  dplyr::select(PlayerId, Name, birth_year, last_year, Position, BISPosition)


# Get list of players in the HOF (who were voted in as players)

hof_url <- "https://www.baseball-reference.com/awards/hof.shtml"

hof_players <- read_html(hof_url) %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table(header = TRUE)

names(hof_players)[3] <- "Years"

hof_players <-
  hof_players %>%
  filter(`Inducted As` == "Player") %>%
  mutate(birth_year = as.numeric(str_extract(Years, "^[0-9]{4}"))) %>%
  dplyr::select(Name, birth_year) %>%
  mutate(
    HOF = "elected",

    # correct some discrepancies
    Name = str_replace(Name, "Cal Ripken Jr.", "Cal Ripken"),
    birth_year = ifelse(Name == "Frankie Frisch", 1898, birth_year)
  )
```

```{r}
# gather fielding data. the main goal is to identify LF, RF, and CF separately
# so they can be compared correctly.
# we have 3 sources of data here:
# 1. detailed FG fielding info from innings compiled in the field
# 2. the Lahman DB
# 3. BIS Positional info
# get all the data from each source, then for each outfielder, examine them
# in descending order of priority for whether the "OF" truly is a LF, RF, or CF

# get ID looukps, used to join FG player info with LahmanDB info
ids <-
  fg_db %>%
  tbl("playerid_lookup") %>%
  dplyr::select(playerid, refid) %>%
  collect(n = Inf)

# get fielding data from detailed FG table
fielding_data_raw <-
  fg_db %>%
  tbl("stats_fielding") %>%
  dplyr::select(PlayerId, Position, Season, Type, G, Inn) %>%
  collect(n = Inf)

fld <-
  fielding_data_raw %>%

  # omit stat lines that total up all outfield numbers. because we want more detailed positional info
  filter(Position != "OF") %>%
  group_by(PlayerId, Position) %>%
  summarize(total_innings = sum(Inn)) %>%
  group_by(PlayerId) %>%
  filter(total_innings == max(total_innings)) %>%
  dplyr::select(-total_innings)

# take player ID's, add in Lahman fielding data, and more detailed FG dielding data.
# see what we're left with

lahman_fielding_grouped <-
  FieldingOFsplit %>%
  as_tibble() %>%
  group_by(playerID, POS) %>%
  summarize(innings = sum(InnOuts)) %>%
  group_by(playerID) %>%
  filter(innings == max(innings)) %>%
  dplyr::select(refid = playerID, Position = POS)

# merge all 3 sources of positional data in the hopes that one will have a more specific
# designation than "OF"

# order of operations for delineating outfielders: prefer fg detail over lahman over BISposition
positional_info <-
  ids %>%
  left_join(lahman_fielding_grouped, by = "refid") %>%
  left_join(fld, by = c("playerid" = "PlayerId"), suffix = c("_lahman", "_fgdetail")) %>%
  left_join(player_info, by = c("playerid" = "PlayerId")) %>%
  mutate(real_position = case_when(
    Position == "OF" ~ case_when(
      Position_fgdetail %in% c("LF", "RF", "CF") ~ Position_fgdetail,
      Position_lahman %in% c("LF", "RF", "CF") ~ Position_lahman,
      BISPosition %in% c("LF", "RF", "CF") ~ BISPosition,
      TRUE ~ Position
    ),
    TRUE ~ Position
  )) %>%
  dplyr::select(PlayerId = playerid, Position = real_position)
```





```{r}

# the most recent season played
current_year <- 2020

# combine batting & pitching WAR for all player-seasons
war_through_age <-
  player_info %>%
  dplyr::select(-Position, -BISPosition) %>%
  full_join(batter_stats, by = "PlayerId") %>%
  full_join(pitcher_stats, by = c("PlayerId", "Age"), suffix = c("_bat", "_pitch")) %>%
  replace_na(list(WAR_bat = 0, WAR_pitch = 0)) %>%
  mutate(WAR = WAR_bat + WAR_pitch) %>%
  dplyr::select(-WAR_bat, -WAR_pitch) %>%
  left_join(hof_players, by = c("Name", "birth_year")) %>% # joining by birth year prevents mis-identifying players w/same name
  replace_na(list(HOF = "not_elected")) %>%
  group_by(PlayerId, Name, last_year) %>%

# #  inner_join(positional_info, by = "PlayerId") %>%
#   mutate(Position = case_when(
#     Position %in% c("LF", "CF", "RF") ~ "OF",
#     TRUE ~ Position
#   )) %>%
  arrange(Age) %>%
  mutate(
    num_seasons = n(),
    cumulative_war = round(cumsum(WAR), 1),
    considered_hof = if_else(last_year <= current_year - 6 & num_seasons >= 10, TRUE, FALSE),
  ) %>%
  dplyr::select(
    playerid = PlayerId, name = Name, last_year, age = Age,
    cumulative_war, considered_hof, hof = HOF
  ) %>%
  ungroup() %>%
  distinct() %>%
  na.omit() %>%
  filter(age >= 19, age <= 38)  %>%
  mutate(is_scandal = case_when(
    name %in% c("Barry Bonds", "Roger Clemens", "Joe Jackson", "Robinson Cano", "Pete Rose", "Alex Rodriguez", "Manny Ramirez", "Mark McGwire", "Sammy Sosa", "Jose Canseco", "Rafael Palmeiro", "Jason Giambi", "Gary Sheffield", "Miguel Tejada", "Nelson Cruz", "Andy Pettite", "Ryan Braun", "Carlos Beltran", "Jose Altuve", "Alex Bregman", "David Ortiz", "Carlos Correa", "Melky Cabrera", "George Springer") ~ 1,
    TRUE ~ 0
  )) %>%
  inner_join(positional_info, by=c("playerid" = "PlayerId")) %>%
  dplyr::select(playerid, name, position = Position, last_year, is_scandal, age, cumulative_war, considered_hof, hof) %>%
  mutate(hof = factor(hof, levels = c("elected", "not_elected")))


```


exploratory data analysis

```{r}
war_through_age  %>%
  filter(considered_hof) %>%
  # group_by(age, position, hof) %>%
  # summarize(typical_cume_war = median(cumulative_war, na.rm = TRUE)) %>%
  ggplot(aes(age, cumulative_war, group = hof, color = hof)) +
  geom_point(size=0.5) + 
  facet_wrap(vars(position)) +
  ggtitle("Age vs. Typical WAR Trajectories, by HOF Inclusion Type",
          subtitle = "Ages 19 - 38") +
  labs(y="Median fWAR Accumulated")

# position doesn't seem to matter too much except for DH (and probably relief pitcher, if I split those out). maybe can remove
```

modeling with keras / neural networks

```{r}

# using a neural network. https://www.tidymodels.org/learn/models/parsnip-nnet/

hof_split <-
  war_through_age %>%
  # train model only on players who have been considered for the HOF
  filter(considered_hof) %>%
  dplyr::select(-playerid, -name, -considered_hof, -last_year) %>%
  initial_split(strata = hof, prop = 0.8)

hof_train <- training(hof_split)
hof_test <- testing(hof_split)

# TODO: implement hyperparameter tuning and cross-validation

# hof elections are highly imbalanced, so need to penaliize the model
# to account for this.
# To define the appropriate weight, we divide the fraction of the majority class
# by the fraction of the minority # class to get how many times the former 
# is larger than the latter.
# this weight is unused as of now. 
weight <-
  war_through_age %>%
  distinct(playerid, hof) %>%
  add_count(hof) %>%
  mutate(prop = n / n()) %>%
  distinct(prop) %>%
  mutate(penalty = prop / lead(prop)) %>%
  filter(!is.na(penalty)) %>%
  dplyr::select(penalty) %>%
  as.numeric()

log_mod <-
  logistic_reg(penalty = tune(), mixture = 1) %>%
  set_mode("classification") %>%
  set_engine("glmnet")
# add adjustments for class imbalances later, here

log_folds <- vfold_cv(hof_train, strata = hof)

log_workflow <-
  workflow() %>%
  add_model(log_mod) %>%
  add_formula(hof ~ .)

log_grid <-
  grid_regular(penalty(),
               levels = 50)

log_res <-
  log_workflow %>%
  tune_grid(resamples = log_folds,
            grid = log_grid,
            control = control_grid(save_pred = TRUE),
            metrics = metric_set(pr_auc))

# plot the value of 'penalty' vs. the area under the P-R curve
log_res %>% 
  collect_metrics() %>% 
  ggplot(aes(x = penalty, y = mean)) + 
  geom_point() + 
  geom_line() + 
  ylab("Area under the Precision Recall Curve") +
  scale_x_log10(labels = scales::label_number())

# choose penalty number 34. this cuts out a lot of predictors while maintaining
# a high PR-AUC

log_best <-
  log_res %>%
  collect_metrics() %>%
  arrange(penalty) %>%
  dplyr::slice(34)

log_res %>% 
  collect_predictions(parameters = log_best) %>% 
  pr_curve(hof, .pred_elected) %>% 
  mutate(model = "Logistic Regression") %>%
  autoplot()

final_wf <-
  log_workflow %>%
  finalize_workflow(log_best)

#fit the final model on the full training set and evaluate it on the test set
final_fit <-
  final_wf %>%
  last_fit(hof_split)

# plot the importance of model predictors
final_fit %>% 
  purrr::pluck(".workflow", 1) %>%   
  pull_workflow_fit() %>% 
  vip(num_features = 20)

final_predictions <-
  final_fit %>%
  collect_predictions()

# evaluation: compute the area under the P-R curve
pr_area <-
  final_predictions %>%
  pr_auc(hof, .pred_elected) %>%
  dplyr::select(.estimate) %>%
  as.numeric %>%
  round(3)
  
#evaluation: show the precision-recall curve
final_predictions %>% 
  mutate(.pred_elected = as.numeric(.pred_elected)) %>%
  pr_curve(truth = hof, .pred_elected) %>% 
  autoplot() + 
  ggtitle("Precision-Recall Curve, HOF Model",
                       subtitle = glue("Area under curve: {pr_area}")) +
  geom_abline(intercept = 1, slope = -1, linetype = "dashed")

# evaluation: show the confusion matrix
final_fit %>%
  collect_predictions() %>%
  conf_mat(hof, .pred_class)

# evaluation: show the confusioin matrix metrics
final_fit %>%
  collect_predictions() %>%
  conf_mat(hof, .pred_class) %>%
  summary() %>%
  ggplot(aes(.metric, .estimate)) +
  geom_col() + coord_flip()

hof_mdl <-
  final_wf %>%
  fit(hof_train)
```

```{r}

hof_results <-
  hof_test %>%
  bind_cols(predict(log_fit, new_data = .)) %>%
  mutate(pred_hof = if_else(.pred_class == "elected", 1, 0))

au_roc <-
  hof_results %>%
  roc_auc(truth = hof, pred_hof) %>%
  dplyr::select(.estimate) %>%
  as.numeric() %>%
  round(3)

# plot the precision-recall curve. 
hof_results %>%
  roc_curve(truth = hof, pred_hof) %>%
  autoplot() +
  ggtitle("ROC Curve, HOF Model",
          subtitle = glue("Area under the curve: {au_roc}"))

hof_results %>% 
  conf_mat(truth = hof, .pred_class)

hof_results %>% 
  conf_mat(truth = hof, .pred_class) %>%
  summary() %>%
  ggplot(aes(.metric, .estimate)) + geom_col() +
  coord_flip()

# predict HOF chances for players who meet the following criteria:
# have not been considered for the HOF
# last played in the past 2 years (e.g. likely are still active) OR
# have at least 10 seasons in the majors (they are eligible at some point soon)
# this avoids predicting players like Brandon Webb and Josh Hamilton
# who are retired but didn't play 10 years so aren't eligible and will never be

year_threshold <- 2
num_players <- 10

war_through_age %>%
  add_count(playerid, name = "num_seasons") %>%
  filter(position != "OF",
         !considered_hof,
         between(last_year, current_year - year_threshold, current_year) | num_seasons >= 10) %>% 
  group_by(playerid) %>%
  filter(age == max(age)) %>%
  ungroup() %>%
  bind_cols(predict(log_fit, new_data = .),
            predict(log_fit, new_data = ., type = "prob")) %>%
  mutate(prob_hof = 100 * (.pred_elected)) %>% 
  group_by(position) %>%
  slice_max(n = num_players, order_by = prob_hof) %>%
  ggplot(aes(reorder(name, prob_hof), prob_hof)) +
  geom_col() + coord_flip() + facet_wrap(vars(position), scales = "free_y") +
  labs(x="", y = "HOF Probability (%)") +
  geom_hline(yintercept=50, color = "red") +
  ggtitle(glue("Probability of HOF election"), subtitle = "Active or recently retired eligible players")

```

