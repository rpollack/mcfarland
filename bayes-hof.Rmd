```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(Lahman)
library(broom)
library(lubridate)
library(lazyeval)
library(doParallel)
library(xgboost)
library(rvest)
library(vip)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)

fg_db <- dplyr::src_mysql(
  dbname = Sys.getenv("FG_DB"),
  host = Sys.getenv("FG_HOST"),
  user = Sys.getenv("FG_USER"),
  password = Sys.getenv("FG_PW")
)
```





# Get Player Data

```{r}
# get seasonal pitching WAR for players. remove relievers
pitcher_stats <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId, WAR = ValueW, Age, GS, G) %>%
  collect(n = Inf) %>%
  group_by(PlayerId) %>% 
  filter(sum(GS) / sum(G) >= 0.5) %>% 
  ungroup() %>%
  dplyr::select(-G, -GS)

# get seasonal batting/fielding WAR for players
batter_stats <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId = playerid, WAR = ValueW, Age) %>%
  collect(n = Inf)

player_info <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, BirthDate, LastGame, Position, BISPosition) %>%
  collect(n = Inf) %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(
    last_year = year(ymd(LastGame)),
    Position = str_extract(Position, "^(P|C|1B|2B|3B|SS|OF|DH)"), # extract primary position from dataset
    birth_year = year(ymd(BirthDate))
  ) %>%
  dplyr::select(PlayerId, Name, birth_year, last_year, Position, BISPosition)


# Get list of players in the HOF (who were voted in as players)

hof_url <- "https://www.baseball-reference.com/awards/hof.shtml"

hof_players <- read_html(hof_url) %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table(header = TRUE)

names(hof_players)[3] <- "Years"

hof_players <-
  hof_players %>%
  filter(`Inducted As` == "Player") %>%
  mutate(birth_year = as.numeric(str_extract(Years, "^[0-9]{4}"))) %>%
  dplyr::select(Name, birth_year) %>%
  mutate(
    HOF = "elected",

    # correct some discrepancies
    Name = str_replace(Name, "Cal Ripken Jr.", "Cal Ripken"),
    birth_year = ifelse(Name == "Frankie Frisch", 1898, birth_year)
  )
```

```{r}
# gather fielding data. the main goal is to identify LF, RF, and CF separately
# so they can be compared correctly.
# we have 3 sources of data here:
# 1. detailed FG fielding info from innings compiled in the field
# 2. the Lahman DB
# 3. BIS Positional info
# get all the data from each source, then for each outfielder, examine them
# in descending order of priority for whether the "OF" truly is a LF, RF, or CF

# get ID looukps, used to join FG player info with LahmanDB info
ids <-
  fg_db %>%
  tbl("playerid_lookup") %>%
  dplyr::select(playerid, refid) %>%
  collect(n = Inf)

# get fielding data from detailed FG table
fielding_data_raw <-
  fg_db %>%
  tbl("stats_fielding") %>%
  dplyr::select(PlayerId, Position, Season, Type, G, Inn) %>%
  collect(n = Inf)

fld <-
  fielding_data_raw %>%

  # omit stat lines that total up all outfield numbers. because we want more detailed positional info
  filter(Position != "OF") %>%
  group_by(PlayerId, Position) %>%
  summarize(total_innings = sum(Inn)) %>%
  group_by(PlayerId) %>%
  filter(total_innings == max(total_innings)) %>%
  dplyr::select(-total_innings)

# take player ID's, add in Lahman fielding data, and more detailed FG dielding data.
# see what we're left with

lahman_fielding_grouped <-
  FieldingOFsplit %>%
  as_tibble() %>%
  group_by(playerID, POS) %>%
  summarize(innings = sum(InnOuts)) %>%
  group_by(playerID) %>%
  filter(innings == max(innings)) %>%
  dplyr::select(refid = playerID, Position = POS)

# merge all 3 sources of positional data in the hopes that one will have a more specific
# designation than "OF"

# order of operations for delineating outfielders: prefer fg detail over lahman over BISposition
positional_info <-
  ids %>%
  left_join(lahman_fielding_grouped, by = "refid") %>%
  left_join(fld, by = c("playerid" = "PlayerId"), suffix = c("_lahman", "_fgdetail")) %>%
  left_join(player_info, by = c("playerid" = "PlayerId")) %>%
  mutate(real_position = case_when(
    Position == "OF" ~ case_when(
      Position_fgdetail %in% c("LF", "RF", "CF") ~ Position_fgdetail,
      Position_lahman %in% c("LF", "RF", "CF") ~ Position_lahman,
      BISPosition %in% c("LF", "RF", "CF") ~ BISPosition,
      TRUE ~ Position
    ),
    TRUE ~ Position
  )) %>%
  dplyr::select(PlayerId = playerid, Position = real_position)
```





```{r}



# combine batting & pitching WAR for all player-seasons
war_through_age <-
  player_info %>%
  dplyr::select(-Position, -BISPosition) %>%
  full_join(batter_stats, by = "PlayerId") %>%
  full_join(pitcher_stats, by = c("PlayerId", "Age"), suffix = c("_bat", "_pitch")) %>%
  replace_na(list(WAR_bat = 0, WAR_pitch = 0)) %>%
  mutate(WAR = WAR_bat + WAR_pitch) %>%
  dplyr::select(-WAR_bat, -WAR_pitch) %>%
  left_join(hof_players, by = c("Name", "birth_year")) %>% # joining by birth year prevents mis-identifying players w/same name
  replace_na(list(HOF = "not_elected")) %>%
  group_by(PlayerId, Name, last_year) %>%

# #  inner_join(positional_info, by = "PlayerId") %>%
#   mutate(Position = case_when(
#     Position %in% c("LF", "CF", "RF") ~ "OF",
#     TRUE ~ Position
#   )) %>%
  arrange(Age) %>%
  mutate(
    num_seasons = n(),
    cumulative_war = round(cumsum(WAR), 1),
    considered_hof = if_else(last_year <= current_year - 6 & num_seasons >= 10, TRUE, FALSE),
  ) %>%
  dplyr::select(
    playerid = PlayerId, name = Name, last_year, age = Age,
    cumulative_war, considered_hof, hof = HOF
  ) %>%
  ungroup() %>%
  distinct() %>%
  na.omit() %>%
  filter(age >= 19, age <= 38) 

```


exploratory data analysis

```{r}
war_through_age  %>%
  filter(considered_hof) %>%
  group_by(age, position, hof) %>%
  summarize(typical_cume_war = median(cumulative_war, na.rm = TRUE)) %>%
  ggplot(aes(age, typical_cume_war, group = hof, color = hof)) +
  geom_point(size=0.5) + geom_line() +
  facet_wrap(~position) +
  ggtitle("Age vs. Typical WAR Trajectories, by HOF Inclusion Type",
          subtitle = "Ages 19 - 38") +
  labs(y="Typical Player's Cumulative WAR")

# position doesn't seem to matter too much except for DH (and probably relief pitcher, if I split those out). maybe can remove
```

modeling with xgboost

```{r}

war_through_age <-
  war_through_age %>%
  pivot_wider(
    names_from = age, values_from = cumulative_war, names_glue = "war_through_{age}",
    values_fn = mean
  ) %>%
  mutate(hof = factor(hof, levels = c("elected", "not_elected"))) %>%
  dplyr::select(playerid, name, last_year, contains("war_through"), considered_hof, hof)

# create training and test splits.
# remove irrelevant predictors and filter data to only those who've been considered for HOF


hof_split <-
  war_through_age %>%
  filter(considered_hof) %>%
  dplyr::select(-playerid, -name, -considered_hof) %>%
  initial_split(strata = hof)

hof_train <- training(hof_split)
hof_test <- testing(hof_split)

xgb_spec <- boost_tree(
  trees = 100,
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(), ## first three: model complexity
  sample_size = tune(),
  mtry = tune(), ## randomness
  learn_rate = tune(), ## step size
) %>%
  set_engine("xgboost") %>%
  set_mode("classification")


xgb_grid <- grid_latin_hypercube(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), hof_train),
  learn_rate(),
  size = 30
)

xgb_wf <- workflow() %>%
  add_formula(hof ~ .) %>%
  add_model(xgb_spec)

# 10-fold cross validation
hof_folds <-
  vfold_cv(hof_train, strata = hof)

doParallel::registerDoParallel()

# tune model parameters on the training set, using area under the precision-recall
# curve as the success metric
xgb_res <-
  tune_grid(
    xgb_wf,
    resamples = hof_folds,
    grid = xgb_grid,
    metrics = metric_set(pr_auc),
    control = control_grid(save_pred = TRUE)
  )

# show how tuning parameters affect results
xgb_res %>%
  collect_metrics() %>%
  filter(.metric == "pr_auc") %>%
  select(mean, mtry:sample_size) %>%
  pivot_longer(mtry:sample_size,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "AUPRC")


hof_mdl <-
  finalize_workflow(
    xgb_wf,
    select_best(xgb_res, "pr_auc")
  )

# plot predictor importance
hof_mdl %>%
  fit(data = hof_train) %>%
  pull_workflow_fit() %>%
  vip(geom = "point")

# fit the final model to the training set & evaluate on the test set
final_res <- last_fit(hof_mdl, hof_split)

collect_metrics(final_res)

final_res %>%
  collect_predictions() %>%
  #mutate(.pred_class = as.numeric(.pred_class)) %>%
  # mutate(.pred_hof = as.numeric(if_else(.pred_FALSE > .pred_TRUE, FALSE, TRUE))) %>%
  roc_curve(hof, .pred_class) %>%
  autoplot()


# now how the fuck do i use the model to predict new data?!?!?

# predict.model_fit(final_res, hof_test, type = "regression")
```


modeling with logistic regression

```{r}

logistic_glm <-
  logistic_reg(mode = "classification") %>%
  set_engine("glm") %>%
  fit(hof ~ ., data = hof_train)

logistic_glm %>%

```





```{r}
prob_war_thru_age <- function(PlayerId, Age, Position, war_floor, war_ceiling, ...) {
  # number of players (all-time HOF eligible and HOF inductees) who, at age X,
  # have accumulated between Y and Z WAR at that position. only look at players who retired 5 years ago or earlier.
  # these are the players we should be comparing to.
  # also remove the player themselves from the analysis. otherwise if the player is eligible but not inducted (like Barry Bonds), they're compared to themselves and that lowers their probability, since they are not HOF by definition


  # TODO: this code works great when run by itself. but not when inside a function.
  # probably has to do with scoping ...

  hof_eligible_players %>%
    filter(
      PlayerId != !!PlayerId,
      Age == !!Age,
      Position == !!Position,
      cumulative_war >= !!war_floor,
      cumulative_war <= !!war_ceiling
    ) %>%
    distinct(PlayerId, HOF) %>% # retain only one row for each matching player
    count(HOF) %>%
    complete(HOF = c("Yes", "No"), fill = list(n = 0)) %>%
    spread(HOF, n) %>%
    mutate(num_eligible_players_who_meet_criteria = No + Yes) %>%
    dplyr::select(num_eligible_players_who_meet_criteria, num_hof_players_who_meet_criteria = Yes)
}
```




```{r}
# === EVERYTHING BELOW HERE IS LEGACY ===

# compute HOF & non-HOF totals and probabilities at each position
current_year <- 2020
hof_probabilities_by_position <-
  war_through_age %>%
  ungroup() %>%
  filter(last_year <= current_year - 6) %>%
  distinct(PlayerId, HOF, Position) %>%
  count(HOF, Position) %>%
  spread(HOF, n) %>%
  dplyr::select(Position, non_hof_at_position = No, hof_at_position = Yes) %>%

  # replace computed totals with totals from HOF website: https://baseballhall.org/hall-of-famers/hall-of-famers-by-position
  mutate(
    hof_at_position = case_when(
      Position == "1B" ~ 24,
      Position == "2B" ~ 21,
      Position == "3B" ~ 17,
      Position == "SS" ~ 26,
      Position == "C" ~ 19,
      Position == "LF" ~ 22,
      Position == "CF" ~ 24,
      Position == "RF" ~ 26,
      Position == "DH" ~ 2,
      Position == "P" ~ 83
    ),
    total_eligible_players_at_position = hof_at_position + non_hof_at_position,
    p_hof_at_position = hof_at_position / total_eligible_players_at_position
  )


# find only HOF eligible players
hof_eligible_players <- war_through_age %>%
  ungroup() %>%
  filter(last_year <= current_year - 6)

# for each player, find the number of players (HOF & non-HOF) with WAR in that range.
# then use totals to compute Bayesian parameters & finally the probability of that player reaching HOF
# focus on the latest seasons for non-HOF players

war_age_combinations <-
  war_through_age %>%
  filter(HOF == "No") %>%
  dplyr::select(PlayerId, Age, Position, war_floor, war_ceiling) %>%
  # head(1000) %>%
  group_by(PlayerId) %>%
  filter(Age == max(Age)) %>%
  ungroup() %>%
  # rowwise(PlayerId, Age, cumulative_war, Position, war_floor, war_ceiling) %>%
  pmap_dfr(prob_war_thru_age)

# compute HOF probabilities for all splayers
bayes_hof <-
  war_through_age %>%
  filter(HOF == "No") %>%
  group_by(PlayerId) %>%
  filter(Age == max(Age)) %>%
  ungroup() %>%
  # add data used to calculate bayesian parameters
  bind_cols(war_age_combinations) %>%
  inner_join(hof_probabilities_by_position, by = "Position") %>%
  mutate(
    p_b = p_hof_at_position,
    p_e_b = num_hof_players_who_meet_criteria / hof_at_position,
    p_e = num_eligible_players_who_meet_criteria / total_eligible_players_at_position,
    prob_hof = round(((p_b * p_e_b) / p_e) * 100, 1)
  ) %>%
  dplyr::select(
    PlayerId, Name, prob_hof, cumulative_war, Age, Position, last_year, everything(), -WAR,
    -HOF, -birth_year, -p_hof_at_position
  ) %>%
  arrange(desc(prob_hof))

bayes_hof %>%
  filter(is.na(prob_hof)) %>%
  arrange(desc(cumulative_war))

full_list <- bayes_hof %>%
  ungroup() %>%
  filter(
    Position != "DH",
    !Name %in% c("Aaron Sanchez", "Chris Perez")
  ) %>%
  dplyr::select(Name, `HOF Chance (%)` = prob_hof, WAR = cumulative_war, Age, Position) %>%
  write_csv("full-list.csv")
```


### Exploration

```{r}


top_5_by_position <- bayes_hof %>%
  filter(Position != "DH", last_year == 2017, Name != "Carlos Beltran") %>%
  group_by(Position) %>%
  arrange(desc(prob_hof)) %>%
  filter(row_number() <= 5) %>%
  arrange(Position, desc(prob_hof))

top_10_active_players <- bayes_hof %>%
  filter(last_year == 2017) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

top_10_20s_hof <- bayes_hof %>%
  filter(
    Age >= 20,
    Age <= 29,
    last_year == 2017
  ) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

top_10_30s_hof <- bayes_hof %>%
  filter(
    Age >= 30,
    Age <= 39,
    last_year == 2017
  ) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

hof_40s <- bayes_hof %>%
  filter(
    Age > 39,
    last_year == 2017
  ) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

top_10_inactive <- bayes_hof %>%
  filter(last_year < 2017) %>%
  arrange(desc(prob_hof)) %>%
  head(10)

pet_causes <- bayes_hof %>%
  filter(Name %in% c(
    "Kenny Lofton",
    "Jim Edmonds",
    "Lou Whitaker",
    "Ted Simmons",
    "Bobby Grich",
    "Jim Fregosi",
    "Dick Allen",
    "John Olerud"
  ) |
    PlayerId == 642) %>%
  arrange(desc(prob_hof))


albies_comparables <- hof_eligible_players %>%
  filter(
    Position == "2B",
    Age == 20,
    cumulative_war <= 1.9
  )


# barry bonds comparables
hof_eligible_players %>%
  filter(
    Position == "OF",
    Age == 42,
    cumulative_war >= 164.4 - (1.5 * 22),
    cumulative_war <= 164.4 + (1.5 * 22)
  ) %>%
  View()

((.024 * (2 / 71)) / (2 / 2862))
```



### different analysis
given player X has had N seasons between Y and Z WAR at position P, what is the probability of HOF?

p(b) = probability of HOF at that position (already have this data in hof_probabilities_by_position tibble)
p(e|b) = given HOF at that position, probability player nad a season between Y and Z WAR
p(e) = proability at that position of having a season between Y and Z WAR

also:

looking at HOF eligible players, for each position:
- find how many HOFers had <threshold> seasons between <floor> and <ceiling> WAR
- find how many non-HOFers had <threshold> seasons in that range.

initial DF should look like:

position | war_floor | war_ceiling | threshold_seasons

then do: calc_

position | war_range | threshold_seasons | p_b | p_e_b | p_b | p_b_e





```{r}
# for each position, count the nmber of HOF and non-HOF players who had a certain number of seasons in that WAR range
prob_num_seasons_in_range <- function(position, war_floor, war_ceiling, num_seasons) {
  hof_eligible_players_seasonal %>%
    filter(Position == position) %>%
    mutate(season_in_war_range = if_else(WAR >= war_floor & WAR < war_ceiling, 1, 0)) %>%
    group_by(PlayerId, Name, Position, HOF) %>%
    summarize(num_seasons_in_range = sum(season_in_war_range)) %>%
    filter(num_seasons_in_range == num_seasons) %>%
    print() %>% # show us the players who meet the criteria
    ungroup() %>%
    count(HOF) %>%
    complete(HOF = c("Yes", "No"), fill = list(n = 0)) %>% # account for situations zero HOF'ers or zero non HOF'ers
    spread(HOF, n) %>%
    select(non_hof_who_meet_criteria = No, hof_who_meet_criteria = Yes) %>%
    as_tibble() %>%
    return()
}
```

test cases:

1. everyone returned is not in the HOF:
prob_num_seasons_in_range("3B", 1, 3, 1)

the above should give a tibble of:

No: 1
Yes: 0

the only player returned is Todd Zeile who is not in the HOF.

2. no one returned is in the HOF:


single-line execution of the function above, for debugging purposes:

hof_eligible_players_seasonal %>% filter(Position == "3B") %>% mutate(seasons_in_war_range = if_else(WAR >= 1 & WAR <= 3, 1, 0)) %>% group_by(PlayerId, Name, Position, HOF) %>% summarize(num_seasons_in_range = sum(seasons_in_war_range)) %>% filter(num_seasons_in_range == 10) %>% ungroup %>% count(HOF) %>% complete(HOF = c("No", "Yes"), fill=list(n=0)) %>% spread(HOF,n) %>% mutate(num_eligible_players_who_meet_criteria = No + Yes)

```{r}

# examine seasons of only only HOF eligible players
hof_eligible_players_seasonal <-
  seasonal_war %>%
  filter(
    last_year <= current_year - 6,
    Position != "P"
  ) # omit pitchers since we can't separate SP from RP

wl <- c(0, 2, 4, 6, 8, 10, 12)
wh <- c(2, 4, 6, 8, 10, 12, 14)
pos <- c("1B", "2B", "3B", "SS", "OF", "C")
n <- c(seq(1:12))

df <- expand.grid(
  position = pos,
  war_floor = wl,
  war_ceiling = wh,
  num_seasons_to_analyze = n
) %>%
  filter(war_ceiling - war_floor == 2) %>% # retain only valid 2-WAR ranges
  mutate(position = as.character(position)) %>%
  as_tibble()

# TODO: find a better way to list the players at each WAR range.

base_hof_prob <- hof_probabilities_by_position %>%
  filter(Position == pos) %>%
  select(position = Position, hof_at_position, total_eligible_players_at_position, p_hof_at_position)

results <-
  df %>%
  group_by(position, war_floor, war_ceiling, num_seasons_to_analyze) %>%
  do(prob_num_seasons_in_range(.$position, .$war_floor, .$war_ceiling, .$num_seasons_to_analyze)) %>%
  mutate(total_who_meet_criteria = non_hof_who_meet_criteria + hof_who_meet_criteria) %>%
  inner_join(hof_probabilities_by_position, by = c("position" = "Position")) %>%
  mutate(
    p_b = p_hof_at_position,
    p_e_b = hof_who_meet_criteria / hof_at_position,
    p_e = total_who_meet_criteria / total_eligible_players_at_position,
    p_hof = round(((p_b * p_e_b) / p_e) * 100, 1)
  ) %>%
  ungroup() %>%
  mutate(war_ceiling = war_ceiling - 0.1) %>% # so we label the WAR ranges correctly
  unite(war_range, war_floor, war_ceiling, sep = " - ") %>%
  dplyr::select(position, war_range, num_seasons_to_analyze, p_hof, everything()) %>%
  mutate(war_range = factor(war_range,
    levels = c(
      "0 - 1.9", "2 - 3.9", "4 - 5.9", "6 - 7.9", "8 - 9.9",
      "10 - 11.9", "12 - 13.9"
    )
  )) %>%
  arrange(position, war_range, num_seasons_to_analyze, p_hof)
```

# single function run

```{r, fig.height = 4, fig.width=4}
results %>%
  # filter(position == "OF") %>%
  ggplot(aes(x = num_seasons_to_analyze, y = p_hof, color = position)) +
  fgt +
  geom_point() +
  facet_wrap(~war_range) +
  scale_x_continuous(breaks = n) +
  labs(x = "Number of Seasons in WAR Range", y = "HOF Probability (%)", title = "HOF Probability by Number of Seasons in WAR Ranges", caption = "Sources: FanGraphs, Baseball-Reference")
```
