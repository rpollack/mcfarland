```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)
library(lubridate)
library(gamlss)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))



```


# Get Player Data

```{r}

batter_info <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%
  dplyr::select(playerid, WAR = ValueW, Age) %>%
  collect(n=Inf)


#get seasonal batting/fielding WAR for position players
seasonal_war <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, BirthDate, LastGame, Position) %>%
  collect(n=Inf) %>%
  filter(!str_detect(Position, "P")) %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(last_year = year(ymd(LastGame)),
         Position = str_extract(Position, "^(C|1B|2B|3B|SS|OF|DH)"),    #extract primary position from dataset
         birth_year = year(ymd(BirthDate))) %>%   
  dplyr::select(PlayerId, Name, birth_year, last_year, Position) %>%
  inner_join(batter_info, by=c("PlayerId" = "playerid")) 

# Get list of players in the HOF (who were voted in as players)

hof_url <- "https://www.baseball-reference.com/awards/hof.shtml"

hof_players <- read_html(hof_url) %>%
  html_nodes("table") %>%
    .[[1]] %>%
    html_table(header=TRUE)

names(hof_players)[3] <- "Years"

hof_players <- hof_players %>%
  filter(`Inducted As` == "Player") %>%
  mutate(birth_year = as.numeric(str_extract(Years, "^[0-9]{4}"))) %>%
  dplyr::select(Name, birth_year) %>%
  mutate(HOF = "Yes",
         Name = str_replace(Name, "Ken Griffey", "Ken Griffey Jr."),
         birth_year = ifelse(Name == "Frankie Frisch", 1898, birth_year))
  
```


# For each player, for each age, find cumulative WAR through that age



```{r}
#for each player-season, compute their total WAR through the age they were that season
#also mark which players are in HOF
#round up cumulative WAR totals to speed up computations later

war_through_age <- seasonal_war %>%
  group_by(PlayerId, Name, last_year, Position) %>%
  arrange(Age) %>%
  mutate(cumulative_war = ceiling(cumsum(WAR))) %>%
  left_join(hof_players, by=c("Name", "birth_year")) %>% #joining by birth year prevents mis-identifying players w/same name
  replace_na(list(HOF= "No"))

#find the number of HOF-eligible players

# num_hof_eligible_players <- seasonal_war %>% 
#   filter(last_year <= current_year - 5) %>%
#   distinct(PlayerId) %>% 
#   nrow()

#find number of HOF players
# num_players_in_hof <- hof_players %>%
#   distinct(Name) %>%
#   nrow()

#compute HOF & non-HOF totals and probabilities at each position
current_year = 2017
hof_probabilities_by_position <- war_through_age %>% 
  ungroup() %>% 
  filter(last_year <= current_year - 5) %>%
  distinct(PlayerId, HOF, Position) %>%
  count(HOF, Position) %>% 
  spread(HOF, n) %>%
  dplyr::select(Position, non_hof_at_position = No, hof_at_position = Yes) %>%
  
  #replace computed totals with totals from HOF website: https://baseballhall.org/hall-of-famers/hall-of-famers-by-position
  mutate(hof_at_position = ifelse(Position == "1B", 23,
                                  ifelse(Position == "2B", 21,
                                         ifelse(Position == "3B", 16,
                                                ifelse(Position == "SS", 24,
                                                       ifelse(Position == "C", 18,
                                                              ifelse(Position == "OF", 70,
                                                                     ifelse(Position == "DH", 0, hof_at_position))))))),
         total_eligible_players_at_position = hof_at_position + non_hof_at_position,
         p_hof_at_position = hof_at_position / total_eligible_players_at_position)

#for computing totals, compare players to only those who have retired 5 years ago or earlier.
hof_eligible_players <- war_through_age %>%
  ungroup() %>%
  filter(last_year <= current_year - 5)

prob_war_thru_age <- function(age, war, position){
  #number of players (all-time HOF eligible and HOF inductees) who, at age X or younger, 
  #have accumulated Y +/- 2 WAR at that position
  
  war_lower_bound <- war - 2
  war_upper_bound <- war + 2

  matching_players <- hof_eligible_players %>%
    dplyr::select(PlayerId, Age, HOF, cumulative_war, Position) %>%
    filter(Age <= age,
           Position == position,
           cumulative_war >= war_lower_bound,
           cumulative_war <= war_upper_bound) %>%
    distinct(PlayerId, HOF)
  
  num_players_at_position <- matching_players %>%
    nrow()
  
  num_hof_players_at_position <- matching_players %>%
    filter(HOF == "Yes") %>%
    nrow()
  
  result <- sprintf("%d %d", num_players_at_position, num_hof_players_at_position)
  return(result)
}
prob_war_thru_age <- Vectorize(prob_war_thru_age)
```

# compute Bayesian parameters

```{r}

#round all war values up to the nearest integer, to speed things up. ceiling()

#for each age/cumulative war combination, find the number of players (HOF & non-HOF) who achieved that total,
# plus or minus 2 WAR, at that age or younger
war_age_combinations <- war_through_age %>%
  ungroup() %>%
  dplyr::select(Age, cumulative_war, Position) %>%
  expand(nesting(Age, cumulative_war, Position)) %>%
  mutate(x = prob_war_thru_age(Age, cumulative_war, Position)) %>%
  separate(x, c("num_eligible_players_who_meet_criteria", 
                "num_hof_players_who_meet_criteria"), sep = " ") %>%
  mutate(num_eligible_players_who_meet_criteria = as.numeric(num_eligible_players_who_meet_criteria),
         num_hof_players_who_meet_criteria = as.numeric(num_hof_players_who_meet_criteria))

bayes_hof <- inner_join(war_through_age, war_age_combinations, by=c("Age", "cumulative_war", "Position")) %>%
  inner_join(hof_probabilities_by_position, by="Position") %>%
  filter(HOF == "No",              #no need to do this analysis for HOF inductees
         Position != "DH") %>%     #there are no DH's in HOF so their probability is Inf
  group_by(PlayerId, Name) %>%
  filter(Age == max(Age)) %>%
  mutate(p_b = p_hof_at_position,
         p_e_b = num_hof_players_who_meet_criteria / hof_at_position,
         p_e = num_eligible_players_who_meet_criteria / total_eligible_players_at_position,
         prob_hof = round(((p_b * p_e_b) / p_e) * 100, 1)) %>%
  dplyr::select(PlayerId, Name, Position, cumulative_war, Age, prob_hof, everything(), -WAR, -HOF) %>%
  arrange(desc(prob_hof))

active_players <- bayes_hof %>%
  filter(last_year == 2017)

  
```


