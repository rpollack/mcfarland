```{r}
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
library(RMariaDB)
library(Lahman)
library(doParallel)
library(rvest)
library(styler)
library(themis)
library(vip)
library(glue)
library(lubridate)
library(probably)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)
```


# Get Player Data

```{r}
# get seasonal pitching WAR for players. remove relievers.
# use average of FIP-based and run-based WAR

con <-
  DBI::dbConnect(RMariaDB::MariaDB(),
    dbname = Sys.getenv("FG_DB"),
    host = Sys.getenv("FG_HOST"),
    user = Sys.getenv("FG_USER"),
    password = Sys.getenv("FG_PW"),
    port = 5001,
    ssl.ca = "~/Documents/skysql_fangraphs-db.pem"
  )

pitcher_stats_q <-
  dbSendQuery(con, "select spmp.PlayerId, ValueW as FIP_WAR, \`RA9-Wins\`, Age, GS, G
              from stats_pitching_master_pfx spmp
join player_info pi on spmp.PlayerId = pi.PlayerId
              where Type = 0
and pi.position like '%P%'")

pitcher_stats <-
  dbFetch(pitcher_stats_q) %>%
  as_tibble() %>%
  mutate(WAR = round((FIP_WAR + `RA9-Wins`) / 2, 1)) %>%
  group_by(PlayerId) %>%
  filter(sum(GS) / sum(G) >= 0.5) %>%
  ungroup() %>%
  dplyr::select(-G, -GS, -FIP_WAR, -`RA9-Wins`)

dbClearResult(pitcher_stats_q)

batter_stats_q <-
  dbSendQuery(con, "select sb.playerid AS PlayerId, ValueW as WAR, Age
from stats_batting sb
         join player_info pi on sb.playerid = pi.PlayerId
where sb.Type = 0
  and pi.Position not like '%P%'")

batter_stats <-
  dbFetch(batter_stats_q) %>%
  as_tibble()

dbClearResult(batter_stats_q)


player_info_q <-
  dbSendQuery(con, "select PlayerId, FirstName, LastName, BirthDate, Debut, LastGame, Position, BISPosition from player_info")

player_info <-
  dbFetch(player_info_q) %>%
  as_tibble() %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(
    last_year = year(ymd(LastGame)),
    debut = year(ymd(Debut)),
    Position = str_extract(Position, "^(P|C|1B|2B|3B|SS|OF|DH)"), # extract primary position from dataset
    birth_year = year(ymd(BirthDate)),
    mean_year = (debut + last_year) / 2
  ) %>%
  dplyr::select(PlayerId, Name, birth_year, debut, last_year, mean_year, Position, BISPosition)

dbClearResult(player_info_q)

# gather fielding data. the main goal is to identify LF, RF, and CF separately
# so they can be compared correctly.
# we have 3 sources of data here:
# 1. detailed FG fielding info from innings compiled in the field
# 2. the Lahman DB
# 3. BIS Positional info
# get all the data from each source, then for each outfielder, examine them
# in descending order of priority for whether the "OF" truly is a LF, RF, or CF

# get ID looukps, used to join FG player info with LahmanDB info

id_q <-
  dbSendQuery(con, "select playerid, refid from playerid_lookup")

ids <-
  dbFetch(id_q) %>%
  as_tibble()

dbClearResult(id_q)

# get career fielding data from detailed FG table. A type of -1 is the full career info at that position. Omit "OF" entries;
# those just total up LF/CF/RF which isn't as usesful as the more detailed positional info.
fielding_q <- dbSendQuery(con, "select PlayerId, Position, Season, G, Inn from stats_fielding where Type = -1 and Position != 'OF'")

fielding_data_raw <-
  dbFetch(fielding_q) %>%
  as_tibble()

dbClearResult(fielding_q)
dbDisconnect(con)

fld <-
  fielding_data_raw %>%
  # omit stat lines that total up all outfield numbers. because we want more detailed positional info
  group_by(PlayerId) %>%
  filter(Inn == max(Inn)) %>%
  dplyr::select(PlayerId, Position)

# take player ID's, add in Lahman fielding data, and more detailed FG dielding data.
# see what we're left with

lahman_fielding_grouped <-
  FieldingOFsplit %>%
  as_tibble() %>%
  group_by(playerID, POS) %>%
  summarize(innings = sum(InnOuts)) %>%
  group_by(playerID) %>%
  filter(innings == max(innings)) %>%
  dplyr::select(refid = playerID, Position = POS)

# merge all 3 sources of positional data in the hopes that one will have a more specific
# designation than "OF"

# order of operations for delineating outfielders: prefer fg detail over lahman over BISposition
positional_info <-
  ids %>%
  left_join(lahman_fielding_grouped, by = "refid") %>%
  left_join(fld, by = c("playerid" = "PlayerId"), suffix = c("_lahman", "_fgdetail")) %>%
  left_join(player_info, by = c("playerid" = "PlayerId")) %>%
  mutate(real_position = case_when(
    Position == "OF" ~ case_when(
      Position_fgdetail %in% c("LF", "RF", "CF") ~ Position_fgdetail,
      Position_lahman %in% c("LF", "RF", "CF") ~ Position_lahman,
      BISPosition %in% c("LF", "RF", "CF") ~ BISPosition,
      TRUE ~ Position
    ),
    TRUE ~ Position
  )) %>%
  dplyr::select(PlayerId = playerid, position = real_position)

# Get list of players in the HOF (who were voted in as players)

hof_url <- "https://www.baseball-reference.com/awards/hof.shtml"

hof_html <- read_html(hof_url) %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table(header = TRUE)

names(hof_html)[3] <- "Years"

hof_players <-
  hof_html %>%
  filter(`Inducted As` == "Player") %>%
  mutate(birth_year = as.numeric(str_extract(Years, "^[0-9]{4}"))) %>%
  dplyr::select(Name, birth_year) %>%
  mutate(
    hof = "elected",
    Name = str_replace_all(Name, c(
      "\\s" = " ", # fix non-breaking spacess
      # align some B-R names to the FG names
      "Cal Ripken Jr." = "Cal Ripken",
      "Henry Aaron" = "Hank Aaron",
      "Old Hoss Radbourn" = "Charley Radbourn",
      "Home Run Baker" = "Frank Baker",
      "Charles Bender" = "Chief Bender",
      "High Pockets Kelly" = "George Kelly"
    )),
    birth_year = case_when(
      Name == "Frankie Frisch" ~ 1898,
      Name == "Phil Rizzuto" ~ 1916,
      TRUE ~ birth_year
    )
  )

player_seasons <-
  pitcher_stats %>%
  inner_join(player_info, by = "PlayerId") %>%
  bind_rows(batter_stats %>% inner_join(player_info, by = "PlayerId"))

# get positional data for HOF'ers inducted as players.
hof_site <- "https://baseballhall.org/discover-more/stories/hall-of-famer-facts/hall-of-famers-by-position"

hof_page <- read_html(hof_site)

hof_positions <-
  hof_page %>% 
  html_elements(".hof-ref-item") %>% 
  html_text2() %>% 
  as_tibble_col() %>%
  filter(!str_detect(value, "Manager|Executive|Umpire")) %>%
  mutate(name = str_trim(str_extract(value, ".*(?=Inducted)")),
         position = case_when(
           str_detect(value, "Pitcher") ~ "P",
           str_detect(value, "Catcher") ~ "C",
           str_detect(value, "1st") ~ "1B",
           str_detect(value, "2nd") ~ "2B",
           str_detect(value, "3rd") ~ "3B",
           str_detect(value, "Shortstop") ~ "SS",
           str_detect(value, "Left Fielder") ~ "LF",
           str_detect(value, "Right Fielder") ~ "RF",
           str_detect(value, "Center Fielder") ~ "CF",
           str_detect(value, "Outfielder") ~ "OF",
           str_detect(value, "Designated Hitter") ~ "DH",
           TRUE ~ NA_character_
         ),
    name = str_replace_all(name, c(
      "\\s" = " ", # fix non-breaking spaces
      # align some names to the FG names
      "Cal Ripken Jr." = "Cal Ripken",
      "Henry Aaron" = "Hank Aaron",
      "Old Hoss Radbourn" = "Charley Radbourn",
      "Home Run Baker" = "Frank Baker",
      "Charles Bender" = "Chief Bender",
      "High Pockets Kelly" = "George Kelly",
      "Tim Raines Sr." = "Tim Raines",
      "é" = "e", # tony perez
      "ñ" = "n",
      "á" = "a",
      "í" = "i"  # pedro martinez, ivan rodriguez
    ))) %>%
  dplyr::select(name, position)

hof_inductees <-
  hof_players %>% 
  inner_join(hof_positions, by=c("Name" = "name"))

```

```{r}

# the most recent season played
current_year <- 2021

# combine batting & pitching WAR for all player-seasons.
# add positional info where we can
# discard players whose position is "OF". there are about 1,200 of them and only 4-5 HOFers; not enough data,
# and no one is classified this way today, so not important.


war_through_age <-
  player_seasons %>%
  dplyr::select(-Position, -BISPosition) %>%
  left_join(hof_inductees, by = c("Name", "birth_year")) %>% # joining by birth year prevents mis-identifying players w/same name
  inner_join(positional_info, by = "PlayerId", suffix=c("_inducted", "_played")) %>%
  replace_na(list(hof = "not_elected")) %>%
  group_by(PlayerId, Name, last_year) %>%
  arrange(Age) %>%
  mutate(
    position = if_else(hof == "elected", position_inducted, position_played), # reconcile position for inductees
    num_seasons = n(),
    cumulative_war = round(cumsum(WAR), 1),
    considered_hof = if_else((last_year <= current_year - 6 & num_seasons >= 10) | Name == "Addie Joss", TRUE, FALSE),
  ) %>%
  ungroup() %>%
  distinct() %>%
  mutate(scandal_type = case_when(
    Name %in% c("Barry Bonds", "Roger Clemens", "Jose Canseco", "Rafael Palmeiro", "Jason Giambi", "Gary Sheffield", "Miguel Tejada", "Nelson Cruz", "Andy Pettite", "Ryan Braun", "Manny Ramirez", "Alex Rodriguez", "Mark McGwire", "Sammy Sosa", "Robinson Cano", "Starling Marte", "Melky Cabrera", "David Ortiz", "Dee Gordon", "Bartolo Colon") ~ "PED's",
    Name %in% c("Joe Jackson", "Eddie Cicotte", "Buck Weaver", "Chick Gandil", "Fred McMullin", "Swede Risberg", "Lefty Williams", "Joe Gedeon", "Pete Rose") ~ "Gambling",
    Name %in% c("Carlos Beltran", "Jose Altuve", "Alex Bregman", "Alex Cora", "Carlos Correa", "George Springer", "Gaylord Perry") ~ "Cheating",
    Name %in% c("Curt Schilling", "Lenny Dykstra") ~ "Misc.",
    Name %in% c("Marcell Ozuna", "Roberto Osuna", "Jose Reyes", "Aroldis Chapman", "Omar Vizquel") ~ "Domestic Violence",
    TRUE ~ "None"
  )) %>%
  dplyr::select(playerid = PlayerId, name = Name, position, last_year, mean_year, scandal_type, age = Age, cumulative_war, considered_hof, hof) %>%
  # force some positions for some inductees. fielding positional data from bb-ref and BB HOF website. need to be more specific for averill as there are 2 guys with his name. really this should be done with player ID's.
  mutate(
    position = case_when(
      name %in% c(
        "Ty Cobb", "Earle Combs", "Edd Roush", "Hack Wilson", "Joe DiMaggio", "Lloyd Waner",
        "Max Carey", "Tris Speaker", "Joe Jackson", "Hugh Duffy"
      ) | (name == "Earl Averill" & position == "OF") | (name == "Billy Hamilton" & position == "OF") ~ "CF",
      name %in% c(
        "Al Simmons", "Chick Hafey", "Ed Delahanty", "Fred Clarke", "Goose Goslin",
        "Jesse Burkett", "Joe Medwick", "Zack Wheat", "Jim O'Rourke", "Joe Kelley", "Heinie Manush", "Jim Rice"
      ) ~ "LF",
      name %in% c(
        "Babe Ruth", "Chuck Klein", "Elmer Flick", "Harry Heilmann", "Harry Hooper",
        "Mel Ott", "Paul Waner", "Ross Youngs", "Sam Crawford", "Sam Rice", "Willie Keeler",
        "Kiki Cuyler", "Sam Thompson", "Tommy McCarthy"
      ) ~ "RF",
      TRUE ~ position
    )
  ) %>%
  filter(position != "OF") %>%
  mutate(hof = factor(hof, levels = c("elected", "not_elected"))) %>%
  distinct() %>%
  filter(!name %in% c("Satchel Paige", "Monte Irvin")) %>% # filter out some Negro Leagues players
  na.omit()
```

exploratory data analysis

```{r, fig.height = 3}
war_through_age %>%
  filter(considered_hof) %>%
  # group_by(age, position, hof) %>%
  # summarize(typical_cume_war = median(cumulative_war, na.rm = TRUE)) %>%
  ggplot(aes(age, cumulative_war, group = hof, color = hof)) +
  geom_point(size = 0.5, alpha = 0.75) +
  facet_wrap(vars(position, scandal_type)) +
  ggtitle("Age vs. Typical WAR Trajectories, by HOF Inclusion Type") +
  labs(y = "Cumulative fWAR")

# number of elected vs. not-elected at each position, by mean year over time.
war_through_age %>%
  filter(last_year < 2016) %>% # only those who've been voted on
  mutate(decade = mean_year - mean_year %% 10) %>%
  distinct(playerid, decade, position, hof) %>%
  count(decade, position, hof) %>%
  ungroup() %>%
  complete(decade, position, hof, fill = list(n = 0)) %>%
  group_by(decade, position) %>%
  mutate(prop = n / sum(n) * 100) %>%
  filter(hof == "elected") %>%
  ggplot(aes(decade, prop)) +
  facet_wrap(vars(position), scales = "free_y") +
  geom_point() +
  geom_path() +
  geom_smooth()

# position doesn't seem to matter too much except for DH (and probably relief pitcher, if I split those out). maybe can remove
```

build and evaluate a classification model using xgboost

```{r}


hof_split <-
  war_through_age %>%
  # train model only on players who have been considered for the HOF
  filter(considered_hof) %>%
  dplyr::select(-playerid, -name, -considered_hof, -last_year) %>%
  initial_split(strata = hof)

hof_train <- training(hof_split)
hof_test <- testing(hof_split)

xgb_spec <-
  boost_tree(
    trees = 150,
    tree_depth = tune(), min_n = tune(),
    loss_reduction = tune(),
    sample_size = tune(), mtry = tune(),
    learn_rate = tune()
  ) %>%
  set_engine("xgboost") %>%
  set_mode("classification")

# TODO: set higher tree depths and mtry's. the accuracy seems to increase with those as higher values.

xgb_grid <- grid_latin_hypercube(
  tree_depth(range = c(6, 32)),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  mtry(range(6, 32)),
  learn_rate(),
  size = 50
)

xgb_recipe <-
  recipe(hof ~ ., data = hof_train) %>%
  step_dummy(position, scandal_type) %>%
  step_smote(hof)

xgb_wf <-
  workflow() %>%
  add_model(xgb_spec) %>%
  add_recipe(xgb_recipe)

# find the optimal values of tuning parameters using 10-fold cross validation
hof_folds <- vfold_cv(hof_train, strata = hof, repeats = 5)

doParallel::registerDoParallel()

xgb_res <- tune_grid(
  xgb_wf,
  resamples = hof_folds,
  grid = xgb_grid,
  control = control_grid(save_pred = TRUE),
  metrics = metric_set(pr_auc)
)

# show how each parameter affects the model performance
xgb_res %>%
  collect_metrics() %>%
  filter(.metric == "pr_auc") %>%
  dplyr::select(mean, mtry:sample_size) %>%
  pivot_longer(mtry:sample_size,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "PR_AUC")

best_auc <- select_best(xgb_res, "pr_auc")

final_xgb <- finalize_workflow(
  xgb_wf,
  best_auc
)

# show the important of each variable
final_xgb %>%
  fit(data = hof_train) %>%
  extract_fit_parsnip() %>%
  vip(num_features = 20) +
  ggtitle("Predictor Importance, HOF Prediction Model")

# fit model to training set and evaluate on test set.
final_res <-
  last_fit(final_xgb, hof_split)

# extract final model and use it to predict MVP's
hof_mdl <- final_res$.workflow[[1]]

# evaluate model using curves & area underneath it

predictions <-
  final_res %>%
  collect_predictions()

# compute area under ROC using class probabilities
area_under_curve <-
  predictions %>%
  pr_auc(truth = hof, .pred_elected) %>%
  dplyr::select(.estimate) %>%
  as.numeric() %>%
  round(2)

# draw  PR Curve using class probabilities
predictions %>%
  pr_curve(truth = hof, .pred_elected) %>%
  ggplot(aes(recall, precision)) +
  geom_path() +
  geom_hline(yintercept = 0.121, size = 1.1, color = "red", lty = "dashed") +
  ggtitle("Precision-Recall Curve, HOF Prediction Model",
    subtitle = glue("Area Under Curve: {area_under_curve}")
  )


predictions %>%
  conf_mat(truth = hof, estimate = .pred_class) %>%
  pluck(1) %>%
  as_tibble() %>%
  ggplot(aes(Prediction, Truth)) + 
  geom_tile(show.legend = FALSE) +
  geom_text(aes(label = n), colour = "white", alpha = 1) +
  ggtitle("Confusion Matrix, HOF Prediction Model")


predictions %>%
  f_meas(truth = hof, estimate = .pred_class)

predictions %>%
  bal_accuracy(truth = hof, estimate = .pred_class)

# find optimal threshold for class predictions
predictions %>%
  threshold_perf(hof, .pred_elected, thresholds = seq(0.1, 1, by = 0.0025)) %>%
  group_by(.metric) %>%
  filter(.estimate == max(.estimate))
```

predict hall of famers

```{r fig.height=3, fig.width=5}

# predict HOF chances for players who meet the following criteria:
# have not been considered for the HOF
# last played in the past 2 years (e.g. likely are still active) OR
# have at least 10 seasons in the majors (they are eligible at some point soon)
# this avoids predicting players like Brandon Webb and Josh Hamilton
# who are retired but didn't play 10 years so aren't eligible and will never be

year_threshold <- 2
num_players <- 10

war_through_age %>%
  add_count(playerid, name = "num_seasons") %>%
  filter(
    position != "OF",
    !considered_hof,
    between(last_year, current_year - year_threshold, current_year) | num_seasons >= 10
  ) %>%
  group_by(playerid) %>%
  filter(age == max(age)) %>%
  ungroup() %>%
  bind_cols(
    predict(hof_mdl, new_data = .),
    predict(hof_mdl, new_data = ., type = "prob")
  ) %>%
  mutate(prob_hof = 100 * (.pred_elected)) %>%
  group_by(position) %>%
  slice_max(n = num_players, order_by = prob_hof) %>%
  ggplot(aes(reorder(name, prob_hof), prob_hof)) +
  geom_col() +
  ylim(0, 100) +
  coord_flip() +
  facet_wrap(vars(position), scales = "free_y") +
  labs(x = "", y = "HOF Probability (%)") +
  geom_hline(yintercept = 21.25, lty = "dashed") +
  ggtitle(glue("Probability of HOF election"), subtitle = "Active or retired but not voted on yet. 21.25% = Predicted Hall of Famer")

ggsave("hof-predictions-final.png", width = 10)
```


```{r}
war_age_data %>%
  inner_join(war_age_data %>%
    filter(!active) %>%
    group_by(playerid) %>%
    arrange(age, .by_group = TRUE) %>%
    filter(row_number() == n()) %>%
    dplyr::select(name, final_war = cumulative_war), by = "name") %>%
  View()
```


other fun: predicting career WAR

need to add final war by player. that is the missing piece. 

```{r}
war_through_age %>%
  group_by(playerid) %>%
  filter(age == max(age)) %>%
  ggplot(aes(cumulative_war)) +
  geom_histogram()

war_age_data <-
  war_through_age %>%
  mutate(active = if_else(last_year < 2020, FALSE, TRUE)) %>%
  ungroup()

# add data point "final_war" to every player. this is what we're going to predict
war_split <-
  war_age_data %>%
  filter(!active) %>%
  inner_join(war_age_data %>%
    filter(!active) %>%
    group_by(playerid) %>%
    arrange(age, .by_group = TRUE) %>%
    filter(row_number() == n()) %>%
    ungroup() %>%
    dplyr::select(name, final_war = cumulative_war), by = "name") %>%
  ungroup() %>%
  dplyr::select(position, mean_year, age, cumulative_war, final_war) %>%
  initial_split(strata = final_war)

war_train <- training(war_split)
war_test <- testing(war_split)

war_spec <-
  boost_tree(
    trees = 150,
    tree_depth = tune(), min_n = tune(),
    loss_reduction = tune(),
    sample_size = tune(), mtry = tune(),
    learn_rate = tune()
  ) %>%
  set_engine("xgboost") %>%
  set_mode("regression")


war_grid <- grid_latin_hypercube(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), war_train),
  learn_rate(),
  size = 50
)

war_recipe <-
  recipe(final_war ~ ., data = war_train) %>%
  step_dummy(position) %>%
  step_BoxCox(cumulative_war)

war_wf <-
  workflow() %>%
  add_model(war_spec) %>%
  add_recipe(war_recipe)

# find the optimal values of tuning parameters using 10-fold cross validation
war_folds <- vfold_cv(war_train, strata = final_war, repeats =)

doParallel::registerDoParallel()

war_res <- tune_grid(
  war_wf,
  resamples = war_folds,
  grid = war_grid
)

# show how each parameter affects the model performance
war_res %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, mtry:sample_size) %>%
  pivot_longer(mtry:sample_size,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "RMSE")

best_war <- select_best(war_res, "rmse")

final_war <- finalize_workflow(
  war_wf,
  best_war
)

# show the important of each variable
final_war %>%
  fit(data = war_train) %>%
  extract_fit_parsnip() %>%
  vip(num_features = 20)

# fit model to training set and evaluate on test set.
war_res <-
  last_fit(final_war, war_split)

# extract final model and use it to predict cumulative WAR
war_mdl <- war_res$.workflow[[1]]

# evaluate model using curves & area underneath it

war_res %>%
  collect_metrics()

war_predictions <-
  war_res %>%
  collect_predictions() %>%
  mutate(residual = .pred - final_war)

war_predictions %>%
  ggplot(aes(final_war, .pred)) +
  geom_point() +
  geom_smooth(method = "lm")

war_predictions %>%
  ggplot(aes(final_war, residual)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "blue")


war_age_data %>%
  filter(last_year == 2021) %>%
  group_by(playerid) %>%
  filter(age == max(age)) %>%
  bind_cols(
    predict(war_mdl, new_data = .)
  ) %>%
  arrange(desc(.pred)) %>%
  dplyr::select(name, position, age, cumulative_war, predicted_final_war = .pred)
```
war through age and MVP shares.

```{r}
shares_url <- "https://www.baseball-reference.com/leaders/mvp_cya.shtml"

shares_html <- read_html(shares_url)

mvp_shares <-
  shares_html %>%
  html_table() %>%
  pluck(1)

cya_shares <-
  shares_html %>%
  html_table() %>%
  pluck(2)

mvp_names <-
  mvp_shares %>%
  mutate(name = str_trim(str_replace_all(`Most Valuable Player`, c(
    "\\*" = "",
    "\\([:digit:] wins\\)" = "",
    "\\(1 win\\)" = ""
  )), side = "both")) %>%
  dplyr::select(name, mvp_shares = `Award Shares`) %>%
  mutate(
    name = str_replace_all(name, "\\s", " "), # fix non-breaking spaces
    name =
      str_replace_all(name, c(
        "Cal Ripken Jr." = "Cal Ripken",
        "Henry Aaron" = "Hank Aaron"
      ))
  )

cya_names <-
  cya_shares %>%
  mutate(name = str_trim(str_replace_all(`Cy Young Award`, c(
    "\\*" = "",
    "\\([:digit:] wins\\)" = "",
    "\\(1 win\\)" = ""
  )), side = "both")) %>%
  dplyr::select(name, cya_shares = `Award Shares`) %>%
  mutate(name = str_replace_all(name, "\\s", " ")) # fix non-breaking spaces

# TODO: there are multiple players names Randy Johnson, Jose Ramirez, Bob Gibson, Chris Carpenter, Pete Rose, Frank Thomas, Joe Morgan, Billy Williams, Boog Powell, earl averill  ...going to have to join by player ID's here!
```

```{r}
war_shares_data <-
  war_through_age %>%
  left_join(cya_names, by = "name") %>%
  left_join(mvp_names, by = "name") %>%
  replace_na(list(
    mvp_shares = 0,
    cya_shares = 0
  )) 

mvp_shares_data <-
  war_shares_data %>%
  group_by(playerid) %>%
  filter(
    age == max(age),
    position != "P",
    mean_year >= 1931
  ) # played most of their career after 1931 when the award was first given

mvp_shares_data %>%
  ggplot(aes(cumulative_war, mvp_shares)) +
  geom_point()


# best position players to have 0 MVP shares
mvp_shares_data %>%
  ungroup() %>%
  filter(mvp_shares == 0) %>%
  arrange(desc(cumulative_war)) %>%
  slice_head(n = 25)

# worst players to receive the highest amount of MVP shares
mvp_shares_data %>%
  ungroup() %>%
  filter(!playerid %in% c(1009178, 1011218, 1012976, 1013976, 15103, 6141, 1000379)) %>% # get rid of 'impostor' players who have the same names as HOF'ers
  mutate(shares_per_war = round(mvp_shares / cumulative_war, 3)) %>%
  dplyr::select(playerid, name, mean_year, cumulative_war, mvp_shares, shares_per_war) %>%
  arrange(shares_per_war, desc(cumulative_war))
```
