```{r}
library(tidyverse)
library(rvest)
library(broom)
library(stringr)
library(RMySQL)
library(lubridate)
library(plotly)
library(glue)
library(styler)
library(ggridges)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)

fg_db <- dplyr::src_mysql(
  dbname = Sys.getenv("FG_DB"),
  host = Sys.getenv("FG_HOST"),
  user = Sys.getenv("FG_USER"),
  password = Sys.getenv("FG_PW")
)


```


```{r}

# get data from FB db. also load spreadsheets that were downloaded from baseball savant. ensure all data types match
swinging_data <-
  fg_db %>%
  tbl("gd_savant_new") %>% 
  select(pitch_type, game_date, pitcher = player_name, pitcher_id = pitcher, batter_mlbam = batter, description, p_throws, balls, strikes, sz_top, sz_bot, plate_x, plate_z, events) %>%
  collect(n=Inf) %>%
  mutate(season_type = "regular") %>%
  bind_rows(read_csv("playoff-pitch-data-2015-16.csv",
                     col_names = TRUE,
                     cols(pitch_type = col_character(),
                          game_date = col_character(),
                          player_name = col_character(),
                          pitcher = col_integer(),
                          batter = col_integer(),
                          description = col_character(),
                          p_throws = col_character(),
                          balls = col_integer(),
                          strikes = col_integer(),
                          sz_top = col_number(),
                          sz_bot = col_number(),
                          plate_x = col_number(),
                          plate_z = col_number(),
                          events = col_character())) %>%
              select(pitch_type, game_date, pitcher = player_name, pitcher_id = pitcher, batter_mlbam = batter, description,
                      p_throws, balls, strikes, sz_top, sz_bot, plate_x, plate_z, events) %>%
              mutate(season_type = "playoff")) %>%
  bind_rows(read_csv("playoff-pitch-data-2017-18-19.csv",
                     col_names = TRUE,
                     cols(pitch_type = col_character(),
                          game_date = col_character(),
                          player_name = col_character(),
                          pitcher = col_integer(),
                          batter = col_integer(),
                          description = col_character(),
                          p_throws = col_character(),
                          balls = col_integer(),
                          strikes = col_integer(),
                          sz_top = col_number(),
                          sz_bot = col_number(),
                          plate_x = col_number(),
                          plate_z = col_number(),
                          events = col_character())) %>%
              select(pitch_type, game_date, pitcher = player_name, pitcher_id = pitcher, batter_mlbam = batter, description,
                      p_throws, balls, strikes, sz_top, sz_bot, plate_x, plate_z, events) %>%
              mutate(season_type = "playoff")) 
  


id_info <- fg_db %>%
  tbl("playerid_lookup") %>%
  dplyr::select(mlbamid, playerid) %>%
  collect(n=Inf)

players <- 
  fg_db %>%
  tbl("player_info") %>%
  dplyr::select(playerid = PlayerId, FirstName, LastName) %>%
  collect(n = Inf) %>%
  unite(player_name, FirstName, LastName, sep = " ")

# create full dataset and add some variables

full_swinging_data <-
  inner_join(swinging_data, id_info, by=c("batter_mlbam" = "mlbamid")) %>%
  inner_join(players, by="playerid") %>%
  select(game_date, pitcher_id, pitcher, batter_id = playerid, batter = player_name, everything()) %>%
  filter(pitch_type %in% c("SL", "CU", "KC")) %>%
  mutate(is_swinging_strike = if_else(description %in% c("swinging_strike", "swinging_strike_blocked"), TRUE, FALSE))

# group & filter data according to the criteria we want

breaking_pitches_threshold <- 10

# compute swinging strike rate for all pitcher-games where the pitcher threw at least 25 breaking pitches
# verducci framed his data as NO swings and misses, but it's easier to understand when framed as just SwStr%
data_grouped <-
  full_swinging_data %>%
  count(game_date, pitcher_id, pitcher, p_throws, is_swinging_strike, season_type, name="num_pitches") %>%
  group_by(game_date, pitcher_id, pitcher, p_throws, season_type) %>%
  mutate(total_breaking_pitches_that_day = sum(num_pitches)) %>%
  ungroup() %>%
  mutate(percentage = num_pitches / total_breaking_pitches_that_day * 100,
         percentage = round(percentage, 1)) %>%
  filter(is_swinging_strike,
         total_breaking_pitches_that_day >= breaking_pitches_threshold)


```

```{r, fig.height=3}

# analysis: all pitchers
data_grouped %>% 
  ggplot(aes(percentage)) + 
  geom_histogram(binwidth = 5)


# show clayton kershaw, 2017
data_grouped %>% 
  filter(pitcher == "Clayton Kershaw",
         str_detect(game_date, "2017")) %>%
  ggplot(aes(percentage)) + 
  geom_histogram(binwidth = 5) +
  ggtitle("Kershaw 2017")

# other good pitchers that year
data_grouped %>% 
  filter(pitcher %in% c("Clayton Kershaw", "Justin Verlander", "Chris Sale", "Max Scherzer", "Jacob deGrom",
                        "Corey Kluber", "Luis Severino", "Stephen Strasburg", "Ervin Santana", "Marcus Stroman",
                        "Zack Greinke"),
         str_detect(game_date, "2017"),
         season_type == "regular") %>%
#  count(pitcher_id, pitcher, p_throws, percentage) %>%
  ggplot(aes(x=percentage, y = pitcher, height = stat(density)), color=pitcher) + 
  geom_density_ridges(stat = "binline", bins = 15, scale = 3, aes(fill=pitcher)) +
  labs(y="", x="Whiff Rate on Breaking Pitches (%)") +
  ggtitle("Whiff Rate on Breaking Pitches", subtitle="Cy Young Contenders, 2017 Regular Season")

```

# show all lefties

# show all pitchers LIKE kershaw (similar arsenal ..? is there anyone?)

# TODO: need to add a 'complete' somewhere

# CAN I CITE VERDUCCI'S ORIGINAL CLAIM? WHERE IS IT??

# kershaw on the date in question
full_swinging_data %>% filter(pitcher == "Clayton Kershaw", game_date == "2017-10-29")

# show take & contact rates for all pitcher-games
data_grouped %>%
  ggplot(aes(percentage, x=1)) + geom_boxplot() +
  expand_limits(y=0) +
  ggtitle("BLAH", subtitle = "2015-2019, at least 25 sliders or curveballs thrown in a game") +
  labs(y="% sliders & curveballs either taken or contacted", x="")

# ... now just kershaw. is this typical for him? 
data_grouped %>%
  filter(pitcher == "Clayton Kershaw") %>%
  ggplot(aes(percentage, x=1)) + geom_boxplot() +
  expand_limits(y=0) +
  ggtitle("BLAH", subtitle = "Kershaw, 2015-2019, at least 25 sliders or curveballs thrown in a game") +
  labs(y="% sliders & curveballs either taken or contacted", x="")

# max scherzer
data_grouped %>%
  filter(pitcher == "Max Scherzer") %>%
  ggplot(aes(percentage, x=1)) + geom_boxplot() +
  expand_limits(y=0) +
  ggtitle("BLAH", subtitle = "Scherzer, 2015-2019, at least 25 sliders or curveballs thrown in a game") +
  labs(y="% sliders & curveballs either taken or contacted", x="")

# chris sale
data_grouped %>%
  filter(pitcher == "Chris Sale") %>%
  ggplot(aes(percentage, x=1)) + geom_boxplot() +
  expand_limits(y=0) +
  ggtitle("BLAH", subtitle = "Sale, 2015-2019, at least 25 sliders or curveballs thrown in a game") +
  labs(y="% sliders & curveballs either taken or contacted", x="")

# JV
data_grouped %>%
  filter(pitcher == "Justin Verlander") %>%
  ggplot(aes(percentage, x=1)) + geom_boxplot() +
  expand_limits(y=0) +
  ggtitle("BLAH", subtitle = "Verlander, 2015-2019, at least 25 sliders or curveballs thrown in a game") +
  labs(y="% sliders & curveballs either taken or contacted", x="")

  
# what about for pitchers of his caliber?  

data_grouped %>%
  top_n(25, percentage) %>%
  arrange(desc(percentage))



# but kershaw has GOOD breaking balls. I don't care if Mike Leake can't get a swing and miss ... but pitchers the caliber of Kershaw???  
  
```

