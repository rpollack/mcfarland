```{r setup, include=FALSE, echo=FALSE}


library(tidyverse)
library(rvest)
library(stringr)
library(plotly)
library(lubridate)
library(RMySQL)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

to get batters: Appelman pulls based on pitchers so that's why player name is pitchers. You have to use batter to join with player info, etc, based on mlbamid

compute spray angle from hc_x and hc_y:
df$angle <- with(df, round(
  (tan(
    (hit_x-125.42)/(198.27-hit_y)
  )*180/pi*.75)
  ,1)
)


```{r}

gd_info <- fg_db %>%
  tbl("gd_roster") %>%
  select(mlbamid, playerid)

fg_info <- fg_db %>%
  tbl("player_info") %>%
  select(PlayerId, FirstName, LastName, BISPosition) %>%
  collect(n=Inf)

k_and_bb <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Season == 2017, 
         Type == 0) %>%
  select(playerid, Season, batter_K_perc = `K%`, batter_BB_perc = `BB%`) %>%
  collect(n=Inf)

savant_data <- fg_db %>%
  tbl("gd_savant") %>%
  #filter(game_year == 2017) %>%
  select(batter, player_name, game_date, game_year, pitch_type, start_speed, events, description, des, tfs_zulu, px, pz, 
         hc_x, hc_y, hit_speed, hit_angle, hit_distance_sc, home_team, away_team, inning_top_bottom) %>%
  inner_join(gd_info, by=c("batter" = "mlbamid")) %>%
  collect(n=Inf)
```

### Clean Data

```{r}

savant_data <- savant_data %>%
  mutate(batting_team = ifelse(inning_top_bottom == "bot", home_team, away_team),
         fielding_team = ifelse(batting_team == away_team, home_team, away_team),
         
         #convert numbers to numeric, leaving 'null' values as NA
         hit_speed = as.numeric(hit_speed),
         hit_distance_sc = as.numeric(hit_distance_sc),
         hit_angle = as.numeric(hit_angle),
         px = as.numeric(px),
         pz = as.numeric(pz))%>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  
  #Add player's first name & spray angle of hit
  mutate(Name = sprintf("%s %s", FirstName, LastName),
         spray_angle = round(tan((hc_x - 125.42)/ (198.27-hc_y)) * 180/pi*.75, 1))
  
```

### compute horizontal and vertical plate coverage for non-pitchers who hit at least 50 balls fair, as well as YoY change
```{r}
plate_coverage <- savant_data %>%
  filter(str_detect(description, "In play")) %>%
  arrange(game_date, tfs_zulu) %>%
  filter(!BISPosition %in% c("", "SP", "RP"),
         pz > 0) %>%    #why does this line remove all 2017 balls?
  select(Name, player_name, everything()) %>%
  group_by(Name, game_year) %>%
  summarize(num_balls_contacted = n(),
            horiz_coverage = round(mad(px), 3),
            vertical_coverage = round(mad(pz), 3)) %>%
  mutate(total_coverage = horiz_coverage * vertical_coverage) %>%
  filter(num_balls_contacted >= 50)

plate_coverage_change <- plate_coverage %>%
  group_by(Name) %>%
  arrange(game_year) %>%
  mutate(horiz_diff = horiz_coverage - lag(horiz_coverage),
         vertical_diff = vertical_coverage - lag(vertical_coverage),
         total_diff = round(horiz_diff + vertical_diff, 3)) %>%
  filter(game_year == 2017)

coverage_change_plot <- ggplot(plate_coverage_change, aes(horiz_diff, vertical_diff, label=Name)) + geom_point() + fgt
ggplotly(coverage_change_plot)

```



### Get fielders' names for plays


```{r}
str1 <- "Kennys Vargas grounds out, third baseman Mike Moustakas to first baseman Eric Hosmer."

#need to get this to where either a "to" or a period can follow.
str_extract(str1, "(?<=third baseman).*(?=to)|(?=\\.)")
#not sure why this works on "to" but not when a period follows (as in str2 below.)

str2 <- "C. J. Cron flies out to center fielder Delino DeShields."

#not sure why this works above for str1 but doesn't work here.
str_extract(str2, "(?<=center fielder).*(?=to)|(?=\\.+)")


str3 <- "Christian Yelich grounds out, second baseman Andres Blanco to first baseman Erik Kratz."
str_extract(str3, "(?<=second baseman | shortstop).*(?=to)|(?=\\.)")


str4 <- "Miguel Rojas pops out to shortstop Freddy Galvis."



str5 <- "Mitch Moreland lines out sharply to center fielder Mike Trout. Shin-Soo Choo to 3rd."
str6 <- "Stephen Piscotty lines out to right fielder Nick Markakis."

#[position][name][to or a period]

```

### who turns hard-hit balls into outs the most often?
# which team turns the highest % of barrels into outs?



### Compute YoY change in mean hit speed of outs.





```{r}


savant_data_plt <- savant_data %>%
  arrange(game_date, tfs_zulu) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  mutate(Name = sprintf("%s %s", FirstName, LastName),
         spray_angle = round(tan((hc_x - 125.42)/ (198.27-hc_y)) * 180/pi*.75, 1)) %>%
  select(Name, everything()) %>%
  inner_join(k_and_bb, by=c("playerid", "game_year" = "Season"))
```

### Compute pitch sequences along with batted-ball results

```{r}
pitch_sequences <- savant_data_plt %>%
  #filter(Name == "Adam Jones") %>%
  group_by(Name, player_name, game_date, des, events) %>%
  arrange(tfs_zulu) %>%
  summarize(pitch_seq = paste0(pitch_type, collapse = " "),
            pa_start = min(tfs_zulu),
            num_pitches = n(),
            hit_speed = min(hit_speed, na.rm = TRUE),
            launch_angle = min(hit_angle, na.rm = TRUE),
            spray_angle = min(spray_angle, na.rm = TRUE)) %>%
  arrange(game_date, pa_start)
```

#For all PAs with at least 3 pitches; what are the most common 3-pitch sequences in them?

next up: split by batter/pitcher handedness (RR, RL, LR, LL), runners on base, etc.

```{r}
num_pitches_in_sequence <- 3

sequences_gt_3_pitches <- pitch_sequences %>%
  filter(num_pitches >= num_pitches_in_sequence)

ng_sequence <- ngram(sequences_gt_3_pitches$pitch_seq, n=num_pitches_in_sequence)
common_pitch_sequences <- get.phrasetable(ng_sequence) %>%
  mutate(prop = round(100 * prop, 1)) %>%
  select(three_pitch_sequence = ngrams, freq, prop)

View(common_pitch_sequences)
```


```{r}

miley_savant_plt <- miley_savant %>%
  mutate(year = year(as.Date(game_date)),
         hit_speed = as.numeric(hit_speed),
         hit_angle = as.numeric(hit_angle)) %>%
  filter(hit_speed >= 0) %>%
  group_by(year) %>%
  summarize(mean_hit_speed = mean(hit_speed, na.rm = TRUE),
            mean_hit_angle = mean(hit_angle, na.rm = TRUE))

```