```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(stringr)
library(plotly)
library(lubridate)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

to get batters: Appelman pulls based on pitchers so that's why player name is pitchers. You have to use batter to join with player info, etc, based on mlbamid

compute spray angle from hc_x and hc_y:
df$angle <- with(df, round(
  (tan(
    (hit_x-125.42)/(198.27-hit_y)
  )*180/pi*.75)
  ,1)
)


```{r}

gd_info <- fg_db %>%
  tbl("gd_roster") %>%
  select(mlbamid, playerid)

fg_info <- fg_db %>%
  tbl("player_info") %>%
  select(PlayerId, FirstName, LastName) %>%
  collect(n=Inf)

k_and_bb <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Season == 2017, 
         Type == 0) %>%
  select(playerid, Season, batter_K_perc = `K%`, batter_BB_perc = `BB%`) %>%
  collect(n=Inf)

savant_data <- fg_db %>%
  tbl("gd_savant") %>%
  filter(game_year == 2017) %>%
  select(batter, player_name, game_date, game_year, pitch_type, events, description, des, tfs_zulu, 
         hc_x, hc_y, hit_speed, hit_angle, hit_distance_sc) %>%
  inner_join(gd_info, by=c("batter" = "mlbamid")) %>%
  collect(n=Inf)
```


```{r}

#need to replace 'null' string with NAs

savant_data_plt <- savant_data %>%
  arrange(game_date, tfs_zulu) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  mutate(Name = sprintf("%s %s", FirstName, LastName),
         spray_angle = round(tan((hc_x - 125.42)/ (198.27-hc_y)) * 180/pi*.75, 1)) %>%
  select(Name, everything()) %>%
  inner_join(k_and_bb, by=c("playerid", "game_year" = "Season"))
```

### Compute pitch sequences along with batted-ball results

```{r}
pitch_sequences <- savant_data_plt %>%
  #filter(Name == "Adam Jones") %>%
  group_by(Name, player_name, game_date, des, events) %>%
  arrange(tfs_zulu) %>%
  summarize(pitch_seq = paste0(pitch_type, collapse = " "),
            pa_start = min(tfs_zulu),
            num_pitches = n(),
            hit_speed = min(hit_speed),
            launch_angle = min(hit_angle),
            spray_angle = min(spray_angle))
  arrange(game_date, pa_start)
```

#For all PAs with at least 3 pitches; what are the most common 3-pitch sequences in them?

```{r}
num_pitches_in_sequence <- 3

sequences_gt_3_pitches <- pitch_sequences %>%
  filter(num_pitches >= num_pitches_in_sequence)

ng_sequence <- ngram(sequences_gt_3_pitches$pitch_seq, n=num_pitches_in_sequence)
common_pitch_sequences <- get.phrasetable(ng_sequence) %>%
  mutate(prop = round(100 * prop, 1)) %>%
  select(three_pitch_sequence = ngrams, freq, prop)

View(common_pitch_sequences)
```

%>% 
  mutate(pitch_number = row_number()) %>%
  select(Batter = Name, game_date, Pitcher = player_name, pitch_seq, pa_result = des, events, pitch_number, description, batter_K_perc, batter_BB_perc, everything())

pitch_sequences

# still not there -- multiple games are happening at once which throws off timing. is there a game_id I can group by? 

```
%>%
  
  select(Name, game_date, pitch_type, events, description, pa_result = des, hit_speed, hit_angle, 
         hc_x, hc_y, hit_distance_sc)
  
```

```{r}

miley_savant_plt <- miley_savant %>%
  mutate(year = year(as.Date(game_date)),
         hit_speed = as.numeric(hit_speed),
         hit_angle = as.numeric(hit_angle)) %>%
  filter(hit_speed >= 0) %>%
  group_by(year) %>%
  summarize(mean_hit_speed = mean(hit_speed, na.rm = TRUE),
            mean_hit_angle = mean(hit_angle, na.rm = TRUE))

```