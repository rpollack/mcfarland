```{r}
library(tidyverse)
library(tidymodels)
library(tidytext)
library(lubridate)
library(vip)
library(glue)
library(themis)
library(rvest)



fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#8e001c"),
  strip.text = element_text(family = "Lato")
)


TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg) {
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}


get_league_voting <- function(df, league, year) {
  # this function takes a tibble of data, scraped from bref, and formats
  # the data according to the league and year being requested
  df %>%
    dplyr::select(player_name = 2, mvp_points = 4) %>%
    filter(row_number() != 1) %>%
    mutate(
      League = league,
      Season = year,
      mvp_points = as.numeric(mvp_points)
    )
}

get_mvp_voting <- function(year) {
  # scrapes baseball reference MVP voting data for the year in question
  # and creates AL and NL voting dataframes with the necessary information
  url <- glue("https://www.baseball-reference.com/awards/awards_{year}.shtml")

  x <-
    url %>%
    read_html() %>%
    html_elements("table") %>%
    html_table()

  al_voting <-
    x %>%
    pluck(1) %>%
    get_league_voting("AL", year)

  nl_voting <-
    x %>%
    pluck(2) %>%
    get_league_voting("NL", year)

  bind_rows(al_voting, nl_voting)
}
```


get, clean, mutate, and join data

```{r, message=FALSE}



year_to_predict <- 2021
year_min <- year_to_predict - 21
year_max <- year_to_predict - 1

con <-
  DBI::dbConnect(RMariaDB::MariaDB(),
    dbname = Sys.getenv("FG_DB"),
    host = Sys.getenv("FG_HOST"),
    user = Sys.getenv("FG_USER"),
    password = Sys.getenv("FG_PW"),
    port = 5001,
    ssl.ca = "~/Documents/skysql_fangraphs-db.pem"
  )

player_info_query <-
  dbSendQuery(con, glue("select pi.PlayerId          as playerid,
       pi.FirstName,
       pi.LastName,
       batting.Season,
       batting.Type,
       batting.AVG             as batting_average,
       batting.PA              as plate_appearances,
       batting.HR              as home_runs,
       batting.RBI             as rbi,
       batting.OPS             as ops,
       batting.SB              as stolen_bases,
       batting.Fielding        as defense,
       batting.G               as games_played,
       batting.ValueW          as WAR,
       st.TeamId,
       st.W / (st.W + st.L) AS team_PCT,
       st.League,
       st.G                 as team_games,
       st.AbbName           as team,
       st.Division
from player_info pi
         inner join stats_batting batting on pi.PlayerId = batting.PlayerId
         left join season_team st on batting.TeamId = st.TeamId AND batting.Season = st.Season
where pi.Position != 'P'
  and batting.Type in (0, 1103)
  and batting.Season >= {year_min}"))

# fetch data, join with list of MVP's, clean up data, and compute ranks
player_data <-
  dbFetch(player_info_query) %>%
  as_tibble() %>%
  unite(player_name, FirstName, LastName, sep = " ") %>%
  mutate(
    League = factor(League),
    is_pitcher = 0,
  ) %>%
  # grab player's steamer projected WAR
  group_by(playerid, player_name) %>%
  arrange(Season, Type, .by_group = TRUE) %>%
  mutate(proj_war = if_else(Type == 0 & Season == year_to_predict, lead(WAR), -1)) %>%
  filter(Type == 0) %>%
  dplyr::select(-Type)

dbClearResult(player_info_query)

# get shohei ohtani's pitching WAR. he's the only player for whom batting and pitching WAR
# will be considered
ohtani_pitching_q <-
  dbSendQuery(con, "select PlayerId as playerid, Season, Type, ValueW as ValueW_p from stats_pitching where PlayerId = 19755 and Type in (0, 1103)")

ohtani_pitching_war <-
  dbFetch(ohtani_pitching_q) %>%
  as_tibble() %>%
  arrange(Season, Type) %>%
  mutate(proj_war_p = if_else(Type == 0 & Season == year_to_predict, lead(ValueW_p), -1)) %>%
  filter(Type == 0) %>%
  dplyr::select(-Type)


dbClearResult(ohtani_pitching_q)


pitcher_query <- dbSendQuery(con, glue("select pi.PlayerId          as playerid,
       pi.FirstName,
       pi.LastName,
       spmp.Season,
       spmp.Type,
       spmp.IP              as innings_pitched,
       spmp.ER              as earned_runs,
       spmp.SO              as strikeouts,
       spmp.ValueW          as WAR,
       st.TeamId,
       st.W / (st.W + st.L) AS team_PCT,
       st.League,
       st.G                 as team_games,
       st.AbbName           as team,
       st.Division
from player_info pi
         inner join stats_pitching spmp on pi.PlayerId = spmp.PlayerId
         left join season_team st on spmp.TeamId = st.TeamId AND spmp.Season = st.Season
where pi.Position = 'P'
  and spmp.Type in (0, 1103)
  and spmp.Season >= {year_min}"))

pitcher_data <-
  dbFetch(pitcher_query) %>%
  as_tibble() %>%
  unite(player_name, FirstName, LastName, sep = " ") %>%
  mutate(
    League = factor(League),
    is_pitcher = 1
  ) %>%
  # grab player's steamer-projected WAR
  group_by(playerid, player_name) %>%
  arrange(Season, Type, .by_group = TRUE) %>%
  mutate(proj_war = if_else(Type == 0 & Season == year_to_predict, lead(WAR), -1)) %>%
  filter(Type == 0) %>%
  dplyr::select(-Type)

dbClearResult(pitcher_query)

dbDisconnect(con)



# get MVP voting data (mvp points player accrued in a year)
# TODO: variableize the sequence of years to 21 years before this one, and 1 before this one
mvp_voting_data <-
  seq(year_min, year_max) %>%
  map_df(get_mvp_voting) %>%
  mutate(player_name = str_replace(player_name, "Ã©", "e"))
# TODO: non-pitcher names to handle: AJ Pollock, Carlos Ruiz, Dee Strange-Gordon

# TODO: fix ohtani. his pitching stats aren't showing up because he's listed as 'DH' in the tables. probably just as (position = P OR playerid = XXXXXX for him.)

player_ranks <-
  player_data %>%
  full_join(ohtani_pitching_war, by = c("Season", "playerid")) %>%
  # compute batting + pitching WAR totals for ohtani
  mutate(
    WAR = if_else(is.na(ValueW_p), WAR, WAR + ValueW_p),
    proj_war = if_else(is.na(proj_war_p), proj_war, proj_war + proj_war_p)
  ) %>%
  dplyr::select(-ValueW_p) %>%
  bind_rows(pitcher_data) %>%
  filter(
    !is.na(TeamId), # remove guys who changed teams in a year
    !is.na(proj_war)
  ) %>%
  # remove guys without Steamer projections, this causes data errors
  group_by(Season, League) %>%
  # compute player's season-league ranking in major stats, where a rank of 1 indicates first place/league-leading.
  mutate(
    league_ops_rank = min_rank(-ops),
    league_hr_rank = min_rank(-home_runs),
    league_war_rank = min_rank(-WAR),
    league_sb_rank = min_rank(-stolen_bases),
    league_avg_rank = min_rank(-batting_average),
    league_rbi_rank = min_rank(-rbi),

    # for past seasons, use actual WAR rank. for current season, use projected EOY WAR rank
    league_war_rank = if_else(Season == year_to_predict, min_rank(-proj_war), min_rank(-WAR)),
    league_ip_rank = min_rank(-innings_pitched),
    league_earned_runs_rank = min_rank(earned_runs),
    league_k_rank = min_rank(-strikeouts)
  )

# compute where each team finished in its division for the year
season_team_ranks <-
  player_ranks %>%
  distinct(Season, League, Division, TeamId, team, team_PCT) %>%
  group_by(Season, League, Division) %>%
  mutate(team_division_rank = min_rank(-team_PCT))

master_df <-
  player_ranks %>%
  inner_join(season_team_ranks, by = c("Season", "TeamId", "team", "League", "Division", "team_PCT")) %>%
  full_join(mvp_voting_data) %>%
  replace_na(list(league_ops_rank = 0, league_hr_rank = 0, league_sb_rank = 0, league_avg_rank = 0, league_rbi_rank = 0, league_ip_rank = 0, league_k_rank = 0, mvp_points = 0)) %>%
  # filter(!is.na(playerid)) %>%
  dplyr::select(playerid, player_name, is_pitcher, Season, League, team, contains("rank"), mvp_points) %>%
  ungroup()
```


```{r}


# split model into training and testing sets. in doing this, use only data from years past,
# not from the year we're trying to predict.
mvp_split <-
  master_df %>%
  filter(Season != year_to_predict) %>%
  dplyr::select(is_pitcher, contains("rank"), mvp_points) %>%
  initial_split(strata = mvp_points)

mvp_train <- training(mvp_split)
mvp_test <- testing(mvp_split)

# adapted from https://juliasilge.com/blog/tidymodels-ml-course/

xgb_spec <-
  boost_tree(
    trees = 300,
    tree_depth = tune(), min_n = tune(),
    loss_reduction = tune(),
    sample_size = tune(), mtry = tune(),
    learn_rate = tune()
  ) %>%
  set_engine("xgboost") %>%
  set_mode("regression")

xgb_grid <- grid_latin_hypercube(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), mvp_train),
  learn_rate(),
  size = 50
)

xgb_recipe <-
  recipe(mvp_points ~ ., data = mvp_train)

xgb_wf <-
  workflow() %>%
  add_model(xgb_spec) %>%
  add_recipe(xgb_recipe)

# find the optimal values of tuning parameters using 10-fold cross validation
mvp_folds <- vfold_cv(mvp_train, strata = mvp_points)

doParallel::registerDoParallel()

xgb_res <- tune_grid(
  xgb_wf,
  resamples = mvp_folds,
  grid = xgb_grid,
  control = control_grid(save_pred = TRUE)
)

# show how each parameter affects the RMSE
xgb_res %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, mtry:sample_size) %>%
  pivot_longer(mtry:sample_size,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "RMSE")

best_rmse <- select_best(xgb_res, "rmse")

final_xgb <- finalize_workflow(
  xgb_wf,
  best_rmse
)

# show the important of each variable
final_xgb %>%
  fit(data = mvp_train) %>%
  pull_workflow_fit() %>%
  vip(geom = "point")

# fit model to training set and evaluate on test set.
final_res <-
  last_fit(final_xgb, mvp_split)

final_metrics <-
  collect_metrics(final_res)

# show metrics from test set evaluation
final_metrics

# extract final model and use it to predict MVP's
mvp_mdl <- final_res$.workflow[[1]]
```

```{r}
mvp_predictions <-
  master_df %>%
  filter(Season == year_to_predict) %>%
  bind_cols(predict(mvp_mdl, new_data = .))


mvp_predictions %>%
  group_by(League) %>%
  slice_max(n = 10, order_by = .pred) %>%
  ggplot(aes(reorder(player_name, .pred), .pred)) +
  geom_col() +
  coord_flip() +
  facet_wrap(vars(League), scales = "free_y") +
  labs(x = "", y = "Predicted MVP Points") +
  ggtitle(glue("Predicted MVP Voting, {year_to_predict}"),
    subtitle = glue("Based on stats through {Sys.Date()-days(1)}, current division standings, 
                    and projected Steamer full-season WAR")
  )
```

```{r}
analysis <-
  master_df %>%
  filter(Season != current_year) %>%
  bind_cols(predict(mvp_mdl, new_data = .)) %>%
  mutate(residual = .pred - mvp_points)

analysis %>%
  ggplot(aes(mvp_points, .pred)) +
  geom_point() +
  geom_smooth(method = "lm")

analysis %>%
  ggplot(aes(.pred, residual)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "blue")

# find biggest MVP snubs, according to the model
analysis %>%
  # remove actual MVP's
  group_by(Season, League) %>%
  filter(mvp_points != max(mvp_points)) %>%
  group_by(League) %>%
  slice_max(n = 10, order_by = residual) %>%
  unite(label, player_name, Season, sep = ", ") %>%
  ggplot(aes(reorder(label, residual), residual)) +
  facet_wrap(vars(League), scales = "free_y") +
  geom_col() +
  coord_flip() +
  labs(x = "", y = "Predicted MVP Points minus Actual MVP Points") +
  ggtitle("Biggest MVP Snubs, 2000-2020", subtitle = "Players who did worse than expected in MVP voting (excluding actual MVP's)")

# biggest MVP surprises!
analysis %>%
  group_by(Season, League) %>%
  mutate(player_name = if_else(mvp_points == max(mvp_points), glue("{player_name}*"), player_name)) %>%
  group_by(League) %>%
  slice_max(n = 10, order_by = -residual) %>%
  unite(label, player_name, Season, sep = ", ") %>%
  ggplot(aes(reorder(label, -residual), residual)) +
  facet_wrap(vars(League), scales = "free_y") +
  geom_col() +
  coord_flip() +
  labs(
    x = "", y = "Predicted MVP Points minus Actual MVP Points",
    caption = "* Won MVP"
  ) +
  ggtitle("Biggest MVP Surprises, 2000-2020", subtitle = "Players who did better than expected in MVP voting (including actual MVP's)")
```
