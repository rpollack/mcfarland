```{r}
library(tidyverse)
library(tidymodels)
library(lubridate)
library(vip)



fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#8e001c"),
  strip.text = element_text(family = "Lato")
)


TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg) {
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}


get_league_voting <- function(df, league, year) {
  # this function takes a tibble of data, scraped from bref, and formats
  # the data according to the league and year being requested
  df %>%
    select(player_name = 2, mvp_points = 4) %>%
    filter(row_number() != 1) %>%
    mutate(
      League = league,
      Season = year,
      mvp_points = as.numeric(mvp_points)
    )
}

get_mvp_voting <- function(year) {
  # scrapes baseball reference MVP voting data for the year in question
  # and creates AL and NL voting dataframes with the necessary information
  url <- glue("https://www.baseball-reference.com/awards/awards_{year}.shtml")

  x <-
    url %>%
    read_html() %>%
    html_elements("table") %>%
    html_table()

  al_voting <-
    x %>%
    pluck(1) %>%
    get_league_voting("AL", year)

  nl_voting <-
    x %>%
    pluck(2) %>%
    get_league_voting("NL", year)
  
  bind_rows(al_voting, nl_voting)
}



```


get, clean, mutate, and join data

```{r, message=FALSE}



year_to_predict <- 2020
data_min <- year_to_predict - 16
data_max <- year_to_predict - 1

con <-
  DBI::dbConnect(RMariaDB::MariaDB(),
    dbname = Sys.getenv("FG_DB"),
    host = Sys.getenv("FG_HOST"),
    user = Sys.getenv("FG_USER"),
    password = Sys.getenv("FG_PW"),
    port = 5001,
    ssl.ca = "~/Documents/skysql_fangraphs-db.pem"
  )

player_info_query <-
  dbSendQuery(con, "select pi.PlayerId as playerid, pi.FirstName, pi.LastName, sbmp.Season, sbmp.AVG as batting_average, sbmp.PA as plate_appearances,
  sbmp.HR as home_runs, sbmp.RBI as rbi, sbmp.OPS as ops, sbmp.SB as stolen_bases, sbmp.Fielding as defense, sbmp.G as games_played, sbmp.ValueW as WAR,
  st.TeamId, st.W / (st.W + st.L) AS team_PCT, st.League, st.G as team_games, st.AbbName as team, st.Division
  from player_info pi
  inner join stats_batting_master_pfx sbmp on pi.PlayerId = sbmp.PlayerId
  inner join season_team st on sbmp.TeamId = st.TeamId AND sbmp.Season = st.Season
  where pi.Position != \'P\'
  and sbmp.Type = 0")

# fetch data, join with list of MVP's, clean up data, and compute ranks
player_data <-
  dbFetch(player_info_query) %>%
  as_tibble() %>%
  unite(player_name, FirstName, LastName, sep = " ") %>%
  mutate(League = factor(League)) %>%
  full_join(read_csv("mlb season awards - MVPs.csv") %>%
    mutate(
      player_name = str_replace_all(
        player_name,
        c(
          "Cal Ripken, Jr." = "Cal Ripken",
          "Ken Griffey, Jr." = "Ken Griffey Jr."
        )
      ),
      player_name = if_else(Season %in% c(1996, 1998) & League == "AL", "Juan Gonzalez",
        if_else(Season == 1999 & League == "AL", "Ivan Rodriguez",
          if_else(Season == 2017 & League == "AL", "Jose Altuve",
            player_name
          )
        )
      ),
      League = factor(League),
      is_mvp = 1
    ), by = c("Season", "player_name", "League")) %>%
  replace_na(list(is_mvp = 0))

dbClearResult(player_info_query)

dbDisconnect(con)

# compute where each team finished in its division for the year
season_team_ranks <-
  player_data %>%
  distinct(Season, League, Division, TeamId, team, team_PCT) %>%
  group_by(Season, League, Division) %>%
  mutate(team_division_rank = min_rank(-team_PCT))

# get MVP voting data (mvp points player accrued in a year)
# TODO: variableize the sequence of years to 21 years before this one, and 1 before this one
mvp_voting_data <-
  seq(2000, 2020) %>%
  map_df(get_mvp_voting) %>%
  mutate(player_name = str_replace(player_name, "Ã©", "e"))
# TODO: non-pitcher names to handle: AJ Pollock, Carlos Ruiz, Dee Strange-Gordon 
# TODO handle pitchers in MVP dataset but not in master_df


master_df <-
  inner_join(player_data, season_team_ranks, by = c("Season", "TeamId", "team", "League", "Division", "team_PCT")) %>%
  # prevent small-sample rate stats from leading the league. 2.93 PA/Game is the fewest any MVP ever had -- Stargell, 1979
  filter(plate_appearances >= 2.93 * (team_games)) %>%
  group_by(Season, League) %>%
  # compute player's season-league ranking in major stats, where a rank of 1 indicates first place/league-leading.
  mutate(
    league_ops_rank = min_rank(-ops),
    league_hr_rank = min_rank(-home_runs),
    league_war_rank = min_rank(-WAR),
    league_sb_rank = min_rank(-stolen_bases),
    league_avg_rank = min_rank(-batting_average),
    league_rbi_rank = min_rank(-rbi),
    is_mvp = factor(is_mvp, levels = c("1", "0"))
  ) %>%
  ungroup() %>%
  full_join(mvp_voting_data) %>%
  filter(Season >= 2000) %>%
  replace_na(list(mvp_points = 0)) %>%
  dplyr::select(playerid, player_name, Season, League, team, contains("rank"), mvp_points)

```


do some exploratory data analysis. 

```{r}
master_df %>%
  ggplot(aes(league_war_rank, mvp_points, color = Season)) +
  geom_point() +
  facet_wrap(vars(League))
```


```{r}

year_to_predict == year(Sys.Date())

mvp_split <-
  master_df %>%
  # train model only on players who have been considered for the HOF
  filter(Season != year_to_predict) %>%
  dplyr::select(-playerid, -player_name, -team, -League, -Season) %>%
  initial_split(strata = mvp_points)

mvp_train <- training(mvp_split)
mvp_test <- testing(mvp_split)

# adapted from https://juliasilge.com/blog/tidymodels-ml-course/

xgb_spec <-
  boost_tree(
    trees = 300,
    tree_depth = tune(), min_n = tune(),
    loss_reduction = tune(), ## first three: model complexity
    sample_size = tune(), mtry = tune(), ## randomness
    learn_rate = tune(), ## step size
  ) %>%
  set_engine("xgboost") %>%
  set_mode("regression")

xgb_grid <- grid_latin_hypercube(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), mvp_train),
  learn_rate(),
  size = 50
)

xgb_wf <- workflow() %>%
  add_formula(mvp_points ~ .) %>%
  add_model(xgb_spec)

mvp_folds <- vfold_cv(mvp_train, strata = mvp_points)

doParallel::registerDoParallel()

# find the optimal values of tuning parameters usiing 10-fold cross validation
xgb_res <- tune_grid(
  xgb_wf,
  resamples = mvp_folds,
  grid = xgb_grid,
  control = control_grid(save_pred = TRUE)
)

# show how each parameter affects the RMSE
xgb_res %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  dplyr::select(mean, mtry:sample_size) %>%
  pivot_longer(mtry:sample_size,
    values_to = "value",
    names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "RMSE")

best_rmse <- select_best(xgb_res, "rmse")

final_xgb <- finalize_workflow(
  xgb_wf,
  best_rmse
)

# show the important of each variable
final_xgb %>%
  fit(data = mvp_train) %>%
  pull_workflow_fit() %>%
  vip(geom = "point")

final_res <- last_fit(final_xgb, mvp_split)

collect_metrics(final_res)

# final_res %>%
#   collect_predictions() %>%
#   mutate(pred_mvp = if_else(.pred_class == 0, 0, 1)) %>%
#   roc_curve(is_mvp, pred_mvp) %>%
#   ggplot(aes(x = 1 - specificity, y = sensitivity)) +
#   geom_line(size = 1.5, color = "midnightblue") +
#   geom_abline(
#     lty = 2, alpha = 0.5,
#     color = "gray50",
#     size = 1.2
#   )

# fit the final model and predict this year's MVP's

# evaluate the model on the test set
mvp_mdl <-
  final_xgb %>%
  fit(data = mvp_train)

glue("Model RMSE: {final_res %>% collect_metrics() %>% filter(.metric == \"rmse\") %>%
     select(.estimate) %>% as.numeric() %>% round(1)} points")

# fit the final model and predict MVP's
master_df %>%
  filter(Season == current_year) %>%
  bind_cols(predict(mvp_mdl, new_data = .)) %>%
  group_by(League) %>%
  slice_max(n = 10, order_by = .pred) %>%
  ggplot(aes(reorder(player_name, .pred), .pred)) +
  geom_col() +
  coord_flip() +
  facet_wrap(vars(League), scales = "free_y") +
  labs(x="", y ="Predicted MVP Points")

# at this point can I just use predict() on the 2021 data??
```



```{r}


# compute total games playes in field as well as primary position. the former will be used to
# identify DH's
fielding_info <- fg_db %>%
  tbl("stats_fielding") %>%
  filter(
    Season >= data_min,
    Season <= year_to_predict,
    Position != "OF", # omit these rows; they're totals of distinct LF/CF/RF playing time
    Position != "P",
    Type == 0
  ) %>%
  dplyr::select(Season, playerid = PlayerId, Position, innings = Inn, G) %>%
  collect(n = Inf) %>%
  group_by(Season, playerid) %>%
  mutate(games_in_field = sum(G)) %>%
  arrange(desc(innings)) %>%
  filter(row_number() == 1) %>%
  dplyr::select(Season, playerid, Position, games_in_field)
```



for informational purposes, show the kind of data the model is trained on

```{r}

master_df %>%
  filter(Season != year_to_predict) %>%
  mutate(team_PCT = round(team_PCT, 3)) %>%
  dplyr::select(
    Player = player_name, League, Season, Position, `Team Winning Percentage` = team_PCT,
    `RBI Rank` = rbi_rank_league, `OPS Rank` = ops_rank_league, `SB Rank` = sb_rank_league,
    `AVG Rank` = avg_rank_league, `HR Rank` = hr_rank_league, `WAR Rank` = war_rank_league,
    `DEF Rank` = defense_rank_league
  ) %>%
  sample_n(5) %>%
  write_csv("mvp_predictor_informational.csv")
```
