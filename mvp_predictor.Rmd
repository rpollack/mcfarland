```{r}
library(tidyverse)
library(RMySQL)
library(lubridate)
library(xgboost)
library(caret)
library(twilio)
library(pROC)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#8e001c"),
  strip.text = element_text(family="Lato")
)

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                          host = Sys.getenv("FG_HOST"), 
                          user = Sys.getenv("FG_USER"),
                          password = Sys.getenv("FG_PW"))

TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg){
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}


```

get, clean, mutate, and join data

```{r, message=FALSE}
player_info <- fg_db %>%
  tbl("player_info") %>%
  filter(Position != "P") %>% #TODO: add pitchers in later
  dplyr::select(playerid = PlayerId, FirstName, LastName) %>%
  collect(n=Inf) %>%
  unite(player_name, FirstName, LastName, sep = " ")

team_info <- fg_db %>%
  tbl("season_team") %>%
  filter(Season >= 1931) %>%   
  select(teamid = TeamId, Season, League, team_games = G, team_wins = W, team_losses = L) %>%
  collect(n=Inf) %>%
  mutate(team_PCT = team_wins / (team_wins + team_losses),
         League = factor(League)) %>%
  select(-team_wins, -team_losses)

player_stats <- fg_db %>%
  tbl("stats_batting_master_pfx") %>%
  filter(Type == 0,
         Season >= 1931) %>%
  select(playerid, Season, teamid, batting_average = AVG, plate_appearances = PA,
         home_runs = HR, rbi = RBI, ops = OPS, stolen_bases = SB, defense = Fielding, games_played = G,
         WAR = ValueW) %>%
  collect(n=Inf) %>%
  inner_join(player_info, by="playerid") %>%
  select(playerid, player_name, everything())

# compute total games playes in field as well as primary position. the former will be used to
# identify DH's
fielding_info <- fg_db %>%
  tbl("stats_fielding") %>%
  filter(Season >= 1931,
         Position != "OF",      # omit these rows; they're totals of distinct LF/CF/RF playing time
         Position != "P",
         Type == 0) %>%  
  select(Season, playerid = PlayerId, Position, innings = Inn, G) %>%
  collect(n=Inf) %>%
  group_by(Season, playerid) %>% 
  mutate(games_in_field = sum(G)) %>%
  arrange(desc(innings)) %>%
  filter(row_number() == 1) %>%
  select(Season, playerid, Position, games_in_field)



# read in list of MVP's. this is from wikipedia so need to clean up some of the names to match FanGraphs
# the if_else lines deal with players with accented characters in their names
# also mark each player as mvp for when we join this DF to the main stats DF later
mvp_list <- read_csv("mlb season awards - MVP's.csv") %>% 
  mutate(player_name = str_replace_all(player_name,
                                       c("Cal Ripken, Jr." = "Cal Ripken",
                                         "Ken Griffey, Jr." = "Ken Griffey Jr.")),
         player_name = if_else(Season %in% c(1996, 1998) & League == "AL", "Juan Gonzalez",
                               if_else(Season == 1999 & League == "AL", "Ivan Rodriguez",
                                       if_else(Season == 2017 & League == "AL", "Jose Altuve",
                                               player_name))),
         League = factor(League),
         is_mvp = "Yes")

master_df <- inner_join(player_stats, team_info, by=c("Season", "teamid")) %>%
  inner_join(fielding_info, by=c("playerid", "Season")) %>%
  full_join(mvp_list, by=c("Season", "player_name", "League")) %>%
  replace_na(list(is_mvp = "No")) %>%
  filter(plate_appearances >= 2.93 * (team_games))  %>% # fewest PA/game who won the MVP was Stargell in 1979
  group_by(Season, League) %>%    
  arrange(desc(ops)) %>%   
  mutate(ops_rank_league = row_number()) %>%
  arrange(desc(home_runs)) %>%
  mutate(hr_rank_league = row_number()) %>%
  arrange(desc(rbi)) %>%
  mutate(rbi_rank_league = row_number()) %>%
  arrange(desc(batting_average)) %>%
  mutate(avg_rank_league = row_number()) %>%
  arrange(desc(stolen_bases)) %>%
  mutate(sb_rank_league = row_number()) %>%
  arrange(desc(defense)) %>%
  mutate(defense_rank_league = row_number()) %>%
  arrange(desc(WAR)) %>%
  mutate(war_rank_league = row_number()) %>%
  ungroup() %>%
  mutate(Position = if_else(games_in_field <= .5 * games_played, "DH", Position)) %>%
  select(-plate_appearances)

```

```{r, message=FALSE}


set.seed(6)

# best seed so far: 4

# remove informational paramters i don't want the model to look at
# cross-validate model on data from 2017 and prior so we can apply it to 2018 data
train_df <- master_df %>%
  filter(Season != 2018,
         Season >= 2007) %>% # train & test on data prior to 2018
  select(-playerid, -player_name, -teamid, -team_games, -ops, -home_runs, -rbi, -stolen_bases, -batting_average,
         -defense, -games_played, -games_in_field, -WAR)

control_parameters <- trainControl(method = "cv",
                                   number = 10,
                                   search = "grid",
                                   allowParallel = TRUE,
                                   classProbs = TRUE,
                                   summaryFunction = twoClassSummary)

parameter_grid <- expand.grid(
  nrounds = c(50, 100, 150), 
  eta = c(0, .01, 0.1),
  max_depth = c(5, 10, 15, 20),
  gamma = c(0, 1, 2, 5),
  colsample_bytree = c(0.1, 0.5, 0.9),
  min_child_weight = c(0, 0.1),
  subsample = c(0.1, 0.2, 0.5, 0.7))

mvp_predictor <- train(is_mvp ~ .,
                       data = train_df, 
                       method = "xgbTree", 
                       trControl = control_parameters,
                       tuneGrid = parameter_grid,
                       metric = "ROC")

send_message(sprintf("MVP predictor model is finished training!"))


```

augment train data with predictions from model and evaluate

```{r}
master_with_predictions <-
  master_df %>% 
  filter(Season >= 2007,
         Season < 2018) %>%
  mutate(pred_mvp = predict(mvp_predictor, newdata = ., type="raw"),
         is_mvp = factor(is_mvp, levels = c("Yes", "No")),
         pred_mvp = factor(pred_mvp, levels=c("Yes", "No")))

confusionMatrix(master_with_predictions$is_mvp, 
                master_with_predictions$pred_mvp,
                mode = "everything")

roc(master_with_predictions$is_mvp, 
                as.numeric(master_with_predictions$pred_mvp))


# AUC = 0.775. This is the probability that a random positive example will be ranked above a random negative example.

```

```{r, message=FALSE}

season_to_test <- 2018

predict_df <- master_df %>%
  filter(Season == season_to_test) %>%
  select(-playerid, -player_name, -teamid, -team_games, -ops, -home_runs, -rbi, -batting_average, -is_mvp,
         -defense, -games_played, -games_in_field)

mvp_predictions <- predict(mvp_predictor, newdata = predict_df, type ="prob") %>%
  mutate(prob_mvp = round(100 * Yes, 2)) %>%
  as_tibble() %>%
  select(prob_mvp) %>%
  bind_cols(predict_df) %>%
  inner_join(master_df) %>%
  select(playerid, player_name, League, prob_mvp, everything()) %>%
  select(-is_mvp) %>%
  arrange(desc(prob_mvp))

# plot variable importance
bind_cols(row.names(varImp(mvp_predictor)$importance) %>% 
            as_tibble(), 
          varImp(mvp_predictor)$importance %>% 
            as_tibble()) %>%
  filter(value != "PositionP") %>% # spurious data %>%
  mutate(value = str_replace_all(value,
                                 c("team_PCT" = "Team Winning Percentage",
                                   "rbi_rank_league" = "RBI Rank",
                                   "ops_rank_league" = "OPS Rank",
                                   "sb_rank_league" = "SB Rank",
                                   "avg_rank_league" = "AVG Rank",
                                   "hr_rank_league" = "HR Rank",
                                   "PositionCF" = "Is Center Fielder?",
                                   "PositionLF" = "Is Left Fielder?",
                                   "PositionRF" = "Is Right Fielder?",
                                   "PositionC" = "Is Catcher?",
                                   "Position2B" = "Is Second Baseman?",
                                   "PositionSS" = "Is Shortstop?",
                                   "PositionDH" = "Is Designated Hitter?",
                                   "Position3B" = "Is Third Baseman?",
                                   "pa_rank_league" = "PA Rank",
                                   "defense_rank_league" = "DEF Rank",
                                   "LeagueNL" = "Is National League?",
                                   "war_rank_league" = "WAR Rank"))) %>%
  ggplot(aes(reorder(value, Overall), Overall)) + geom_col() + coord_flip() + fgt +
  labs(x="", y="Relative Importance") + ggtitle("What Factors are Important in MVP Voting? (2007 - 2017)")

# top 10 contenders in each league
mvp_predictions %>%
  group_by(League) %>%
  filter(row_number() <= 10) %>%
  ggplot(aes(reorder(player_name, prob_mvp), prob_mvp)) + geom_col() + coord_flip() + 
  facet_wrap(~League, scales = "free") + fgt + labs(x="", y="Probability of Season Winning the MVP (%)") +
  ggtitle(sprintf("Top 10 %s Player-Seasons with the Highest MVP Probabilities", season_to_test))

# these probabilities don't sum to 1 because they're framed as being focused on individual players. the question I'm answering here is not "who will win the MVP?" but "if a player had a season like this, what's the probability that player will win the MVP?"


```

```{r, fig.height = 20, fig.width = 10}

informational_df <-
  mvp_predictions %>%
  group_by(League) %>%
  filter(row_number() <= 10) %>%
  ungroup() %>%
  left_join(master_df, by=c("player_name", "Season", "League")) %>%
  select(player_name, League, Season, Position = Position.x, `Team Winning Percentage` = team_PCT.x,
         `RBI Rank` = rbi_rank_league.x, `OPS Rank` = ops_rank_league.x, `SB Rank` = sb_rank_league.x,
         `AVG Rank` = avg_rank_league.x, `HR Rank` = hr_rank_league.x,
         prob_mvp) %>%
  gather(metric, value, -player_name, -League, -Season, -Position) 

ggplot(informational_df, aes(metric, value)) + 
  geom_col() +
  facet_grid(rows = vars(player_name), cols = vars(League), scales = "free")

```