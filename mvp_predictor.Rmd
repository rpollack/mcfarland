```{r}
library(tidyverse)
library(RMySQL)
library(lubridate)
library(xgboost)
library(caret)
library(twilio)
library(pROC)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
)

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                          host = Sys.getenv("FG_HOST"), 
                          user = Sys.getenv("FG_USER"),
                          password = Sys.getenv("FG_PW"))

TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg){
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}


```

get, clean, mutate, and join data

```{r}
player_info <- fg_db %>%
  tbl("player_info") %>%
  filter(Position != "P") %>% #TODO: add pitchers in later
  dplyr::select(playerid = PlayerId, FirstName, LastName, Position) %>%
  collect(n=Inf) %>%
  unite(player_name, FirstName, LastName, sep = " ") %>%
  mutate(Position = str_extract(Position, "^(P|C|1B|2B|3B|SS|OF|DH)"), #use first position listed to avoid split positions
         Position = factor(Position)) %>%
  filter(Position != "P")  # Hal Jeffcoat sneaks in there via this method of getting positions

team_info <- fg_db %>%
  tbl("season_team") %>%
  filter(Season >= 1931) %>%   
  select(teamid = TeamId, Season, League, team_games = G, team_wins = W, team_losses = L) %>%
  collect(n=Inf) %>%
  mutate(team_PCT = team_wins / (team_wins + team_losses),
         League = factor(League)) %>%
  select(-team_wins, -team_losses)

player_stats <- fg_db %>%
  tbl("stats_batting_master_pfx") %>%
  filter(Type == 0,
         Season >= 1931) %>%
  select(playerid, Season, teamid, plate_appearances = PA, batting_average = AVG, 
         home_runs = HR, rbi = RBI, ops = OPS, stolen_bases = SB, defense = Fielding) %>%
  collect(n=Inf) %>%
  inner_join(player_info, by="playerid") %>%
  select(playerid, player_name, everything())

# read in list of MVP's. this is from wikipedia so need to clean up some of the names to match FanGraphs
# the if_else lines deal with players with accented characters in their names
# also mark each player as mvp for when we join this DF to the main stats DF later
mvp_list <- read_csv("mlb season awards - MVP's.csv") %>% 
  mutate(player_name = str_replace_all(player_name,
                                       c("Cal Ripken, Jr." = "Cal Ripken",
                                         "Ken Griffey, Jr." = "Ken Griffey Jr.")),
         player_name = if_else(Season %in% c(1996, 1998) & League == "AL", "Juan Gonzalez",
                               if_else(Season == 1999 & League == "AL", "Ivan Rodriguez",
                                       if_else(Season == 2017 & League == "AL", "Jose Altuve",
                                               player_name))),
         League = factor(League),
         is_mvp = "Yes")

master_df <- inner_join(player_stats, team_info, by=c("Season", "teamid")) %>%
  full_join(mvp_list, by=c("Season", "player_name", "League")) %>%
  replace_na(list(is_mvp = "No")) %>%
  filter(plate_appearances >= 2.93 * (team_games))  %>% # fewest PA/game who won the MVP was Stargell in 1979
  group_by(Season, League) %>%    
  arrange(desc(ops)) %>%   
  mutate(ops_rank_league = row_number()) %>%
  arrange(desc(home_runs)) %>%
  mutate(hr_rank_league = row_number()) %>%
  arrange(desc(rbi)) %>%
  mutate(rbi_rank_league = row_number()) %>%
  arrange(desc(batting_average)) %>%
  mutate(avg_rank_league = row_number()) %>%
  arrange(desc(stolen_bases)) %>%
  mutate(sb_rank_league = row_number()) %>%
  arrange(desc(defense)) %>%
  mutate(defense_rank_league = row_number()) %>%
  arrange(desc(plate_appearances)) %>%
  mutate(pa_rank_league = row_number()) %>%
  ungroup()

```

```{r}

# TODO: put in primary position based on fielding stats that year. having the split 1B/DH position isn't helpful
# because most split positions go together

set.seed(4)

# best seed so far: 4

# remove informational paramters i don't want the model to look at
# cross-validate model on data from 2017 and prior so we can apply it to 2018 data
train_df <- master_df %>%
  filter(Season != 2018,
         Season >= 2007) %>% # train & test on data prior to 2018
  select(-playerid, -player_name, -teamid, -team_games, -ops, -home_runs, -rbi, -stolen_bases, -batting_average,
         -defense, -plate_appearances)

control_parameters <- trainControl(method = "cv",
                                   number = 10,
                                   search = "grid",
                                   allowParallel = TRUE,
                                   savePredictions = "final",
                                   classProbs = TRUE,
                                   summaryFunction = twoClassSummary)

parameter_grid <- expand.grid(
  nrounds = 50, 
  eta = c(0, .01, 0.1),
  max_depth = c(5, 10, 15, 20),
  gamma = c(0, 1, 2, 5),
  colsample_bytree = c(0.1, 0.5, 0.9),
  min_child_weight = c(0, 0.1),
  subsample = c(0.1, 0.2, 0.5, 0.7))

mvp_predictor <- train(is_mvp ~ .,
                       data = train_df, 
                       method = "xgbTree", 
                       trControl = control_parameters,
                       tuneGrid = parameter_grid,
                       metric = "ROC")


max_roc <- mvp_predictor$results$ROC %>% 
  max()

# msg <- sprintf("MVP predictor model is finished training!")

send_message(sprintf("MVP predictor model is finished training! Max ROC: %s", max_roc))


```

augment 2018 data with predictions from model

```{r}

season_to_test <- 2018

predict_df <- master_df %>%
  filter(Season == season_to_test) %>%
  select(-playerid, -player_name, -teamid, -team_games, -ops, -home_runs, -rbi, -batting_average, -is_mvp,
         -defense, -plate_appearances)

predict_al <- predict_df %>%
  filter(League == "AL")

predict_nl <- predict_df %>%
  filter(League == "NL")

predictions_al <- predict(mvp_predictor, newdata = predict_al, type ="prob") %>%
  mutate(prob_mvp = round(100 * Yes, 2)) %>%
  select(prob_mvp)

predictions_nl <- predict(mvp_predictor, newdata = predict_nl, type ="prob") %>%
  mutate(prob_mvp = round(100 * Yes, 2)) %>%
  select(prob_mvp)

mvp_prediction_al <-
  predict_al %>%
  bind_cols(predictions_al) %>%
  inner_join(master_df, by=c("Season", "Position", 
                             "League", "team_PCT", "ops_rank_league", "defense_rank_league",
                             "pa_rank_league")) %>%
  select(playerid, player_name, League, prob_mvp, everything()) %>%
  select(-is_mvp) %>%
  arrange(desc(prob_mvp))

mvp_prediction_nl <-
  predict_nl %>%
  bind_cols(predictions_nl) %>%
  inner_join(master_df, by=c("Season", "Position", 
                             "League", "team_PCT", "ops_rank_league", "pa_rank_league")) %>%
  select(playerid, player_name, League, prob_mvp, everything()) %>%
  select(-is_mvp) %>%
  arrange(desc(prob_mvp))

#construct master DF
mvp_predictions <-
  bind_rows(mvp_prediction_al, mvp_prediction_nl)

# plot variable importance
bind_cols(row.names(varImp(mvp_predictor)$importance) %>% 
            as_tibble(), 
          varImp(mvp_predictor)$importance %>% 
            as_tibble()) %>%
  filter(value != "PositionP") %>% # spurious data %>%
  mutate(value = str_replace_all(value,
                                 c("team_PCT" = "Team Winning Percentage",
                                   "rbi_rank_league" = "RBI Rank",
                                   "ops_rank_league" = "OPS Rank",
                                   "sb_rank_league" = "SB Rank",
                                   "avg_rank_league" = "AVG Rank",
                                   "hr_rank_league" = "HR Rank",
                                   "PositionOF" = "Is Outfielder?",
                                   "PositionC" = "Is Catcher?",
                                   "Position2B" = "Is Second Baseman?",
                                   "PositionSS" = "Is Shortstop?",
                                   "PositionDH" = "Is Designated Hitter?",
                                   "Position3B" = "Is Third Baseman?",
                                   "pa_rank_league" = "PA Rank",
                                   "defense_rank_league" = "DEF Rank",
                                   "LeagueNL" = "Is National League?"))) %>%
  ggplot(aes(reorder(value, Overall), Overall)) + geom_col() + coord_flip() + fgt +
  labs(x="", y="Relative Importance") + ggtitle("What Factors are Important in MVP Voting?")


# top 10 contenders in each league
mvp_predictions %>%
  group_by(League) %>%
  filter(row_number() <= 10) %>%
  ggplot(aes(reorder(player_name, prob_mvp), prob_mvp)) + geom_col() + coord_flip() + 
  facet_wrap(~League, scales = "free") + fgt + labs(x="", y="MVP Probability (%)") +
  ggtitle(sprintf("Top 10 MVP Candidates per League: %s", season_to_test))


```