---
output:
  pdf_document: default
---

```{r, echo=FALSE}
library(tidyverse)
```


NEW OUTLINE:

-- MLB controlled WAR (big list, then scatterplot)
--- Talk about the results
-- MLB controlled salary (big list, then scatterplot)
--- Talk about the results
-- MLB controlled surplus value (big list, then scatterplot)
--- Talk about the results / dive into the Cubs' dominance here







METHODOLOGY 

Surplus value under control has three parts: the number of years a player is under control, their WAR during that time period, and their salary during that time period. Below I describe the process I used to calculate each and any assumptions I made.

To determine the number of years a player is under control, I used team payroll information from Baseball Reference. To simplify my task, I assumed all contract options are exercised and no opt-outs are. I limited the time horizon to five years because I have WAR projections only for the next five years. For example, although Miguel Cabrera is under control for at least seven more years, my analysis only shows him as under control for the next five.

To project WAR I used a method Tom Tango proposed that weights past performance and applies an aging curve. The details are here: http://tangotiger.com/index.php/site/comments/war-marcels-...-warcels; read up if you're interested. The method isn't perfect, particularly when it comes to pitchers, but I trust Tango's methodology enough to go forward. For missing years I gave the player 0 WAR.

Projecting salary was trickier:

- For free-agent contract years, I information when available from Baseball Reference. I noticed they don't defer salary; for example, Chris Davis will make $17M next year, but $23M is listed on the Orioles' payroll page. I used the latter number.
- For 2017 arbitration salaries, I used projections from MLB Trade Rumors.
- For arbitrations years beyond 2017, I applied the 25%/40%/60% research described by Kevin Creagh at The Point of Pittsburgh (http://www.thepointofpittsburgh.com/calculating-mlb-arbitration-percentages/). For example, Jonathan Schoop is projected to earn $3.4M in 2017, his Arb-1 year. To project his Arb-2 salary, I calculated his free-agent AAV as (3.4 / .25), then multiplied by .4 to get a projection of $5.44M. I then used $5.44M to project his Arb-3 salary at $8.16M. 
- For Arb-4 years, I used 70% of free-agent salary. For simplicity's sake, I did not identify Arb-4 players and then apply the 20%/33%/50%/70% progression that Creagh found. The progression in my analysis goes 25%/40%/60%/70%.
- For pre-arb salaries, I used the 2017 league minimum of $535k. I did not step up each year as the CBA dictates.

The toughest part was projecting arbitration salaries for players who will be pre-arb in 2017. No arbitration projection yet exists for these fellas. I used $2.2M, which is the average Arb-1 salary given out in 2016, according to MLBTR's tracker (http://www.mlbtraderumors.com/arbtracker2016). The 25/40/60/70 rubric kicked in for subsequent arbitration projections.

Using averages in situations like these has its perils. For example, we as people know that Kris Bryant will get far more than $2.2M in his first arbitration season. So in the following analysis, his surplus value is drastically overstated. But short of projecting Arb-1 for every player uniquely, this was the best I could do. I'm open to other methods if you'd like to share them in the comments. This area is the biggest shortcoming of this project.

With years of control, WAR under control, and salary under control, I calculated a player's surplus value as (8.5 * _WAR Under Control_) - _Salary_Under_Control_. I inflated the value of WAR by 5% each year of control.

===RESULTS===

OK, now we can get to the results, which are simply this: the Cubs dominate the entire sport of Major League Baseball in terms of talent they control and the surplus value they're getting from that talent. Other teams control their players for longer on average, but no team comes close to the value per dollar Theo Epstein and his crew are getting.

The following table shows the surplus value under control for each team through 2021:



^^ INTRO AND METHODOLOGY GO ABOVE HERE ^^

=== WAR UNDER CONTROL ===

To project WAR, I used a method Tom Tango proposed that weights the past three years' WAR and applies an aging curve. The details are here [http://tangotiger.com/index.php/site/comments/war-marcels-...-warcels]; read up if you're interested. The method isn't perfect, particularly when it comes to pitchers, but I trust Tango's methodology enough to go forward. For missing years I gave the player 0 WAR.

To compute how long players are under team control for, I used the payroll pages at Baseball-Reference. (Here's an example for the Orioles [http://www.baseball-reference.com/teams/BAL/baltimore-orioles-salaries-and-contracts.shtml].) For simplicity's sake I assumed no options will vest or get picked up. I capped the number of years of control to five, because that's as far out as Tango's WAR projections go.

I also removed players who either:
- Project for a controlled total of less than 1 WAR, or
- Project for a controlled average annual salary of less than $5M. (I explain my salary calculations below.)

This logic filters out most scrubs, who aren't guaranteed a job anyway, while letting major dead weight contracts like Albert Pujols factor into the analysis.

With this in mind, the following chart shows the WAR each team controls through the next five years:

```{r, echo=FALSE}

war_tbl <- warcels %>%
  group_by(Team) %>%
  summarize(`Controlled WAR Through 2021` = sum(war_under_control)) %>%
  arrange(desc(`Controlled WAR Through 2021`)) %>%
  write_csv("mlb-war-thru-2021.csv")

ggplot(war_tbl, aes(reorder(Team, `Controlled WAR Through 2021`), `Controlled WAR Through 2021`)) + geom_bar(stat="identity") + fgt + coord_flip() + labs(y="Controlled WAR", x="Team") + ggtitle("MLB Controlled WAR, 2017 — 2021")


```

Cubs win! They control 127 WAR, nearly 20 more than the Dodgers who control 109. That's just an average four wins per year, but because the teams play in different divisions, Theo Epstein is probably fine with this situation.

The closest NL Central rival to the Cubs is the Cardinals, who control 80 WAR through this same time period. John Mozeliak has his work cut out for him, as do all the other NL Central GMs. Here's a chart showing just the NL Central teams:

```{r}
nl_central_war <- war_tbl %>%
  filter(Team %in% c("CHC", "STL", "PIT", "CIN", "MIL"))

ggplot(nl_central_war, aes(reorder(Team, `Controlled WAR Through 2021`), `Controlled WAR Through 2021`)) + geom_bar(stat="identity") + fgt + coord_flip() + labs(y="Controlled WAR", x="Team") + ggtitle("NL Central Controlled WAR, 2017 — 2021")

```

The rosters of the Cardinals, Reds, Pirates, and Brewers will of course change as the teams trade and expand payroll. But the Cubs' roster will change too. Can the Brewers improve by 18 wins per year for the next five years? That's what they'll have to do to overtake the Cubs.

=== CONTENTION WINDOWS ===

Not all WAR is controlled equally. Contending teams tend to control a lot of WAR for short amounts of time; rebuilding ones, a small amount for longer. The data I gathered can reveal each team's contention window. How long can we expect the Cubs to contend for? The following graph shows project rosters' WAR values spread across by the number of years it controls the average player:

```{r}
war_timeline <- warcels %>%
  group_by(Team) %>%
  mutate(num_players = n()) %>%
  summarize(total_war_under_control = sum(war_under_control),
            total_years_of_control = sum(years_of_control),
            avg_years_of_control = mean(years_of_control),
            avg_war_under_control_pear_year = total_war_under_control / avg_years_of_control)

ggplot(data=war_timeline, aes(avg_years_of_control, avg_war_under_control_pear_year, label=Team)) + geom_point(color="#336699") + geom_text(aes(label=Team), hjust=-0.01, vjust=0) + labs(x="Avg. Length of Control of Roster (Years)", y="Avg. Roster WAR per Year") + ggtitle("MLB Team WAR Over Time, 2017 — 2021") + fgt
```

The results again paint Theo Epstein's group in a favorable light. For the next three years or so, the Cubs project to average about 40 WAR per year as a team. That's a projected average of 93 wins through 2019, given today's roster. And remember, this analysis doesn't have the team picking up Anthony Rizzo's options (which they surely will). Nor does it have them extending Kris Bryant or any other young stars, which they'll surely attempt to do.

The rest of the sport is just fighting it out for second place. While the Dodgers will try to upend the Cubs, the Indians and Red Sox should battle it out for the AL crown. The Orioles have the narrowest contention window in baseball. The Diamondbacks look more like the rebuilding efforts in Cincinnati and Milwaukee than NL West contenders.  

== SALARY UNDER CONTROL ==

For most teams it's not enough to build a winner; their GMs have to do it on a budget. So WAR has a salary component as well. I used the same payroll data from Baseball-Reference to project each team's payroll for the next five years. Here's what I did:

- When available, I used free-agent and arbitration salaries directly. I used non-deferred salaries because that's what the pages list. This affects players like Chris Davis, who'll make $17M this year but for the purposes of this study makes $23M.
- I assumed $535k for all pre-arbitration salaries unless otherwise listed. I did not step up the salary each year as the latest CBA dictates. Some late entries, like the Cubs rewarding its young stars [https://www.mlbtraderumors.com/2017/03/cubs-kris-bryant-agree-to-record-pre-arb-deal.html], aren't reflected in the dataset.
- To project first-year arbitration salaries, I used MLB Trade Rumors' Arbitration Trackers to build a simple linear model based on first-year arbitration salaries from 2014-2016 as a function of WAR accrued prior to being awarded a first-year salary. The model is 1.36881 * (.26896 * Total_WAR_when_entering_arbitration). This approach is simplistic but gives results the pass the sniff test.
- For future arbitration years, I applied the 25%/40%/60% research described by Kevin Creagh at The Point of Pittsburgh [http://www.thepointofpittsburgh.com/calculating-mlb-arbitration-percentages/]. For example, Jonathan Schoop will earn $3.48M in 2017, his Arb-1 year. To project his Arb-2 salary, I calculated his free-agent AAV as (3.48 / .25), then multiplied by .4 to get a projection of $5.57M. I used this Arb-2 salary to project his Arb-3 salary at $8.25M.
- For Arb-4 years, I used 70% of free-agent salary as described by Creagh. For simplicity's sake, I didn't identify Arb-4 players and then apply the 20%/33%/50%/70% progression that Creagh found. The progression in my analysis goes 25%/40%/60%/70%.
- Finally as I described above, I used average annual salary as one criterion for filtering players out of this analysis.
- I accounted for a few unique situations, like Texas paying only $9M annually (for 0 WAR) to Prince Fielder because the Tigers and insurance are paying the rest.

The following chart shows each team's projected controlled salary through 2021: 

```{r, echo=FALSE}

salary_tbl <- warcels %>%
  group_by(Team) %>%
  summarize(`Controlled Salary Through 2021` = sum(salary_under_control)) %>%
  arrange(`Controlled Salary Through 2021`) %>%
  write_csv("mlb-salary-thru-2021.csv")

ggplot(salary_tbl, aes(reorder(Team, `Controlled Salary Through 2021`), `Controlled Salary Through 2021`)) + geom_bar(stat="identity") + fgt + coord_flip() + labs(y="Controlled Salary (Millions USD)", x="Team") + ggtitle("MLB Controlled Salary, 2017 — 2021")


```

The Cubs' post-2015 spending binge shows up here. The team will spend a projected $512 million in salary over the next five years, sixth-most in the sport. The teams above them are all also trying to contend in this timeframe, as are many of the teams below them. I'd say you have to go all the way down to the Reds in 21st place before you find a team who isn't trying to contend this year or next. Even then, you have the Pirates in 26th place who will shoot for the Wild Card during the next few years.

=== SURPLUS VALUE ===

Now we get to the true art of the Cubs' rebuild: surplus value. I've shown how the Cubs project to have the most team WAR in baseball over the next five years. While the salary analysis appears to show them spending a lot, the reality is they've spent wisely. The following chart shows each team's projected surplus value for the next five years:  

```{r, echo=FALSE}

surplus_tbl <- warcels %>%
  group_by(Team) %>%
  summarize(`Controlled Surplus Value Through 2021` = sum(controlled_surplus_value)) %>%
  arrange(desc(`Controlled Surplus Value Through 2021`)) %>%
  write_csv("mlb-surplus-value-thru-2021.csv")

ggplot(surplus_tbl, aes(reorder(Team, `Controlled Surplus Value Through 2021`), `Controlled Surplus Value Through 2021`)) + geom_bar(stat="identity") + fgt + coord_flip() + labs(y="Controlled Surplus Value (Millions USD)", x="Team") + ggtitle("MLB Controlled Surplus Value, 2017 — 2021")

```

The Cubs are running the highest-value roster in the sport, with just over $800M in surplus value over the next five years. Surplus value isn't literal profit, but it's close. Tom Ricketts can't buy a yacht with the money Theo Epstein has saved, but he could justify spending a lot of it to improve the team in some fashion.

But the Cubs are no small-market Cindarellas. They operate in 

Presented in this light, the raises given to Bryant and others seem paltry. An extra $500,000? That's a pittance. Bryant projects, without this raise, to nearly $270M in surplue value all by himself. Addison Russell? $146.6M in surplus value. Anthony Rizzo? $101.1M. You get the idea. 

Kyle Hendricks, Javier Baez, and Wilson Contreras round out the six Cubs players who rank at or above the 90th percentile for surplus value. The Indians are next with four players; the Dodgers, Giants, Blue Jays, and Nationals have three each.




=== CONCLUSION ===

I can't overstate how successful the Cubs' rebuild has been. Theo Epstein and Jed Hoyer not only set the team up to dominate the sport for the next five years, but also paid bottom dollar to do so. They've hit on nearly every trade (Jake Arrieta, Anthony Rizzo, Kyle Hendricks), made impactful draft picks (Kris Bryant, Kyle Schwarber), and signed excellent free agents (Jon Lester, Jason Heyward). 

...(Be sure to thank Bill Petti for research assistance!)...





During this time they project to:

1. Lead the entire sport in WAR.
3. Surpass their closest division rival by 17 WAR per year for the next three years.
4. Get $800 million of on-field production for free.

Oh, and they reached the NLCS in 2015 and won the World Series in 2016.

By any measure, the rebuild was a success. 




* * *

The Cub's are paying the least for the most talent, even when you factor in that many of their pre-arb players get hurt by the $2.2M Arb-1 projection I mentioned. This projection hurts the Cubs more than any other team because the Cubs have so many pre-arb players to begin with.

Controlled surplus value is nice, but teams have to balance that value with the amount of time they control it. Here again, the Cubs lead the pack. They don't have the longest control over their players, but for the next 3-4 years they have nearly double the surplus value of the next-highest team:

```{r, echo=FALSE}

team_surplus_value <- warcels %>%
  group_by(Team) %>%
  summarize(`Avg. Years of Control of Roster` = round(mean(years_of_control), 2),
            `Avg. Surplus Value per Player Per Year (Millions USD)` = sum(controlled_surplus_value) / sum(years_of_control))

ggplot(team_surplus_value, aes(`Avg. Years of Control of Roster`, `Avg. Surplus Value per Player Per Year (Millions USD)`, Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + ggtitle("MLB Controlled Surplus Value, 2017 - 2021") + fgt

for_fg <- team_surplus_value %>%
  select(-Team) %>%
  write_csv("mlb-team-surplus-value.csv")


```

The Cubs' roster averages nearly $5M in surplus value each year for the next 3-4 years. That's what having a core of pre-arbitration talent does. The next-best team doesn't even average $1M in surplus value per year. The remaining 28 teams, featuring older and/or worse players, don't get any surplus value at all.

```{r, echo=FALSE}
cubs_surplus_value <- warcels %>%
  filter(Team == "CHC") %>%
  mutate(salary_under_control = round(salary_under_control, 1)) %>%
  select(Name, `Years of Control` = years_of_control, `WAR Under Control` = war_under_control,
         `Salary Under Control*` = salary_under_control, `Surplus Value Under Control*` =
           controlled_surplus_value, `Surplus Value MLB Rank (%)` = surplus_value_rank) %>%
  arrange(desc(`Surplus Value MLB Rank (%)`)) %>%
  write_csv("cubs-surplus-value-players.csv")

cubs_surplus_value
```

My $2.2M Arb-1 projection makes many of the guys atop this list appear to be better bargains than they are -- Bryant, Russell, and Hendricks especially. These guys will make far more than that in their Arb-1 years. But so will many other players on other teams to whom I applied this projection.

Still, the Cubs are far ahead of everyone else. Seven of their players rank in the top 90% of surplus value and an eighth, Kyle Schwarber, just misses the cut. Two teams have six players at this ranking; seven teams have five players here.


```{r}
rank_90th_percentile <- warcels %>%
  filter(surplus_value_rank >= 90.0) %>%
  group_by(Team) %>%
  summarize(num_players_at_or_above_90th_perc = n()) %>%
  arrange(desc(num_players_at_or_above_90th_perc)) %>%
  write_csv("rank-90th.csv")


rank_90th_percentile

```


===RAW TALENT===

Surplus value isn't everything. Teams need to put talent on the field. Here again, the Cubs shine. The following graph shows simply the average amount of WAR they control each year, across their entire current roster, and the average time they control each player for:

```{r, echo=FALSE}
ggplot(data=team_war, aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="Avg. no. of years team controls its current players", y="Avg. total WAR per year") + ggtitle("MLB Team Control of Talent, 2017-2021") + fgt

for_fg <- team_war %>%
  select(`Avg. Control of Current Players (Years)` = years_of_control,
         `Avg. Total WAR per Year` = war_under_control_per_year) %>%
  write_csv("team_war.csv")


```





