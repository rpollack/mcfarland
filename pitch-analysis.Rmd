

```{r}
library(tidyverse)
library(stringr)
library(RMySQL)
library(lubridate)
library(xgboost)
library(caret)
library(e1071)
library(twilio)
library(styler)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)

fg_db <- dplyr::src_mysql(
  dbname = Sys.getenv("FG_DB"),
  host = Sys.getenv("FG_HOST"),
  user = Sys.getenv("FG_USER"),
  password = Sys.getenv("FG_PW")
)

TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg) {
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}
```


who is throwing pitches they shouldn't? or who needs to re-sequence, or adjust mechanics/spin/velo/etc. of a certain pitch?

look for pitchers to throw a high % of pitch types, in certain zones, to certain-handed batters, that get smacked for a high xWOBA

get data

```{r}
data <-
  fg_db %>%
  tbl("gd_savant_new") %>%

  # try hard to get only legit data. documentation: https://baseballsavant.mlb.com/csv-docs
  filter(
    pitch_type %in% c("FA", "FF", "FT", "FC", "FS", "SI", "SF", "SL", "CH", "CB", "CU", "KC", "KN", "EP"), # get legit pitch types only
    game_type %in% c("R", "F", "D", "L", "W"), # ignore spring training, etc. games
    zone != 0 # ignore invalid strikezone data
  ) %>%
  dplyr::select(player_name, game_year, p_throws, pitch_type, balls, strikes, zone, stand, description, xwoba) %>%
  collect(n = Inf)
```

```{r}


# mark good outcomes as: swinging strike or called strike. in 'description' field.
# then compute percentage of pitches that resulted in a good outcome
# this does not incorporate weakly hit balls ... perhaps I can do CALLED STRIKE, SWINGING STRIKE, OR xwOBA < lg average.


total_pitches_to_each_side_cutoff <- 5

# find median xwoba of all batted balls. the histogram is skewed so the median is more appropriate than the mean here
# batted balls that produce a value less than this are considered 'good'
median_xwoba_2019 <-
  data %>%
  filter(
    str_detect(description, "hit_into_play"),
    game_year == 2019
  ) %>%
  summarize(median_xwoba = median(xwoba)) %>%
  as.numeric()


data_grouped <-
  data %>%
  filter(game_year == 2019,      # filter to 2019 to focus on advice that's immediately actionable
         description != "foul") %>%   # do not count foul balls as either good or bad
  mutate(
    zone_type_vertical = case_when(
      zone %in% c(11, 12, 1, 2, 3) ~ "High",
      zone %in% c(4, 5, 6) ~ "Middle",
      zone %in% c(7, 8, 9, 13, 14) ~ "Low"
    ),
    zone_type_horizontal = case_when(
      zone %in% c(2, 5, 8) ~ "Middle",
      stand == "R" & zone %in% c(11, 13) ~ "Inside",
      stand == "R" & zone %in% c(1, 4, 7) ~ "In",
      stand == "R" & zone %in% c(3, 6, 9) ~ "Away",
      stand == "R" & zone %in% c(12, 14) ~ "Outside",
      stand == "L" & zone %in% c(11, 13) ~ "Outside",
      stand == "L" & zone %in% c(1, 4, 7) ~ "Away",
      stand == "L" & zone %in% c(3, 6, 9) ~ "In",
      stand == "L" & zone %in% c(12, 14) ~ "Inside"
    ),

    # define a good pitch as one that is either a called/swinging strike or gets hit for a sub-median xWOBA
    # remember, foul balls are not counted as either good or bad
    outcome = if_else(str_detect(description, "strike") |
      (str_detect(description, "hit_into_play") & xwoba <= median_xwoba_2019), "good", "bad")
  ) %>%
  unite(zone_desc, zone_type_vertical, zone_type_horizontal, sep = " and ") %>%
  unite(count, balls, strikes, sep = "-") %>%
  group_by(player_name, game_year, p_throws, stand) %>%
  mutate(total_pitches_to_batters_of_this_hand = n()) %>%
  filter(total_pitches_to_batters_of_this_hand >= total_pitches_to_each_side_cutoff) %>% # try to get only full time pitchers
  group_by(player_name, game_year, p_throws, count, zone_desc, stand, pitch_type, outcome) %>%
  summarize(
    num_pitches = n()
  ) %>%
  mutate(percentage = round(num_pitches / sum(num_pitches) * 100, 1))
#  mutate(pitch_percentage = round(num_pitches / total_pitches_to_batters_of_this_hand * 100, 1))
```



```{r}

# pitchers with the highest and lowest percentages of good pitches
by_pitcher <-
  data_grouped %>%
  group_by(player_name) %>%
  mutate(total_pitches = sum(num_pitches)) %>%
  # filter(total_pitches < 500) %>% # get starters
  filter(outcome == "good") %>%
  group_by(player_name, total_pitches) %>%
  summarize(num_good_pitches = sum(num_pitches)) %>%
  mutate(good_pitch_percentage = round(num_good_pitches / total_pitches, 3)) %>%
  arrange(desc(good_pitch_percentage))

# compute shape parameters of beta curve, given data
mu <- mean(by_pitcher$good_pitch_percentage)
var <- var(by_pitcher$good_pitch_percentage)

alpha0 <- ((1 - mu) / var - 1 / mu) * mu^2
beta0 <- alpha0 * (1 / mu - 1)

ggplot(by_pitcher, aes(good_pitch_percentage)) + geom_histogram(binwidth = .01, aes(y = ..density..)) +
  stat_function(
    fun = dbeta,
    args = list(shape1 = alpha0, shape2 = beta0),
    lwd = 2,
    aes(color = "All Pitchers")
  ) +
  labs(x = "Good Pitches per Pitch Thrown") +
  labs(color = "Distributions") +
  ggtitle("Probability Distribution for Good Pitch %")

# estimate good-pitch-rate by applying priors to all pitchers. also compute credible intervals
good_pitches_est <-
  by_pitcher %>%
  mutate(
    est_good_pitch_percentage = (num_good_pitches + alpha0) / (total_pitches + alpha0 + beta0),
    alpha1 = alpha0 + num_good_pitches,
    beta1 = beta0 + total_pitches - num_good_pitches,
    low_credible = qbeta(.025, alpha1, beta1),
    high_credible = qbeta(.975, alpha1, beta1)
  ) %>%
  arrange(desc(est_good_pitch_percentage))

# best pitchers
ggplot(good_pitches_est %>% head(25), aes(reorder(player_name, est_good_pitch_percentage), est_good_pitch_percentage)) + coord_flip() +
  geom_point() + geom_errorbar(aes(ymin = low_credible, ymax = high_credible)) +
  labs(x = "")

# worst pitchers
ggplot(good_pitches_est %>% tail(25), aes(reorder(player_name, est_good_pitch_percentage), est_good_pitch_percentage)) + coord_flip() +
  geom_point() + geom_errorbar(aes(ymin = low_credible, ymax = high_credible)) +
  labs(x = "")

# TODO:
# is there any confounding factor? I think there is ... good pitchers will get more chances to throw total pitches
# so the model should account for that.
# ---- also, probably need to separate relievers from starters. they have a different number of pitches ...
# OR maybe let the credible intervals handle it ... starters will have smaller ones because they've thrown
# more pitches. ... I think this is the right decision.
```


```{r, fig.height=5}
pitch_cutoff <- 2 # get only zones/batters who've seen at least this many pitches, from the pitcher in this count

# how to incorporate the count in it? that matters

data_grouped %>%
  filter(
    outcome == "good",
    num_pitches >= pitch_cutoff
  ) %>%
  unite(label, player_name, pitch_type, count, zone_desc, stand, sep = " - ") %>%
  arrange(desc(percentage)) %>%
  head(25) %>%
  ggplot(aes(reorder(label, percentage), percentage)) + geom_col() + coord_flip() +
  ggtitle("Mean xWOBA by Pitch Type, Location, and Batter Handedness",
    subtitle = glue("For pitches thrown at least {percentage_cutoff}% of the time in that location to batters of that hand
                          For pitchers with at least {total_pitches_to_each_side_cutoff * 2} pitches in 2019")
  ) +
  labs(
    x = "", y = "Percentage of Pitches that are Good",
    caption = "Good pitch: swinging strike, called strike, or batted ball with xWOBA less than the league median xWOBA"
  )

data_grouped %>%
  filter(
    outcome == "good",
    num_pitches >= pitch_cutoff
  ) %>%
  unite(label, player_name, pitch_type, count, zone_desc, stand, sep = " - ") %>%
  arrange(desc(percentage)) %>%
  tail(25) %>%
  ggplot(aes(reorder(label, -percentage), percentage)) + geom_col() + coord_flip() +
  ggtitle(" by Pitch Type, Location, and Batter Handedness",
    subtitle = glue("For pitches thrown at least {percentage_cutoff}% of the time in that location to batters of that hand
                          For pitchers with at least {total_pitches_to_each_side_cutoff * 2} pitches in 2019")
  ) +
  facet_grid(vars(count)) +
  labs(x = "", y = "Percentage of Pitches that are Good")
```


