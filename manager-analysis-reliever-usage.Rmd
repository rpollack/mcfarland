---
title: "manager-analysis"
output: html_document
---



```{r}
# library(tidyverse)
library(tidyverse)
library(rvest)
library(broom)
library(stringr)
library(RMariaDB)
library(lubridate)
library(plotly)
library(glue)
library(styler)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family = "Lato")
)

fg_db <-
  DBI::dbConnect(RMariaDB::MariaDB(),
    dbname = Sys.getenv("FG_DB"),
    host = Sys.getenv("FG_HOST"),
    user = Sys.getenv("FG_USER"),
    password = Sys.getenv("FG_PW")
  )

TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg) {
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}
```

```{r}
get_team_managers <- function(team) {
  # this function takes a team as an input and returns a list of manager names, given the season is 2007 or later
  # and the team had only one manager that year

  url <- glue("https://www.baseball-reference.com/teams/{team}/index.shtml")

  tryCatch(
    url %>%
      read_html() %>%
      html_nodes("table") %>%
      .[[1]] %>%
      html_table(header = TRUE) %>%
      as_tibble() %>%
      dplyr::select(Season = Year, Manager = Managers) %>%
      filter(
        !str_detect(Manager, "and"),
        Season >= 2007
      ) %>%
      mutate(
        Manager = str_extract(Manager, "[A-Z].[:graph:]*"),
        Team = team
      ) %>%
      dplyr::select(Season, Team, Manager),
    error = function(e) {
      print(glue("No such URL for team abbreviation: {team}"))
    }
  )
}

```


- quantify good bullpen decisions by correlating k-bb% for the first 3 months of the season with average gmLI for the second half of the season
- player assumptions: player faced at least 25 batters in the first half. k-bb%+ is computed relative to others on team that year
- team assumptions: at least 5 relievers appeared for them 5 times in the 2nd half

get data

```{r}

id_info <- fg_db %>%
  tbl("playerid_lookup") %>%
  dplyr::select(mlbamid, playerid) %>%
  collect(n=Inf)

players <- 
  fg_db %>%
  tbl("player_info") %>%
  filter(BISPosition == "RP") %>%
  dplyr::select(playerid = PlayerId, FirstName, LastName) %>%
  collect(n = Inf) %>%
  unite(player_name, FirstName, LastName, sep = " ")

teams <-
  fg_db %>%
  tbl("season_team") %>%
  filter(Season >= 2012) %>%
  dplyr::select(Season, TeamId, AbbName, W, L, R, RA) %>%
  collect(n = Inf) %>%
  mutate(pct = W / (W + L),
         pythag_pct = (R * R)/((R * R) + (RA * RA)))

reliever_projections <-
  fg_db %>%
  tbl("proj_pitching") %>%
  filter(Type == "Steamer",
         PlayerId %in% !!players$playerid) %>%
  collect(n = Inf) %>%
  mutate(k_perc = SO / TBF, 
         bb_perc = BB / TBF,
         proj_k_minus_bb = (k_perc - bb_perc) * 100) %>%
  dplyr::select(PlayerId, Season, k_perc, bb_perc, proj_k_minus_bb)

# get managers for teams that've had only one manager per year. replace a few team names to match FanGraphs' names
team_managers <- c(
  "ARI", "ATL", "BAL", "BOS", "CHC",
  "CHW", "CIN", "CLE", "COL", "DET",
  "HOU", "KCR", "ANA", "LAD", "FLA",
  "MIL", "MIN", "NYM", "NYY", "OAK",
  "PHI", "PIT", "SDP", "SEA", "SFG",
  "STL", "TBD", "TEX", "TOR", "WSN"
) %>% 
  map_df(get_team_managers) %>%
  mutate(Team = case_when(
    Team == "ANA" ~ "LAA",
    Team == "TBD" ~ "TBR",
    TRUE ~ Team
  ))

# gmLI data: get plate appearances that began with a pitcher who was subbed in for another pitcher
wpa_data <- fg_db %>%
  tbl("wpa_log") %>%
  filter(
    !is.na(PitcherSubId),
    GameDate >= "2012-01-01"
  ) %>%
  collect(n = Inf)

transactions <- 
  fg_db %>%
  tbl("gd_transactions") %>%
  collect(n = Inf)
```

let's follow zach britton's history

```{r}


player_availability <-
  transactions %>%
  # want to filter down to relievers here
  
#  filter(mlbamid %in% c(592518, 502154)) %>%
  dplyr::select(trans_date, type, note, everything()) %>%
  mutate(

    # based on correlating data columns with news articles, trans_date seems to be the right one.
    trans_date = ymd(trans_date),
    is_active = case_when(
      str_detect(note, "signed free agent|recalled|selected the contract") ~ TRUE,

      # check that a major league team is activating the player. minor league teams can activate players too
      str_detect(note, "activated") & str_detect(team, "Baltimore|New York|Boston|Tampa|Toronto|Chicago|Kansas|Detroit|
                                                 Minnesota|Cleveland|Houston|Oakland|Los Angeles|Seattle|Texas|
                                                 Washington|Atlanta|Philadelphia|St. Louis|Milwaukee|Pittsburgh|Cincinnati|
                                                 Colorado|Arizona|San Diego|San Francisco") ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  arrange(trans_date) %>%
  mutate(interval = if_else(is.na(lead(trans_date)), trans_date %--% ymd(Sys.Date()),
    trans_date %--% lead(trans_date)
  )) %>%
  filter(is_active) %>% # retain only intervals where the player is active
  group_by(mlbamid, team) %>%
  arrange(trans_date, .by_group = TRUE)
  


# TODO:
# 0. when grouping, intervals seem to be assigned numeric units(seconds?) rather than dates. since this won't work i will have to test that the player is available for that team iff. pitching_team == transactions$team & game_date %within% transactions$interval. 

# this will give me a tibble

# 1. it is not catching Zach Britton's activation in June 2018. he pitched on 6/12 through 7/21. the entry with trans_date 6/11/2/18 just reads "Zach Britton roster status changed by Baltimore Orioles." there is nothing to tell that he was activated. i can't use "roster status changed" because on 7-2-2019, the same text appears for Manny Machado when he was suspended: "SS Manny Machado roster status changed by San Diego Padres." there is a corresponding "activated" entry the next day. 
# 2. may need to futz with intervals some more. for example Manny Machado was not available on 7-2-2019; he was suspended. but his active intervals give that date as active. 


```

i have availability dates and i have substitution dates. i want to know the list of actual dates each players were available

```{r}
availability <-
  read_csv("reliever_availability.csv")
```


mash together datasets and compute

```{r}

# extract individual gmLI, clean data, and add some other variables
li_individual <-
  wpa_data %>%
  inner_join(players, by = c("P" = "playerid")) %>%
  mutate(
    Season = year(GameDate),
    game_month = month(GameDate)
  ) %>%
  
  # label regular & postseason data for later use
  mutate(season_type = if_else(
    Season == 2012 & GameDate <= "2012-10-03" |
      Season == 2013 & GameDate <= "2013-09-30" |
      Season == 2014 & GameDate <= "2014-09-28" |
      Season == 2015 & GameDate <= "2015-10-04" |
      Season == 2016 & GameDate <= "2016-10-02" |
      Season == 2017 & GameDate <= "2017-10-01" |
      Season == 2018 & GameDate <= "2018-10-01" |
      Season == 2019 & GameDate <= "2019-09-29",
    "regular", "postseason"
    )) %>%
  
  inner_join(teams, by = c("Season",
    "HomeTeamId" = "TeamId"
  )) %>%
  mutate(home_team = AbbName) %>%
  inner_join(teams, by = c("Season",
    "AwayTeamId" = "TeamId"
  )) %>%
  mutate(
    away_team = AbbName.y,
    inning_half = if_else(InningHalf == 0, "Top", "Bottom"),
    pitching_team = if_else(inning_half == "Top", home_team, away_team),
    pitching_team_score = if_else(inning_half == "Top", HomeScore, AwayScore),
    batting_team_score = if_else(inning_half == "Bottom", HomeScore, AwayScore),
    pitching_team_lead = pitching_team_score - batting_team_score
  ) %>%
  dplyr::select(Season, GameDate, game_month, home_team, away_team, inning_half,
    inning = Inning, outs = Outs, pitching_team_score, batting_team_score, pitching_team_lead, pitching_team, pitcher_playerid = P,
    pitcher_subbed_in = player_name, LI, season_type
  )

# find the mean gmLI for each pitcher in each seaosn and add in projected K-BB%, the team's manager, and the team's performance that year
li_grouped <-
  li_individual %>%
  group_by(Season, pitching_team, pitcher_playerid, pitcher_subbed_in) %>%
  summarize(
    num_appearances = n(),
    mean_gmLI = round(mean(LI), 2)
  ) %>%
  inner_join(reliever_projections, by = c("Season", "pitcher_playerid" = "PlayerId")) %>%
  inner_join(team_managers, by=c("Season", "pitching_team" = "Team")) %>%
  group_by(Manager) %>% 
  mutate(num_pitcher_substitutions = n())

# produce overall correlations for managers given all data in the set
manager_correlations_overall <-
  li_grouped %>%
  ungroup() %>%
  split(.$Manager) %>%
  map(~ lm(mean_gmLI ~ proj_k_minus_bb, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared") %>%
  tidy() %>%
  mutate(r_squared = round(x, 2),
         r = sqrt(r_squared)) %>%
  dplyr::select(names, r_squared, r) %>%
  arrange(desc(r_squared))

manager_correlations

# product annual correlations for each manager. this way we can see managers' tendencies evolve over time
manager_correlations_annual <-
  li_grouped %>%
  ungroup() %>%
  split(list(.$Manager, .$pitching_team, .$Season), drop = TRUE, sep = "_") %>%
  map(~ lm(mean_gmLI ~ proj_k_minus_bb, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared") %>%
  tidy() %>%
  mutate(r_squared = round(x, 2),
         r = sqrt(r_squared)) %>%
  dplyr::select(names, r_squared, r) %>%
  separate(names, c("manager", "team", "Season"), sep = "_", convert = TRUE) %>%
  inner_join(teams, by=c("Season", "team" = "AbbName")) %>%
  pivot_longer(contains("pct"), names_to = "wins_metric", values_to = "percentage") %>%
  dplyr::select(-TeamId, -W, -L, -R, -RA) %>%
  arrange(desc(r_squared))

manager_correlations_annual

```

```{r}
# plot each manager year to year ... 
manager_plot <-
  manager_correlations_annual %>%
  distinct(manager, team, Season, r) %>%
  ggplot(aes(Season, r, color = manager, group = manager)) + 
  geom_point() + 
  geom_line()

ggplotly(manager_plot, tooltip=c("manager", "Season", "r"))


# how strongly does the r each year correlate to winning % (regular and pythagorean) ?
manager_correlations_annual %>%
  split(.$wins_metric) %>%
  map(~ lm(percentage ~ r, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared") %>%
  tidy() %>%
  mutate(r_squared = round(x, 2),
         r = sqrt(r_squared)) %>%
  dplyr::select(names, r_squared, r) %>%
  arrange(desc(r_squared))

# plot the above
manager_correlations_annual %>%
  ggplot(aes(r, percentage)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(vars(wins_metric))



# most consistent managers year-to-year


# plot individual seasons


```



plot buck showalter's usage for each year he was in charge of the Orioles

```{r}
showalter_plt <-
  li_grouped %>%
  filter(Manager == "B.Showalter",
         pitching_team == "BAL") %>%
  ggplot(aes(proj_k_minus_bb, mean_gmLI, text = pitcher_subbed_in)) + geom_point() +
  labs(x="Preseason Projected K-BB% (Steamer)", y="Mean In-season gmLI") +
  facet_wrap(vars(Season)) + ggtitle("Decision-Making in Reliever Insertion, Buck Showalter, Baltimore Orioles")

ggplotly(showalter_plt, tooltip = c("text", "proj_k_minus_bb", "mean_gmLI"))

cooper_plt <-
  li_grouped %>%
  filter(Manager == "C.Cooper") %>%
  ggplot(aes(first_half_K_BB_perc_plus, second_half_mean_gmLI, text = pitcher_subbed_in)) + geom_point() +
  labs(x="Reliever First-Half K-BB%+", y="Reliever Second Half Mean gmLI") +
  facet_wrap(vars(Season)) + ggtitle("Decision-Making in the Second Half, Cecil Cooper", 
                                     subtitle = "Buck Showalter, Baltimore Orioles")

ggplotly(cooper_plt, tooltip = c("text", "first_half_K_BB_perc_plus", "second_half_mean_gmLI"))


roberts_plt <-
  li_grouped %>%
  filter(Manager == "D.Roberts") %>%
  ggplot(aes(first_half_K_BB_perc_plus, second_half_mean_gmLI, text = pitcher_subbed_in)) + geom_point() +
  labs(x="Reliever First-Half K-BB%+", y="Reliever Second Half Mean gmLI") +
  facet_wrap(vars(Season)) + ggtitle("Decision-Making in the Second Half, Dave Roberts", 
                                     subtitle = "Buck Showalter, Baltimore Orioles")

ggplotly(roberts_plt, tooltip = c("text", "first_half_K_BB_perc_plus", "second_half_mean_gmLI"))

```


```{r, fig.height=3}
reliever_use_plt <-
  ggplot(li_grouped, aes(first_half_K_BB_perc_plus, second_half_mean_gmLI, text = label)) +
  geom_point()

ggplotly(reliever_use_plt, tooltip = c("text", "first_half_K_BB_perc_plus", "second_half_mean_gmLI"))


top_10_names <-
  correlations %>%
  head(10)

bottom_10_names <-
  correlations %>%
  tail(10)

# graph plots of top 10 teams
top_10_plt <-
  li_grouped %>%
  unite(season_team, Season, pitching_team, sep = " ") %>%
  filter(season_team %in% top_10_names$names) %>%
  ggplot(aes(first_half_K_BB_perc_plus, second_half_mean_gmLI, text = pitcher_subbed_in)) +
  geom_point() +
  facet_wrap(vars(season_team), scales = "free_x") +
  ggtitle("Best Bullpen Usage")

bottom_10_plt <-
  li_grouped %>%
  unite(season_team, Season, pitching_team, sep = " ") %>%
  filter(season_team %in% bottom_10_names$names) %>%
  ggplot(aes(first_half_K_BB_perc_plus, second_half_mean_gmLI, text = pitcher_subbed_in)) +
  geom_point() +
  facet_wrap(vars(season_team), scales = "free_x") +
  ggtitle("Worst Bullpen Usage")

ggplotly(top_10_plt, tooltip = c("text", "first_half_K_BB_perc_plus", "second_half_mean_gmLI"))

ggplotly(bottom_10_plt, tooltip = c("text", "first_half_K_BB_perc_plus", "second_half_mean_gmLI"))

# not fair to managers really ... they can't control who's on their roster, so they can't control

# so like 2011 SFG ... Romo was much better as a pitcher than anyone else in the bullpen. yet Wilson and Affeldt got the highest leverage opportunities.
# but 2013 MIA didn't have much of a choice ...
```

