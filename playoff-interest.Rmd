---
title: "playoff-interesst"
output: html_document
date: '`r Sys.Date()`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(baseballr)
library(httr)
library(tidyjson)
library(jsonlite)
library(styler)
library(ggrepel)
library(glue)
library(kableExtra)
select <- dplyr::select
```


```{r echo=FALSE, fig.width=9, message=FALSE, warning=FALSE}

# TODO: will need to update a lot of this for the fact the A's aren't 'Oakland' anymore and their abbreviation is, i think, ATH -- not OAK. 



# get playoff chances from baseball prospectus/PECOTA
pecota_poff <-
  read_html("https://www.baseballprospectus.com/standings/") %>%
  html_elements("table")

poff_chance_pecota <-
  pecota_poff %>%
  pluck(1) %>%
  html_table() %>%
  filter(!str_detect(`AL East`, "AL ")) %>%
  select(team_name = `AL East`, poff_chance = `Playoff%`) %>%
  bind_rows(pecota_poff %>% pluck(2) %>% html_table() %>% filter(!str_detect(`NL East`, "NL ")) %>% select(team_name = `NL East`, poff_chance = `Playoff%`)) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "LAD") ~ "Los Angeles Dodgers",
      str_detect(team_name, "NYY") ~ "New York Yankees",
      str_detect(team_name, "Baltimore") ~ "Baltimore Orioles",
      str_detect(team_name, "BOS") ~ "Boston Red Sox",
      str_detect(team_name, "TOR") ~ "Toronto Blue Jays",
      str_detect(team_name, "Tampa Bay") ~ "Tampa Bay Rays",
      str_detect(team_name, "CLE") ~ "Cleveland Guardians",
      str_detect(team_name, "Minnesota") ~ "Minnesota Twins",
      str_detect(team_name, "CWS") ~ "Chicago White Sox",
      str_detect(team_name, "Detroit") ~ "Detroit Tigers",
      str_detect(team_name, "Kansas") ~ "Kansas City Royals",
      str_detect(team_name, "Houston") ~ "Houston Astros",
      str_detect(team_name, "LAA") ~ "Los Angeles Angels",
      str_detect(team_name, "Sacramento") ~ "Athletics",
      str_detect(team_name, "Seattle") ~ "Seattle Mariners",
      str_detect(team_name, "Washington") ~ "Washington Nationals",
      str_detect(team_name, "Miami") ~ "Miami Marlins",
      str_detect(team_name, "NYM") ~ "New York Mets",
      str_detect(team_name, "Philadelphia") ~ "Philadelphia Phillies",
      str_detect(team_name, "CHC") ~ "Chicago Cubs",
      str_detect(team_name, "Pittsburgh") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Milwaukee") ~ "Milwaukee Brewers",
      str_detect(team_name, "Cincinnati") ~ "Cincinnati Reds",
      str_detect(team_name, "Texas") ~ "Texas Rangers",
      str_detect(team_name, "San Diego") ~ "San Diego Padres",
      str_detect(team_name, "San Francisco") ~ "San Francisco Giants",
      str_detect(team_name, "St. Louis") ~ "St. Louis Cardinals",
      str_detect(team_name, "Colorado") ~ "Colorado Rockies",
      str_detect(team_name, "Atlanta") ~ "Atlanta Braves",
      str_detect(team_name, "Arizona") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    ),
    poff_chance = as.numeric(str_extract(poff_chance, "[:digit:]{1,3}\\.[:digit:]{1}"))
  )

# get odds from teamrankings.com

poff_chance_teamrankings <-
  read_html("https://www.teamrankings.com/mlb/") %>%
  html_elements("table") %>%
  pluck(1) %>%
  html_table() %>%
  mutate(
    team_name = str_replace_all(Team, c(
      "LA Dodgers" = "Los Angeles Dodgers",
      "NY Yankees" = "New York Yankees",
      "Houston" = "Houston Astros",
      "Toronto" = "Toronto Blue Jays",
      "NY Mets" = "New York Mets",
      "Atlanta" = "Atlanta Braves",
      "Philadelphia" = "Philadelphia Phillies",
      "Tampa Bay" = "Tampa Bay Rays",
      "San Diego" = "San Diego Padres",
      "Chi Sox" = "Chicago White Sox",
      "Milwaukee" = "Milwaukee Brewers",
      "Seattle" = "Seattle Mariners",
      "St. Louis" = "St. Louis Cardinals",
      "Boston" = "Boston Red Sox",
      "Minnesota" = "Minnesota Twins",
      "LA Angels" = "Los Angeles Angels",
      "SF Giants" = "San Francisco Giants",
      "Cleveland" = "Cleveland Guardians",
      "Texas" = "Texas Rangers",
      "Miami" = "Miami Marlins",
      "Baltimore" = "Baltimore Orioles",
      "Chi Cubs" = "Chicago Cubs",
      "Arizona" = "Arizona Diamondbacks",
      "Cincinnati" = "Cincinnati Reds",
      "Detroit" = "Detroit Tigers",
      "Kansas City" = "Kansas City Royals",
      "Sacramento" = "Athletics",
      "Colorado" = "Colorado Rockies",
      "Washington" = "Washington Nationals",
      "Pittsburgh" = "Pittsburgh Pirates"
    )),
    team_name = str_extract(team_name, ".*[a-z]"),
    poff_chance = as.numeric(str_extract(Playoffs, "[:digit:]{1,3}\\.[:digit:]{1}"))
  ) %>%
  select(team_name, poff_chance)

# # get odds from numberFire
# numberfire <-
#   read_html("https://www.numberfire.com/mlb/teams/power-rankings") %>%
#   html_elements("table") %>%
#   html_table()
# 
# poff_chance_numberfire <-
#   numberfire %>%
#   pluck(1) %>%
#   bind_cols(
#     numberfire %>%
#       pluck(2)
#   ) %>%
#   mutate(
#     team_name = str_extract(Team, ".*[a-z]"),
#     poff_chance = as.numeric(str_extract(Playoffs, "[:digit:]{1,3}\\.[:digit:]{1}"))
#   ) %>%
#   select(team_name, poff_chance)

# get FG playoff odds
headers <- c(
  "user-agent" = "Mozilla/5.0",
  "content-type" = "application/json;charset=UTF-8"
)

url <- glue("https://www.fangraphs.com/api/playoff-odds/odds?dateEnd={Sys.Date()}&dateDelta=&projectionMode=2&standingsType=div")

poff_chances_fg <-
  GET(url, add_headers(headers)) %>%
  content() %>%
  as_tbl_json() %>%
  # gather_array() %>%
  spread_all() %>%
  select(abbName, poff_chance = endData.poffTitle) %>%
  mutate(poff_chance = round(poff_chance, 3) * 100) %>%
  as_tibble() %>%
  mutate(team_name = case_when(
    abbName == "LAA" ~ "Los Angeles Angels",
    abbName == "BAL" ~ "Baltimore Orioles",
    abbName == "BOS" ~ "Boston Red Sox",
    abbName == "CHW" ~ "Chicago White Sox",
    abbName == "CLE" ~ "Cleveland Guardians",
    abbName == "DET" ~ "Detroit Tigers",
    abbName == "KCR" ~ "Kansas City Royals",
    abbName == "MIN" ~ "Minnesota Twins",
    abbName == "NYY" ~ "New York Yankees",
    abbName == "ATH" ~ "Athletics",
    abbName == "SEA" ~ "Seattle Mariners",
    abbName == "TBR" ~ "Tampa Bay Rays",
    abbName == "TEX" ~ "Texas Rangers",
    abbName == "TOR" ~ "Toronto Blue Jays",
    abbName == "ARI" ~ "Arizona Diamondbacks",
    abbName == "ATL" ~ "Atlanta Braves",
    abbName == "CHC" ~ "Chicago Cubs",
    abbName == "CIN" ~ "Cincinnati Reds",
    abbName == "COL" ~ "Colorado Rockies",
    abbName == "MIA" ~ "Miami Marlins",
    abbName == "HOU" ~ "Houston Astros",
    abbName == "LAD" ~ "Los Angeles Dodgers",
    abbName == "MIL" ~ "Milwaukee Brewers",
    abbName == "WSN" ~ "Washington Nationals",
    abbName == "NYM" ~ "New York Mets",
    abbName == "PHI" ~ "Philadelphia Phillies",
    abbName == "PIT" ~ "Pittsburgh Pirates",
    abbName == "STL" ~ "St. Louis Cardinals",
    abbName == "SFG" ~ "San Francisco Giants",
    abbName == "SDP" ~ "San Diego Padres",
  )) %>%
  select(team_name, poff_chance)

# get today' schedule
todays_games <-
  mlb_schedule(season = 2025) %>%
  filter(date == Sys.Date()) %>%
  select(contains("team_name"))

# get playoff odds from clay davenport's forecast site
playoff_davenport <- read_html("http://www.claydavenport.com/stats/ps_oddspec.html") %>%
  html_elements("pre") %>%
  html_text2() %>%
  str_split("\n")

# the above returns a list of data frames. iterate through them and pull out the information
playoff_chances_davenport <-
  playoff_davenport %>%
  map_df(function(x) {
    pluck(x) %>% 
      as_tibble() %>%
      filter(row_number() > 3) %>%
      separate_wider_delim(cols = value, names = c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine"), delim = regex("\\s{2,}"), too_few = "align_end") %>%
      filter(one != "") %>%
      select(team_name = one, poff_chance = nine) %>%
      mutate(poff_chance = as.numeric(poff_chance)) %>%
      filter(!is.na(poff_chance))
  }) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "Dodgers") ~ "Los Angeles Dodgers",
      str_detect(team_name, "Yankees") ~ "New York Yankees",
      str_detect(team_name, "Orioles") ~ "Baltimore Orioles",
      str_detect(team_name, "Red Sox") ~ "Boston Red Sox",
      str_detect(team_name, "Blue Jays") ~ "Toronto Blue Jays",
      str_detect(team_name, "Rays") ~ "Tampa Bay Rays",
      str_detect(team_name, "Guardians") ~ "Cleveland Guardians",
      str_detect(team_name, "Twins") ~ "Minnesota Twins",
      str_detect(team_name, "White Sox") ~ "Chicago White Sox",
      str_detect(team_name, "Tigers") ~ "Detroit Tigers",
      str_detect(team_name, "Royals") ~ "Kansas City Royals",
      str_detect(team_name, "Astros") ~ "Houston Astros",
      str_detect(team_name, "Angels") ~ "Los Angeles Angels",
      str_detect(team_name, "Athletics") ~ "Athletics",
      str_detect(team_name, "Mariners") ~ "Seattle Mariners",
      str_detect(team_name, "Nationals") ~ "Washington Nationals",
      str_detect(team_name, "Marlins") ~ "Miami Marlins",
      str_detect(team_name, "Mets") ~ "New York Mets",
      str_detect(team_name, "Phillies") ~ "Philadelphia Phillies",
      str_detect(team_name, "Cubs") ~ "Chicago Cubs",
      str_detect(team_name, "Pirates") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Brewers") ~ "Milwaukee Brewers",
      str_detect(team_name, "Reds") ~ "Cincinnati Reds",
      str_detect(team_name, "Rangers") ~ "Texas Rangers",
      str_detect(team_name, "Padres") ~ "San Diego Padres",
      str_detect(team_name, "Giants") ~ "San Francisco Giants",
      str_detect(team_name, "Cardinals") ~ "St. Louis Cardinals",
      str_detect(team_name, "Rockies") ~ "Colorado Rockies",
      str_detect(team_name, "Braves") ~ "Atlanta Braves",
      str_detect(team_name, "Diamondbacks") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    )
  )


poff_chances <-
  playoff_chances_davenport |>
  inner_join(poff_chances_fg, by = "team_name", suffix = c("_davenport", "_fg")) |>
  select(team_name, poff_chance_davenport, poff_chance_fg) %>%
#  inner_join(poff_chance_numberfire, by = "team_name") %>%
 # select(team_name, poff_chance_davenport, poff_chance_fg, poff_chance_numberfire = poff_chance) %>%
  inner_join(poff_chance_teamrankings, by = "team_name") %>%
  select(team_name, poff_chance_davenport, poff_chance_fg, poff_chance_teamrankings = poff_chance) %>%
  inner_join(poff_chance_pecota, by = "team_name") %>%
  select(team_name, poff_chance_davenport, poff_chance_fg, poff_chance_teamrankings, poff_chance_pecota = poff_chance) %>%
  pivot_longer(-team_name, names_to = "site", values_to = "poff_chance")

poff_chances_today <-
  poff_chances %>%
  group_by(team_name) %>%
  summarize(median_poff_chance = round(median(poff_chance), 1)) %>%
  mutate(
    # compute 'interest' based off playoff chances. teams closer to 50% should be more interesting, and higher scores should be more interessting
    interest = 50 - abs(50 - median_poff_chance)
  )


sched <-
  todays_games %>%
  inner_join(poff_chances_today, by = c("teams_away_team_name" = "team_name")) %>%
  select(contains("team"), poff_chance_away = median_poff_chance, interest_away = interest) %>%
  inner_join(poff_chances_today, by = c("teams_home_team_name" = "team_name")) %>%
  select(contains("team"), poff_chance_away, interest_away, poff_chance_home = median_poff_chance, interest_home = interest) %>%
  mutate(
    interest_game = interest_away + interest_home, # simple addition suggested by https://www.reddit.com/user/daedeloth86/
    interest_plus = round(interest_game / mean(interest_game) * 100, 0),
  ) %>%
  arrange(desc(interest_plus)) %>%
  select(teams_away_team_name, teams_home_team_name, interest_plus, interest_game, everything())

sched

# minimum interest score (most interesting) = 0
# maximum = 50


# take the current playoff chances, add the date, bind all the rows from the existing disk file, then save the new combined/appended file


poff_chances_clean <-
  poff_chances %>%
  mutate(
    site = case_when(
      site == "poff_chance_davenport" ~ "Clay Davenport",
      site == "poff_chance_fg" ~ "FanGraphs",
      site == "poff_chance_teamrankings" ~ "TeamRankings.com",
      site == "poff_chance_pecota" ~ "Baseball Prospectus (PECOTA)",
    ),
    division = case_when(
      str_detect(team_name, "Orioles|Red Sox|Yankees|Blue Jays|Rays") ~ "AL East",
      str_detect(team_name, "White Sox|Twins|Tigers|Royals|Guardians") ~ "AL Central",
      str_detect(team_name, "Astros|Athletics|Angels|Rangers|Mariners") ~ "AL West",
      str_detect(team_name, "Mets|Phillies|Marlins|Braves|Nationals") ~ "NL East",
      str_detect(team_name, "Pirates|Reds|Brewers|Cardinals|Cubs") ~ "NL Central",
      str_detect(team_name, "Dodgers|Padres|Rockies|Diamondbacks|Giants") ~ "NL West"
    ),
    league = if_else(str_detect(division, "AL"), "American League", "National League")
  ) %>%
  group_by(team_name) %>%
  mutate(median_poff_chance = median(poff_chance)) %>%
  ungroup()

poff_chances_clean |>
  distinct(team_name, league, median_poff_chance) |>
  mutate(median_poff_chance = round(median_poff_chance, 1)) |>
  mutate(label = glue("{team_name}: {median_poff_chance}%")) |>
  ggplot(aes(x = reorder(label, median_poff_chance), y = median_poff_chance)) +
  geom_col() +
  coord_flip() +
  labs(y = "Playoff Chance (%)", x = "", caption = "Playoff chances: median of FG, BPro, Clay Davenport, and TeamRankings") +
  geom_hline(yintercept = 50, lty = "dashed") +
  facet_wrap(vars(league), scales = "free_y") +
  ggtitle("MLB Team Playoff Chances", subtitle = glue("Prior to Games Played on {Sys.Date()}"))

ggsave("playoff_chances.png")

# append data to disk
poff_chances_clean |>
  mutate(prediction_date = Sys.Date()) |>
  select(prediction_date, everything(), -median_poff_chance) |>
  write_csv(file = "playoff_chances_2025.csv", append = FALSE)

# compute playoff chances change between the start of the season and the current date

poff_chance_change <-
  read_csv("playoff_chances_2025.csv") |>
  # 2025 season only
  filter(prediction_date >= "2025-03-27") |>
  group_by(team_name, prediction_date) |>
  summarize(median_poff_chance = median(poff_chance)) |>
  filter(prediction_date == min(prediction_date) | prediction_date == max(prediction_date)) |>
  mutate(prediction_date = if_else(prediction_date == min(prediction_date), "start", "current")) |>
  pivot_wider(names_from = prediction_date, values_from = median_poff_chance) |>
  mutate(change = current - start) |>
  arrange(desc(change))

poff_chance_change |>
  mutate(abbrev = case_when(
    str_detect(team_name, "Giants") ~ "SFG",
    str_detect(team_name, "Red Sox") ~ "BOS",
    str_detect(team_name, "Pirates") ~ "PIT",
    str_detect(team_name, "Padres") ~ "SDP",
    str_detect(team_name, "Orioles") ~ "BAL",
    str_detect(team_name, "Dodgers") ~ "LAD",
    str_detect(team_name, "Diamondbacks") ~ "ARI",
    str_detect(team_name, "Twins") ~ "MIN",
    str_detect(team_name, "Rays") ~ "TBR",
    str_detect(team_name, "Angels") ~ "LAA",
    str_detect(team_name, "Giants") ~ "SFG",
    str_detect(team_name, "Braves") ~ "ATL",
    str_detect(team_name, "Rangers") ~ "TEX",
    str_detect(team_name, "Tigers") ~ "DET",
    str_detect(team_name, "Reds") ~ "CIN",
    str_detect(team_name, "Rockies") ~ "COL",
    str_detect(team_name, "Nationals") ~ "WAS",
    str_detect(team_name, "Athletics") ~ "ATH",
    str_detect(team_name, "Royals") ~ "KCR",
    str_detect(team_name, "Cubs") ~ "CHC",
    str_detect(team_name, "Astros") ~ "HOU",
    str_detect(team_name, "Phillies") ~ "PHI",
    str_detect(team_name, "Blue Jays") ~ "TOR",
    str_detect(team_name, "Mariners") ~ "SEA",
    str_detect(team_name, "Marlins") ~ "MIA",
    str_detect(team_name, "White Sox") ~ "CHW",
    str_detect(team_name, "Brewers") ~ "MIL",
    str_detect(team_name, "Guardians") ~ "CLE",
    str_detect(team_name, "Yankees") ~ "NYY",
    str_detect(team_name, "Mets") ~ "NYM",
    str_detect(team_name, "Cardinals") ~ "STL",
    TRUE ~ NA_character_
  )) |>
  ggplot(aes(change, current)) +
  geom_label_repel(aes(label = abbrev), max.overlaps = 20) +
  geom_point() +
  ggtitle("Playoff Chances & Changes",
    subtitle = glue("From 2025-03-28 to {Sys.Date()}")
  ) +
  labs(
    x = "Change Since March 28th, 2024 (percentage points)", y = "Current Playoff Chance (%)",
    caption = "Playoff chances: median of FG, BPro, Clay Davenport, Numberfire, and TeamRankings"
  ) +
  geom_hline(yintercept = 50, lty = "dashed", color = "gray") +
  geom_vline(xintercept = 0, lty = "dashed", color = "gray")
# xlim(-80, 80) # TODO: figure out boundaries by taking the max & min change values and making those even somehwo

ggsave("playoff-change-change.png")

# TODO idea for next year: also save the interest_game and interest_plus scores for each day of the season. then we can look back and see what the most impactful games were.
```


```{r, fig.width = 10}
abbrev <- "BAL"
season <- "2024"

data <-
  read_html(glue("https://www.baseball-reference.com/teams/{abbrev}/{season}-schedule-scores.shtml")) |>
  html_table() |>
  pluck(1) |>
  select(Date, R, RA) |>
  mutate(runs_scored = as.integer(R), runs_allowed = as.integer(RA)) |>
  filter(!is.na(runs_scored)) |>
  mutate(
    rdif = runs_scored - runs_allowed,
    date = as.Date(strptime(Date, "%A, %B %d"))
  ) |>
  select(date, runs_scored, runs_allowed, rdif) |>
  mutate(
    runs_7 = (runs_scored + lag(runs_scored) + lag(runs_scored, 2) + lag(runs_scored, 3) + lag(runs_scored, 4) + lag(runs_scored, 5) + lag(runs_scored, 6)) / 7,
    runs_allowed_7 = (runs_allowed + lag(runs_allowed) + lag(runs_allowed, 2) + lag(runs_allowed, 3) + lag(runs_allowed, 4) + lag(runs_allowed, 5) + lag(runs_allowed, 6)) / 7,
    rdif_7 = (rdif + lag(rdif) + lag(rdif, 2) + lag(rdif, 3) + lag(rdif, 4) + lag(rdif, 5) + lag(rdif, 6)) / 7
  )

# compute season summary metrics
num_games <- nrow(data)
rpg <- round(sum(data$runs_scored) / num_games, 1)
rag <- round(sum(data$runs_allowed) / num_games, 1)

data |>
  pivot_longer(runs_7:rdif_7, names_to = "metric") |>
  select(date, metric, value) |>
  mutate(metric_set = if_else(metric %in% c("runs_7", "runs_allowed_7"), "Runs Scored vs. Allowed", "Run Differential")) |>
  ggplot(aes(date, value, group = metric, color = metric)) +
  geom_path() +
  ggtitle(glue("{abbrev} {season} Season ({num_games} Games)"),
    subtitle = glue("7 game moving average of runs scored/game, runs allowed/game, and run differential
              Overall: {rpg} runs scored per game, {rag} runs allowed per game")
  ) +
  expand_limits(y = 0) +
  labs(y = "", x = "", caption = "Source: Baseball Reference") +
  facet_grid(vars(metric_set), scales = "free_y") +
  geom_hline(yintercept = 0, lty = "dashed")

ggsave(glue("{abbrev}-{season}-rs-ra-7dma.png"), width = 7)
```


```{r}



end_date <- Sys.Date()

#duran_duran <- statcast_search_pitchers("2022-03-28", end_date, 661395, "pitcher")

# adley
player <- 668939

player_data <-
  statcast_search_batters("2024-03-28", end_date, player, "batter")


# player_data |>
#   filter(
#     !is.na(events),
#     events != "",
#     events != "caught_stealing_2b"
#   ) |>
#   mutate(outcome = if_else(description == "hit_into_play", bb_type, events),
#     outcome = if_else(str_detect(events, "strikeout"), "strikeout", outcome)) |>
#   count(outcome) |>
#   mutate(pct = n / sum(n) * 100)

player_data |>
  mutate(half = if_else(game_date <= "2024-07-16", "Pre-ASB", "Post-ASB")) |>
  group_by(half) |>
  summarize(
    mean_la = mean(launch_angle, na.rm = TRUE),
    mean_ls = mean(launch_speed, na.rm = TRUE),
    p95ev = quantile(launch_speed, .95, na.rm = TRUE),
    mean_batspeed = mean(bat_speed, na.rm = TRUE),
    mean_swinglength = mean(swing_length, na.rm = TRUE),
    mean_hitdistance = mean(hit_distance_sc, na.rm = TRUE),
    #     woba = round(mean(woba_value, na.rm = TRUE) / mean(woba_denom, na.rm = TRUE), 3),
    xwoba = round(mean(estimated_woba_using_speedangle, na.rm = TRUE), 3),
    mean_platez = mean(plate_z, na.rm = TRUE)
  )


player_data |>
  filter(
    !is.na(events),
    events != "",
    events != "caught_stealing_2b"
  ) |>
  select(game_date, description, events, bb_type) |>
  mutate(
    game_date = as.Date(game_date),
    month = month(game_date, label = TRUE),
    outcome = if_else(description == "hit_into_play", bb_type, events),
    outcome = if_else(str_detect(events, "strikeout"), "strikeout", outcome)
  ) |> # collapse 2 strikeout outcomes
  count(month, outcome) |>
  complete(month, outcome, fill = list(n = 0)) |>
  filter(month %in% c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep")) |>
  group_by(month) |>
  mutate(pct = n / sum(n) * 100) |>
  ggplot(aes(month, pct, group = outcome, fill = outcome, color = outcome)) +
  geom_path() +
  geom_point() +
  labs(x = "", y = "Percentage of PA Outcomes", caption = "Source: Statcast") +
  ggtitle("Adley Rutschman PA Outcomes, by Month", subtitle = glue("2024 Season through {end_date - 1}"))
```

note the increase in pop-ups. average LA increased from 19.7 degrees to 24.2 degrees. it doesn't matter how hard you hit it, if it's straight up in the air it'll be an easy out. 

```{r}
# iffb first half, min 200 PA
read_csv("~/Downloads/fangraphs-leaderboards-15.csv") |>
  mutate(pct = percent_rank(`IFFB%`)) |>
  filter(Name == "Adley Rutschman")

# iffb second half, min 150 PA
read_csv("~/Downloads/fangraphs-leaderboards-16.csv") |>
  mutate(pct = percent_rank(`IFFB%`)) |>
  filter(Name == "Adley Rutschman")
```


he seems to have compensated a bit on his swing. bat speed is down a hair from 67.7 MPH to 67.3 MPH. and the swing length is dowm from 6.9 MPH to 6.8. 



but he's also getting a bit unlucky.


woba, xwoba
pre-asb: .337, .336 (gap of .001). https://baseballsavant.mlb.com/statcast_search?hfPT=&hfAB=&hfGT=R%7C&hfPR=&hfZ=&hfStadium=&hfBBL=&hfNewZones=&hfPull=&hfC=&hfSea=2024%7C&hfSit=&player_type=batter&hfOuts=&hfOpponent=&pitcher_throws=&batter_stands=&hfSA=&game_date_gt=&game_date_lt=2024-07-16&hfMo=&hfTeam=&home_road=&hfRO=&position=&hfInfield=&hfOutfield=&hfInn=&hfBBT=&hfFlag=&metric_1=&group_by=name&min_pitches=0&min_results=0&min_pas=100&sort_col=wobadiff&player_event_sort=api_p_release_speed&sort_order=desc&chk_stats_woba=on&chk_stats_xwoba=on&chk_stats_wobadiff=on#results

this gap is in the 64th percentile of hitters with 100 PA before the break. 

```{r}
read_csv("~/Downloads/savant_data-29.csv") |>
  mutate(
    woba_minus_x = woba - xwoba,
    ptile = percent_rank(woba_minus_x)
  ) |>
  View()
```


post-asb: .257, .291 (gap of -.034)

the latter gap is 8th percentile of hitters with 100 PA since the break. https://baseballsavant.mlb.com/statcast_search?hfPT=&hfAB=&hfGT=R%7C&hfPR=&hfZ=&hfStadium=&hfBBL=&hfNewZones=&hfPull=&hfC=&hfSea=2024%7C&hfSit=&player_type=batter&hfOuts=&hfOpponent=&pitcher_throws=&batter_stands=&hfSA=&game_date_gt=2024-07-16&game_date_lt=&hfMo=&hfTeam=&home_road=&hfRO=&position=&hfInfield=&hfOutfield=&hfInn=&hfBBT=&hfFlag=&metric_1=&group_by=name&min_pitches=0&min_results=0&min_pas=100&sort_col=wobadiff&player_event_sort=api_p_release_speed&sort_order=desc&chk_stats_woba=on&chk_stats_xwoba=on&chk_stats_wobadiff=on#results


```{r}
read_csv("~/Downloads/savant_data-30.csv") |>
  mutate(
    woba_minus_x = woba - xwoba,
    ptile = percent_rank(woba_minus_x)
  ) |>
  View()
```




```{r}
# arson judge
read_csv("~/Downloads/savant_data-26.csv", show_col_types = FALSE) |>
  mutate(
    game_date = as.Date(game_date),
    month = month(game_date, label = TRUE),
    outcome = if_else(description == "hit_into_play", bb_type, events)
  ) |>
  count(month, outcome) |>
  complete(month = c("Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep"), outcome, fill = list(n = 0)) |>
  group_by(month) |>
  mutate(pct = n / sum(n) * 100) |>
  ggplot(aes(month, pct, group = outcome, color = outcome)) +
  geom_path() +
  geom_point() +
  labs(x = "", y = "Percentage of PA Outcomes", caption = "Source: Baseball Savant") +
  ggtitle("Aaron Judge PA Outcomes, by Month", subtitle = "2024 Season through Sept 6th")
```
 
```{r} 
# all orioles
read_csv("~/Downloads/savant_data-27.csv", show_col_types = FALSE) |>
  mutate(
    game_date = as.Date(game_date),
    month = month(game_date, label = TRUE),
    outcome = if_else(description == "hit_into_play", bb_type, events),
    outcome = if_else(str_detect(events, "strikeout"), "strikeout", outcome), # combine 'strikeout' and 'SO DP'
    half = if_else(game_date <= "2024-07-16", "Pre-ASB", "Post-ASB"),
    half = factor(half, labels = c("Pre-ASB", "Post-ASB"))
  ) |>
  count(month, outcome) |>
  group_by(month) |>
  mutate(pct = n / sum(n) * 100) |>
  ggplot(aes(month, pct, group = outcome, fill = outcome)) +
  geom_area() +
  labs(x = "", y = "Percentage of PA Outcomes", caption = "Source: Baseball Savant") +
  ggtitle("Orioles PA Outcomes, by Month", subtitle = "2024 Season through Sept 6th")
```


```{r}
player <- "craig-kimbrel/6655"

read_html(glue("https://www.fangraphs.com/players/{player}/game-log?position=P&gds=&gde=&season=2024&type=5")) |>
  html_table() |>
  pluck(10) |>
  select(Date, gmli = `gmLIgmLI - Average Leverage Index when entering the game`) |>
  mutate(
    gmli = as.numeric(gmli),
    Date = as.Date(strptime(Date, "%Y-%m-%d"))
  ) |>
  filter(!is.na(Date)) |>
  ggplot(aes(Date, gmli)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ggtitle("Craig Kimbrel, 2024 Season, Leverage Index when Entering Game") +
  labs(y = "Leverage Index when Entering Game", caption = "Source: FanGraphs")
```




```{r}
riggs_stats <-
  read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1921") |>
  html_table() |>
  pluck(5) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1922") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1923") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1924") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1925") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1926") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1927") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1928") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1929") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1930") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1931") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1932") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1933") |>
    html_table() |>
    pluck(5)) |>
  bind_rows(read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1934") |>
    html_table() |>
    pluck(5))


riggs_stats |>
  select(H, AB) |>
  filter(
    H != "H",
    AB != "AB",
    AB != 0
  ) |> # remove annual total rows from data
  mutate(
    H = as.numeric(H),
    AB = as.numeric(AB)
  ) |>
  filter(AB < 15) |>
  mutate(
    game = row_number(),
    AVG = H / AB,
    AVG_career = cumsum(H) / cumsum(AB)
  ) |>
  ggplot(aes(game, AVG_career)) +
  geom_point() +
  geom_path() +
  geom_hline(yintercept = 0.3, lty = "dashed", color = "gray") +
  ylim(0, 0.7)

read_html("https://www.baseball-reference.com/players/gl.fcgi?id=stephri01&t=b&year=1926") |>
  html_table() |>
  pluck(5) |>
  select(H, AB) |>
  filter(
    H != "H",
    AB != "AB",
    AB != 0
  ) |> # remove annual total rows from data
  mutate(
    H = as.numeric(H),
    AB = as.numeric(AB)
  ) |>
  filter(AB < 15) |>
  mutate(
    game = row_number(),
    AVG = H / AB,
    AVG_career = cumsum(H) / cumsum(AB)
  ) |>
  ggplot(aes(game, AVG_career)) +
  geom_point() +
  geom_path() +
  geom_hline(yintercept = 0.3, lty = "dashed", color = "gray") +
  ylim(0, 0.7)
```





# make tweet

```{r}
# TODO: make twitter handles for each team via mutate,

tweet_data <-
  sched %>%
  filter(row_number() == 1) %>%
  inner_join(twitter_handles, by = c("teams_away_team_name" = "team_name")) %>%
  select(everything(), away_handle = handle) %>%
  inner_join(twitter_handles, by = c("teams_home_team_name" = "team_name")) %>%
  select(everything(), home_handle = handle)


away <- tweet_data$teams_away_team_name
away_pct <- tweet_data$poff_chance_away
away_handle <- tweet_data$away_handle

home <- tweet_data$teams_home_team_name
home_pct <- tweet_data$poff_chance_home
home_handle <- tweet_data$home_handle

interest <- tweet_data$interest_game
interest_plus <- tweet_data$interest_plus

playoff_start <- "2023-10-07"

tweet <- glue("Good morning! The @MLB playoffs start in {difftime(playoff_start, Sys.Date(), units = 'days') %>% floor() %>% as.numeric()} days. The current playoff picture is attached.

Most impactful game today: {away_handle} ({away_pct %>% round(0)}% chance) at {home_handle} ({home_pct %>% round(0)}%).

Srcs: @fangraphs @baseballpro Clay Davenport @ESPN @numberFire @teamRankings")

tweet
nchar(tweet)
```
```{r}
sched %>%
  select(Visitor = teams_away_team_name, `Visitor Playoff Chance (%)` = poff_chance_away, `Home Team` = teams_home_team_name, `Home Team Playoff Chance (%)` = poff_chance_home, Interest = interest_game, `Interest+` = interest_plus) %>%
  mutate(across(where(is.numeric), ~ round(.x, 0))) %>%
  kbl(align = "c") %>%
  kable_classic()
```

tweet form:

"Full list of matchups & playoff chances. Chances closer to 50% are more interesting
Orioles (15%) at Rays (48%)
Brewers (64%) at Cardinals (77%)
Guardians (62%) at Blue Jays (85%)
Twins (48%) at Angels (0%)
Tigers(0%) at White Sox (42%)

```{r}
foo <-
  mlb_schedule(season = 2023) %>%
  filter(date == Sys.Date()) |>
  mutate(
    game_start = as_datetime(game_date, tz = "US/Eastern"),
    start_hour = hour(game_start)
  ) |>
  select(contains("team_name"), game_start, start_hour)

first_hour_start <- foo |>
  filter(row_number() == 1) |>
  pull(start_hour)

foo |>
  mutate(
    hrs_from_start = start_hour - first_hour_start,
    mod = start_hour - first_hour_start %% 2,
    chunk = case_when(
      hrs_from_start < 2 ~ "One",
      hrs_from_start < 4 ~ "Two",
      hrs_from_start < 6 ~ "Three",
      hrs_from_start < 8 ~ "Four",
      hrs_from_start < 10 ~ "Five",
      hrs_from_start < 12 ~ "Six"
    )
  )


# goal is to separate out chunks of games starting more than 2 hours apart

# |>
#   mutate(start_class = case_when(
#     start_hour < 12 ~ "Morning",
#     between(start_hour, 12, 16) ~ "Afternoon",
#     between(start_hour, 17, 19) ~ "Evening",
#     start_hour > 19 ~ "Night"
#   ))
```

```{r}
read_html("https://ans.mlb.com/b/ss/mlbglobal08,mlbcom08/1/H.27.4/s7244009547094?AQB=1&ndh=1&t=13%2F3%2F2023%2018%3A50%3A49%204%20300&mid=90337289130997972743705511536346669406&ce=UTF-8&ns=mlb&pageName=Baseballsavant.com%20Site%3A%20Statcast%20Expected%20wOBA%2C%20xBA%2C%20xSLG&g=https%3A%2F%2Fbaseballsavant.mlb.com%2Fleaderboard%2Fexpected_statistics%3Ftype%3Dpitcher&r=https%3A%2F%2Fbaseballsavant.mlb.com%2Fleaderboard%2Fstatcast%3Ftype%3Dpitcher&cc=USD&ch=Baseballsavant.com%20Site&events=event4&c1=Baseballsavant.com%20Site&c24=mlbglobal08%2Cmlbcom08&c35=4%2F13%2F2023%2019%3A50%3A49&c64=D%3Ds_vi&v64=D%3Ds_vi&s=1680x1050&c=24&j=1.6&v=N&k=Y&bw=1563&bh=554&p=PDF%20Viewer%3BChrome%20PDF%20Viewer%3BChromium%20PDF%20Viewer%3BMicrosoft%20Edge%20PDF%20Viewer%3BWebKit%20built-in%20PDF%3B&AQE=1")
```

```{r}
read_csv("~/Downloads/fangraphs-leaderboards-3.csv") |>
  select(Season, PlayerId, Name, PA, G, Off) |>
  filter(PA <= 520, Off >= 40) |>
  arrange(desc(Off))
```

```{r}
read_csv("~/Downloads/Export_4D34B5232574DEED7FE868804D7A726391A35894.csv") |>
  filter(
    `Is_Member?` == "Yes",
    Primary_Group == "Chapter: TX-Rogers Hornsby (Austin/San Antonio)"
  ) |>
  summarize(foo = str_flatten(Email_Address, collapse = ", "))
```

```{r}
read_csv("~/Downloads/fangraphs-leaderboards-14.csv") |>
  select(Name, `WPA/LI`, `K-BB%`) |>
  mutate(mean_wpa = mean(`WPA/LI`), mean_kbb = mean(`K-BB%`)) |>
  mutate(wpa_li_plus = 100 * (`WPA/LI` / mean_wpa), k_bb_pct_plus = 100 * (`K-BB%` / mean_kbb), single_metric = k_bb_pct_plus / wpa_li_plus) |>
  View()

#
# ggplot(aes(wpa_li_plus, k_bb_pct_plus)) +
# geom_point() +
# geom_label_repel(aes(label = Name), max.overlaps = 30)
```


```{r}
# bot <- rtweet_app()
# auth_as(bot)
#
# post_tweet(status="testing")
```
