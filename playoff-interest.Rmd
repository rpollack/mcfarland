---
title: "playoff-interesst"
output: html_document
date: '`r Sys.Date()`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(baseballr)
library(httr)
library(jsonlite)
```

```{r}

# get playoff chances from baseball prospectus/PECOTA
pecota_poff <-
  read_html("https://www.baseballprospectus.com/standings/") %>%
  html_elements("table")

poff_chance_pecota <-
  pecota_poff %>%
  pluck(1) %>%
  html_table() %>%
  filter(!str_detect(`AL East`, "AL ")) %>%
  select(team_name = `AL East`, poff_chance = `Playoff%`) %>%
  bind_rows(pecota_poff %>% pluck(2) %>% html_table() %>% filter(!str_detect(`NL East`, "NL ")) %>% select(team_name = `NL East`, poff_chance = `Playoff%`)) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "LAD") ~ "Los Angeles Dodgers",
      str_detect(team_name, "NYY") ~ "New York Yankees",
      str_detect(team_name, "Baltimore") ~ "Baltimore Orioles",
      str_detect(team_name, "BOS") ~ "Boston Red Sox",
      str_detect(team_name, "TOR") ~ "Toronto Blue Jays",
      str_detect(team_name, "Tampa Bay") ~ "Tampa Bay Rays",
      str_detect(team_name, "CLE") ~ "Cleveland Guardians",
      str_detect(team_name, "Minnesota") ~ "Minnesota Twins",
      str_detect(team_name, "CWS") ~ "Chicago White Sox",
      str_detect(team_name, "Detroit") ~ "Detroit Tigers",
      str_detect(team_name, "Kansas") ~ "Kansas City Royals",
      str_detect(team_name, "Houston") ~ "Houston Astros",
      str_detect(team_name, "LAA") ~ "Los Angeles Angels",
      str_detect(team_name, "Oakland") ~ "Oakland Athletics",
      str_detect(team_name, "Seattle") ~ "Seattle Mariners",
      str_detect(team_name, "Washington") ~ "Washington Nationals",
      str_detect(team_name, "Miami") ~ "Miami Marlins",
      str_detect(team_name, "NYM") ~ "New York Mets",
      str_detect(team_name, "Philadelphia") ~ "Philadelphia Phillies",
      str_detect(team_name, "CHC") ~ "Chicago Cubs",
      str_detect(team_name, "Pittsburgh") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Milwaukee") ~ "Milwaukee Brewers",
      str_detect(team_name, "Cincinnati") ~ "Cincinnati Reds",
      str_detect(team_name, "Texas") ~ "Texas Rangers",
      str_detect(team_name, "San Diego") ~ "San Diego Padres",
      str_detect(team_name, "San Francisco") ~ "San Francisco Giants",
      str_detect(team_name, "St. Louis") ~ "St. Louis Cardinals",
      str_detect(team_name, "Colorado") ~ "Colorado Rockies",
      str_detect(team_name, "Atlanta") ~ "Atlanta Braves",
      str_detect(team_name, "Arizona") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    ),
    poff_chance = as.numeric(str_extract(poff_chance, "[:digit:]{1,3}\\.[:digit:]{1}"))
  )

# get odds from teamrankings.com

poff_chance_teamrankings <-
  read_html("https://www.teamrankings.com/mlb/") %>%
  html_elements("table") %>%
  pluck(1) %>%
  html_table() %>%
  mutate(
    team_name = str_replace_all(Team, c(
      "LA Dodgers" = "Los Angeles Dodgers",
      "NY Yankees" = "New York Yankees",
      "Houston" = "Houston Astros",
      "Toronto" = "Toronto Blue Jays",
      "NY Mets" = "New York Mets",
      "Atlanta" = "Atlanta Braves",
      "Philadelphia" = "Philadelphia Phillies",
      "Tampa Bay" = "Tampa Bay Rays",
      "San Diego" = "San Diego Padres",
      "Chi Sox" = "Chicago White Sox",
      "Milwaukee" = "Milwaukee Brewers",
      "Seattle" = "Seattle Mariners",
      "St. Louis" = "St. Louis Cardinals",
      "Boston" = "Boston Red Sox",
      "Minnesota" = "Minnesota Twins",
      "LA Angels" = "Los Angeles Angels",
      "SF Giants" = "San Francisco Giants",
      "Cleveland" = "Cleveland Guardians",
      "Texas" = "Texas Rangers",
      "Miami" = "Miami Marlins",
      "Baltimore" = "Baltimore Orioles",
      "Chi Cubs" = "Chicago Cubs",
      "Arizona" = "Arizona Diamondbacks",
      "Cincinnati" = "Cincinnati Reds",
      "Detroit" = "Detroit Tigers",
      "Kansas City" = "Kansas City Royals",
      "Oakland" = "Oakland Athletics",
      "Colorado" = "Colorado Rockies",
      "Washington" = "Washington Nationals",
      "Pittsburgh" = "Pittsburgh Pirates"
    )),
    team_name = str_extract(team_name, ".*[a-z]"),
    poff_chance = as.numeric(str_extract(Playoffs, "[:digit:]{1,3}\\.[:digit:]{1}"))
  ) %>%
  select(team_name, poff_chance)

# get odds from numberFire
numberfire <-
  read_html("https://www.numberfire.com/mlb/teams/power-rankings") %>%
  html_elements("table") %>%
  html_table()

poff_chance_numberfire <-
  numberfire %>%
  pluck(1) %>%
  bind_cols(
    numberfire %>%
      pluck(2)
  ) %>%
  mutate(
    team_name = str_extract(Team, ".*[a-z]"),
    poff_chance = as.numeric(str_extract(Playoffs, "[:digit:]{1,3}\\.[:digit:]{1}"))
  ) %>%
  select(team_name, poff_chance)

# get FG playoff odds
headers <- c(
  "user-agent" = "Mozilla/5.0",
  "content-type" = "application/json;charset=UTF-8"
)

url <- glue("https://www.fangraphs.com/api/playoff-odds/odds?dateEnd={Sys.Date()}&dateDelta=&projectionMode=2&standingsType=div")

poff_chances_fg <-
  GET(url, add_headers(headers)) %>%
  content() %>%
  as_tbl_json() %>%
  gather_array() %>%
  spread_all() %>%
  select(abbName, poff_chance = endData.poffTitle) %>%
  mutate(poff_chance = round(poff_chance, 2) * 100) %>%
  as_tibble() %>%
  mutate(team_name = case_when(
    abbName == "LAA" ~ "Los Angeles Angels",
    abbName == "BAL" ~ "Baltimore Orioles",
    abbName == "BOS" ~ "Boston Red Sox",
    abbName == "CHW" ~ "Chicago White Sox",
    abbName == "CLE" ~ "Cleveland Guardians",
    abbName == "DET" ~ "Detroit Tigers",
    abbName == "KCR" ~ "Kansas City Royals",
    abbName == "MIN" ~ "Minnesota Twins",
    abbName == "NYY" ~ "New York Yankees",
    abbName == "OAK" ~ "Oakland Athletics",
    abbName == "SEA" ~ "Seattle Mariners",
    abbName == "TBR" ~ "Tampa Bay Rays",
    abbName == "TEX" ~ "Texas Rangers",
    abbName == "TOR" ~ "Toronto Blue Jays",
    abbName == "ARI" ~ "Arizona Diamondbacks",
    abbName == "ATL" ~ "Atlanta Braves",
    abbName == "CHC" ~ "Chicago Cubs",
    abbName == "CIN" ~ "Cincinnati Reds",
    abbName == "COL" ~ "Colorado Rockies",
    abbName == "MIA" ~ "Miami Marlins",
    abbName == "HOU" ~ "Houston Astros",
    abbName == "LAD" ~ "Los Angeles Dodgers",
    abbName == "MIL" ~ "Milwaukee Brewers",
    abbName == "WSN" ~ "Washington Nationals",
    abbName == "NYM" ~ "New York Mets",
    abbName == "PHI" ~ "Philadelphia Phillies",
    abbName == "PIT" ~ "Pittsburgh Pirates",
    abbName == "STL" ~ "St. Louis Cardinals",
    abbName == "SFG" ~ "San Francisco Giants",
    abbName == "SDP" ~ "San Diego Padres",
  )) %>%
  select(team_name, poff_chance)

# get today' schedule
todays_games <-
  mlb_schedule(season = 2022) %>%
  filter(date == Sys.Date()) %>%
  select(contains("team_name"))

# get playoff odds from baseball-reference
playoff_url <- read_html("https://www.baseball-reference.com/leagues/majors/2022-playoff-odds.shtml")

poff_chances_bbref <-
  playoff_url %>%
  html_elements("table") %>%
  pluck(2) %>%
  html_table() %>%
  select(team_name = 2, poff_chance = 20) %>%
  mutate(poff_chance = as.numeric(str_extract(poff_chance, "[:digit:]*\\.[:digit:]"))) %>%
  filter(!is.na(poff_chance))

# get playoff odds from clay davenport's forecast site
playoff_davenport <- read_html("http://www.claydavenport.com/stats/ps_oddspec.html") %>%
  html_elements("pre") %>%
  html_text2() %>%
  str_split("\n")

# the above returns a list of data frames. iterate through them and pull out the information
playoff_chances_davenport <-
  playoff_davenport %>%
  map_df(function(x) {
    pluck(x) %>%
      as_tibble() %>%
      filter(row_number() > 3) %>%
      separate(value, c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine"), sep = "\\s{2,}") %>%
      filter(one != "") %>%
      select(team_name = one, poff_chance = nine) %>%
      mutate(poff_chance = as.numeric(poff_chance)) %>%
      filter(!is.na(poff_chance))
  }) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "Dodgers") ~ "Los Angeles Dodgers",
      str_detect(team_name, "Yankees") ~ "New York Yankees",
      str_detect(team_name, "Orioles") ~ "Baltimore Orioles",
      str_detect(team_name, "Red Sox") ~ "Boston Red Sox",
      str_detect(team_name, "Blue Jays") ~ "Toronto Blue Jays",
      str_detect(team_name, "Rays") ~ "Tampa Bay Rays",
      str_detect(team_name, "Guardians") ~ "Cleveland Guardians",
      str_detect(team_name, "Twins") ~ "Minnesota Twins",
      str_detect(team_name, "White Sox") ~ "Chicago White Sox",
      str_detect(team_name, "Tigers") ~ "Detroit Tigers",
      str_detect(team_name, "Royals") ~ "Kansas City Royals",
      str_detect(team_name, "Astros") ~ "Houston Astros",
      str_detect(team_name, "Angels") ~ "Los Angeles Angels",
      str_detect(team_name, "Athletics") ~ "Oakland Athletics",
      str_detect(team_name, "Mariners") ~ "Seattle Mariners",
      str_detect(team_name, "Nationals") ~ "Washington Nationals",
      str_detect(team_name, "Marlins") ~ "Miami Marlins",
      str_detect(team_name, "Mets") ~ "New York Mets",
      str_detect(team_name, "Phillies") ~ "Philadelphia Phillies",
      str_detect(team_name, "Cubs") ~ "Chicago Cubs",
      str_detect(team_name, "Pirates") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Brewers") ~ "Milwaukee Brewers",
      str_detect(team_name, "Reds") ~ "Cincinnati Reds",
      str_detect(team_name, "Rangers") ~ "Texas Rangers",
      str_detect(team_name, "Padres") ~ "San Diego Padres",
      str_detect(team_name, "Giants") ~ "San Francisco Giants",
      str_detect(team_name, "Cardinals") ~ "St. Louis Cardinals",
      str_detect(team_name, "Rockies") ~ "Colorado Rockies",
      str_detect(team_name, "Braves") ~ "Atlanta Braves",
      str_detect(team_name, "Diamondbacks") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    )
  )


# get odds from 538 and average them with BB-ref odds
playoff_538 <- read_html("https://projects.fivethirtyeight.com/2022-mlb-predictions/")

poff_chances <-
  playoff_538 %>%
  html_table() %>%
  pluck(1) %>%
  select(team_name = 1, poff_chance = 7) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "Dodgers") ~ "Los Angeles Dodgers",
      str_detect(team_name, "Yankees") ~ "New York Yankees",
      str_detect(team_name, "Orioles") ~ "Baltimore Orioles",
      str_detect(team_name, "Red Sox") ~ "Boston Red Sox",
      str_detect(team_name, "Blue Jays") ~ "Toronto Blue Jays",
      str_detect(team_name, "Rays") ~ "Tampa Bay Rays",
      str_detect(team_name, "Guardians") ~ "Cleveland Guardians",
      str_detect(team_name, "Twins") ~ "Minnesota Twins",
      str_detect(team_name, "White Sox") ~ "Chicago White Sox",
      str_detect(team_name, "Tigers") ~ "Detroit Tigers",
      str_detect(team_name, "Royals") ~ "Kansas City Royals",
      str_detect(team_name, "Astros") ~ "Houston Astros",
      str_detect(team_name, "Pirates") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Angels") ~ "Los Angeles Angels",
      str_detect(team_name, "Athletics") ~ "Oakland Athletics",
      str_detect(team_name, "Mariners") ~ "Seattle Mariners",
      str_detect(team_name, "Nationals") ~ "Washington Nationals",
      str_detect(team_name, "Marlins") ~ "Miami Marlins",
      str_detect(team_name, "Mets") ~ "New York Mets",
      str_detect(team_name, "Phillies") ~ "Philadelphia Phillies",
      str_detect(team_name, "Cubs") ~ "Chicago Cubs",
      str_detect(team_name, "Brewers") ~ "Milwaukee Brewers",
      str_detect(team_name, "Reds") ~ "Cincinnati Reds",
      str_detect(team_name, "Rangers") ~ "Texas Rangers",
      str_detect(team_name, "Padres") ~ "San Diego Padres",
      str_detect(team_name, "Giants") ~ "San Francisco Giants",
      str_detect(team_name, "Cardinals") ~ "St. Louis Cardinals",
      str_detect(team_name, "Rockies") ~ "Colorado Rockies",
      str_detect(team_name, "Braves") ~ "Atlanta Braves",
      str_detect(team_name, "Diamondbacks") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    ),
    poff_chance = as.numeric(str_extract(poff_chance, "[:digit:]{1,2}"))
  ) %>%
  filter(!is.na(team_name)) %>%
  inner_join(poff_chances_bbref, by = "team_name", suffix = c("_538", "_bbref")) %>%
  inner_join(playoff_chances_davenport, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport = poff_chance) %>%
  inner_join(poff_chances_fg, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport, poff_chance_fg = poff_chance) %>%
  inner_join(poff_chance_numberfire, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport, poff_chance_fg, poff_chance_numberfire = poff_chance) %>%
  inner_join(poff_chance_teamrankings, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport, poff_chance_fg, poff_chance_numberfire, poff_chance_teamrankings = poff_chance) %>%
  inner_join(poff_chance_pecota, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport, poff_chance_fg, poff_chance_numberfire, poff_chance_teamrankings, poff_chance_pecota = poff_chance) %>%
  pivot_longer(-team_name, names_to = "site", values_to = "poff_chance")

poff_chances_today <-
  poff_chances %>%
  group_by(team_name) %>%
  summarize(median_poff_chance = round(median(poff_chance), 1)) %>%
  mutate(
    # compute 'interest' based off playoff chances. teams closer to 50% should be more interesting, and higher scores should be more interessting
    interest = 50 - abs(50 - median_poff_chance)
  )

sched <- 
  todays_games %>%
  inner_join(poff_chances_today, by = c("teams_away_team_name" = "team_name")) %>%
  select(contains("team"), poff_chance_away = median_poff_chance, interest_away = interest) %>%
  inner_join(poff_chances_today, by = c("teams_home_team_name" = "team_name")) %>%
  select(contains("team"), poff_chance_away, interest_away, poff_chance_home = median_poff_chance, interest_home = interest) %>%
  mutate(
    interest_game = interest_away + interest_home, # simple addition suggested by https://www.reddit.com/user/daedeloth86/
    interest_plus = round(interest_game / mean(interest_game) * 100, 0),
  ) %>%
  arrange(desc(interest_plus)) %>%
  select(teams_away_team_name, teams_home_team_name, interest_plus, interest_game, everything())

sched

# minimum interest score (most interesting) = 0
# maximum = 50
```


```{r, fig.height=3, fig.width=3}
poff_chances %>%
  mutate(site = case_when(
    site == "poff_chance_538" ~ "FiveThirtyEight",
    site == "poff_chance_bbref" ~ "Baseball Reference",
    site == "poff_chance_davenport" ~ "Clay Davenport",
    site == "poff_chance_fg" ~ "FanGraphs",
    site == "poff_chance_numberfire" ~ "numberFire",
    site == "poff_chance_teamrankings" ~ "TeamRankings.com",
    site == "poff_chance_pecota" ~ "Baseball Prospectus (PECOTA)"
  )) %>%
  group_by(team_name) %>%
  mutate(median_poff_chance = median(poff_chance)) %>%
  ungroup() %>%
  ggplot(aes(x = reorder(team_name, median_poff_chance), y = poff_chance)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = site), size = 0.5) +
  coord_flip() +
  labs(y = "Playoff Chance (%)", x = "") +
  geom_hline(yintercept = 50, lty = "dashed") +
  ggtitle("MLB Team Playoff Chances", subtitle = glue("Prior to Games Played on {Sys.Date()}"))


ggsave("playoff_chances.png")
```


# make tweet

```{r}
#TODO: make twitter handles for each team via mutate, 

tweet_data <-
  sched %>% 
  filter(row_number() == 1)

away <- tweet_data$teams_away_team_name
away_pct <- tweet_data$poff_chance_away
away_interest <- tweet_data$interest_away

home <- tweet_data$teams_home_team_name
home_pct <- tweet_data$poff_chance_home
home_interest <- tweet_data$interest_home

interest <- tweet_data$interest_game
interest_plus <- tweet_data$interest_plus

tweet <- glue("Most interesting game today: @CHW at @TEX. Interest score of {interest}

Highes interest score = 50% playoff chance. Teams' scores are summed. Max game score: 100.

CLE score: {round(away_interest, 1)} ({away_pct}% chance)
TEX score: {round(home_interest, 1)} ({home_pct}% chance)

Chances from: @fangraphs @baseball_ref @baseballpro Clay Davenport @FiveThirtyEight @numberFire @teamRankings")

tweet
nchar(tweet)
```

