---
title: "playoff-interesst"
output: html_document
date: '`r Sys.Date()`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(baseballr)
library(httr)
library(jsonlite)

fix_team_name <- function(in_name) {

}
```


```{r}
# get FG playoff odds
headers <- c(
  "user-agent" = "Mozilla/5.0",
  "content-type" = "application/json;charset=UTF-8"
)

url <- glue("https://www.fangraphs.com/api/playoff-odds/odds?dateEnd={Sys.Date()}&dateDelta=&projectionMode=2&standingsType=div")

poff_chances_fg <-
  GET(url, add_headers(headers)) %>%
  content() %>%
  as_tbl_json() %>%
  gather_array() %>%
  spread_all() %>%
  select(abbName, poff_chance = endData.poffTitle) %>%
  mutate(poff_chance = round(poff_chance, 2) * 100) %>%
  as_tibble() %>%
  mutate(team_name = case_when(
    abbName == "LAA" ~ "Los Angeles Angels",
    abbName == "BAL" ~ "Baltimore Orioles",
    abbName == "BOS" ~ "Boston Red Sox",
    abbName == "CHW" ~ "Chicago White Sox",
    abbName == "CLE" ~ "Cleveland Guardians",
    abbName == "DET" ~ "Detroit Tigers",
    abbName == "KCR" ~ "Kansas City Royals",
    abbName == "MIN" ~ "Minnesota Twins",
    abbName == "NYY" ~ "New York Yankees",
    abbName == "OAK" ~ "Oakland Athletics",
    abbName == "SEA" ~ "Seattle Mariners",
    abbName == "TBR" ~ "Tampa Bay Rays",
    abbName == "TEX" ~ "Texas Rangers",
    abbName == "TOR" ~ "Toronto Blue Jays",
    abbName == "ARI" ~ "Arizona Diamondbacks",
    abbName == "ATL" ~ "Atlanta Braves",
    abbName == "CHC" ~ "Chicago Cubs",
    abbName == "CIN" ~ "Cincinnati Reds",
    abbName == "COL" ~ "Colorado Rockies",
    abbName == "MIA" ~ "Miami Marlins",
    abbName == "HOU" ~ "Houston Astros",
    abbName == "LAD" ~ "Los Angeles Dodgers",
    abbName == "MIL" ~ "Milwaukee Brewers",
    abbName == "WSN" ~ "Washington Nationals",
    abbName == "NYM" ~ "New York Mets",
    abbName == "PHI" ~ "Philadelphia Phillies",
    abbName == "PIT" ~ "Pittsburgh Pirates",
    abbName == "STL" ~ "St. Louis Cardinals",
    abbName == "SFG" ~ "San Francisco Giants",
    abbName == "SDP" ~ "San Diego Padres",
  )) %>%
  select(team_name, poff_chance)

# get today' schedule
todays_games <-
  mlb_schedule(season = 2022) %>%
  filter(date == Sys.Date()) %>%
  select(contains("team_name"))

# get playoff odds from baseball-reference
playoff_url <- read_html("https://www.baseball-reference.com/leagues/majors/2022-playoff-odds.shtml")

poff_chances_bbref <-
  playoff_url %>%
  html_elements("table") %>%
  pluck(2) %>%
  html_table() %>%
  select(team_name = 2, poff_chance = 20) %>%
  mutate(poff_chance = as.numeric(str_extract(poff_chance, "[:digit:]*\\.[:digit:]"))) %>%
  filter(!is.na(poff_chance))

# get playoff odds from clay davenport's forecast site
playoff_davenport <- read_html("http://www.claydavenport.com/stats/ps_oddspec.html") %>%
  html_elements("pre") %>%
  html_text2() %>%
  str_split("\n")

# the above returns a list of data frames. iterate through them and pull out the information
playoff_chances_davenport <-
  playoff_davenport %>%
  map_df(function(x) {
    pluck(x) %>%
      as_tibble() %>%
      filter(row_number() > 3) %>%
      separate(value, c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine"), sep = "\\s{2,}") %>%
      filter(one != "") %>%
      select(team_name = one, poff_chance = nine) %>%
      mutate(poff_chance = as.numeric(poff_chance)) %>%
      filter(!is.na(poff_chance))
  }) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "Dodgers") ~ "Los Angeles Dodgers",
      str_detect(team_name, "Yankees") ~ "New York Yankees",
      str_detect(team_name, "Orioles") ~ "Baltimore Orioles",
      str_detect(team_name, "Red Sox") ~ "Boston Red Sox",
      str_detect(team_name, "Blue Jays") ~ "Toronto Blue Jays",
      str_detect(team_name, "Rays") ~ "Tampa Bay Rays",
      str_detect(team_name, "Guardians") ~ "Cleveland Guardians",
      str_detect(team_name, "Twins") ~ "Minnesota Twins",
      str_detect(team_name, "White Sox") ~ "Chicago White Sox",
      str_detect(team_name, "Tigers") ~ "Detroit Tigers",
      str_detect(team_name, "Royals") ~ "Kansas City Royals",
      str_detect(team_name, "Astros") ~ "Houston Astros",
      str_detect(team_name, "Angels") ~ "Los Angeles Angels",
      str_detect(team_name, "Athletics") ~ "Oakland Athletics",
      str_detect(team_name, "Mariners") ~ "Seattle Mariners",
      str_detect(team_name, "Nationals") ~ "Washington Nationals",
      str_detect(team_name, "Marlins") ~ "Miami Marlins",
      str_detect(team_name, "Mets") ~ "New York Mets",
      str_detect(team_name, "Phillies") ~ "Philadelphia Phillies",
      str_detect(team_name, "Cubs") ~ "Chicago Cubs",
      str_detect(team_name, "Pirates") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Brewers") ~ "Milwaukee Brewers",
      str_detect(team_name, "Reds") ~ "Cincinnati Reds",
      str_detect(team_name, "Rangers") ~ "Texas Rangers",
      str_detect(team_name, "Padres") ~ "San Diego Padres",
      str_detect(team_name, "Giants") ~ "San Francisco Giants",
      str_detect(team_name, "Cardinals") ~ "St. Louis Cardinals",
      str_detect(team_name, "Rockies") ~ "Colorado Rockies",
      str_detect(team_name, "Braves") ~ "Atlanta Braves",
      str_detect(team_name, "Diamondbacks") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    )
  )


# get odds from 538 and average them with BB-ref odds
playoff_538 <- read_html("https://projects.fivethirtyeight.com/2022-mlb-predictions/")

poff_chances <-
  playoff_538 %>%
  html_table() %>%
  pluck(1) %>%
  select(team_name = 1, poff_chance = 7) %>%
  mutate(
    team_name = case_when(
      str_detect(team_name, "Dodgers") ~ "Los Angeles Dodgers",
      str_detect(team_name, "Yankees") ~ "New York Yankees",
      str_detect(team_name, "Orioles") ~ "Baltimore Orioles",
      str_detect(team_name, "Red Sox") ~ "Boston Red Sox",
      str_detect(team_name, "Blue Jays") ~ "Toronto Blue Jays",
      str_detect(team_name, "Rays") ~ "Tampa Bay Rays",
      str_detect(team_name, "Guardians") ~ "Cleveland Guardians",
      str_detect(team_name, "Twins") ~ "Minnesota Twins",
      str_detect(team_name, "White Sox") ~ "Chicago White Sox",
      str_detect(team_name, "Tigers") ~ "Detroit Tigers",
      str_detect(team_name, "Royals") ~ "Kansas City Royals",
      str_detect(team_name, "Astros") ~ "Houston Astros",
      str_detect(team_name, "Pirates") ~ "Pittsburgh Pirates",
      str_detect(team_name, "Angels") ~ "Los Angeles Angels",
      str_detect(team_name, "Athletics") ~ "Oakland Athletics",
      str_detect(team_name, "Mariners") ~ "Seattle Mariners",
      str_detect(team_name, "Nationals") ~ "Washington Nationals",
      str_detect(team_name, "Marlins") ~ "Miami Marlins",
      str_detect(team_name, "Mets") ~ "New York Mets",
      str_detect(team_name, "Phillies") ~ "Philadelphia Phillies",
      str_detect(team_name, "Cubs") ~ "Chicago Cubs",
      str_detect(team_name, "Brewers") ~ "Milwaukee Brewers",
      str_detect(team_name, "Reds") ~ "Cincinnati Reds",
      str_detect(team_name, "Rangers") ~ "Texas Rangers",
      str_detect(team_name, "Padres") ~ "San Diego Padres",
      str_detect(team_name, "Giants") ~ "San Francisco Giants",
      str_detect(team_name, "Cardinals") ~ "St. Louis Cardinals",
      str_detect(team_name, "Rockies") ~ "Colorado Rockies",
      str_detect(team_name, "Braves") ~ "Atlanta Braves",
      str_detect(team_name, "Diamondbacks") ~ "Arizona Diamondbacks",
      TRUE ~ NA_character_
    ),
    poff_chance = as.numeric(str_extract(poff_chance, "[:digit:]{1,2}"))
  ) %>%
  filter(!is.na(team_name)) %>%
  inner_join(poff_chances_bbref, by = "team_name", suffix = c("_538", "_bbref")) %>%
  inner_join(playoff_chances_davenport, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport = poff_chance) %>%
  inner_join(poff_chances_fg, by = "team_name") %>%
  select(team_name, poff_chance_538, poff_chance_bbref, poff_chance_davenport, poff_chance_fg = poff_chance) %>%
  mutate(
    avg_poff_chance = round((poff_chance_538 + poff_chance_bbref + poff_chance_davenport + poff_chance_fg) / 4, 0),

    # compute 'interest' based off playoff chances. teams closer to 50% should be more interesting, and higher scores should be more interessting
    interest = 50 - abs(50 - avg_poff_chance)
  )

todays_games %>%
  inner_join(poff_chances, by = c("teams_away_team_name" = "team_name")) %>%
  select(contains("team_name"), poff_chance_away = avg_poff_chance, interest_away = interest) %>%
  inner_join(poff_chances, by = c("teams_home_team_name" = "team_name")) %>%
  select(contains("team_name"), poff_chance_away, interest_away, poff_chance_home = avg_poff_chance, interest_home = interest) %>%
  mutate(
    interest_game = interest_away + interest_home, # simple addition suggested by https://www.reddit.com/user/daedeloth86/
    interest_plus = round(interest_game / mean(interest_game) * 100, 0),
  ) %>%
  arrange(desc(interest_plus)) %>%
  View()

# minimum interest score (most interesting) = 0
# maximum = 50
```

```{r, fig.height=3, fig.width=3}
poff_chances %>%
  pivot_longer(2:5, names_to = "site") %>%
  select(team_name, site, playoff_chance = value) %>%
  mutate(site = case_when(
    site == "poff_chance_538" ~ "FiveThirtyEight",
    site == "poff_chance_bbref" ~ "Baseball Reference",
    site == "poff_chance_davenport" ~ "Clay Davenport",
    site == "poff_chance_fg" ~ "FanGraphs",
  )) %>%
  group_by(team_name) %>%
  mutate(median_poff_chance = median(playoff_chance)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(team_name, median_poff_chance), y=playoff_chance)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = site), size = 0.5) +
  coord_flip() +
  labs(y = "Playoff Chance (%)", x = "") + 
  geom_hline(yintercept = 50, lty = "dashed") +
  ggtitle("MLB Team Playoff Chances", subtitle = glue("Prior to Games Played on {Sys.Date()}"))


ggsave("playoff_chances.png")
```
