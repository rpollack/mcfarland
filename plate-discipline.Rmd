```{r setup, include=FALSE, echo=FALSE}


library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)
library(ggjoy)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

### Get data

```{r}

# gd_info <- fg_db %>%
#   tbl("gd_roster") %>%
#   dplyr::select(mlbamid, playerid)

id_info <- fg_db %>%
  tbl("playerid_lookup") %>%
  dplyr::select(mlbamid, playerid) %>%
  collect(n=Inf)

fg_info <- fg_db %>%
  tbl("player_info") %>%
  filter(!BISPosition %in% c("SP", "RP")) %>%
  dplyr::select(PlayerId, FirstName, LastName, LastGame) %>%
  collect(n=Inf) %>%
  mutate(LastGame = ymd(LastGame),
         lastYear = year(LastGame)) %>%
  unite(batter_name, FirstName, LastName, sep = " ")

batting_war <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0, 
         Season >= 2015) %>%
  dplyr::select(playerid, Season, wrc_plus = `wRC+`, RBI) %>%
  collect(n=Inf) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  inner_join(id_info, by="playerid")


# for each spot in zone ... ratio of swings to takes? can divide px and pz into deciles to compute zones ... 

#get all pitches, then classify as swing/non-swing, then take ratio, then split by baserunner situation

#get all swings
savant_data <- fg_db %>%
  tbl("gd_savant_new") %>%
  filter(description %in% c("foul", "hit_into_play", "hit_into_play_no_out",
                            "hit_into_play_score", "swinging_pitchout", "swinging_strike",
                            "swinging_strike_blocked")) %>%
  dplyr::select(batter, pitcher = player_name, pitcher_mlbam_id = pitcher, game_date, 
                game_year, description, plate_x, plate_z,
                on_1b, on_2b, on_3b, balls, strikes, outs_when_up) %>%
  collect(n=Inf) %>%
  inner_join(batting_war, by=c("batter" = "mlbamid", "game_year" = "Season")) %>%
  mutate(plate_x = as.numeric(plate_x),
         plate_z = as.numeric(plate_z)) %>%
  #compute inches instead of feet
  mutate(px_in = plate_x * 12,
         pz_in = plate_z * 12,
         
         #don't care WHO the runners are, just where they are
         on_1b = ifelse(on_1b > 0, "Y", "N"),
         on_2b = ifelse(on_2b > 0, "Y", "N"),
         on_3b = ifelse(on_3b > 0, "Y", "N"),
         runners_on_base = paste0(on_1b, on_2b, on_3b)) %>%
  filter(balls <= 3,            #get rid of some weird data
         strikes <= 2) %>%
  unite(count, balls, strikes, sep = "-")
```


HEADLINE OPTIONS (What am I promising here?)

- 
- 
- 
- 
- 

INTRO

- Set the tone



A couple of months ago I wrote about plate coverage, which I defined as several folks asked me -- what about plate _discipline_? This is a metric that gets even more attention


DEFINING AGGRESSION

I used Statcast data to compute hitters' Aggression Factors in the following manner:

- For each hitter in each year, I found the median absolute deviation (MAD) along the horizontal (MADx) and vertical (MADy) axes of pitches they'd swung at.
- I multiplied these MADx and MADy together to get a sense of the square inches a hitter's attempted to cover.
- I divided this number by the total number of swings and multiplied by 100, to normalize among hitters with different amounts of playing time. This resulting number is the hitter's Aggression Factor (AF). Lower AF's indicate the hitter swings mostly at pitches in one area; higher AF's indicate a player chases pitches in a variety of locations.
- I filtered out hitters who'd swung fewer than 200 times in a season, to prevent role players from polluting the sample too much.

EXAMPLES

Joey Votto and Justin Bour are both left-handed NL first basemen. Whereas in 2017 Votto has an AF of 4.3, Bour has an AF of 13.6. The plots below show pitches they've swung at:
```{r}
ggplot(savant_data %>% filter(game_year == 2017,
                              batter_name %in% c("Joey Votto", "Justin Bour")),
       aes(px_in, pz_in)) + geom_point() + facet_grid(~batter_name) + 
  ggtitle("Swings from Select Hitters, 2017") + xlim(-20, 20) +ylim(0, 60) + fgt
```

Bour's clearly is the more aggressive hitter, swinging at pitches all over the place, including some close to five feet off the ground. Meanwhile Votto's plot demonstrates the patience for which he's known, refusing to chase at balls off the plate and, in particular, recognizing middle-middle pitches really well.

LEADERS AND LAGGARDS

The following table shows the 25 least aggressive hitter-seasons in this dataset:

```{r}

plate_discipline_overall <- savant_data %>%
  group_by(playerid, batter_name, game_year, lastYear, wrc_plus) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3)) %>%
  mutate(discipline_sq_in = horiz_disc * vertical_disc,
         aggression_factor = discipline_sq_in / num_swings * 100) %>%
  filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(aggression_factor) %>%
  ungroup()


least_aggressive <- plate_discipline_overall %>%
  mutate(wrc_plus = round(wrc_plus, 0),
         aggression_factor = round(aggression_factor, 1)) %>%
  dplyr::select(Name = batter_name, Season = game_year, `wRC+` = wrc_plus, `Aggression Factor` = aggression_factor) %>%
  unite(name_season, Name, Season, sep = ", ") %>%
  head(25)

ggplot(least_aggressive, aes(reorder(name_season, -`Aggression Factor`), `Aggression Factor`)) + geom_bar(stat="identity") + 
  coord_flip() + fgt + labs(x="") + ggtitle("Least Aggressive Hitters, 2015 - 2017")

```

These are some very good hitter-seasons. The cohort includes Josh Donaldson's 2015 MVP campaign; overall, the mean wRC+ of this cohort is a stellar 129. Seeing Votto on this list helps validate the metric's worth, matching our perception of him as one of the most patient hitters in baseball.

And now the most aggressive hitters in this dataset:
```{r}
most_aggressive <- plate_discipline_overall %>%
  mutate(wrc_plus = round(wrc_plus, 0),
         aggression_factor = round(aggression_factor, 1)) %>%
  dplyr::select(Name = batter_name, Season = game_year, `wRC+` = wrc_plus, `Aggression Factor` = aggression_factor) %>%
  unite(name_season, Name, Season, sep = ", ") %>%
  tail(25)

ggplot(most_aggressive, aes(reorder(name_season, -`Aggression Factor`), `Aggression Factor`)) + geom_bar(stat="identity") + 
  coord_flip() + fgt + labs(x="") + ggtitle("Most Aggressive Hitters, 2015 - 2017")
```

These hitters are not so notable. Despite a few standout campaigns like Corey Seager's 174 wRC+ in 27 games in 2015, the mean wRC+ for these hitter-seasons is just 84.

Looking at these two graphs, you might conclude that Aggression Factor correlates with offense. And you'd be right. The following scatterplot and parabola of best-fit show that the more aggressive a hitter becomes, the more his offense drops:

```{r}
ggplot(plate_discipline_overall, aes(aggression_factor, wrc_plus)) + geom_point() + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
  labs(x="Aggression Factor", y="wRC+") + 
  ggtitle("It Pays to be Patient at the Plate") + fgt

aggression_factor_model <- lm(plate_discipline_overall$wrc_plus ~ 
                                   poly(plate_discipline_overall$aggression_factor, 2))
summary(aggression_factor_model)
```

A polynomial model of wRC+ = 96.16 + (170.6 * AF^2) - (425 * AF), with p < 2.2e-16, best fits this data. The R^2 of .21 indicates AF explains 21% of the variation in a hitter's wRC+. That's quite a large effect for just one metric to have on a hitter's offense.

I also broke this dataset into deciles, where Decile 1 contains the least aggressive hitters (AF's from 4.2 to 5.9) and Decile 10 contains the most aggressive hitters (AF's from 22.6 to 41.5), and computed the mean wRC+ in each decile. The results align with common sense: as hitters get more aggressive, their offensive output declines. 

```{r}

plate_discipline_deciles <- plate_discipline_overall %>%
  ungroup() %>%
  mutate(decile = ntile(aggression_factor, 10)) %>%
  group_by(decile) %>%
  summarize(from_disc = min(aggression_factor),
            to_disc = max(aggression_factor),
            mean_wrc_plus = mean(wrc_plus))


ggplot(plate_discipline_deciles, aes(reorder(as.character(decile), decile), mean_wrc_plus)) +
  geom_bar(stat="identity") + labs(x="Decile (1 = Low Aggression, 10 = High Aggression)", y="Mean wRC+") + fgt
```

OVER TIME

The following boxplot shows how hitters' AF's have changed over time:
```{r}
ggplot(plate_discipline_overall, aes(as.character(game_year),
                                     aggression_factor)) + geom_boxplot() + coord_flip() + 
  labs(x="", y="Aggression Factor") + 
  ggtitle("Hitters Are Becoming Not Only More Similar, But Also More Aggressive") + fgt

ggplot(plate_discipline_overall, aes(y=as.character(game_year), x=aggression_factor)) +
  geom_joy(scale=1) + fgt +labs(x="Aggression Factor", y="") + ggtitle("Distributions of Aggression Factors over Time")

```

I see two trends in this graph:
- Since 2017, the peak of the AF curve has moved to the right, indicating that the typical hitter today is more aggressive than the typical hitter in 2015. The median AF in 2015 was 9.3; today it's 9.7. That's a small change but it becomes noticeable when expressed over hundreds of hitters in a season.
- Since 2017, the maximum tolerable aggression has declined. The most aggressive hitter in 2015 (Brett Wallace) had an AF of 38.3; the most aggressive hitter in 2017 (JaCoby Jones) has an AF of 38.8. In between, Steven Moya had an AF of 41.5 in 2016.

Collectively, the graph tells me that GM's and managers are selecting hitters who are more aggressive -- to a point. There is such a thing as too much aggression. As a result, hitters are becoming more similar to each other. The inter-quartile range in AF has shrunk from 8.3 in 2015 to 8.25 in 2017 (although it did expand to 8.9 in 2016). 

Individual hitters also become more and less aggressive over time. The following graph shows how a change in AF relates to a change in wRC+:

```{r}
ggplot(year_to_year_changes_2017, aes(disc_diff, wrc_diff)) + geom_point() +
  geom_smooth(method="lm") + labs(x="YoY Change in Aggression Factor", y="YoY Change in wRC+") +
  ggtitle("Year-over-Year, Expanding the Zone is Associated with a Decrease in Offense") + fgt


yoy_discipline_model <- lm (year_to_year_changes_2017$wrc_diff ~ year_to_year_changes_2017$disc_diff)
summary(yoy_discipline_model)

```

The results of this graph fit what we've seen so far. An increase in aggression is associated with a decrease in wRC+. The effect is there but small: an R^2 of .06 indicates that a change in AF explains 6% of the variance of the change in wRC+.

The following players have decreased their aggression the most since 2015:

```{r}
#
```

### BASE-OUT STATES

Statcase also gives us the base-out state when a hitter's batting. I used this information to see which base-out states induce the most aggression in hitters. The results should not surprise you:

```{r}

#by baserunner state, count, and outs generally.
plate_discipline_by_base_out_states <- savant_data %>%
  group_by(runners_on_base, outs_when_up) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3),
            discipline_sq_in = horiz_disc * vertical_disc,
            aggression_factor = discipline_sq_in / num_swings * 100) %>%
  filter(num_swings >= 10) %>%    
  arrange(aggression_factor)

ggplot(plate_discipline_by_base_out_states, aes(x=runners_on_base, y=as.character(outs_when_up))) +
         geom_point(aes(color=aggression_factor, size=aggression_factor)) +
  ggtitle("Hitters are Most Aggressive when a Runner's on Third Base") +
  labs(x="Runners On Base (Y = Runner, N = No Runner)", y="Outs") +
  guides(color=guide_legend(), size = guide_legend()) +
  scale_color_gradient(low="green", high = "red") + fgt

```

Is there a runner on third? Then generally speaking, a hitter will swing at a wider variety of pitches than they would if the bases are empty. Hitters are particularly aggressive when there's a runner on third and no outs, while they're less aggressive if there's also a runner on second or first. I attribute the latter to wanting to stay out of the double play; that's why hitters are less aggressive with the bases loaded than they are with a single runner on third base.

But some control their aggression better than others. By taking the ratio of AF when there's a runner on third to the AF when there isn't, we can understand who gets jumpiest when they have an RBI chance standing 90 feet from scoring. The average player gets nearly 10x as aggressive in this situation, in terms of the horizontal and vertical location of a pitch they'll swing at. Who is the calmest in these situations:

```{r}
# which players change their approach the most from runner-not-on-third to runner-on-third (when there are 0 outs)

player_aggression_relative <- savant_data %>%
  mutate(runner_on_third = ifelse(runners_on_base %in% c("NNY", "NYY", "YNY", "YYY"), "Y", "N")) %>%
  group_by(playerid, batter_name, lastYear, runner_on_third) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3),
            discipline_sq_in = horiz_disc * vertical_disc,
            aggression_factor = discipline_sq_in / num_swings * 100) %>%
  filter(num_swings >= 50) %>%   #want players who've swung at least 50 times in both situations
  group_by(playerid, batter_name, lastYear) %>%
  arrange(runner_on_third) %>%
  mutate(aggression_multiplier_when_runner_on_third = aggression_factor / lag(aggression_factor)) %>%
  filter(lastYear == 2017,
         !is.na(aggression_multiplier_when_runner_on_third)) %>%
  arrange(desc(aggression_multiplier_when_runner_on_third)) %>%
  ungroup()


#the least
player_aggression_relative %>%
  dplyr::select(batter_name, aggression_multiplier_when_runner_on_third) %>%
  tail(15) %>%
  ggplot(aes(reorder(batter_name, aggression_multiplier_when_runner_on_third),
             aggression_multiplier_when_runner_on_third)) +
  geom_bar(stat="identity") + coord_flip() + labs(x="", y="AF Multiplier when Runner on Third")



#mean(player_aggression_relative$aggression_multiplier_when_runner_on_third)

```

Raul Mondesi, Curt Casali, and John Hicks are as cool as cucumbers when there's a man on third. We can't say that about the following list of hitters, who exhibit a large increase in aggression when hitting with a man on third:

```{r}
player_aggression_relative %>%
  dplyr::select(batter_name, aggression_multiplier_when_runner_on_third) %>%
  head(15) %>%
  ggplot(aes(reorder(batter_name, aggression_multiplier_when_runner_on_third),
             aggression_multiplier_when_runner_on_third)) +
  geom_bar(stat="identity") + coord_flip() + labs(x="", y="AF Multiplier when Runner on Third")
```

Manual Margot, Tyler Collins, and Travis Jankowski get jumpier than a long-tailed cat in a room full of rocking chairs when they have an RBI chance. Curiously enough, so does Mike Trout. He always looks so calm and collected, doesn't he? Never a rise in emotion? Well now we can see what's going through his head when he has a chance to knock a man in from third. He'll swing at dang near anything.






The following 
```{r}

  
#players who change their approach the most with runners on 3rd
player_aggression_relative %>%
  dplyr::select(batter_name, aggression_multiplier_when_runner_on_third) %>%
  head(25)

```


* * *







I interpret this graph as showing that over time, hitters are becoming not only _more_ aggressive, but also _similarly_ aggressive. Either that, or front offices and managers are selecting for these kinds of players. (It's probably both.)

Between 2015 and 2017 the following changes occurred:
- The median aggression factor increased
- The interquartile range of agggression factors decreased

These changes aren't large by themselves but become noticeable when expressed by the hundreds of major-leaguers each year. We've said for years that hitters are less afraid than ever of striking out [https://calltothepen.com/2017/01/11/mlb-curious-ks-modern-day-hitters/]; the graph above appears to show that not only is this true, but also that managers and GM's are okay with the trend.













I defined aggression as the median absolute deviation (MAD) along the horizontal and vertical axes of pitches that hitters swung at

### Compute batter aggeression

```{r}



year_to_year_changes_2017 <- plate_discipline_overall %>%
  group_by(playerid) %>%
  arrange(game_year) %>%
  mutate(disc_diff = aggression_factor - lag(aggression_factor),
         wrc_diff = wrc_plus - lag(wrc_plus)) %>%
  filter(!is.na(disc_diff)) %>%
  arrange(disc_diff)



#by batter by baserunner state. who is more aggressive when there are runners on base?
plate_discipline_by_base_state <- savant_data %>%
  group_by(playerid, batter_name, game_year, lastYear, runners_on_base) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3)) %>%
  mutate(discipline_sq_in = horiz_disc * vertical_disc,
         aggression_factor = discipline_sq_in / num_swings * 100) %>%
 # filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(aggression_factor)


```




### plots

```{r}

#per_pitch makes no mathematical sense but it equalizes folks and the top of the list 'looks' right in that
#it has really good hitters in it.




```

### compute & plot deciles



### Models for Graphs Above

```{r}


#r^2 = .21!!!

discipline_augmented <- augment(aggression_factor_model)


```

### show votto & bour's aggression to demonstrate the methodology

```{r}

#votto & bour are two great examples; they're both lefties and their plots contrast well.


```


### compute pitcher aggression (that they induce in batters)

```{r}
pitcher_plate_discipline_overall <- savant_data %>%
  group_by(pitcher, game_year) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3)) %>%
  mutate(discipline_sq_in = horiz_disc * vertical_disc,
         aggression_factor = discipline_sq_in / num_swings * 100) %>%
  filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(aggression_factor)

# it seems the best pitchers induce lots of swings IN the zone ... but somehow remain untouched.

#correlate discipline_per_100 to xFIP-

ggplot(savant_data %>% filter(game_year == 2017,
                              pitcher %in% c("Max Scherzer", "Hisashi Iwakuma")),
       aes(px_in, pz_in)) + geom_point() + facet_wrap(~pitcher) + 
  ggtitle("Swings Induced by Select Pitchers, 2017") + xlim(-20, 20) +ylim(0, 60)
```

### in which base-out states are hitters the most aggressive?





### graph outlier players

```{r}

#pitches from player who gets more aggressive
aggressive_player <- savant_data %>%
  mutate(runner_on_third = ifelse(runners_on_base %in% c("NNY", "NYY", "YNY", "YYY"), "Y", "N")) %>%
  filter(batter_name == "Manuel Margot")

ggplot(aggressive_player, aes(px_in, pz_in)) + geom_point() + facet_wrap(~runner_on_third) +
  ggtitle("Manuel Margot's Aggression w/Runners on Third & Without")

non_aggressive_player <- savant_data %>%
  mutate(runner_on_third = ifelse(runners_on_base %in% c("NNY", "NYY", "YNY", "YYY"), "Y", "N")) %>%
  filter(batter_name == "Raul Mondesi")

ggplot(non_aggressive_player, aes(px_in, pz_in)) + geom_point() + facet_wrap(~runner_on_third) +
  ggtitle("Raul Mondesi's Aggression w/Runners on Third & Without")



```

