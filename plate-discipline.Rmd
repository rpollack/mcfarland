```{r setup, include=FALSE, echo=FALSE}


library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

### Get data

```{r}

# gd_info <- fg_db %>%
#   tbl("gd_roster") %>%
#   dplyr::select(mlbamid, playerid)

id_info <- fg_db %>%
  tbl("playerid_lookup") %>%
  dplyr::select(mlbamid, playerid) %>%
  collect(n=Inf)

fg_info <- fg_db %>%
  tbl("player_info") %>%
  filter(!BISPosition %in% c("SP", "RP")) %>%
  dplyr::select(PlayerId, FirstName, LastName) %>%
  collect(n=Inf) %>%
  unite(batter_name, FirstName, LastName, sep = " ")

batting_war <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0, 
         Season >= 2015) %>%
  dplyr::select(playerid, Season, wrc_plus = `wRC+`) %>%
  collect(n=Inf) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  inner_join(id_info, by="playerid")


# for each spot in zone ... ratio of swings to takes? can divide px and pz into deciles to compute zones ... 

#get all pitches, then classify as swing/non-swing, then take ratio, then split by baserunner situation

#get all swings
savant_data <- fg_db %>%
  tbl("gd_savant_new") %>%
  filter(description %in% c("foul", "hit_into_play", "hit_into_play_no_out",
                            "hit_into_play_score", "swinging_pitchout", "swinging_strike",
                            "swinging_strike_blocked")) %>%
  dplyr::select(batter, pitcher = player_name, pitcher_mlbam_id = pitcher, game_date, game_year, description, plate_x, plate_z,
                on_1b, on_2b, on_3b, balls, strikes, outs_when_up) %>%
  collect(n=Inf) %>%
  inner_join(batting_war, by=c("batter" = "mlbamid", "game_year" = "Season")) %>%
  mutate(plate_x = as.numeric(plate_x),
         plate_z = as.numeric(plate_z)) %>%
  #compute inches instead of feet
  mutate(px_in = plate_x * 12,
         pz_in = plate_z * 12,
         
         #don't care WHO the runners are, just where they are
         on_1b = ifelse(on_1b > 0, "Y", "N"),
         on_2b = ifelse(on_2b > 0, "Y", "N"),
         on_3b = ifelse(on_3b > 0, "Y", "N"),
         runners_on_base = paste0(on_1b, on_2b, on_3b)) %>%
  filter(balls <= 3,            #get rid of some weird data
         strikes <= 2) %>%
  unite(count, balls, strikes, sep = "-")
```

### Compute batter aggeression

```{r}

plate_discipline_overall <- savant_data %>%
  group_by(playerid, batter_name, game_year, wrc_plus) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3)) %>%
  mutate(discipline_sq_in = horiz_disc * vertical_disc,
         discipline_per_100_swings = discipline_sq_in / num_swings * 100) %>%
  filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(discipline_sq_in)

year_to_year_changes_2017 <- plate_discipline_overall %>%
  group_by(playerid) %>%
  arrange(game_year) %>%
  mutate(disc_diff = discipline_per_100_swings - lag(discipline_per_100_swings),
         wrc_diff = wrc_plus - lag(wrc_plus)) %>%
  filter(!is.na(disc_diff)) %>%
  arrange(disc_diff)

#by baserunner state, count, and outsgenerally.
plate_discipline_by_base_out_states <- savant_data %>%
  group_by(runners_on_base, outs_when_up) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3),
            discipline_sq_in = horiz_disc * vertical_disc,
            discipline_per_100_swings = discipline_sq_in / num_swings * 100) %>%
 # filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(discipline_per_100_swings)

#by batter by baserunner state. who is more aggressive when there are runners on base?
plate_discipline_by_base_state <- savant_data %>%
  group_by(playerid, batter_name, game_year, runners_on_base) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3)) %>%
  mutate(discipline_sq_in = horiz_disc * vertical_disc,
         discipline_per_100_swings = discipline_sq_in / num_swings * 100) %>%
 # filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(discipline_per_100_swings)



plate_discipline_deciles <- plate_discipline_overall %>%
  ungroup() %>%
  mutate(decile = ntile(discipline_per_100_swings, 10)) %>%
  group_by(decile) %>%
  summarize(from_disc = min(discipline_per_100_swings),
            to_disc = max(discipline_per_100_swings),
            mean_wrc_plus = mean(wrc_plus))

# largest_zone_2017 <- plate_discipline_overall %>%
#   filter(game_year == 2017) %>%
#   arrange(desc(discipline_per_100_swings)) %>%
#   head(10)
# 
# largest_zone_plts <- savant_data %>%
#   filter(game_year == 2017,
#          batter_name %in% largest_zone_2017$batter_name) 
# 
# smallest_zone_2017 <- plate_discipline_overall %>%
#   filter(game_year == 2017) %>%
#   arrange(desc(discipline_per_100_swings)) %>%
#   tail(10) 
# 
# smallest_zone_plts <- savant_data %>%
#   filter(game_year == 2017,
#          batter_name %in% smallest_zone_2017$batter_name) 
```




### plots

```{r}
ggplot(plate_discipline_overall, aes(discipline_per_100_swings, wrc_plus)) + geom_point() + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
  labs(x="Aggression (sq. inches / 100 swings)", y="wRC+") + 
  ggtitle("It Pays to be Patient at the Plate") + fgt
#per_pitch makes no mathematical sense but it equalizes folks and the top of the list 'looks' right in that
#it has really good hitters in it.

ggplot(year_to_year_changes_2017, aes(disc_diff, wrc_diff)) + geom_point() +
  geom_smooth(method="lm") + labs(x="YoY Change in Aggression (sq. in / 100 swings)", y="YoY Change in wRC+") +
  ggtitle("Year-over-Year, Expanding the Zone is Associated with a Decrease in Offense") + fgt

```

### Models for Graphs Above

```{r}
discipline_per_100_swings_model <- lm(plate_discipline_overall$wrc_plus ~ 
                                   poly(plate_discipline_overall$discipline_per_100_swings, 2))
summary(discipline_per_100_swings_model)

#r^2 = .21!!!

discipline_augmented <- augment(discipline_per_100_swings_model)

yoy_discipline_model <- lm (year_to_year_changes_2017$wrc_diff ~ year_to_year_changes_2017$disc_diff)
summary(yoy_discipline_model)



# r2 = 
```

```{r}

#votto & bour are two great examples; they're both lefties and their plots contrast well.
ggplot(savant_data %>% filter(game_year == 2017,
                              batter_name %in% c("Joey Votto", "Justin Bour")),
       aes(px_in, pz_in)) + geom_point() + facet_grid(~batter_name) + 
  ggtitle("Swings from Select Hitters, 2017") + xlim(-20, 20) +ylim(0, 60)

# ggplot(largest_zone_plts, aes(px_in, pz_in)) + geom_point() +
#   facet_wrap(~batter_name) + ggtitle("Most Aggressive Batters per 100 Pitches, 2017") + ylim(0, 60) + xlim(-20, 20)
# 
# ggplot(smallest_zone_plts, aes(px_in, pz_in)) + geom_point() +
#   facet_wrap(~batter_name) + ggtitle("Least Aggressive Batters per 100 Pitches, 2017") + ylim(0, 60) + xlim(-20, 20)

#biggest declines in aggression, 2016-2017
ggplot(year_to_year_changes_2017 %>% filter(game_year == 2017) %>% arrange(disc_diff))


ggplot(plate_discipline_deciles, aes(reorder(as.character(decile), decile), mean_wrc_plus)) +
  geom_bar(stat="identity") + labs(x="Decile", y="Mean wRC+") + fgt

ggplot(year_to_year_changes_2017, aes(disc_diff, wrc_diff)) + geom_point()

ggplot(plate_discipline_overall, aes(as.character(game_year),
                                     discipline_per_100_swings)) + geom_boxplot() + coord_flip() + 
  labs(x="", y="Aggression (sq. in / 100 swings)") + 
  ggtitle("Hitters Are Becoming Not Only More Similar, but also More Aggressive")
```


### compute pitcher aggression (that they induce in batters)

```{r}
pitcher_plate_discipline_overall <- savant_data %>%
  group_by(pitcher, game_year) %>%
  summarize(num_swings = n(),
            horiz_disc = round(mad(px_in), 3),
            vertical_disc = round(mad(pz_in), 3)) %>%
  mutate(discipline_sq_in = horiz_disc * vertical_disc,
         discipline_per_100_swings = discipline_sq_in / num_swings * 100) %>%
  filter(num_swings >= 200) %>%    #this is about 1/6 of a full season, to reduce survivor bias
  arrange(discipline_per_100_swings)

# it seems the best pitchers induce lots of swings IN the zone ... but somehow remain untouched.

#correlate discipline_per_100 to xFIP-

ggplot(savant_data %>% filter(game_year == 2017,
                              pitcher %in% c("Max Scherzer", "Hisashi Iwakuma")),
       aes(px_in, pz_in)) + geom_point() + facet_grid(~pitcher) + 
  ggtitle("Swings Induced by Select Pitchers, 2017") + xlim(-20, 20) +ylim(0, 60)
```

```{r}
ggplot(plate_discipline_by_base_out_states, aes(x=runners_on_base, y=as.character(outs_when_up))) +
         geom_point(aes(color=discipline_per_100_swings, size=discipline_per_100_swings)) +
  ggtitle("Hitters are Most Aggressive with No Outs and a Runner on Third") +
  labs(x="Runners On Base (Y = Runner, N = No Runner)", y="Outs") +
  guides(color=guide_legend(), size = guide_legend()) +
  scale_color_gradient(low="green", high = "red") + fgt

```

