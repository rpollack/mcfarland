---
title: "FanGraphs Leaderboard Scraper"
output: html_document
---

### Load required packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(magrittr)
library(XML)
library(plotly)
library(RMySQL)
library(readr)
```




```{r}

fg_players <- fg_db %>%
  tbl("player_info") %>%
  collect(n=Inf)

fg_bat <- fg_db %>%
  tbl("stats_batting") %>%
  collect(n=Inf)

fg_pitch <- fg_db %>%
  tbl("stats_pitching") %>%
  collect(n=Inf)

fg_merged <- inner_join(fg_players, fg_bat, by=c("PlayerId" = "playerid"))




totals <- fg_merged %>%
  filter(Type==-1)

num_players <- nrow(totals)

#TASKS:
# re-compute p(e) (prob. that a player will make HOF)
#for each player:
#   --- find cumulative WAR through their current age --- 
#   calculate probability that, given HOF, they accumulated that WAR through that age (this is p(e|b))
#   calculate the probability that any player will accumulate that WAR though that age (this is p|b) 
#       # of players who were within (num_seasons * 2) WAR at that age  / (done) number of players who played seasons >= that age

#find, for each age, the number of players who played at that age and past it.
num_players_at_each_age <- fg_merged %>%
  filter(Type==0,
         is.na(Age) == FALSE) %>%     #some folks don't have ages; ignore them
  group_by(Age) %>%
  summarize(num_players_at_age = n()) %>%
  mutate(num_players_gte_age = lapply(Age, function(x){
    return(sum(batting_fielding_war$Age >= x))
  })) %>%
  select(-num_players_at_age)

batting_fielding_war <- fg_merged %>%
  filter(Type==0) %>%
  mutate(FullName = sprintf("%s %s", FirstName, LastName),
         BattingFieldingWar = ValueW) %>%
  select(PlayerId, FullName, Season, Age, BattingFieldingWar) %>%
  group_by(PlayerId, FullName) %>%
  arrange(Season) %>%
  mutate(cumulative_war = cumsum(BattingFieldingWar)) %>%
  filter(Age == max(Age)) %>%      #display only the player's most recent age
  inner_join(num_players_at_each_age, by="Age")  #populate each age with the number of players who played at that age or past it

#now, for each age/WAR combination, find the number of players within (# seasons * 2) WAR of it

  
  
  
num_players_at_each_age <- fg_merged %>%
  filter(Type==0,
         is.na(Age) == FALSE) %>%     #some folks don't have ages; ignore them
  group_by(Age) %>%
  summarize(num_players_at_age = n()) %>%



  arrange(Age) %>%
  mutate(total_players_through_this_age = cumsum(num_players_at_age))



  mutate(num_players_at_age_or_greater = lapply(Age, function(x){
              return(sum(Age >= x))
            }))
              
              

#num players with a season >= that age?


  



probs_hof <- lapply(batting_fielding_war, function(x){
  #for each age, number of players who had a season >= that age
  
})




sapply(types, function(x){
      url <- sprintf("http://www.fangraphs.com/leaders.aspx?pos=np&stats=bat&lg=all&qual=0&type=%s&season=%s&month=0&season1=%s&ind=1&team=0&rost=0&age=0&filter=&players=0&page=1_%s", x, end_season, start_season, num_players)
      out <- readHTMLTable(url, stringsAsFactors = FALSE)
      out <- as.data.frame(out$LeaderBoard1_dg1_ctl00)
      }
      ),
    by=c("Name", "Team", "Season")

calculate_bayes <- function(){
  #find number of players who reached that age   
} 

#if we're looking at a 30 y.o player should we include totals for 35 yos?



  summarize(num_seasons = n(),
            first_year = min(Season),
            last_year = max(Season),
            total_war = sum(BattingWar),
            war_per_season = total_war / num_seasons)


#get cumulative WAR per age

#filter out pitchers -- how?
#identify Hall of Famers -- perhaps merge with Lahman HOF table
#for active players get cumulative WAR per age

```

### Create lookup table

The user will pass named strings into scrape_player_batting_data(). These strings need to be transformed into numbers for use in the leaderboards URL.

```{r}
dashboards <- as.character(c("standard", "advanced", "batted_ball", "win_probability", "pitch_type",
                             "plate_discipline", "value", "pitch_value", "pfx_pitch_type", "pfx_velocity", 
                             "pfx_h_mov", "pfx_v_mov", "pfx_pitch_val","pfx_pitch_val_c", "pfx_plate_discipline"))
types <- c(0, 1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15)
leaderboard_lookup <- data.frame(dashboards, types)
```

### Clean up data  
  
Clean up a number of inconsistencies associated with leaderboards data elements that prevent useful analysis in R.
  
```{r}    
clean_data <- function(df){
  df <- df[, !duplicated(colnames(df))] #Remove duplicate columns, like 'PA' which is returned from multiple dashboards
  df %<>%
    select(-matches("#")) #remove the 'Rank' column from the data

  #Handle percentage columns, which reports rates as strings
  for(i in names(df)){
    if(is.na(grep("%", i, value = TRUE)[1]) == FALSE | i == "HR/FB"){
      df[[i]] <- as.numeric(sub("%", "", df[[i]]))/100
    }
  }
  
  #Handle the "Dollars" column, which reports negative values in parentheses and has a $ character
  if ("Dollars" %in% names(df)){
    #Convert values in parentheses to strings with "-"" in front 
    df$Dollars <- gsub("\\(", "-", df$Dollars)
    df$Dollars <- gsub("\\)", "", df$Dollars)
    
    #Remove dollar sign & convert to numeric
    df$Dollars <- as.numeric(sub("\\$", "", df$Dollars))
  }
  
  #Convert every column except Name and Team to numeric. Otherwise they are characters & don't sort properly
  cols_to_convert <- c(1, 4:ncol(df))
  df[,cols_to_convert] %<>%
    lapply(function(x) as.numeric(x))
  
  #Make a few column names R-friendly
  colnames(df) <- gsub("\\/", "_per_", colnames(df))
  colnames(df) <- gsub("%", "_perc", colnames(df))
  colnames(df) <- gsub("\\+", "_plus", colnames(df))
  colnames(df) <- gsub("-", "_", colnames(df))
  colnames(df)[8] <- "Singles"
  colnames(df)[9] <- "Doubles"
  colnames(df)[10] <- "Triples"


  return(df)
}
```


### Scrape data

```{r}
scrape_player_batting_data <- function(n, start_season, end_season){
  
  #Get type IDs of dashboard(s) the user wants
  if("all" %in% n){
    types <- leaderboard_lookup$types
  }
  else{
    n <- as.data.frame(n)
    colnames(n)[1] <- "dashboards"
    n <- inner_join(leaderboard_lookup, n, by="dashboards")
    types <- n$types
  }
  
  #Compute number of players to grab per dashboard; assume 900 non-pitchers per season
  num_players <- 900 * (end_season - start_season + 1)

  #Combine requested dashboards into one data frame
  df <- plyr::join_all(
    sapply(types, function(x){
      url <- sprintf("http://www.fangraphs.com/leaders.aspx?pos=np&stats=bat&lg=all&qual=0&type=%s&season=%s&month=0&season1=%s&ind=1&team=0&rost=0&age=0&filter=&players=0&page=1_%s", x, end_season, start_season, num_players)
      out <- readHTMLTable(url, stringsAsFactors = FALSE)
      out <- as.data.frame(out$LeaderBoard1_dg1_ctl00)
      }
      ),
    by=c("Name", "Team", "Season")
  )
  
  df <- clean_data(df)
  return(df)
}
  #Clean up data
```
  


### In progress

```{r}
compute_yoy_change <- function(df, stat){
  new_column = sprintf("%s_perc_change", stat)
  new_df <- df %>%
    select_(Name, Season, Team, PA, stat, wOBA) %>%
    filter(PA > 100) %>% #remove seasons shortened due to injury or whatever
    group_by(Name) %>%
    arrange(Name, Season) %>%
    mutate(new_column = round(((stat - lag(stat)) / lag(stat)) * 100, 2)) %>%
    filter(Season == 2016, is.na(new_column) == FALSE, is.finite(new_column) == TRUE) %>% #focus on current year; ignore rookies
    arrange(desc(new_column))
  
  return(new_df)
}

```

### Get Data

```{r}
fg_data <- scrape_player_batting_data("all", 2015, 2016)
#fg_team_data <- read_csv("~/Downloads/fg-team-data.csv")
#colnames(fg_team_data)[7] <- "Singles"
#colnames(fg_team_data)[8] <- "Doubles"
#colnames(fg_team_data)[9] <- "Triples"
#colnames(fg_team_data)[1] <- "Season"



```

```{r}
wrc_changers <- fg_data %>%
  group_by(Name) %>%
  arrange(Season) %>%
  select(Season, Name, PA, wRC_plus) %>%
  mutate(change = (wRC_plus - lag(wRC_plus))) %>%
  filter(Season == 2016) %>%
  arrange(desc(PA), desc(change))

#robbie grossman is having a great under-the-radar season ... legit improved bb% abd k%
#leads league in FA_perc_increase 
```

```{r}
got_fooled <- fg_data %>%
  filter(PA >= 300) %>%
  mutate(o_zone = 1 - Zone_perc,
         prob_fool = O_Swing_perc * o_zone, #probability of both a pitch outside AND a swing
         prob_no_fool = Z_Swing_perc * Zone_perc, #probability of swinging at a pitch INSIDE the zone
         disc = prob_no_fool - prob_fool) %>%  
  select(Name, Team, PA, Season, ISO, prob_fool, prob_no_fool, disc) %>%
  filter(Season == 2016) %>%
  group_by(Team) %>%
  summarize(mean_fool = mean(prob_fool),
            mean_no_fool = mean(prob_no_fool),
            mean_disc = round(mean(disc, na.rm = TRUE), 3),
            mean_ISO = round(mean(ISO), 3))

ggplot(got_fooled, aes(x=mean_fool, y=mean_no_fool)) + geom_point() + geom_text(aes(label=Team), hjust=0, vjust=0) + labs(x="Probability of Pitch Outside Zone + Swing", y="Probability of Pitch Inside Zone + Swing") + ggtitle("Team Plate Discipline, 2016 (Non-Traded Players Only)") 
```

```{r}
discipline_changes <- fg_data %>%
  filter(PA >= 300) %>%
  mutate(discipline_diff = Z_Swing_perc - O_Swing_perc) %>%
  select(Name, Team, Season, PA, discipline_diff) %>%
  group_by(Name) %>%
  arrange(Season) %>%
  mutate(change = discipline_diff - lag(discipline_diff)) %>%
  filter(Season == 2016)

contact_changes <- fg_data %>%
  group_by(Name) %>%
  arrange(Season) %>%
  select(Season, Name, PA, Contact_perc, wRC_plus) %>%
  mutate(change = (Contact_perc - lag(Contact_perc))) %>%
  filter(Season == 2016, PA > 300) %>%
  arrange(desc(PA), desc(change))

#travis jankowski making a ton more contact

zone_changes <- fg_data %>%
  group_by(Name) %>%
  arrange(Season) %>%
  filter(G > 100) %>%
  select(Season, Name, PA, Zone_perc) %>%
  mutate(change = (Zone_perc - lag(Zone_perc))) %>%
  filter(Season == 2016, PA > 300) %>%
  arrange(desc(PA), desc(change))
  
FA_changes <- fg_data %>%
  group_by(Name) %>%
  arrange(Season) %>%
  #filter(G > 100) %>%      #find only players who played 100 games in each year
  select(Season, Name, PA, FA_perc) %>%
  mutate(change = (FA_perc - lag(FA_perc))) %>%
  filter(Season == 2016, PA > 300)

#yadier molina seeing a big increase in fastball% ... ?

```

### Calculate position-players' percentage of their team's position-player WAR

```{r}
player_value_to_team <- fg_data %>%
  filter(Season == 2016, Team != "- - -") %>%
  select(Season, Name, Team, G, WAR) %>%
  group_by(Team) %>%
  mutate(team_hitter_war_non_pitchers = sum(WAR),
         num_hitters_non_pitchers = n()) %>%
  group_by(Name) %>%
  mutate(hitter_war_perc = round(100 * (WAR / team_hitter_war_non_pitchers), 2),
         name_plus_team = sprintf("%s (%s)", Name, Team)) %>%
  arrange(desc(hitter_war_perc))

team_value_plt <- ggplot(data=head(player_value_to_team, 50), aes(x=reorder(name_plus_team, hitter_war_perc), y=hitter_war_perc)) + geom_bar(stat="identity") + coord_flip() + ggtitle("Good Hitters on Bad Teams (Except for Manny Machado!)") + labs(y="% of Team's Non-Pitcher WAR", x="Player")

team_value_plt

#can maybe subset this graph for teams under and over .500
#could do this across multiple years to find 'who toils in obscurity' the most.
```
