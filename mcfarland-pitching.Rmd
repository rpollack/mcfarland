---
title: "test"
output: html_document
date: "2025-07-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(tidyverse)
library(readr)
library(httr)
library(jsonlite)
library(stringi)
library(baseballr)
library(glue)
library(shinyWidgets)
library(bslib)
library(commonmark)
library(shinybusy)
```

## R Markdown


how to get pitchers into the mcfarland app:

1. the player selector should have "hitter", "starter", or "reliever" in it along with the player's name. this should pull from one df. so for example it should have "Jose Altuve (hitter)" and "Dylan Cease (Starter)" and "David Bednar (Reliever)".
2. once the user chooses a name, we should:
2a. understand the player's position, based on the playerid of the player selected (this should avoid name collisions).
2b. load the appropriate stat df (hitter, starter, or reliever)
2c. create the stat block for the prompt (current year stats, last 3 years' stats, diff)
2d. use the correct prompt (one for hitters, another for starters & relievers)
3. construct the prompt, send it to openai, and get the results back.

i'm open to suggestions on this flow, but that's what i've come up with.

we may now also get into the issue of players with the same name, so we should use playerIDs as much as possible.

to do this, we need to:

DONE 2: add pitcher CSV's to gitignore. check them in.

refresh_data.R:
-1: modify refresh_data to create 2 stat DF's: one for hitters and one for pitchers. 
-- each stat DF is a composite of last 3 years' stats, current year stats, and the diff. 
1. create a lookup df with 3 cols: name + position (for display), playerid, and position

app.R
leverage new 'lookup' df created above
2. based on the position (separate col) of the playerid selected:
2a. load the appropriate df (hitter or pitcher)
2b. filter for the selected playerid
2c. pluck the right stats out
2d. create like a stats_block or something. (this is currently called prompt_text)
2e. choose the right base prompt (hitter or pitcher)
2f. insert the stats_block (prompt_text) into the right base_prompt
2g. make sure to preserve the 'vibe' selected.
2h. send the prompt to chatgpt
2i. display the results



... we'll handle shohei ohtani later. 
====


1. read in all csv's
2. take the previous 3 years: 2022-2024
3. compute the cumulative stats: era, xera, fip, k%, bb%, k-bb%, xera-era gap, fip era gap, barrel rate, LD rate, babip, lob, o-swing %, c_sw_str_percent
4. save it to a last_3_p tibble
5. do the same for 2025 stats
6. join by playerid's
7. compute current year, prev_3, and the diff
8. save everything as the full df

```{r}
current_year <- 2025

pitching_stats_last_3 <-
  bind_rows(
    read_csv("pitcher-stats-2022.csv", show_col_types = FALSE) |> mutate(year = 2022),
    read_csv("pitcher-stats-2023.csv", show_col_types = FALSE) |> mutate(year = 2023),
    read_csv("pitcher-stats-2024.csv", show_col_types = FALSE) |> mutate(year = 2024)
  ) |>
  group_by(playerid, name, position) |>
  summarize(
    era = sum(er) / sum(ip) * 9,
    k_percent = sum(so) / sum(tbf) * 100,
    bb_percent = sum(bb) / sum(tbf) * 100,
    k_minus_bb_percent = k_percent - bb_percent,
    xera = weighted.mean(x_era, w = tbf, na.rm = TRUE),
    era_xera_gap = era - xera,
    fip = weighted.mean(fip, w = tbf, na.rm = TRUE),
    era_fip_gap = era - fip,
    barrel_percent = weighted.mean(barrel_percent, w = tbf, na.rm = TRUE) * 100,
    o_swing_percent = weighted.mean(o_swing_percent, w = tbf, na.rm = TRUE),
    babip = weighted.mean(babip, w = tbf, na.rm = TRUE),
    lob_percent = weighted.mean(lob_percent, w = tbf, na.rm = TRUE) * 100,
    csw_percent = weighted.mean(c_sw_str_percent, w = tbf, na.rm = TRUE) * 100,
    hr_fb = weighted.mean(hr_fb, w = tbf, na.rm = TRUE),
    .groups = "drop"
  )

# get stats for current year
params <- list(
  pos       = "all",
  stats     = "pit",
  lg        = "all",
  qual      = "1",
  season    = "2025",
  season1   = "2025",
  startdate = "",
  enddate   = "",
  month     = "0",
  ind       = "0",
  type      = "c,7,8,13,-1,43,44,48,51,-1,-1,6,332,45,62,-1,59,6,17,18,19,20,24,14,45,62,43,51,324,328,332,139,140,141,142,143,144,204,210,3,331",
  sortcol   = "4",
  sortdir   = "default",
  pageitems = "500", # pull up to 500 rows
  pagenum   = "1"
)

# 2. Construct the query string and full URL:
qstring <- paste0(names(params), "=",
  vapply(params, URLencode, "", reserved = TRUE),
  collapse = "&"
)
url_api <- paste0("https://www.fangraphs.com/api/leaders/major-league/data?", qstring)

# 3. Fetch & parse the JSON:
raw <- fromJSON(url_api)
pitching_stats_current <-
  raw$data |>
  as_tibble() |>
  clean_names() |>
  mutate(
    name = str_remove_all(name, "<[^>]+>") # remove anything that looks like <â€¦>
  ) |>
  select(playerid, mlbamid = x_mlbamid, name, season, age, g, gs, ip, tbf, h, er, hr, so, bb, ibb, hbp, babip, lob_percent, fip, x_fip, ld_percent, hr_fb, f_bv, c_tv, s_fv, o_swing_percent, csw_percent = c_sw_str_percent, x_era, position, ev90, barrels, barrel_percent) |>
  mutate(
    xera = x_era,
    position = if_else(gs / g >= .5 | ip / g > 4, "SP", "RP"),
    k_percent = so / tbf * 100,
    bb_percent = bb / tbf * 100,
    k_minus_bb_percent = k_percent - bb_percent,
    era = (er / ip) * 9,
    xera_gap = era - x_era,
    fip_era_gap = era - fip,
    barrel_percent = barrel_percent * 100,
    csw_percent = csw_percent * 100
  )
```

```{r}
full_stats <-
  pitching_stats_current |>
  left_join(pitching_stats_last_3, by = c("playerid", "name", "position"), suffix = c("_cur", "_l3")) |>
  mutate(
    era_diff = era_cur - era_l3,
    k_percent_diff = k_percent_cur - k_percent_l3,
    bb_percent_diff = bb_percent_cur - bb_percent_l3,
    k_minus_bb_percent_diff = k_minus_bb_percent_cur - k_minus_bb_percent_l3,
    xera_diff = xera_cur - xera_l3,
    o_swing_percent_diff = o_swing_percent_cur - o_swing_percent_l3,
    csw_percent_diff = csw_percent_cur - csw_percent_l3,
    barrel_percent_diff = barrel_percent_cur - barrel_percent_l3,
    lob_percent_diff = lob_percent_cur - lob_percent_l3,
    babip_diff = babip_cur - babip_l3
  )



data <-
  full_stats |>
  filter(name == "David Bednar")

prompt <- glue(
  "Player: {data$name}
    Year: {current_year}

    Key metrics to analyze:

    Age: {data$age}
    Position: {data$position}
    Batters Faced: {data$tbf}

    ERA: {data$era_cur}  Last 3 Years: {data$era_l3}  Diff: {data$era_diff}
    xERA: {data$xera_cur}  Last 3 Years: {data$xera_l3}  Diff: {data$xera_diff}

    BABIP: {data$babip_cur}  Last 3 Years: {data$babip_l3}  Diff: {data$babip_diff}
    Barrel Rate: {data$barrel_percent_cur}  Last 3 Years: {data$barrel_percent_l3}  Diff: {data$barrel_percent_diff}
    Strikeout rate: {data$k_percent_cur}  Last 3 Years: {data$k_percent_l3}  Diff: {data$k_percent_diff}
    Called Strike & Whiff Rate (CSW%): {data$csw_percent_cur}  Last 3 Years: {data$csw_percent_l3}  Diff: {data$csw_percent_diff}

    Outside Zone Swing Rate (O-Swing%): {data$o_swing_percent_cur}  Last 3 Years: {data$o_swing_percent_l3}  Diff: {data$o_swing_percent_diff}
    Walk rate: {data$bb_percent_cur}  Last 3 Years: {data$bb_percent_l3}  Diff: {data$bb_percent_diff}

    K-BB%: {data$k_minus_bb_percent_cur}  Last 3 Years: {data$k_minus_bb_percent_l3}  Diff: {data$  k_minus_bb_percent_diff}
    LOB% (Left-on-base rate): {data$lob_percent_cur}  Last 3 Years: {data$lob_percent_l3}  Diff: {data$lob_percent_diff}

Guidelines for analysis:

Core skill indicators are strikeout rate, walk rate, and K-BB%. Fluctuations here are more indicative of core skillset changes than luck. Barrel Rate is another core skill indicator. Smaller numbers here indicate weaker contact against the pitcher and thus a more believable BABIP.

Low CSW% but high K% indicates a luck issue or potential negative regression in the future.

Similarly, low O-Swing% but high BB% indicates fewer 'deserved' walks, hinting at negative regression in this stat. (The opposite is true.)

Your primary indicators of luck (good or bad) are BABIP and LOB%. Use these in your analysis. That said, high-strikeout pitchers tend to have higher LOB%. Gap between ERA and xERA (expected ERA) also indicates luck.

Consider the player's sample size (TBF: total batters faced) and their position (RP: reliever, SP: starter.) Relievers are more volatile because they pitch in smaller samples. Starters with fewer batters faced are more prone to the same volatility. A typical starter will face 700 or so batters in a season. As the pitcher's TBF moves up towards this number, the analysis can become more stable/concrete.

Take age into account. Give younger players more grace and older players less.

    "
)

api_key <- Sys.getenv("OPENAI_API_KEY")


# define payload

res <- POST(
    "https://api.openai.com/v1/chat/completions",
    add_headers(Authorization = paste("Bearer", api_key)),
    content_type_json(),
    body = toJSON(list(
      model = "gpt-4.1",
      messages = list(
        list(role = "system", content = "You are a sabermetric baseball analyst skilled in evaluating pitcher performance, tasked with understanding both current in-season performance and getting a sense of future performance for the rest of the season. You need to communicate to a technical audience, but also to the lay audience who just wants to know how excited or concerned they should be about this player."),
        list(role = "user", content = glue("

Data: {prompt}

General instructions:

Please analyze how the player is performing this year, what trends stand out, and whether any aspects of the performance appear to be skill- or luck-driven. Incorporate a prediction: will the player improve, decline, or stay the same for the rest of the season? Explain your reasoning.

The very first element of the response should be a title that encompasses your findings.

Your analysis must incorporate metric, direction, and magnitude of difference. For example BB% is up, indicate by how much, and what the size of that gap might indicate. You don't need to explicitly call out this framing (e.g. in bullets), just make sure to weave it into your analysis.

Separate your analysis into core skills and luck/regression indicators.

Don't repeat yourself. For example, if you say a stat or performance or trend is 'lucky', you don't need to say it's 'not unlucky'.

Remember that when it comes to stats and trends, you only have knowledge of two things: a player's current-year stats and the average of the same stats for the past 3 years (e.g. not their entire career). So when you say things like a stat is 'up' or 'down', make it clear that this is relative to the last 3 years' average.
"
        ))
      ),
      temperature = 0.7
    ), auto_unbox = TRUE)
  )

 parsed <- content(res, as = "parsed", type = "application/json")
  if (!is.null(parsed$error)) {
    return(HTML(paste0("<p style='color:red;'>GPT API error: ", parsed$error$message, "</p>")))
  }
  if (is.null(parsed$choices) || length(parsed$choices) == 0) {
    return(HTML("<p style='color:red;'>No response from GPT.</p>"))
  }
  text <- parsed$choices[[1]]$message$content
  HTML(commonmark::markdown_html(text))


```
