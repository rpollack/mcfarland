```{r setup, include=FALSE, echo=FALSE}


library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

### Get data

```{r}

gd_info <- fg_db %>%
  tbl("gd_roster") %>%
  select(mlbamid, playerid)

fg_info <- fg_db %>%
  tbl("player_info") %>%
  select(PlayerId, FirstName, LastName, BISPosition) %>%
  collect(n=Inf)

batting_war <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0, 
         Season >= 2016) %>%
  select(playerid, Season, wrc_plus = `wRC+`) %>%
  collect(n=Inf)

savant_data_plate_coverage <- fg_db %>%
  tbl("gd_savant") %>%
  filter(game_year >= 2016) %>%
  select(batter, player_name, game_year, description, px, pz) %>%
  inner_join(gd_info, by=c("batter" = "mlbamid")) %>%
  collect(n=Inf) %>%
  filter(str_detect(description, "In play")) %>%
  mutate(px = as.numeric(px),
         pz = as.numeric(pz)) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  filter(!BISPosition %in% c("", "SP", "RP")) %>%
  mutate(Name = sprintf("%s %s", FirstName, LastName),
         
         #compute inches instead of feet
         px_in = px * 12,
         pz_in = pz * 12) %>%
  inner_join(batting_war, by=c("playerid", "game_year" = "Season"))  # add wRC+

```

### Compute plate coverage info

```{r}
plate_coverage_raw <- savant_data_plate_coverage %>%
  group_by(Name, game_year, wrc_plus) %>%
  summarize(num_balls_contacted = n(),
            horiz_coverage = round(mad(px_in), 3),
            vertical_coverage = round(mad(pz_in), 3)) %>%
  mutate(total_coverage = horiz_coverage * vertical_coverage) %>%
  filter(num_balls_contacted >= 50)

# can i draw total coverage for each player, madx * madz??

plate_coverage_change <- plate_coverage_raw %>%
  group_by(Name) %>%
  arrange(game_year) %>%
  mutate(total_coverage_diff = (total_coverage - lag(total_coverage)),
         wrc_diff = wrc_plus - lag(wrc_plus)) %>%
  arrange(desc(total_coverage_diff)) %>%
  filter(!is.na(total_coverage_diff))

```

NEED AN INTRO

To find whose plate coverage improved and declined the most, I looked at all fair balls in both 2016 and 2017. For each non-pitcher who hit at least 50 such balls in each season, I computed the median absolute deviation (MAD) where the pitch crossed the plate on both the x and z axes. (MLB Gameday uses z as the vertical axis because y is the measurement of a pitch's distance from home plate.) Gameday measures in feet but I report here in inches, because baseball is a game of them.

For each axis, the median absolute deviation gives a great idea of the batter's ability to hit inside/outside, or high/low, pitches while keeping them fair.

Examples: The Best and Worst of 2016

The following boxplot shows the players with the worst and best horizontal plate coverages of 2016:

```{r}
example_horiz_coverage <- savant_data_plate_coverage %>%
  filter(game_year == 2016,
         Name %in% c("Caleb Joseph", "Delino DeShields")) %>%
  select(Name, px_in)

example_vertical_coverage <- savant_data_plate_coverage %>%
  filter(game_year == 2016,
         Name %in% c("Taylor Motter", "Corey Dickerson")) %>%
  select(Name, pz_in)

```

```{r}
ggplot(example_horiz_coverage, aes(y=px_in, x=Name)) + geom_boxplot() + geom_jitter() + coord_flip()  +
  ggtitle("Worst and Best Horizontal Plate Coverage, 2016") + labs(x="", y="Horizontal Location of Pitch (inches, catcher's perspective)")
```

In 2016, Delino DeShields' bat covered the smallest amount of home plate, side-to-side, of anyone. His MAD on the x-axis (from here on out, MADx) was 0.375 feet, or 4.5 inches. This means most of the balls DeShields was able to not only hit, but also keep fair, fell within a 4.5-inch-wide horizontal section of home plate.

Conversely, Caleb Joseph had the majors' best horizontal plate coverage. At 9 inches, his MADx was twice DeShields'. Caleb was able to get to a wider variety of pitches that DeShields either couldn't hit or couldn't keep in fair territory. Caleb's excellent horizontal plate coverage makes it all the more strange that he went the entire year without an RBI [https://theringer.com/caleb-joseph-cant-buy-an-rbi-7d045924212a].)

To simplify, just look at the actual boxes in the boxplots above. You'll notice Caleb's box is much larger than DeShields', even though DeShields got to several more inside pitches than Caleb did.

Now: here's where I admit that horizontal plate coverage isn't everything. First, this measurement hides the fact that pitches not only bend and break on the way to home plate, but also have height to them. The boxplot hides both of these  Second, hitters are pitched differently. DeShields' small MADx could be because pitchers frequently threw to the same spots when facing him. Further, DeShields hit 132 balls fair in 2016; Joseph, only 106.

Notice also the small differential between the least and most horizontal plate coverage. 4.5 inches is about 1.5x the diameter of a baseball. This small differential is because home plate is a fixed distance wide. A

Taylor Motter, in his rookie year with the Rays, recorded a MADy of 0.368 feet, or 4.4 inches. If you're wondering, he's listed at 6'1". His teammate Corey Dickerson who also is 6'1" but recorded a MADy of 0.821 feet, or 9.8 inches.

```{r}
ggplot(example_vertical_coverage, aes(y=pz_in, x=Name)) + geom_boxplot() + geom_jitter()  +
  ggtitle("Worst and Best Vertical Plate Coverage, 2016") + labs(x="", y="Vertical Location of Pitch (inches)")
           
```

### Who had the best zone coverage in 2016?

Multiplaying horizontal by vertical coverage tells us who had the most overall coverage in 2016, with a minimum of 50 contacted balls. The leaders:

```{r}
top_10_zone_2016 <- plate_coverage_raw %>%
  filter(game_year == 2016) %>%
  select(Name, `Plate Coverage Distribution (sq. in)` = total_coverage) %>%
  arrange(desc(`Plate Coverage Distribution (sq. in)`))

ggplot(top_10_zone_2016 %>% head(10), aes(reorder(Name, `Plate Coverage Distribution (sq. in)`), `Plate Coverage Distribution (sq. in)`)) + geom_bar(stat="identity") + coord_flip()  + labs(x="") + ggtitle("Largest Plate Coverage, 2016")
```

Joseph and Dickerson lead the list, as does free-swinger Salvador Perez. (Former) teammates Matt Wieters and Adam Jones, another free-swinger, come in next. Except for Joseph, these guys are all full-time players. Their bats can reach a large variety of pitches in the strike zone.

Speaking of full-time players: perhaps the Orioles should consider playing Joseph more. The graph above shows that despite a miserable 6 wRC+ last year, Joseph was the best in the bigs at hitting a wide variety of pitches fair. Combined with his great defense (3.9 runs saved above average so far this year, 7th-best in MLB, per StatCorner [http://www.statcorner.com/CatcherReport.php]) he could be a useful player. The fact that his wRC+ is back to normal levels this year is only more evidence.

When thinking about plate coverage, consider that a baseball is about 2.9 inches in diameter. Joseph's plate coverage of 81 square inches means he can hit a baseball fair that's in about 28 different locations. Abreu's plate coverage of 66 inches means he can reach a baseball in about 23 different locations. Pitchers have more room to miss their spot with Abreu than they do with Joseph. These numbers aren't literal; because we're looking at median absolute deviation, there are exceptions. But the general idea holds. 

Now the 2016 laggards, those with the smallest plate coverage in 2016:

```{r}
bottom_10_zone_2016 <- plate_coverage_raw %>%
  filter(game_year == 2016) %>%
  select(Name, `Plate Coverage Distribution (sq. in)` = total_coverage) %>%
  arrange(desc(`Plate Coverage Distribution (sq. in)`))

ggplot(top_10_zone_2016 %>% tail(10), aes(reorder(Name, `Plate Coverage Distribution (sq. in)`), `Plate Coverage Distribution (sq. in)`)) + geom_bar(stat="identity") + coord_flip()  + labs(x="") + ggtitle("Smallest Plate Coverage, 2016")
```

This list contains catchers and up-the-middle players galore: Avila, Phegley, Garcia, Cervelli, La Stella, Hundley, and DeShields. Motter is a utility player but has spent most of his time at shortstop. None of these guys are particularly good hitters. Now we may have an idea as to why. Pitchers have an easier time with these guys because they can't reach as many balls. The guys in this list mostly rely on their defense to stick in the majors. Alex Avila's coverage fits about 8.6 baseballs in it.

Compariing league-worst Avila to league-best Joseph, we see the differences visually:

```{r}
# compare joseph's coverage to Avila's

joseph_avila <- savant_data_plate_coverage %>%
  filter(game_year == 2016,
         Name %in% c("Caleb Joseph", "Alex Avila")) %>%
  select(Name, px_in, pz_in)

ggplot(joseph_avila, aes(px_in, pz_in)) + geom_point() + facet_grid(~Name) + ggtitle("Locations of Pitches Hit Fair, 2016") +
  labs(x="Horizontal location (inches, catcher's perspective)", y="Vertical location (inches)")

```

Joseph clearly was able to reach, and keep fair, much wider range of pitches than Avila did.

## 2017

It's too early in the season to do leadboards for plate coverage. Instead, let's see who's doing better and worse relative to last year.

The following players have increased their plate coverage the most:

```{r}
# leaders
ggplot(plate_coverage_change %>% head(10), aes(reorder(Name, total_coverage_diff), total_coverage_diff)) + geom_bar(stat="identity") + coord_flip() + labs(y="Difference (sq. inches)", x="") + ggtitle("Largest Increases in Plate Coverage, 2016 – 2017")
```

Peraza's added about 32 square inches of plate coverage, enough to cover the 11 more locations of a pitched baseball. Being a slap/contact hitter, he would do well to maintain a large plate coverage. As it is, his wRC+ of 46 leaves a lot to be desired, even for a speedy shortstop. 

The same holds true for Dyson, another guy who relies on making contact and using his speed to beat out hits.

Garcia, Myers, Mazara, Odor, and Betts are more towards the power side of the hitting spectrum. The idea that they're increasing their plate coverage makes them much scarier opponents.

Now, those who have lost the most plate coverage:

```{r}
#laggards
ggplot(plate_coverage_change %>% tail(10), aes(reorder(Name, total_coverage_diff), total_coverage_diff)) + geom_bar(stat="identity") + coord_flip()  + labs(y="Difference (sq. inches)", x="")
```

Charlie Blackmon is one of the more underrated players in baseball. He and his 122 wRC+ are having another very good year. This fact prompts the question: just how much does plate coverage affect offense? The following graph gives us an idea:

```{r}
plate_coverage_model <- lm(plate_coverage_raw$wrc_plus ~ plate_coverage_raw$total_coverage)
summary(plate_coverage_model)

#ggplot(augment(plate_coverage_model), aes(x = .fitted, y = .resid)) + geom_point()


ggplot(plate_coverage_raw, aes(total_coverage, wrc_plus)) + geom_point() + geom_smooth(method="lm")  + 
  ggtitle("Plate Coverage vs. wRC+, 2016 – May 14, 2017") + labs(y="wRC+", x="Plate Coverage (sq. in)")

#wRC+ = 100.4 - (.0093 * Total Coverage)

```

With eight months of data, the answer appears to be "not much." You can see that the regression line is basically flat, indicating total coverage affects very, very little of wRC+. Interestingly, the line slopes downwards, indicating covering more of the plate is _bad_ for players' offensive output. Mike Trout and his incredibly high wRC+ (171 in 2016; 216 so far in 2017) have a plate coverage of only 53 square inches.

Although we'll have to wait for more data, this makes sense logically: plate coverage indicates simply that a player made contact with a pitch that resulted in a fair ball. Not all fair balls are created equally. Players may be reaching for pitches too much, resulting in weak contact and an easy out instead of extending the plate appearance or simply taking a called strike. A future study of this data should look at exit velocity and launch angle, or perhaps xWOBA on these pitches. 

The following graph further supports the notion that a large plate coverage is a bad thing:

```{r}
plate_coverage_diff_model <- lm(plate_coverage_change$wrc_diff ~ plate_coverage_change$total_coverage_diff)
summary(plate_coverage_model)

#ggplot(augment(plate_coverage_diff_model), aes(x = .fitted, y = .resid)) + geom_point()

ggplot(plate_coverage_change, aes(total_coverage_diff, wrc_diff)) + geom_point() + geom_smooth(method="lm")  + 
  ggtitle("Plate Coverage Change vs. wRC+ Change, 2016 – May 14, 2017") + labs(y="wRC+ Change", x="Plate Coverage Change (sq. in)")
```

Again, the downward-sloping line indicates that players who've added coverage have in general _decreased_ their offensive output. The dot near the bottom-right of the graph is our man Jose Peraza, who leads the league in increased plate coverage but whose wRC+ dropped by 56 runs, the third-largest drop in this dataset.

### Conclusion




Figure out how to order these graphs by year.

```{r}

inciarte_plate_coverage <- savant_data %>%
  filter(game_year >= 2016,
         str_detect(description, "In play"),
         Name == "Ender Inciarte",
         pz > 0) %>%
  select(game_year, px, pz)

franco_plate_coverage <- savant_data %>%
  filter(game_year >= 2016,
         str_detect(description, "In play"),
         Name == "Maikel Franco",
         pz > 0) %>%
  select(game_year, px, pz)


peraza_plate_coverage <- savant_data %>%
  filter(game_year >= 2016,
         str_detect(description, "In play"),
         Name == "Jose Peraza",
         pz > 0) %>%
  select(game_year, px, pz)

shaw_plate_coverage <- savant_data %>%
  filter(game_year >= 2016,
         str_detect(description, "In play"),
         Name == "Travis Shaw",
         pz > 0) %>%
  select(game_year, px, pz)

ggplot(inciarte_plate_coverage, aes(y=px, x=as.character(game_year)))+ 
  geom_boxplot() + geom_jitter() + coord_flip()  + ggtitle("Ender Inciarte Horizontal Plate Coverage, 2016 - 2017") +
  labs(x="", y="Horizontal Location of Contact (feet)")

ggplot(franco_plate_coverage, aes(y=px, x=as.character(game_year))) + geom_boxplot() + geom_jitter() + coord_flip()  +
  ggtitle("Maikel Franco Horizontal Plate Coverage, 2016 - 2017") + labs(x="", y="Horizontal Location of Contact (feet)")

ggplot(peraza_plate_coverage, aes(y=pz, x=as.character(game_year))) + geom_boxplot() + geom_jitter()  +
  ggtitle("Jose Peraza Vertical Plate Coverage, 2016 - 2017") + labs(x="", y="Vertical Location of Contact (feet)")

ggplot(shaw_plate_coverage, aes(y=pz, x=as.character(game_year))) + geom_boxplot() + geom_jitter()  +
  ggtitle("Travis Shaw Vertical Plate Coverage, 2016 - 2017") + labs(x="", y="Vertical Location of Contact (feet)")


```