
notes:
* WAR projections are done using FG WAR & Warcels (link).
* missing seasons are filled in with 1 WAR. this includes seasons prior to a player's debut as well as those #missed due to injury/ineffectiveness/whatever.
* players are assigned to the current team they're on. free agents are not assigned to any team.
* FA computations assume all options are picked up. e.g. starlin castro is given 4 years of control even #though he has three years remaining before his $16 team option in 2020.
* for pre-arb years, minimum salary is used: $535k.
* for arb players, MLBTR projections are used for 2017. for future arb years, including Arb-1's, 25%/40%/60% of FA salary is used to project.
* for Arb-4 players, 80% of salary is used to project
* for players with non-arb contracts, salary under control is computed as AAV of contract * number of years #of control
* for position players, only offensive & defensive WAR is counted. for pitchers, only pitching WAR is counted.
* players who are under contract for longer than 5 years are, for the purposes of this exercise, give 5 years of team control. this is because i only projected WAR out for 5 years. contracts that run more than 5 years contain only the first five years of the player's earnings.
* players who haven't reached arbitration yet use the same calculations but with the minimum salary as their base. so Arb 1 would be assuming a raise from the min. salary, etc.


Questions:

- Win Now-iest team in Baseball
- Worst contract in baseball (least surplus over next 5 years)
- Most efficiently-spending teams over next 5 years

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(glue)
library(stringr)
# library(plotly)
library(ggrepel)
library(scales)


fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color = "white", family = "Lato")
)

fg_db <- dplyr::src_mysql(
  dbname = Sys.getenv("FG_DB"),
  host = Sys.getenv("FG_HOST"),
  user = Sys.getenv("FG_USER"),
  password = Sys.getenv("FG_PW")
)
```


### define meta information about team, such as abbreviation and color to use in graphs

```{r}

# tv household information from http://www.nielsen.com/content/dam/corporate/us/en/docs/solutions/measurement/television/2016-2017-nielsen-local-dma-ranks.pdf
# i set toronto equal to philly because the population sizes are roughly the same per https://www.worldatlas.com/articles/largest-cities-in-north-america.html
# markets with two teams are divided in two for both teams: new york, LA, chicago, SF/OAK; this models the fact that in each market you
# generally pick a team and stick with it
# 2018 payroll source: https://legacy.baseballprospectus.com/compensation/?cyear=2018&team=&pos=

team_info <- tibble(
  team_name = c(
    "ARI", "ATL", "BAL", "BOS", "CHC",
    "CHW", "CIN", "CLE", "COL", "DET",
    "HOU", "KCR", "LAA", "LAD", "MIA",
    "MIL", "MIN", "NYM", "NYY", "OAK",
    "PHI", "PIT", "SDP", "SEA", "SFG",
    "STL", "TBR", "TEX", "TOR", "WSN"
  ),
  team_url = c(
    "arizona-diamondbacks", "atlanta-braves", "baltimore-orioles", "boston-red-sox", "chicago-cubs",
    "chicago-white-sox", "cincinnati-reds", "cleveland-indians", "colorado-rockies", "detroit-tigers",
    "houston-astros", "kansas-city-royals", "los-angeles-angels", "los-angeles-dodgers", "miami-marlins",
    "milwaukee-brewers", "minnesota-twins", "new-york-mets", "new-york-yankees", "oakland-athletics",
    "philadelphia-phillies", "pittsburgh-pirates", "san-diego-padres", "seattle-mariners", "san-francisco-giants",
    "st-louis-cardinals", "tampa-bay-rays", "texas-rangers", "toronto-blue-jays", "washington-nationals"
  ),
  team_color = c(
    "#A71930", "#002F5F", "#ED4C09", "#C60C30", "#003279",
    "#000000", "#C6011F", "#003366", "#333366", "#001742",
    "#072854", "#15317E", "#B71234", "#083C6B", "#F9423A",
    "#182B49", "#072754", "#002C77", "#1C2841", "#003831",
    "#BA0C2F", "#FDB829", "#002147", "#005C5C", "#F2552C",
    "#C41E3A", "#9ECEEE", "#BD1021", "#003DA5", "#BA122B"
  ),
  tv_households = c(
    1890100, 2412730, 1119480, 2424240, 3463060 / 2,
    3463060 / 2, 863800, 1498960, 1630380, 1853030,
    2450800, 919020, 5476830 / 2, 5476830 / 2, 1696330,
    895700, 1742530, 7348620 / 2, 7348620 / 2, 2488090 / 2,
    2942800, 1160220, 1065700, 1808530, 2488090 / 2,
    1215570, 1908590, 2713380, 2942800, 2476680
  ),
  payroll_opening_day_2018 = c(
    131565116, 118284851, 148574615, 233200429, 183156139,
    71217000, 101357500, 134851566, 136953500, 125286000,
    160393900, 123233317, 166649999, 186220715, 99510143,
    90964571, 128713226, 150558844, 166111632, 65985833,
    95270301, 86340001, 94037733, 157903943, 200505278,
    159698667, 76007496, 133137626, 162037223, 180849056
  )
)

# define color scale used in plots below
team_colors <- team_info$team_color
names(team_colors) <- factor(team_info$team_name)
```

#Define functions to read payroll data from bb-ref.

```{r}
# shared by bill petti in FG slack chat on 11.25.2016
# modified by ryan pollack on 1.3.2017 to get detailed payroll information

getPayrolls <- function(Tm, team_name) {

  # need these to construct valid bb-ref URL's
  Tm <- ifelse(Tm == "LAA",
    "ANA",
    ifelse(Tm == "MIA",
      "FLA",
      ifelse(Tm == "TBR",
        "TBD",
        Tm
      )
    )
  )

  url <- paste0("http://www.baseball-reference.com/teams/", Tm, "/", team_name, "-salaries-and-contracts.shtml")
  tms <- url %>%
    read_html() %>%
    html_nodes("table") %>%
    .[[length(.)]] %>%
    html_table(header = TRUE)

  next_year <- 2019
  tms <- tms %>%

    # remove unused cells in the 'Name' column
    filter(!Name %in% c(
      "Name", "", "Arb Costs", "Arb Eligible", "Contract Options",
      "Dollars Committed", "Other Costs", "Option Values", "Other Players",
      "Payroll (no options)", "Payroll (options)", "Signed"
    ))

  # for each player, create multiple rows, one for each "Year", where "value" is either their salary that year, their arbitration status, or their FA status, or blank if the player won't be on the payroll.
  # the 2017, 2018, 2019, etc. columns are the ones collapsed into the 'value' column. because those are left when the others are unselected (with a minus sign)).
  tms_melt <- gather(tms, key = Year, salary, -Name, -Age, -Yrs, -Acquired, -SrvTm, -Agent, -`Contract Status`)
  tms_melt <- tms_melt %>%
    mutate(salary = ifelse(grepl("FA-\\*", salary) == TRUE, "", salary)) %>% # assume options won't happen
    filter(salary != "") %>% # remove years where players aren't on a payroll
    mutate(Team = Tm)
}
```

### Get data from FG DB

```{r}

next_year <- 2019 # this is the year we want to start projecting in
this_year <- next_year - 1

# player ID / Name data from FG. allows distinguishing b/w players with identical names
fg_players <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, TeamId, BirthDate, BISPosition, Position) %>%
  collect(n = Inf)

# projected team for this/next year. allows merging between FG and baseball-reference datasets
fg_projected_teams_batters <- fg_db %>%
  tbl("proj_batting") %>%
  filter(
    Type == "Steamer",
    Season == next_year
  ) %>%
  dplyr::select(PlayerId, Team) %>%
  collect(n = Inf)

fg_projected_teams_pitchers <- fg_db %>%
  tbl("proj_pitching") %>%
  filter(
    Type == "Steamer",
    Season == next_year
  ) %>%
  dplyr::select(PlayerId, Team) %>%
  collect(n = Inf)

# match team abbreviations to those of baseball reference, to allow merging b/w both datasets
fg_projected_teams_all <- bind_rows(fg_projected_teams_batters, fg_projected_teams_pitchers) %>%
  mutate(
    Team = ifelse(Team == "LAN", "LAD", Team),
    Team = ifelse(Team == "SFN", "SFG", Team),
    Team = ifelse(Team == "CHA", "CHW", Team),
    Team = ifelse(Team == "NYA", "NYY", Team),
    Team = ifelse(Team == "NYN", "NYM", Team),
    Team = ifelse(Team == "SDN", "SDP", Team),
    Team = ifelse(Team == "KCA", "KCR", Team),
    Team = ifelse(Team == "CHN", "CHC", Team),
    Team = ifelse(Team == "SLN", "STL", Team),
    Team = ifelse(Team == "WAS", "WSN", Team),
    Team = ifelse(Team == "TBA", "TAM", Team)
  )

# get batting/fielding stats for position players
fg_bat <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>% # get only full-season stats for each player
  dplyr::select(playerid, Season, ValueW) %>%
  collect(n = Inf)

fg_batters <- inner_join(fg_players, fg_bat, by = c("PlayerId" = "playerid")) %>%
  filter(
    Position != "P", # don't get batting WAR for pitchers
    BISPosition != "SP",
    BISPosition != "RP"
  ) %>%
  dplyr::select(PlayerId, FirstName, LastName, Season, BirthDate, ValueW, Position, TeamId)

# get pitching stats for pitchers
fg_pitch <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId, Season, TeamId, ValueW) %>%
  collect(n = Inf)

fg_pitchers <- inner_join(fg_players, fg_pitch, by = "PlayerId") %>%
  filter(BISPosition %in% c("SP", "RP")) %>% # don't get pitching WAR for position players     TODO: should get both WAR projections for Ohtani though
  dplyr::select(PlayerId, FirstName, LastName, Season, BirthDate, ValueW,
    Position = BISPosition,
    TeamId = TeamId.x
  )
```

Combine gathered data into one frame and re-format some data.
Filter out duplicate projections for players like Ohtani
Ensure every player has a WAR value for the 3 years that'll be used for projections; fill in missing years with 0 WAR
Project WAR for the 5 years going forward


### Project WAR each year for the next 5 years for each player
Methodology: http://tangotiger.com/index.php/site/article/war-marcels-...-warcels

```{r}

projected_war <-
  bind_rows(fg_batters, fg_pitchers) %>%
  inner_join(fg_projected_teams_all, by = "PlayerId") %>%
  distinct(PlayerId, FirstName, LastName, Season, BirthDate, ValueW, Position, TeamId, Team) %>% # prevent Shohei Ohtani from having 2 team projections
  filter(Season %in% c(this_year - 2, this_year - 1, this_year)) %>% # retain only years that factor into projections
  dplyr::select(-TeamId) %>%
  mutate(
    FullName = sprintf("%s %s", FirstName, LastName),
    birth_date = as.Date(as.POSIXct(BirthDate)),
    birth_year = format(birth_date, "%Y"),
    Team = ifelse(Team == "TAM", "TBR", Team)
  ) %>%
  dplyr::select(PlayerId, Name = FullName, Season, Team, ValueW, birth_year, Position) %>%

  # give players 0 WAR for missing years
  complete(nesting(PlayerId, Name, birth_year, Team, Position), Season = c(
    this_year - 2, this_year - 1, this_year
  ), fill = list(ValueW = 0)) %>%
  mutate(age = Season - as.numeric(birth_year)) %>%
  group_by(PlayerId, Name) %>%

  # add columns for player's ages and WAR projections in the next five years, then gather into tidy format
  # the style of coding I did allows the column names to a) be years and b) vary year-to-year without having to hunt and peck thru the code
  # i can just change the variable 'next_year' (above) and re-run the code
  arrange(Season) %>%
  mutate(
    age_next_year = age + 1,
    age_in_two_years = age + 2,
    age_in_three_years = age + 3,
    age_in_four_years = age + 4,
    age_in_five_years = age + 5,
    war_next_year = case_when(
      Position %in% c("SP", "RP") ~
      (((0.6 * ValueW) +
        (0.3 * lag(ValueW)) +
        (0.1 * lag(ValueW, 2))) * 0.8) +
        ((26 - age_next_year) * 0.1),
      TRUE ~ (((0.6 * ValueW) +
        (0.3 * lag(ValueW)) +
        (0.1 * lag(ValueW, 2))) * 0.8) +
        ((30 - age_next_year) * 0.1)
    ),
    war_two_years = case_when(
      Position %in% c("SP", "RP") ~
      war_next_year - 0.4,
      TRUE ~ war_next_year - 0.4 + ((30 - age_in_two_years) * .08)
    ),
    war_three_years = case_when(
      Position %in% c("SP", "RP") ~
      war_two_years - 0.4,
      TRUE ~ war_two_years - 0.4 + ((30 - age_in_three_years) * .03)
    ),
    war_four_years = case_when(
      Position %in% c("SP", "RP") ~
      war_three_years - 0.4,
      TRUE ~ war_three_years - 0.4 + ((30 - age_in_four_years) * .03)
    ),
    war_five_years = case_when(
      Position %in% c("SP", "RP") ~
      war_four_years - 0.4,
      TRUE ~ war_four_years - 0.4 + ((30 - age_in_five_years) * .03)
    )
  ) %>%
  filter(Season == this_year) %>% # this row has all the relevant WAR projections in it
  select(PlayerId, Name, Team, birth_year, Position, contains("war_")) %>%
  gather(Season, war, contains("war_")) %>%
  mutate(Season = as.numeric(str_replace_all(Season, c(
    "war_next_year" = glue("{next_year}"),
    "war_two_years" = glue("{next_year + 1}"),
    "war_three_years" = glue("{next_year + 2}"),
    "war_four_years" = glue("{next_year + 3}"),
    "war_five_years" = glue("{next_year + 4}")
  )))) %>%
  select(PlayerId, Name, Season, Team, Position, war)
```

### Figure out a rough relationship between WAR and Arb-1 salaries, for the purposes of estimating Arb-1 salaries for other players. This section only needs to be run once.

```{r, echo=FALSE, eval=FALSE}

find_cumulative_war_through_year <- function(name, year) {
  # search both batter & pitcher data frames for the player and return their cumulative
  # fWAR through the given year. this tactic works because each player appears in only one data frame.

  fname <- str_split(name, " ", simplify = TRUE, n = 2)[1]
  lname <- str_split(name, " ", simplify = TRUE, n = 2)[2]

  batter_search <- fg_batters %>%
    filter(
      FirstName == fname,
      LastName == lname,
      Season >= (year - 4), # restrict year floor to ensure we're getting the player we want
      Season < year
    )

  pitcher_search <- fg_pitchers %>%
    filter(
      FirstName == fname,
      LastName == lname,
      Season >= (year - 4),
      Season < year
    )

  search_space <- bind_rows(batter_search, pitcher_search)

  return(sum(search_space$ValueW))
}
find_cumulative_war_through_year <- Vectorize(find_cumulative_war_through_year)

# arbitration data from MLBTR datafiles
arb_2016 <- read_tsv("arbitration-2016.txt")
arb_2016 <- arb_2016 %>%
  dplyr::select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2016)

arb_2015 <- read_tsv("arbitration-2015.txt")
arb_2015 <- arb_2015 %>%
  dplyr::select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2015)

arb_2014 <- read_tsv("arbitration-2014.txt")
arb_2014 <- arb_2014 %>%
  dplyr::select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2014)

all_arb <- bind_rows(arb_2015, arb_2016, arb_2014) %>%
  filter(
    SrvTm >= 2,
    SrvTm <= 3.9
  ) %>% # make sure I catch first-year arbs only
  dplyr::select(-SrvTm)

all_arb$SettledAmt <- gsub("\\$", "", all_arb$SettledAmt)
all_arb$SettledAmt <- gsub("MM", "", all_arb$SettledAmt)
all_arb$SettledAmt <- as.double(all_arb$SettledAmt)

all_arb <- all_arb %>%
  mutate(
    war_at_signing = find_cumulative_war_through_year(Name, Year),
    predicted_arb = 1.36881 + (.26896 * war_at_signing)
  ) # based on linear model of Arb-1 ~ WAR
```

### get payroll information 

```{r}
# TODO: change do() to map_df()

# get payroll information for all teams, keep only the players who have contract information, keep only the next five years of information for each player, and change some players' names to match how they are formatted in the FanGraphs database, so information from the two datasets can be joined together later.

all_teams_payroll <- team_info %>%
  group_by(team_name) %>%
  do(getPayrolls(.$team_name, .$team_url)) %>%
  filter(`Contract Status` != "") %>%
  dplyr::select(Team = team_name, Name, Acquired, Age, Year, salary) %>%
  group_by(Name, Team) %>%
  top_n(-5, wt = Year) %>% # take only up to the next 5 years because that's all we can project out with WARcels
  ungroup() %>%
  mutate(Name = str_replace_all(Name, c(
    "Danny Coulombe" = "Daniel Coulombe",
    "Daniel Ponce de Leon" = "Daniel Poncedeleon",
    "Gio Urshela" = "Giovanny Urshela",
    "Cedric Mullins" = "Cedric Mullins II",
    "Mike Soroka" = "Michael Sorokad",
    "Nate Karns" = "Nathan Karns",
    "Mike Wright" = "Mike Wright Jr.",
    "Josh James" = "Joshua James",
    "AJ Reed" = "A.J. Reed"
  ))) 


# TODO: change more names to match those in FG. to find names that need changing, run this code:
# anti_join(all_teams_payroll, projected_war) %>% distinct(Name, Team) %>% View()
```

combine payroll information with WAR projections to produce controlled surplus value information

```{r}

# there are several types of salaries that need identifying.
# 1. straight-up salary entries: pre-arb years and contract years (actual and estimated by MLBTR). these are easy.
# for all other players, we need to identify their arb years, project Arb-1 salary, and project future arb salaries off that.
# 2. Some Arb years need identifying, because bb-ref just puts in "Arb" w/no indication of which year it is
# 2a. we identify some of these by their proximity to the player's FA year & whether they're a super two player.
# 2b. others can't be identified because the player's FA year is not in the dataset. have to input these manually.
# 3. after all Arb years are identified, we can project Arb-1 salaries based on cumulative WAR.
# 4. but, some players are labeled Arb-2 or Arb-3 salaries with no previous year's info to base a projection on.
# you can find #4 with the following code: all_teams_payroll %>% group_by(Name, Team) %>% arrange(Year) %>% filter(Year == min(Year), str_detect(salary, "^Arb-2") | str_detect(salary, "^Arb-3") | str_detect(salary, "^Arb-4"), !str_detect(salary, "M"), !str_detect(salary, "k"))

millions_per_war <- 8

master_list <-
  all_teams_payroll %>%
  mutate( # handle type 1
    Season = as.numeric(Year),
    salary = ifelse(grepl("M", salary), as.double(str_extract(salary, "(?<=\\$)[:digit:]+\\.*[:digit:]*")), salary),
    salary = ifelse(grepl("k", salary), as.double(str_extract(salary, "(?<=\\$)[:digit:]+")) / 1000, salary),
    salary = ifelse(grepl("Pre-Arb", salary), 0.555, salary),

    # identify super two players (those w/4 years of arbitration)
    super_two = ifelse(Name %in% c(
      # 2014 players: http://m.mlb.com/news/article/101257198/mlb-and-mlbpa-finalize-list-of-super-two-players/
      "Collin Cowgill", "Anthony Bass", "Alex Presley", "Martin Maldonado", "Shane Robinson", "Hector Sanchez", "Zach Britton",
      "Joe Wieland", "Vance Worley", "Jared Hughes", "Drew Smyly", "Louis Coleman", "Casy Fien", "Tommy Milone", "Kevin Gausman",
      # 2015 players: https://www.mlbtraderumors.com/2015/10/list-of-2016-super-two-qualifiers.html
      "Dan Jennings", "George Kontos", "Justin Grimm", "Arodys Vizcaino", "Avisail Garcia", "Jurickson Profar", "Jedd Gyorko",
      "Juan Lagares", "Didi Gregorius", "Erasmo Ramirez", "Chris Archer", "Nolan Arenado", "Will Smith", "Jean Machi", "Seth Maness",
      "Scott Van Slyke", "David Lough", "Chris Hatcher", "Evan Scribner", "Nick Tepesch",
      "Zach Putnam", "Chris Withrow", "Kole Calhoun", "Jeff Manship", "Anthony Rendon",
      # 2016 players: https://www.mlbtraderumors.com/2016/10/projected-super-two-cutoff-2016.html
      "George Springer", "Danny Salazar", "Matt Shoemaker", "Sam Dyson", "Marcus Stroman", "David Peralta", "Rougned Odor",
      "Kevin Kiermaier", "Brett Oberholtzer", "Ehire Adrianza",
      # baseball-reference lists several players as arb-eligible 4 times despite no official word on their status. I'll trust BB-ref here.
      "Addison Russell", "Cam Bedrosian", "Carlos Rodon", "Corey Knebel", "Felipe Rivero", "Hunter Strickland", "Kris Bryant",
      "Maikel Franco", "Michael Lorenzen", "Mike Foltynewicz", "Odrisamer Despaigne", "Austin Hedges", "Carlos Estevez",
      "Dario Alvarez", "Elias Diaz", "Jose Ramirez", "Justin Nicolino", "Mac Williamson", "Matt Boyd",
      "Michael Fulmer", "Nick Goody", "Tim Adleman", "Tyler Naquin",
      # 2017: https://www.mlbtraderumors.com/2017/10/projected-arbitration-salaries-for-2018.html
      "Andrew Heaney", "J.C. Ramirez", "Lance McCullers", "Dominic Leone", "Mike Foltynewicz", "Cory Knebel", "Kris Bryant",
      "Addison Russell", "Hunter Strickland", "Noah Syndergaard", "Matt Szczur", "Maikel Franco", "Felipe Rivero",
      "Michael Lorenzen", "Zach Rosscup", "Yolmer Sanchez", "Chasen Shreve",
      
      # https://www.mlbtraderumors.com/2018/10/super-two-cutoff-mlb-2018-2019.html
      "Trea Turner", "Matthew Boyd", "Carl Edwards Jr.", "Cody Bellinger"
    ),
    TRUE, FALSE
    )
  ) %>%
  group_by(Name) %>%
  arrange(Year) %>%
  mutate( # handle type 2a
    salary = ifelse(super_two & salary == "Arb",
      ifelse(lead(salary) == "FA",
        "Arb-4",
        ifelse(lead(salary, 2) == "FA",
          "Arb-3",
          ifelse(lead(salary, 3) == "FA",
            "Arb-2",
            ifelse(lead(salary, 4) == "FA", "Arb-1", salary)
          )
        )
      ),
      salary
    ),
    salary = ifelse(!super_two & salary == "Arb",
      ifelse(lead(salary) == "FA",
        "Arb-3",
        ifelse(lead(salary, 2) == "FA",
          "Arb-2",
          ifelse(lead(salary, 3) == "FA",
            "Arb-1",
            salary
          )
        )
      ),
      salary
    ),
    # handle type 2b
    salary = ifelse(Name == "Blake Treinen" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Chris Martin" & Year == 2021, "Arb-1", salary),
    salary = ifelse(Name == "Chris Martin" & Year == 2022, "Arb-2", salary),
    salary = ifelse(Name == "Ehire Adrianza" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Erisbel Arruebarrena" & Year == 2021, "Arb-1", salary),
    salary = ifelse(Name == "Erisbel Arruebarrena" & Year == 2022, "Arb-2", salary),
    salary = ifelse(Name == "Hansel Robles" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Jake Smolinski" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Jorge Soler" & Year == 2021, "FA", salary), # spotrac
    salary = ifelse(Name == "Josh Phegley" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Kendall Graveman" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Lance McCullers" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Lance McCullers" & Year == 2021, "Arb-4", salary),
    salary = ifelse(Name == "Marcus Semien" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Noah Syndergaard" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Robbie Grossman" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Rusney Castillo" & Year == 2021, "FA", salary), # spotrac
    salary = ifelse(Name == "Rusney Castillo" & Year == 2022, "FA", salary), # spotrac
    salary = ifelse(Name == "Trevor May" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Yuli Gurriel" & Year == 2021, "FA", salary), # spotrac

    # handle type 4 if a player has guaranteed money. not all do; for example many are minor league FA's
    salary = ifelse(Name == "Chris Carter" & Year == 2018, 1.75, salary), # spotrac
    salary = ifelse(Name == "Carlos Torres" & Year == 2018, 1.5, salary),
    salary = ifelse(Name == "Evan Scribner" & Year == 2018, 0.8, salary),
    salary = ifelse(Name == "Kevin Siegrist" & Year == 2018, 1.5, salary),
    salary = ifelse(Name == "Tommy Milone" & Year == 2018, 1.2, salary),
    salary = ifelse(Name == "Vance Worley" & Year == 2018, 1.5, salary),
    salary = ifelse(Name == "Wade LeBlanc" & Year == 2018, 1, salary)
  ) %>%
  filter(!salary %in% c("FA", "$0 [Arb-*]", 0)) %>% # discard FA years and weird option years
  inner_join(projected_war, by = c("Name", "Team", "Season")) %>%
  dplyr::select(PlayerId, Name, Team, Acquired, Position, Season, WAR = war, Salary = salary) %>%
  group_by(PlayerId, Name) %>%
  mutate( # handle type 3
    Salary = ifelse(Salary == "Arb-1", 1.36881 + (.26896 * (cumsum(WAR))), Salary) # use linear model i computed elsewhere in this doc
  ) %>%
  ungroup() %>%
  arrange(PlayerId, Name, Season) %>%
  mutate( # use model from The Point of Pittsburgh to project future arb salaries
    Salary = ifelse(Salary == "Arb-2", (as.double(lag(Salary)) / .25) * .4, Salary),
    Salary = ifelse(Salary == "Arb-3", (as.double(lag(Salary)) / .4) * .6, Salary),
    Salary = ifelse(Salary == "Arb-4", (as.double(lag(Salary)) / .6) * .7, Salary),
    Salary = as.numeric(Salary) * ((1-0.0215)^(Season - next_year)), # inflate actual salary each year by the average of the last 3 years' Feb-Feb YoY rates:        
                                                                      # https://inflationdata.com/Inflation/Inflation_Rate/CurrentInflation.asp?reloaded=true
    surplus_value = ((millions_per_war * (1.03^(Season - next_year))) * WAR) - Salary # inflate $/WAR by 5% annually
  ) %>%
  ungroup() %>%
  mutate(Division = ifelse(Team %in% c("BAL", "BOS", "NYY", "TBR", "TOR"),
    "AL East",
    ifelse(Team %in% c("CHW", "MIN", "CLE", "DET", "KCR"),
      "AL Central",
      ifelse(Team %in% c("HOU", "TEX", "LAA", "SEA", "OAK"),
        "AL West",
        ifelse(Team %in% c("WSN", "NYM", "PHI", "MIA", "ATL"),
          "NL East",
          ifelse(Team %in% c("CHC", "STL", "CIN", "PIT", "MIL"),
            "NL Central",
            ifelse(Team %in% c(
              "ARI", "LAD", "COL",
              "SFG", "SDP"
            ),
            "NL West",
            NA_character_
            )
          )
        )
      )
    )
  ),
  Division = factor(Division, levels = c("AL East", "AL Central", "AL West", "NL East", "NL Central", "NL West")))

# retain players with more than 0 WAR under control or whose AAV is over $3 mil.
# these are the guys who will likely get playing time no matter what
# this also removes the scrub relievers who shouldn't really be considered part of a team
warcels <-
  master_list %>%
  group_by(PlayerId, Name, Team, Acquired, Division) %>%
  summarize(
    controlled_years = n(),
    war_under_control = round(sum(WAR), 1),
    salary_under_control = round(sum(Salary, na.rm = TRUE), 1),
    surplus_value_under_control = sum(surplus_value, na.rm = TRUE),
    aav = salary_under_control / controlled_years
  ) %>%
  filter(war_under_control > 0 | aav >= 3) %>%
  mutate(war_per_year_of_control = round(war_under_control / controlled_years, 1))

# save to disk for future analysis
write_csv(warcels, "warcels-2019.csv")

# combine with previous years to do YoY change analysis
warcels_full <-
  warcels %>%
  mutate(year_analyzed = 2019) %>%
  bind_rows(read_csv("warcels-2018.csv") %>%
    mutate(year_analyzed = 2018)) %>%                          # how to account for inflation?
  dplyr::select(PlayerId, Name, year_analyzed, everything())
```


### Team WAR and Controlled Surplus Value per season for the next five years

```{r, fig.height=3}

# TODO: in all graph titles, make <from_year> - <to_year> dynamic to the current year

# team timeline
team_war_per_season <-
  master_list %>%
  inner_join(warcels, by = c("Name", "Team", "Division")) %>% # retain only warcels players
  group_by(Team, Division, Season) %>%
  summarize(
    controlled_war = sum(WAR),
    controlled_surplus_value = sum(surplus_value, na.rm = TRUE)
  ) %>%
  mutate(label = ifelse(Team %in% c("NYY", "CLE", "HOU", "LAD", "MIL", "NYM") &
    Season == min(Season),
  Team,
  NA_character_
  ))

team_war_per_season %>%
  ggplot(aes(Season, controlled_war, color = Team, fill = Team)) + geom_point() + geom_line() +
  labs(y = "WAR Under Control", caption = glue("Sources: Baseball Reference, FanGraphs, & Tom Tango
                                                                        By Ryan Pollack: ryanpollack.com"
                                                                        )) +
  facet_wrap(~Division, ncol = 3) +
  ggtitle(glue("Team Controlled WAR Per Season, {next_year} - {next_year + 4}")) +
  geom_label_repel(aes(label = label),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black",
    nudge_x = 0.5
  ) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors)

team_war_per_season %>%
  ggplot(aes(Season, controlled_surplus_value, color = Team, fill = Team)) + geom_point() + geom_line() + fgt +
  labs(y = "Surplus Value Under Control (Millions USD)", caption = glue("Sources: Baseball Reference, FanGraphs, & Tom Tango
                                                                        By Ryan Pollack: ryanpollack.com"
                                                                        )) +
  facet_wrap(~Division, ncol = 3) +
  ggtitle(glue("Team Controlled Surplus Value Per Season, {next_year} - {next_year + 4}")) +
  geom_label_repel(aes(label = label),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black"
  ) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors)

# team WAR per season AL East
team_war_per_season %>%
  filter(Division == "AL East") %>%
  ggplot(aes(Season, controlled_war, color = Team, fill = Team)) + geom_point() + geom_line() +
  labs(y = "WAR Under Control", caption = "Sources: Baseball Reference, FanGraphs, & Tom Tango") +
  ggtitle(glue("Team Controlled WAR Per Season, {next_year} - {next_year + 4}"),
          subtitle = "AL East Division") +
  geom_label_repel(aes(label = label),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black",
    nudge_x = 1
  ) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) + fgt
```


Graphs - Players

```{r}

surplus_value_change_plt <-
  warcels_full %>%
  group_by(PlayerId, Name) %>%
  arrange(year_analyzed) %>%
  mutate(surplus_value_change = surplus_value_under_control - lag(surplus_value_under_control)) %>%
  filter(!is.na(surplus_value_change))


# players with the most WAR under control
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  arrange(desc(war_under_control)) %>%
  head(25) %>%
  ggplot(aes(reorder(Name, war_under_control), war_under_control)) +
  geom_col() + coord_flip() + fgt +
  labs(x = "", y = "Controlled WAR") +
  ggtitle(glue("Top 10 Controlled WAR, {next_year} – {next_year + 4}"))

warcels_full %>%
  filter(year_analyzed == next_year) %>%
  arrange(desc(war_under_control)) %>%
  tail(25) %>%
  ggplot(aes(reorder(Name, war_under_control), war_under_control)) +
  geom_col() + coord_flip() + fgt +
  labs(x = "", y = "Controlled WAR") +
  ggtitle(glue("Bottom 10 Controlled WAR, {next_year} – {next_year + 4}"))


# players with the most surplus value
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  arrange(desc(surplus_value_under_control)) %>%
  head(10) %>%
  ggplot(aes(reorder(Name, surplus_value_under_control), surplus_value_under_control)) +
  geom_col() + coord_flip() + fgt +
  labs(x = "", y = "Controlled Surplus Value (Millions USD)") +
  ggtitle(glue("Top 10 Controlled Surplus Value, {next_year} – {next_year + 4}"))

# players with the least surplus value
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  arrange(desc(surplus_value_under_control)) %>%
  tail(10) %>%
  ggplot(aes(reorder(Name, surplus_value_under_control), surplus_value_under_control)) +
  geom_col() + coord_flip() + fgt +
  labs(x = "", y = "Controlled Surplus Value (Millions USD)") +
  ggtitle(glue("Bottom 10 Controlled \"Surplus\" Value, {next_year} – {next_year + 4}"))

# 10 players who gained the most controlled WAR YoY
# exclude players who signed any kind of contract; 
# they will get an artificial boost from the fact they're getting an increase in CONTROL.
# I want to focus on an increase in projected talent.
# warcels_full %>%
#   group_by(PlayerId, Name) %>%
#   arrange(year_analyzed) %>%
#   mutate(controlled_war_change = war_under_control - lag(war_under_control)) %>%
#   arrange(desc(controlled_war_change)) %>%
#   head(10) %>%
#   ggplot(aes(reorder(Name, controlled_war_change), controlled_war_change)) +
#   geom_col() + coord_flip() + fgt +
#   labs(x="", y = "Change in Controlled WAR") +
#   ggtitle(glue("Largest Gains in Controlled WAR, {this_year} – {next_year}"),
#           subtitle = glue("Excluding {this_year} Free Agents"))

# 10 players who lost the most surplus value YoY
# surplus_value_change_plt %>%
#   arrange(surplus_value_change) %>%
#   head(10) %>%
#   ggplot(aes(reorder(Name, surplus_value_change), surplus_value_change)) +
#   geom_col() + coord_flip() +
#   labs(x = "", y = "Change in Controlled Surplus Value (Millions USD)") +
#   ggtitle(glue("Largest Drops in Controlled Surplus Value, {this_year} – {next_year}")) + fgt
# 
# # 10 players who gained the most surplus value YoY
# surplus_value_change_plt %>%
#   arrange(desc(surplus_value_change)) %>%
#   head(10) %>%
#   ggplot(aes(reorder(Name, surplus_value_change), surplus_value_change)) +
#   geom_col() + coord_flip() +
#   labs(x = "", y = "Change in Controlled Surplus Value (Millions USD)") +
#   ggtitle(glue("Largest Gains in Controlled Surplus Value, {this_year} – {next_year}")) + fgt


# scatterplot of players' changes, so they are broken out by WAR; current Indians players are labeled for context of an article I'm writing.
# warcels_full %>%
#   group_by(PlayerId, Name) %>%
#   arrange(year_analyzed) %>%
#   mutate(controlled_war_change = war_under_control - lag(war_under_control),
#          controlled_salary_change = salary_under_control - lag(salary_under_control),
#          label = if_else(year_analyzed == 2019 & Name %in% c("Carlos Carrasco",
#                                                              "Francisco Lindor",
#                                                              "Mike Clevinger", 
#                                                              "Jose Ramirez"), Name, NA_character_)) %>% 
#  # filter(controlled_years_change == -2)
#   ggplot(aes(controlled_salary_change, controlled_war_change)) +
#   geom_point() + fgt +
#   geom_label_repel(aes(label = label),
#     na.rm = TRUE,
#     show.legend = FALSE,
#     direction = "both",
#     nudge_x = 10
#   ) 

```


Graphs - Teams

```{r}
# controlled WAR, teams
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  group_by(Team) %>%
  summarize(total_controlled_war = sum(war_under_control)) %>%
  ggplot(aes(reorder(Team, total_controlled_war), total_controlled_war),
    color = Team, fill = Team
  ) +
  geom_col() +
  coord_flip() +
  fgt +
  scale_fill_manual(values = team_colors) +
  labs(x = "", y = "Controlled WAR", caption = "Sources: Baseball Reference, FanGraphs, & Tom Tango") +
  ggtitle(glue("MLB Team Controlled WAR, {next_year} – {next_year + 4}"))

# controlled salary, teams
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  group_by(Team) %>%
  summarize(total_controlled_salary = sum(salary_under_control)) %>%
  ggplot(aes(reorder(Team, total_controlled_salary), total_controlled_salary),
         color = Team, fill = Team
  ) +
  geom_col() +
  coord_flip() +
  fgt +
  scale_fill_manual(values = team_colors) +
  labs(x = "", y = "Controlled Salary (Millions USD)", caption = "Sources: Baseball Reference, FanGraphs, & Tom Tango") +
  ggtitle(glue("MLB Team Controlled Salary, {next_year} – {next_year + 4}"))

```

```{r}

# controlled WAR vs. controlled salary
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  group_by(Team) %>%
  summarize(total_controlled_salary = sum(salary_under_control),
            total_controlled_war = sum(war_under_control)) %>%
  ggplot(aes(total_controlled_war, total_controlled_salary), color = Team, fill = Team) +
  geom_point() +
  geom_label_repel(aes(label = Team),
                   na.rm = TRUE,
                   show.legend = FALSE
  ) +
  ggtitle(glue("MLB Controlled WAR vs. Controlled Salary, {next_year} – {next_year + 4}")) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  fgt +
  labs(x = "Controlled WAR", y = "Controlled Salary (Millions USD)", caption = "Sources: Baseball Reference, FanGraphs, & Tom Tango") +
  theme(legend.position = "None")

# Surplus value under control, Teams
warcels_full %>%
  filter(year_analyzed == next_year) %>%
  group_by(Team) %>%
  summarize(total_surplus_value_under_control = sum(surplus_value_under_control)) %>%
  ggplot(aes(reorder(Team, total_surplus_value_under_control), total_surplus_value_under_control),
    color = Team, fill = Team
  ) +
  geom_col() +
  coord_flip() +
  fgt +
  scale_fill_manual(values = team_colors) +
  labs(x = "", y = "Controlled Surplus Value (Millions USD)", caption = "Sources: Baseball Reference, FanGraphs, & Tom Tango") +
  ggtitle(glue("MLB Team Controlled Surplus Value, {next_year} – {next_year + 4}"))

# YoY Controlled Surplus Value, Teams
# warcels_full %>%
#   group_by(year_analyzed, Team) %>%
#   summarize(total_surplus_value_under_control = sum(surplus_value_under_control)) %>%
#   group_by(Team) %>%
#   arrange(year_analyzed) %>%
#   mutate(surplus_value_change = total_surplus_value_under_control - lag(total_surplus_value_under_control)) %>%
#   filter(!is.na(surplus_value_change)) %>%
#   ggplot(aes(reorder(Team, surplus_value_change), surplus_value_change)) +
#   geom_col() + fgt + coord_flip() +
#   labs(x = "", y = "Change in Controlled Surplus Value (Millions USD)", caption = "Sources: Baseball Reference, FanGraphs, & Tom Tango") +
#   ggtitle(glue("Changes in MLB Team Controlled Surplus Value, {this_year} – {next_year}"))

# YoY change in controlled talent vs. change in salary
# this graph is neat but there really is a lot to unpack
# first off it's not really 2018 to 2019, it's ENTERING 2018 vs. ENTERING 2019. still useful though.
# and it is the result of not just players changing teams, but arb and pre-arb players getting better OR getting raises (and thus pushing their projected salaries up).
# year_to_year_team_changes <-
#   warcels_full %>%
#   group_by(year_analyzed, Team) %>%
#   summarize(
#     controlled_war = sum(war_under_control),
#     controlled_salary = sum(salary_under_control)
#   ) %>%
#   group_by(Team) %>%
#   arrange(year_analyzed) %>%
#   mutate(
#     controlled_war_change = controlled_war - lag(controlled_war),
#     controlled_salary_change = controlled_salary - lag(controlled_salary)
#   ) %>%
#   filter(!is.na(controlled_war_change) & !is.na(controlled_salary_change)) %>%
#   group_by(year_analyzed) %>%
#   mutate(
#     zcontrolled_salary_change = (controlled_salary_change - mean(controlled_salary_change)) / sd(controlled_salary_change),
#     zcontrolled_talent_change = (controlled_war_change - mean(controlled_war_change)) / sd(controlled_war_change)
#   )
# 
# # graph YoY team changes in terms of standard deviation, to make the graph look neat
# year_to_year_team_changes %>%
#   ggplot(aes(zcontrolled_salary_change, zcontrolled_talent_change, color = Team, fill = Team)) +
#   geom_point() +
#   geom_label_repel(aes(label = Team),
#     na.rm = TRUE,
#     show.legend = FALSE,
#     color = "white",
#     segment.color = "black",
#     nudge_y = .2,
#     nudge_x = -.05
#   ) +
#   scale_color_manual(values = team_colors) + fgt +
#   scale_fill_manual(values = team_colors) +
#   theme(legend.position = "None") +
#   ggtitle(glue("MLB Team Changes"), subtitle = glue("Prior to {this_year} – Prior to {next_year}")) +
#   labs(x = "Std. Dev. Change in 5-Year Controlled Salary", y = "Std. Dev. Change in 5-Year Controlled WAR") +
#   xlim(-3, 3) + ylim(-3, 3) +
#   geom_hline(yintercept = 0, linetype = "dashed", color = "gray") + geom_vline(xintercept = 0, linetype = "dashed", color = "gray")
# 
# # same as the above graph but in absolute terms
# year_to_year_team_changes %>%
#   ggplot(aes(controlled_salary_change, controlled_war_change, color = Team, fill = Team)) +
#   geom_point() +
#   geom_label_repel(aes(label = Team),
#     na.rm = TRUE,
#     show.legend = FALSE,
#     color = "white",
#     segment.color = "black",
#     nudge_y = .2,
#     nudge_x = -.05
#   ) +
#   scale_color_manual(values = team_colors) + fgt +
#   scale_fill_manual(values = team_colors) +
#   theme(legend.position = "None") +
#   ggtitle(glue("MLB Team Changes"), subtitle = glue("Prior to {this_year} – Prior to {next_year}")) +
#   labs(x = "Change in 5-Year Controlled Salary (Millions USD)", y = "Change in 5-Year Controlled WAR")

# typical player: median years of control vs. median proj. WAR during that control
warcels %>%
  group_by(Team) %>%
  summarize(
    num_players = n(),
    controlled_years_per_player = median(controlled_years),
    controlled_war_per_player = median(war_under_control)
  ) %>%
  ggplot(aes(controlled_years_per_player, controlled_war_per_player, color = Team, fill = Team)) +
  geom_point() +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black",
    nudge_y = .1
  ) +
  ggtitle(glue("Teams' Typical Players, {next_year} – {next_year + 4}"),
          subtitle = "How long the team controls them vs. total WAR projected during that control") +
  scale_color_manual(values = team_colors) + fgt +
  scale_fill_manual(values = team_colors) +
  labs(
    x = "Median Years of Control", y = "Median Projected WAR during Control",
    caption = "\nSources: Baseball Reference (Salary & Control), FanGraphs (WAR), Tom Tango (Projections)\nBy Ryan Pollack: ryanpollack.com"
  ) +
  theme(legend.position = "None") + 
  expand_limits(y=0)

# how much each team is paying for its controlled talent
warcels %>%
  group_by(Team) %>%
  summarize(
    num_players = n(),
    controlled_war_per_player = median(war_under_control),
    controlled_salary = median(salary_under_control)
  ) %>%
  ggplot(aes(controlled_salary, controlled_war_per_player, color = Team, fill = Team)) +
  geom_point() +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black",
    nudge_y = .1
  ) +
  ggtitle(glue("Value of Typical Player, {next_year} – {next_year + 4}"),
          subtitle = "Teams' typical players: total contolled salary vs. total controlled WAR") +
  scale_color_manual(values = team_colors) + fgt +
  scale_fill_manual(values = team_colors) +
  labs(
    x = "Median Salary under Control (USD Millions)", y = "Median Projected WAR during Control",
    caption = "\nSources: Baseball Reference (Salary & Control), FanGraphs (WAR), Tom Tango (Projections)\nBy Ryan Pollack: ryanpollack.com"
  ) +
  theme(legend.position = "None") + 
  expand_limits(y=0)



```




### controlled surplus value relative to media market size

```{r}

# show that teams in smaller markets tend to have more controlled surplus value
warcels %>%
  group_by(Team) %>%
  summarize(total_controlled_surplus_value = sum(surplus_value_under_control)) %>%
  inner_join(team_info, by = c("Team" = "team_name")) %>%
  ggplot(aes(tv_households, total_controlled_surplus_value, color = Team, fill = Team)) +
  geom_point() + fgt + scale_x_continuous(labels = comma) +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black",
    nudge_y = .1
  ) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  theme(legend.position = "None")
  
# what does the graph above say? that the cle/mil surplus value is even stronger when you account for the team's tiny market size.
# that's not the angle i'd hoped for ... i wanted something like, the yankees' surplus value is even more unfair because they're in a large
# media market and as such are a very high-revenue team anyway.


#the idea im trying ot convey is that surplus value means more to the Rays because they're in a smaller market
#actually they're not ... that's the point!


```

```{r}

team_data <-
  inner_join(warcels_team_2018, team_info, by = c("Team" = "team_name")) %>%
  ungroup()

ggplot(team_data, aes(tv_households, total_surplus_value_under_control, color = Team, fill = Team)) + geom_point() +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black"
  ) +
  ggtitle("MLB Team Market Size* vs. Controlled Surplus Value**") +
  scale_color_manual(values = team_colors) + fgt +
  scale_fill_manual(values = team_colors) +
  scale_x_continuous(labels = comma) +
  labs(
    x = "TV-viewing Households in Designated Market Area", y = "Controlled Surplus Value (Millions USD)",
    caption = "* 2016 - 2017, per Nielsen\n** 2018 - 2022"
  ) +
  theme(legend.position = "None")


ggplot(team_data, aes(tv_households, payroll_opening_day_2018,
  color = Team,
  fill = Team
)) + geom_point() +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black"
  ) +
  ggtitle("MLB Team Market Size* vs. 2018 Opening Day Payroll**") +
  scale_color_manual(values = team_colors) + fgt +
  scale_fill_manual(values = team_colors) +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  labs(
    x = "TV-viewing Households in Designated Market Area", y = "2018 Opening Day Payroll (Millions USD) **",
    caption = "* 2016 - 2017, per Nielsen\n** Source: Baseball Prospectus Compentsaion"
  ) +
  theme(legend.position = "none")

# rebuilding teams only
team_data %>%
  filter(Team %in% c("OAK", "CIN", "CHW", "SDP", "PHI", "ATL", "DET", "MIA", "TBR", "PIT", "MIL")) %>%
  ggplot(aes(tv_households, payroll_opening_day_2018, fill = Team, color = Team)) +
  geom_point() +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black"
  ) + fgt +
  theme(legend.position = "none") +
  labs(
    x = "TV-viewing Households in Designated Market Area", y = "2018 Opening Day Payroll (Millions USD) **",
    caption = "* 2016 - 2017, per Nielsen\n** Source: Baseball Prospectus Compentsaion"
  ) +
  theme(legend.position = "none")
# tampa bay should spend more ...

# lowest payroll per market head (rebuilding teams only, lower is better):
team_data %>%
  filter(Team %in% c("OAK", "CIN", "CHW", "SDP", "PHI", "ATL", "DET", "MIA", "TBR", "PIT", "MIL")) %>%
  mutate(payroll_2018_per_tv_household = payroll_opening_day_2018 / tv_households) %>%
  arrange(payroll_2018_per_tv_household) %>%
  View()

# controlled SV of rebuilding teams (higher is better)
team_data %>%
  filter(Team %in% c("OAK", "CIN", "CHW", "SDP", "PHI", "ATL", "DET", "MIA", "TBR", "PIT", "MIL")) %>%
  arrange(desc(total_surplus_value_under_control)) %>%
  ggplot(aes(reorder(Team, total_surplus_value_under_control), total_surplus_value_under_control)) + geom_col() +
  coord_flip() + fgt

# controlled SV per market size (higher is better)
team_data %>%
  filter(Team %in% c("OAK", "CIN", "CHW", "SDP", "PHI", "ATL", "DET", "MIA", "TBR", "PIT", "MIL")) %>%
  mutate(controlled_sv_per_tv_household = total_surplus_value_under_control / tv_households) %>%
  arrange(desc(controlled_sv_per_tv_household)) %>%
  View()

# market size vs surplus value
team_data %>%
  filter(Team %in% c("OAK", "CIN", "CHW", "SDP", "PHI", "ATL", "DET", "MIA", "TBR", "PIT", "MIL")) %>%
  ggplot(aes(tv_households, total_surplus_value_under_control, fill = Team, color = Team)) +
  geom_point() +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = comma) +
  geom_label_repel(aes(label = Team),
    na.rm = TRUE,
    show.legend = FALSE,
    color = "white",
    segment.color = "black"
  ) + fgt +
  theme(legend.position = "none")
```



