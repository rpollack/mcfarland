---
title: "warcels"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Get data

```{r}

fg_players <- fg_db %>%
  tbl("player_info") %>%
  collect(n=Inf)

fg_bat <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%     #get only full-season stats for each player
  collect(n=Inf)

fg_batters <- inner_join(fg_players, fg_bat, by=c("PlayerId" = "playerid")) %>%
  filter(Position != "P",             #don't get batting WAR for pitchers
         BISPosition != "SP",
         BISPosition != "RP") %>%
  select(FirstName, LastName, Season, BirthDate, ValueW, Position)

fg_pitch <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  collect(n=Inf)

fg_pitchers <- inner_join(fg_players, fg_pitch, by="PlayerId") %>%
  filter(BISPosition %in% c("SP", "RP")) %>% #don't get pitching WAR for position players
  select(FirstName, LastName, Season, BirthDate, ValueW, Position = BISPosition)

#combine dataframes
all_players <- bind_rows(fg_batters, fg_pitchers)

```


# For each team, compute the avg. length they control their current roster and the amount of WAR under this control

notes: 
* position players only.
* players with < 3 years in the majors get 0 WAR computed for years they weren't in the league. affects guys like Kris Bryant.
* free agents (and retirees like Teixeira, A-Rod, and Ortiz) are filtered out so their WAR isn't assigned to a team. e.g. Justin Turner isn't accounted for here
* players are assigned to the current team they're on, including any recent trades/FA signings. e.g. moncada is on CWS
* FA computations assume all options are picked up. e.g. starlin castro is given 4 years of control even though he has three years remaining before his $16 team option in 2020.
* players who are under contract for longer than 5 years are, for the purposes of this exercise, give 5 years of team control. this is because i only projected WAR out for 5 years.
* salary under control is computed as AAV of contract * number of years of control
* for position players, only offensive & defensive WAR is counted. for pitchers, only pitching WAR is counted.

# Compute AAV for each player
```{r}

all_teams_payroll <- all_teams_payroll %>%
  mutate(total_contract = str_extract(`Contract Status`, "\\$.*M"),
         total_contract = str_replace(total_contract, "\\$", ""),
         total_contract = str_replace(total_contract, "M", ""),
         total_contract = as.double(total_contract),
         contract_length = as.double(str_extract(`Contract Status`, "[:digit:]+[:space:]")),
         aav = ifelse(is.na(contract_length) == FALSE, round(total_contract / contract_length, 2), 0.5))

```

```{r}

this_year <- 2016
next_year <- this_year + 1

warcels <- all_players %>%
  mutate(FullName = sprintf("%s %s", FirstName, LastName),
         birth_date = as.Date(as.POSIXct(BirthDate)),
         birth_year = format(birth_date, "%Y")) %>%

  #filter out retirees so their WAR ,isn't assigned to a team
  filter(!FullName %in% c("David Ortiz", "Alex Rodriguez", "Mark Teixeira")) %>%

  #compute years of control remaining, limited to 5 years
  inner_join(all_teams_payroll, by=c("FullName" = "Name")) %>%
  mutate(Year = as.integer(Year),
         years_of_control = ifelse(value == "Pre-Arb3", (Year + 4) - next_year,
                                   ifelse(value == "Arb-1", (Year + 3) - next_year,
                                          ifelse(value == "Arb-2", (Year + 2) - next_year,
                                                 ifelse(value == "Arb-3", (Year + 1) - next_year,
                                                        ifelse(value=="FA", Year - next_year, 5))))),
         years_of_control = ifelse(years_of_control > 5, 5, years_of_control)) %>%   #limit to 5 for this exercise
  group_by(FullName) %>%
  arrange(Season) %>%
  
  #project war under team control using tango's method: http://tangotiger.com/index.php/site/article/war-marcels-...-warcels
  mutate(age_now = this_year - as.integer(birth_year),
         age_next_year = age_now + 1, 
         age_in_two_years = age_now + 2,
         age_in_three_years = age_now + 3,
         age_in_four_years = age_now + 4,
         currentWAR = ifelse(is.na(ValueW) == FALSE, ValueW, 1.5),  #players w/o appearances in a season get 0 WAR for that year
         war_last_year = ifelse(is.na(lag(ValueW)) == FALSE, lag(ValueW), 0),
         war_two_years_ago = ifelse(is.na(lag(ValueW, 2)) == FALSE, lag(ValueW, 2), 0),
         step1 = (0.6 * currentWAR) + (0.3 * war_last_year) + (0.1* war_two_years_ago),
         step2 = 0.8 * step1,
         war_next = round(ifelse(Position == "SP" | Position == "RP", step2 + ((26 - age_now) * 0.1),
                                 step2 + ((30 - age_now) * 0.1)), 1),
         war_in_two_years = round(ifelse(Position == "SP" | Position == "RP", war_next - 0.4,
                                         war_next - 0.4 + ((30-age_next_year) * .08)), 1),
         war_in_three_years = round(ifelse(Position == "SP" | Position == "RP", war_in_two_years - 0.4,
                                           war_in_two_years - 0.4 + ((30-age_in_two_years) * .03)), 1),
         war_in_four_years = round(ifelse(Position == "SP" | Position == "RP", war_in_three_years - 0.4, 
                                          war_in_three_years - 0.4 + ((30-age_in_three_years) * .03)), 1),
         war_in_five_years = round(ifelse(Position == "SP" | Position == "RP", war_in_four_years - 0.4,
                                          war_in_four_years - 0.4 + ((30-age_in_four_years) * .03)), 1),
         war_under_control = 
           round(ifelse(years_of_control == 1, war_next,
                  ifelse(years_of_control == 2, war_next + war_in_two_years,
                         ifelse(years_of_control == 3, war_next + war_in_two_years + war_in_three_years,
                                ifelse(years_of_control == 4, war_next + war_in_two_years + war_in_three_years + war_in_four_years,
                                       war_next + war_in_two_years + war_in_three_years + war_in_four_years + war_in_five_years))))
                 , 1),
         salary_under_control = round(ifelse(is.na(aav) == TRUE, .508 * years_of_control, aav * years_of_control), 2),
         Position = ifelse(Position != "SP" & Position != "RP", "foo", "bar"),
         
         #a low number is good, but below 0 is bad. maybe ... abs?
         dollars_per_win_under_control = ifelse(war_under_control == 0 , round(salary_under_control / .0001, 2),
                                                round(salary_under_control / war_under_control, 2))) %>%
  filter(Season == max(Season)) %>%    #get only the latest projections
  select(FullName, Position, Team, years_of_control, war_under_control, salary_under_control, dollars_per_win_under_control) %>%
  arrange(desc(war_under_control))


team_war <- warcels %>%
  group_by(Team, Position) %>%
  summarize(num_players= n(),
            war_under_control = sum(war_under_control),
            years_of_control = round(mean(years_of_control), 2)) %>%
  mutate(war_under_control_per_year = round(war_under_control / years_of_control, 1),
         war_per_player_per_year = round(war_under_control / num_players / years_of_control, 2))

ggplot(data=team_war %>% filter(Position == "Position Player"), aes(years_of_control, war_under_control, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (position players only; 5 max)") + ggtitle("Avg. Length of Control vs. How Much WAR they Control, Position Players") + xlim(3,5)

ggplot(data=team_war %>% filter(Position == "Pitcher"), aes(years_of_control, war_under_control, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (position players only; 5 max)") + ggtitle("Avg. Length of Control vs. How Much WAR they Control, Pitchers") + xlim(3,5)



#format should be: team | season | war. in order to do this, should have player | team | season | war in fg_batters_project.

```


# Pitcher projections

```{r}
fg_pitchers_project <- fg_pitchers %>%
  mutate(FullName = sprintf("%s %s", FirstName, LastName),
         birth_date = as.Date(as.POSIXct(BirthDate)),
         birth_year = format(birth_date, "%Y"),
         age_now = this_year - as.integer(birth_year),
         age_next_year = age_now + 1, 
         age_in_two_years = age_now + 2,
         age_in_three_years = age_now + 3,
         age_in_four_years = age_now + 4) %>%
  group_by(FullName) %>%
  arrange(Season) %>%
  mutate(step1 = (0.6 * ValueW) + (0.3 * lag(ValueW)) + (0.1* lag(ValueW, 2)),
         step2 = 0.8 * step1,
         war_next = round(step2 + ((26 - age_now) * 0.1), 1),
         war_in_two_years = war_next - 0.4,
         war_in_three_years = war_in_two_years - 0.4,
         war_in_four_years = war_in_three_years - 0.4,
         war_in_five_years = war_in_four_years - 0.4,
         five_year_war = war_next + war_in_two_years + war_in_three_years + war_in_four_years + war_in_five_years) %>%
  filter(Season == max(Season)) %>%
  select(FullName, Team, five_year_war, age_now, war_next, war_in_two_years, war_in_three_years, war_in_four_years, war_in_five_years) %>%
  arrange(desc(five_year_war))
```

