---
title: "warcels"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
```

# Get data

```{r}

fg_players <- fg_db %>%
  tbl("player_info") %>%
  collect(n=Inf)

fg_bat <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%     #get only full-season stats for each player
  collect(n=Inf)

fg_batters <- inner_join(fg_players, fg_bat, by=c("PlayerId" = "playerid")) %>%
  filter(Position != "P",             #don't get batting WAR for pitchers
         BISPosition != "SP",
         BISPosition != "RP") %>%
  select(FirstName, LastName, Season, BirthDate, ValueW, Position)

fg_pitch <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  collect(n=Inf)

fg_pitchers <- inner_join(fg_players, fg_pitch, by="PlayerId") %>%
  filter(BISPosition %in% c("SP", "RP")) %>% #don't get pitching WAR for position players
  select(FirstName, LastName, Season, BirthDate, ValueW, Position = BISPosition)

#combine dataframes
all_players <- bind_rows(fg_batters, fg_pitchers)

```


# For each team, compute the avg. length they control their current roster and the amount of WAR under this control

notes: 
* WAR projections are done using FG WAR & Warcels (link).
* players with < 3 years in the majors get 0 WAR computed for years they weren't in the league. affects guys like Kris Bryant.
* players are assigned to the current team they're on. free agents are not assigned to any team.
* FA computations assume all options are picked up. e.g. starlin castro is given 4 years of control even though he has three years remaining before his $16 team option in 2020.
* for pre-arb years, minimum salary is used: $535k.
* for arb players, MLBTR projections are used for 2017. for future arb years, including Arb-1's, 25%/40%/60% of FA salary is used to project.
* for Arb-4 players, 80% of salary is used to project
* for players with non-arb contracts, salary under control is computed as AAV of contract * number of years of control
* for position players, only offensive & defensive WAR is counted. for pitchers, only pitching WAR is counted.
* players who are under contract for longer than 5 years are, for the purposes of this exercise, give 5 years of team control. this is because i only projected WAR out for 5 years. contracts that run more than 5 years contain only the first five years of the player's earnings.
* players who haven't reached arbitration yet use the same calculations but with the minimum salary as their base. so Arb 1 would be assuming a raise from the min. salary, etc.

### Get years, salary under team control

```{r}

#get the number of years of control a team has over a player, limited to 5, and then compute the player's total salary in that time period

years_of_control <- all_teams_payroll %>%
  filter(value != "FA") %>%
  group_by(Name, Team) %>%
  mutate(years_of_control = n(),
         years_of_control = ifelse(value=="FA", as.integer(Year) - next_year, 5)) %>%
  arrange(Year) %>%
  filter(row_number() <= years_of_control) %>%
  summarize(years_of_control = n(),
            salary_under_control = sum(as.numeric(value), na.rm = TRUE))


```



```{r}

this_year <- 2016
next_year <- this_year + 1
millions_per_war = 8.5

warcels <- all_players %>%
  mutate(FullName = sprintf("%s %s", FirstName, LastName),
         birth_date = as.Date(as.POSIXct(BirthDate)),
         birth_year = format(birth_date, "%Y")) %>%

  #filter out retirees so their WAR ,isn't assigned to a team
  filter(!FullName %in% c("David Ortiz", "Alex Rodriguez", "Mark Teixeira")) %>%
  
  #bring in the years & salary of control for each player
  inner_join(years_of_control, by=c("FullName" = "Name")) %>%
  group_by(FullName) %>%
  arrange(Season) %>%
  
  #project war under team control using tango's method: http://tangotiger.com/index.php/site/article/war-marcels-...-warcels
  mutate(age_now = this_year - as.integer(birth_year),
         age_next_year = age_now + 1, 
         age_in_two_years = age_now + 2,
         age_in_three_years = age_now + 3,
         age_in_four_years = age_now + 4,
         currentWAR = ifelse(is.na(ValueW) == FALSE, ValueW, 1.5),  #players w/o appearances in a season get 0 WAR for that year
         war_last_year = ifelse(is.na(lag(ValueW)) == FALSE, lag(ValueW), 0),
         war_two_years_ago = ifelse(is.na(lag(ValueW, 2)) == FALSE, lag(ValueW, 2), 0),
         step1 = (0.6 * currentWAR) + (0.3 * war_last_year) + (0.1* war_two_years_ago),
         step2 = 0.8 * step1,
         war_next = round(ifelse(Position == "SP" | Position == "RP", step2 + ((26 - age_now) * 0.1),
                                 step2 + ((30 - age_now) * 0.1)), 1),
         war_in_two_years = round(ifelse(Position == "SP" | Position == "RP", war_next - 0.4,
                                         war_next - 0.4 + ((30-age_next_year) * .08)), 1),
         war_in_three_years = round(ifelse(Position == "SP" | Position == "RP", war_in_two_years - 0.4,
                                           war_in_two_years - 0.4 + ((30-age_in_two_years) * .03)), 1),
         war_in_four_years = round(ifelse(Position == "SP" | Position == "RP", war_in_three_years - 0.4, 
                                          war_in_three_years - 0.4 + ((30-age_in_three_years) * .03)), 1),
         war_in_five_years = round(ifelse(Position == "SP" | Position == "RP", war_in_four_years - 0.4,
                                          war_in_four_years - 0.4 + ((30-age_in_four_years) * .03)), 1),
         war_under_control = 
           round(ifelse(years_of_control == 1, war_next,
                  ifelse(years_of_control == 2, war_next + war_in_two_years,
                         ifelse(years_of_control == 3, war_next + war_in_two_years + war_in_three_years,
                                ifelse(years_of_control == 4, war_next + war_in_two_years + war_in_three_years + war_in_four_years,
                                       war_next + war_in_two_years + war_in_three_years + war_in_four_years + war_in_five_years))))
                 , 1),
         
         Position = ifelse(Position == "SP", "Rotation",
                           ifelse(Position == "RP", "Bullpen", "Hitter")),
         dollars_per_win_under_control = ifelse(war_under_control == 0 , round(salary_under_control / .0001, 2),
                                                round(salary_under_control / war_under_control, 2)),
         surplus_value_under_control = round((millions_per_war * war_under_control) - salary_under_control, 1),
         war_per_year_of_control = round(war_under_control / years_of_control, 2)) %>%
  filter(Season == max(Season)) %>%    #get only the latest projections
  select(FullName, Position, Team, years_of_control, war_under_control, war_per_year_of_control, salary_under_control, dollars_per_win_under_control, surplus_value_under_control) %>%
  arrange(desc(surplus_value_under_control))


team_surplus_value <- warcels %>%
  group_by(Team) %>%
  summarize(total_surplus_value_under_control = sum(surplus_value_under_control)) %>%
  arrange(desc(total_surplus_value_under_control))

team_war_by_position <- warcels %>%
  group_by(Team, Position) %>%
  summarize(num_players= n(),
            war_under_control = sum(war_under_control),
            years_of_control = round(mean(years_of_control), 2),
            salary_under_control = sum(salary_under_control)) %>%
  mutate(war_under_control_per_year = round(war_under_control / years_of_control, 1),
         war_per_player_per_year = round(war_under_control / num_players / years_of_control, 2),
         mm_per_war_per_year = round(salary_under_control / war_under_control / years_of_control, 2))


team_war <- warcels %>%
  group_by(Team) %>%
  summarize(num_players= n(),
            war_under_control = sum(war_under_control),
            years_of_control = round(mean(years_of_control), 2),
            salary_under_control = sum(salary_under_control)) %>%
  mutate(war_under_control_per_year = round(war_under_control / years_of_control, 1),
         war_per_player_per_year = round(war_under_control / num_players / years_of_control, 2),
         mm_per_war_per_year = as.numeric(round(salary_under_control / war_under_control / years_of_control, 2)))


ggplot(data=team_war_by_position %>% filter(Position == "Hitter"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (position players only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per year, Position Players") + xlim(2.5,5)

ggplot(data=team_war_by_position %>% filter(Position == "Rotation"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (rotation only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per year, Rotation") + xlim(2.5,5)

ggplot(data=team_war_by_position %>% filter(Position == "Bullpen"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (bullpen only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per Year, Bullpen") + xlim(2.5,5)

ggplot(data=team_war, aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (entire team; 5 max)") + ggtitle("Avg. Length of Control vs. How Much WAR they Control, Entire Team") + xlim(2.5,5)

#format should be: team | season | war. in order to do this, should have player | team | season | war in fg_batters_project.

```


