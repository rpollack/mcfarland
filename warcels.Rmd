
notes:
* WAR projections are done using FG WAR & Warcels (link).
* missing seasons are filled in with 1 WAR. this includes seasons prior to a player's debut as well as those #missed due to injury/ineffectiveness/whatever.
* players are assigned to the current team they're on. free agents are not assigned to any team.
* FA computations assume all options are picked up. e.g. starlin castro is given 4 years of control even #though he has three years remaining before his $16 team option in 2020.
* for pre-arb years, minimum salary is used: $535k.
* for arb players, MLBTR projections are used for 2017. for future arb years, including Arb-1's, 25%/40%/60% of FA salary is used to project.
* for Arb-4 players, 80% of salary is used to project
* for players with non-arb contracts, salary under control is computed as AAV of contract * number of years #of control
* for position players, only offensive & defensive WAR is counted. for pitchers, only pitching WAR is counted.
* players who are under contract for longer than 5 years are, for the purposes of this exercise, give 5 years of team control. this is because i only projected WAR out for 5 years. contracts that run more than 5 years contain only the first five years of the player's earnings.
* players who haven't reached arbitration yet use the same calculations but with the minimum salary as their base. so Arb 1 would be assuming a raise from the min. salary, etc.


Questions:

- Win Now-iest team in Baseball
- Worst contract in baseball (least surplus over next 5 years)
- Most efficiently-spending teams over next 5 years

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(stringr)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0)
  )

```

#Define functions to read payroll data from bb-ref.

```{r}
# shared by bill petti in FG slack chat on 11.25.2016
# modified by ryan pollack on 1.3.2017 to get detailed payroll information 

getTeamabbr <- function(year) {
  team_tbl <- read_html(paste0("http://www.baseball-reference.com/leagues/MLB/", year, ".shtml"), stringsAsFactors=FALSE)
  tms <- team_tbl %>%
    html_nodes("table") %>%
    .[[2]] %>%
    html_table() %>%
    select(Tm) %>%
    filter(Tm != "LgAvg", 
           Tm != "", 
           Tm != "Tm")
  tms$year <- year
  return(tms)
}


getPayrolls <- function(Tm) {
  url <- paste0("http://www.baseball-reference.com/teams/", Tm, "/2016-payroll-salaries.shtml")
  tms <- url %>%
    read_html() %>%
    html_nodes("table") %>%
    .[[length(.)]] %>%
    html_table(header=TRUE)
  
  if (!"2021" %in% names(tms)) {
    tms$`2021` <- NA
  }
  
  next_year <- 2017
  tms <- tms %>%
    
    #remove unused cells in the 'Name' column
    filter(!Name %in% c("Name","","Arb Costs", "Arb Eligible", "Contract Options", 
                        "Dollars Committed", "Other Costs", "Option Values", "Other Players", 
                        "Payroll (no options)", "Payroll (options)", "Signed")) 
  
  #for each player, create multiple rows, one for each "Year", where "value" is either their salary that year, their arbitration status, or their FA status, or blank if the player won't be on the payroll.
  #the 2017, 2018, 2019, etc. columns are the ones collapsed into the 'value' column. because those are left when the others are unselected (with a minus sign)).
  tms_melt <- gather(tms, key = Year, value, -Name, -Age, -Yrs, -Acquired, -SrvTm, -Agent, -`Contract Status`)
  tms_melt <- tms_melt %>%
    mutate(value = ifelse(grepl("FA-\\*", value) == TRUE, "", value)) %>% #assume options won't happen
    filter(value != "",           #remove years where players aren't on a payroll
           value != "FA") %>%                                   
    mutate(Team = Tm)
}
```

### Get data from FG DB

```{r}

#player data from FG
fg_players <- fg_db %>%
  tbl("player_info") %>%
  collect(n=Inf)

this_year <= 2016
teams_lookup <- fg_db %>%
  tbl("season_team") %>%
  filter(!is.na(AbbName),
         Season == this_year) %>%
  select(TeamId, Team = AbbName) %>%
  collect(n=Inf)

fg_bat <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%     #get only full-season stats for each player
  collect(n=Inf)

fg_batters <- inner_join(fg_players, fg_bat, by=c("PlayerId" = "playerid")) %>%
  filter(Position != "P",             #don't get batting WAR for pitchers
         BISPosition != "SP",
         BISPosition != "RP") %>%
  select(FirstName, LastName, Season, BirthDate, ValueW, Position, TeamId)

fg_pitch <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  collect(n=Inf)

fg_pitchers <- inner_join(fg_players, fg_pitch, by="PlayerId") %>%
  filter(BISPosition %in% c("SP", "RP")) %>% #don't get pitching WAR for position players
  select(FirstName, LastName, Season, BirthDate, ValueW, Position = BISPosition, TeamId = TeamId.x)

#combine dataframes
all_players <- bind_rows(fg_batters, fg_pitchers)  %>%
  inner_join(teams_lookup, by="TeamId") %>%
  select(-TeamId) %>%
  group_by(FirstName, LastName, BirthDate) %>%
  arrange(desc(Season)) %>%
  filter(row_number() <= 3)   # only need the most recent 3 years of each player

```

#Figure out a rough relationship between WAR and Arb-1 salaries, for the purposes of estimating Arb-1 salaries for other players.

```{r, echo=FALSE}

find_cumulative_war_through_year <- function(name, year){
  #search both batter & pitcher data frames for the player and return their cumulative
  #fWAR through the given year. this tactic works because each player appears in only one data frame.
  
  fname <- str_split(name, " ", simplify = TRUE, n=2)[1]
  lname <- str_split(name, " ", simplify = TRUE, n=2)[2]

  batter_search <- fg_batters %>%
    filter(FirstName == fname,
           LastName == lname,
           Season >= (year -4),   #restrict year floor to ensure we're getting the player we want
           Season < year)
  
  pitcher_search <- fg_pitchers %>%
    filter(FirstName == fname,
           LastName == lname,
           Season >= (year -4),
           Season < year)
  
  search_space <- bind_rows(batter_search, pitcher_search)
  
  return(sum(search_space$ValueW))
}
find_cumulative_war_through_year <- Vectorize(find_cumulative_war_through_year)

#arbitration data from MLBTR datafiles
arb_2016 <- read_tsv("arbitration-2016.txt")
arb_2016 <- arb_2016 %>%
  select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2016)

arb_2015 <- read_tsv("arbitration-2015.txt")
arb_2015 <- arb_2015 %>%
  select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2015)

arb_2014 <- read_tsv("arbitration-2014.txt")
arb_2014 <- arb_2014 %>%
  select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2014)

all_arb <- bind_rows(arb_2015, arb_2016, arb_2014) %>%
  filter(SrvTm >= 2,
         SrvTm <= 3.9) %>%  #make sure I catch first-year arbs only
  select(-SrvTm)

all_arb$SettledAmt <- gsub("\\$", "", all_arb$SettledAmt)
all_arb$SettledAmt <- gsub("MM", "", all_arb$SettledAmt)
all_arb$SettledAmt <- as.double(all_arb$SettledAmt)

all_arb <- all_arb %>%
  mutate(war_at_signing = find_cumulative_war_through_year(Name, Year),
         predicted_arb = 1.36881 + (.26896 * war_at_signing))  #based on linear model of Arb-1 ~ WAR


```

## LOOKA HERE!!!!!    For each player, project WAR

```{r}

this_year <- 2016
next_year <- this_year + 1
millions_per_war = 8.5

projected_war <- all_players %>%
  mutate(FullName = sprintf("%s %s", FirstName, LastName),
         birth_date = as.Date(as.POSIXct(BirthDate)),
         birth_year = format(birth_date, "%Y")) %>%

  #filter out retirees so their WAR ,isn't assigned to a team
  filter(!FullName %in% c("David Ortiz", "Alex Rodriguez", "Mark Teixeira")) %>%
  
  #bring in the years & salary of control for each player
  group_by(FullName) %>%
  arrange(Season) %>%
  
  #project war under team control using tango's method: http://tangotiger.com/index.php/site/article/war-marcels-...-warcels
  mutate(age_now = this_year - as.integer(birth_year),
         age_next_year = age_now + 1, 
         age_in_two_years = age_now + 2,
         age_in_three_years = age_now + 3,
         age_in_four_years = age_now + 4,
         currentWAR = ifelse(is.na(ValueW) == FALSE, ValueW, 0),  #players w/o appearances in a season get 1 WAR for that year
         war_last_year = ifelse(is.na(lag(ValueW)) == FALSE, lag(ValueW), 0),
         war_two_years_ago = ifelse(is.na(lag(ValueW, 2)) == FALSE, lag(ValueW, 2), 0),
         step1 = (0.6 * currentWAR) + (0.3 * war_last_year) + (0.1* war_two_years_ago),
         step2 = 0.8 * step1,
         war_next = round(ifelse(Position == "SP" | Position == "RP", step2 + ((26 - age_now) * 0.1),
                                 step2 + ((30 - age_now) * 0.1)), 1),
         war_in_two_years = round(ifelse(Position == "SP" | Position == "RP", war_next - 0.4,
                                         war_next - 0.4 + ((30-age_next_year) * .08)), 1),
         war_in_three_years = round(ifelse(Position == "SP" | Position == "RP", war_in_two_years - 0.4,
                                           war_in_two_years - 0.4 + ((30-age_in_two_years) * .03)), 1),
         war_in_four_years = round(ifelse(Position == "SP" | Position == "RP", war_in_three_years - 0.4, 
                                          war_in_three_years - 0.4 + ((30-age_in_three_years) * .03)), 1),
         war_in_five_years = round(ifelse(Position == "SP" | Position == "RP", war_in_four_years - 0.4,
                                          war_in_four_years - 0.4 + ((30-age_in_four_years) * .03)), 1))
```
  
# now get payroll information

```{r}
teamAbbr <- getTeamabbr(2016)
all_teams_payroll <- teamAbbr %>% 
  group_by(Tm) %>%
  do(getPayrolls(.$Tm)) %>%
  select(Team = Tm, Name, Age, Year, value)

#compute years of control (limited to 5) and years before arbitration eligibility
next_year <- 2017
control_information <- all_teams_payroll %>%
  group_by(Name, Team) %>%
  mutate(years_before_arb_eligible = ifelse(value == "Arb-1", as.integer(Year) - next_year, 0)) %>%
  summarize(years_of_control = ifelse(n() > 5, 5, n()),
            years_before_arb_eligible = max(years_before_arb_eligible, na.rm = TRUE)) %>%
  #clean up incorrect bb-ref information about some players
  mutate(years_of_control = ifelse(Name == "Hyun Soo Kim", 1, years_of_control),
         years_of_control = ifelse(Name == "Logan Ondrusek", 1, years_of_control),
         years_of_control = ifelse(Name == "Yulieski Gurriel", 4, years_of_control),
         years_of_control = ifelse(Name == "Jung Ho Kang", 2, years_of_control))

#join control information with payroll information
master <- inner_join(all_teams_payroll, control_information, by=c("Name", "Team")) %>%
  inner_join(projected_war, by=c("Name" = "FullName", "Team")) %>%
  mutate(war_under_control = round(ifelse(years_of_control == 1, war_next,
                  ifelse(years_of_control == 2, war_next + war_in_two_years,
                         ifelse(years_of_control == 3, war_next + war_in_two_years + war_in_three_years,
                                ifelse(years_of_control == 4, war_next + war_in_two_years + 
                                         war_in_three_years + war_in_four_years,
                                       war_next + war_in_two_years + war_in_three_years + war_in_four_years +
                                         war_in_five_years)))), 1)) %>%
  filter(Season == max(Season))

payroll_info <- master %>%
  group_by(Name, Team) %>%
  arrange(Season) %>%
  filter(row_number() <= years_of_control) %>%
  ungroup() %>%
  
  #data cleanup for players i've determined will be worth > 1 WAR. most info take from Spotrac
  mutate(value = ifelse(Name == "A.J. Pollock" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Josh Donaldson" & Year == 2018, "Arb-4", value),
         value = ifelse(Name == "Aledmys Diaz" & Year == 2019, "Arb-1", value),
         value = ifelse(Name == "Aledmys Diaz" & Year == 2020, "Arb-2", value),
         value = ifelse(Name == "Aledmys Diaz" & Year == 2021, "Arb-3", value),
         value = ifelse(Name == "Jose Abreu" & Year == 2018, "Arb-2", value),
         value = ifelse(Name == "Jose Abreu" & Year == 2019, "Arb-3", value),
         value = ifelse(Name == "Avisail Garcia" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Avisail Garcia" & Year == 2019, "Arb-4", value),
         value = ifelse(Name == "Raisel Iglesias" & Year == 2021, "Arb-3", value),
         value = ifelse(Name == "DJ LeMahieu" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Evan Gattis" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Scott Van Slyke" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Scott Van Slyke" & Year == 2019, "Arb-4", value),
         value = ifelse(Name == "Yasiel Puig" & Year == 2019, "Arb-1", value),
         value = ifelse(Name == "Scooter Gennett" & Year == 2018, "Arb-2", value),
         value = ifelse(Name == "Scooter Gennett" & Year == 2019, "Arb-3", value),
         value = ifelse(Name == "Tommy Milone" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Eduardo Escobar" & Year == 2018, "Arb-3", value),
         value = ifelse(Name == "Zack Wheeler" & Year == 2018, "Arb-2", value),
         value = ifelse(Name == "Zack Wheeler" & Year == 2019, "Arb-3", value),
         value = ifelse(Name == "Ruben Tejada" & Year == 2017, 1.35, value),
         value = ifelse(Name == "Felix Doubront" & Year == 2017, 2, value),
         value = ifelse(Name == "Trevor Bauer" & Year == 2018, "Arb-2", value),
         value = ifelse(Name == "Trevor Bauer" & Year == 2019, "Arb-3", value),
         value = ifelse(Name == "Trevor Bauer" & Year == 2020, "Arb-4", value),
         value = ifelse(Name == "Freddy Galvis" & Year == "2018", "Arb-3", value),
         value = ifelse(Name == "Matt Adams" & Year == 2018, "Arb-3", value)) %>%

  #get any FA and pre-arb salaries
  mutate(value = ifelse(grepl("M", value), as.double(str_extract(value, "(?<=\\$)[:digit:]+\\.*[:digit:]*")), value),
         value = ifelse(grepl("k", value), as.double(str_extract(value, "(?<=\\$)[:digit:]+")) / 1000, value),
         value = ifelse(grepl("Pre-Arb", value), 0.535, value)) %>%
  
  #project arb-1 salaries, then use that to project future arb years
  mutate(value = ifelse(value == "Arb-1" & (years_before_arb_eligible == 1 | years_before_arb_eligible == 0), 1.36881 + (.26896 * (currentWAR + war_next)), 
                        ifelse(value == "Arb-1" & years_before_arb_eligible == 2, 1.36881 + (.26896 * (currentWAR + war_next + war_in_two_years)),
                               ifelse(value == "Arb-1" & years_before_arb_eligible == 3, 
                                      1.36881 + (.26896 * (currentWAR + war_next + war_in_two_years + war_in_three_years)), value)))) %>%
  arrange(Name, Team, Year) %>%
  mutate(value = ifelse(value == "Arb-2", (as.double(lag(value)) / .25) * .4, value),
         value = ifelse(value == "Arb-3", (as.double(lag(value)) / .4) * .6, value),
         value = ifelse(value == "Arb-4", (as.double(lag(value)) / .6) * .7, value),
         value = as.numeric(value)) %>%
  group_by(Name, Team) %>%
  summarize(salary_under_control = round(sum(value), 2))

millions_per_war <- 8.5
warcels <- master %>%
  mutate(Position = ifelse(Position == "SP", "Rotation",
                           ifelse(Position == "RP", "Bullpen", "Hitter"))) %>%
  select(Name, Team, Position, Year, years_of_control, war_under_control) %>%
  inner_join(payroll_info, by = c("Name", "Team")) %>%
  group_by(Name, Team) %>%
  filter(Year == max(Year),
         war_under_control > 1) %>%
  mutate(controlled_surplus_value = round((millions_per_war * ((.05 * years_of_control) + 1)) * war_under_control -
           salary_under_control, 1)) %>%
  ungroup() %>%
  mutate(surplus_value_rank = round(percent_rank(controlled_surplus_value) * 100, 2)) %>%
  select(-Year) %>%
  arrange(desc(controlled_surplus_value))

```

### Group WAR per Year by Team

```{r}
team_war <- warcels %>%
  group_by(Team) %>%
  summarize(total_war_under_control = sum(war_under_control),
            total_years_of_control = sum(years_of_control),
            avg_years_of_control = mean(years_of_control),
            avg_war_under_control_pear_year = total_war_under_control / total_years_of_control)

ggplot(data=team_war, aes(avg_years_of_control, avg_war_under_control_pear_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (entire team; 5 max)") + ggtitle("Avg. Length of Control vs. How Much WAR they Control, Entire Team") + xlim(2.5,5)


```

### Group results by team & high-level position

```{r}
team_war_by_position <- warcels %>%
  group_by(Team, Position) %>%
  summarize(war_under_control_per_year = sum(war_under_control) / sum(years_of_control),
            years_of_control = round(mean(years_of_control), 2),
            salary_under_control = sum(salary_under_control),
            surplus_value_under_control = sum(controlled_surplus_value))

ggplot(data=team_war_by_position, aes(Team, war_under_control_per_year, fill=Position)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()

```

### Plot teams' length of control vs. war per year they control

```{r}
ggplot(data=team_war_by_position %>% filter(Position == "Hitter"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (position players only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per year, Position Players")

ggplot(data=team_war_by_position %>% filter(Position == "Rotation"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (rotation only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per year, Rotation")

ggplot(data=team_war_by_position %>% filter(Position == "Bullpen"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (bullpen only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per Year, Bullpen")

```


