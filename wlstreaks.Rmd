---
title: "Untitled"
output: html_document
date: '2022-06-19'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rvest)
library(lubridate)
library(glue)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



```{r}
# create table of franchise abbreviations and years

franchises <- c("BAL", "TOR", "BOS", "NYY", "TBD",
                "MIN", "CHA", "CLE", "KCR", "DET",
                "HOU", "TEX", "SEA", "ANA", "OAK",
                "WSN", "FLA", "ATL", "NYN", "PHI",
                "PIT", "CIN", "MIL", "CHN", "STL",
                "LAD", "COL", "SDP", "ARI", "SFG")

get_urls <- function(franch){
  print(glue("getting abbreviations and years for {franch}"))
  read_html(glue("https://www.baseball-reference.com/teams/{franch}/index.shtml")) %>%
   html_elements("tr") %>% 
  html_elements("a") %>%
  html_attr("href") %>% 
  unlist() %>%
  as_tibble() %>%
  filter(str_detect(value, "teams")) %>%
  distinct() %>%
    mutate(franchise = franch)

}

urls <-
  franchises %>%
  map_dfr(get_urls) %>%
  mutate(abbrev = str_extract(value, "[A-Z]{2,3}"),
         year = str_extract(value, "[:digit:]{4}"),
         url = glue("https://www.baseball-reference.com/teams/{abbrev}/{year}-schedule-scores.shtml"))
```



```{r }

get_game_results <- function(year) {
  url <- glue("https://www.baseball-reference.com/teams/{team}/{year}-schedule-scores.shtml")

  read_html(url) %>%
    html_elements(css = "#all_team_schedule") %>%
    html_table() %>%
    pluck(1) %>%
    select(game_number = `Gm#`, result = `W/L`, streak = Streak) %>%
    
    # remove header rows
    filter(streak != "Streak") %>%
    mutate(
      type = str_extract(result, "W|L"),
      length = str_length(streak),
      year = year,
      team = team
    ) 
}

# build list of teams and years. uses proper abbreviations. e.g. TBR for 2008 and after; TBD in years prior. 
streak_data <-
  expand_grid(team = c("BAL", "CLE", "DET", "NYY"), year = 1954:2022) %>%
  pmap_dfr(get_game_results) %>%
   # identify nonconsecutive streaks in a season. this prevents 11 game streaks from also counting as streaks of 10, 9. 8, etc. games
  mutate(consec = case_when(
    row_number() == 1 ~ TRUE,
    TRUE ~ if_else(type == lag(type), TRUE, FALSE))
  ) %>%
  filter(consec != lead(consec),
         length >= 4) %>%         # we only care about streaks of 4 or more games. 
  unite(streak_type, type, length, sep = "-") %>%
  mutate(year = as.character(year)) %>%
  count(year, streak_type, name = "num_streaks") %>%
  ungroup() %>%
  complete(year, streak_type, fill = list(num_streaks = 0)) 
  
  
streak_data %>%
  mutate(year = as.Date(glue("{year}-01-01"))) %>%
  ggplot(aes(year, num_streaks, group = streak_type, fill = streak_type, color = streak_type)) +
  geom_point(size = 0.2) + geom_path() + 
  facet_wrap(vars(streak_type)) +
  scale_x_date()
```


```{r}


get_run_diff <- function(url) {
  tryCatch(
    {
      read_html(url) %>%
        html_elements(css = "#all_team_schedule") %>%
        html_table() %>%
        pluck(1) %>%
        select(Date, R, RA) %>%
        mutate(url = url)
    },
    error = function(cond) {
      print(cond)
      print(glue("Cannot open {url}."))
      tibble()
    }
  )
}

get_run_diff_v <- Vectorize(get_run_diff)

game_info <-
  urls %>%
  distinct(url) %>%
#  slice_head(n=1000) %>%
  pmap_dfr(get_run_diff) %>%
  inner_join(urls, by="url") %>%
  mutate(
    runs_scored = as.numeric(R),
    runs_allowed = as.numeric(RA),
    run_differential = runs_scored - runs_allowed,
    date = as_date(Date, "%A, %B %d", tz = NULL),
    month = month(date),
    day = day(date),
    game_date = as_date(glue("{year}-{month}-{day}"))
  ) %>%
  filter(!is.na(runs_scored)) %>%
  select(game_date, year, franchise, team = abbrev, runs_scored, runs_allowed, run_differential) %>%
  group_by(franchise) %>%
  arrange(game_date) %>%
  mutate(cumulative_run_differential = cumsum(run_differential)) %>%
  ungroup() %>%
  complete(franchise, game_date, fill = list(cumulative_run_differential = NA)) %>%
  ungroup()
  

# i think the problem is that get_run_diff_v returns data frames of different sizes (some 167, some 169?)

```

```{r, fig.height=4}
game_info %>%
  # mutate(game_month = floor_date(game_date, "month")) %>%
  # group_by(franchise, game_month) %>%
  # summarize(cume_run_diff = sum(cumulative_run_differential)) %>%
  mutate(franchise = str_replace_all(franchise, c("CHN" = "CHC",
                                            "CHA" = "CHW",
                                            "NYN" = "NYM",
                                            "FLA" = "MIA",
                                            "NYA" = "NYY",
                                            "WSN" = "WAS",
                                            "TBD" = "TB"))) %>%
  ggplot(aes(game_date, cumulative_run_differential)) +
  geom_path() +
  facet_wrap(vars(franchise), scales = "free") +
  labs(x = "Game Day", y = "Cumulative Run Differential", caption = "Source: Baseball Reference") +
  ggtitle("Game Day vs. Cumulative Run Differential")
```


%>%
  mutate(
    runs_scored = as.numeric(R),
    runs_allowed = as.numeric(RA),
    run_differential = runs_scored - runs_allowed,
    date = as_date(Date, "%A, %B %d", tz = NULL),
    month = month(date),
    day = day(date),
    game_date = as_date(glue("{season}-{month}-{day}"))
  ) %>%
  filter(!is.na(runs_scored)) %>%
  select(game_date, season, runs_scored, runs_allowed, run_differential) %>%
  group
  mutate(cumulative_run_differential = cumsum(run_differential)) %>%
  complete(game_date = seq.Date(as.Date(glue("{start_year}-01-01")), Sys.Date(), by = "day"), fill = list(cumulative_run_differential = NA))

foo %>%
  ggplot(aes(game_date, cumulative_run_differential)) +
  geom_path() +
  ggtitle(glue("Philadelphia Phillies Franchise Cumulative Run Differential, {start_year}-present")) +
  labs(x = "Game Day", y = "Cumulative Run Differential", caption = "Source: baseball-reference")

# phillies as requested by /u/Alkynesofchemistry/

ggsave("phillies.png")

# after this: dodgers franchise. BRO 1884-1957, LAD 1958-present. requested by /u/greycubed
```


there are a couple ways we can measure this:

max streak length

probability of n-game winning streak occurring. ex: 2019 Rays had multiple 6 game winning streaks. 1993 Orioles had 3 separate 8 game winning streaks, a 9 game win streak, a 10 game win streak, and an 8 game losing streak. 
^^^ do this first, then restrict the data to what's below:

I also think we want to retain the longest of each streak type.e.g. if an 8 game win streak stops there, we want to count 8. however if it becomes an 11 game winning streak, we want to stop it at 11. the 8 shouldn't also count.



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
