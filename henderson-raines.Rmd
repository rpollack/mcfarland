```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)
library(lubridate)
library(gamlss)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```


```{r}
fg_info <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, LastGame) %>%
  collect(n=Inf) %>%
  unite(batter_name, FirstName, LastName, sep = " ")

# get data for SB opportunities from 1974 onward
steal_opportunities <- fg_db %>%
  tbl("wpa_log") %>%
  dplyr::select(GameDate, PlayerId, PlayDesc, contains("BId"), contains("BReplace")) %>%
  collect(n=Inf)

#find sb opportunities. using the l*Id and *BReplace fields accounts for when the player was inserted as a pinch runner

#caught stealings' are not represented in the data ... for example Keon Broxton on 9-22-2015 was caught, but no opp
steal_opportunities_processed <- steal_opportunities %>%
  dplyr::select(-BatterSubId, -PitcherSubId) %>%
  mutate(Season = year(GameDate),
         sb_opportunity = ifelse(
           (`1BId` == PlayerId & is.na(`2BId`)) |
             (`l1BId` == PlayerId & is.na(`l2BId`)) |
             #if there is an entry in 1BReplace, the PlayerID was a pinch runner. give them an opp if the next base is empty
             (`1BReplace` != 0 & is.na(`l2BId`)) |
             (`2BId` == PlayerId & is.na(`3BId`)) |
             (`l2BId` == PlayerId & is.na(`l3BId`)) |
             (`2BReplace` != 0 & is.na(`l3BId`)),
           1, 0)) %>%
  replace_na(sb_opportunity, replace=list(sb_opportunity = 0)) %>%
  group_by(PlayerId, Season) %>%
  summarize(sb_opportunities = sum(sb_opportunity))
  

# 
# sb_info_career <- fg_db %>%
#   tbl("stats_batting") %>%
#   filter(Type == -1) %>%
#   dplyr::select(playerid, SB, CS, singles = `1B`, BB) %>%
#   collect(n=Inf) %>%
#   inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
#   mutate(attempts = CS + SB,
#          sb_perc = SB / attempts,
#          opportunities = singles + BB,
#          attempts_per_opp = attempts /opportunities) %>%
#   filter(!is.na(sb_perc)) %>%
#   dplyr::select(playerid, batter_name, SB, attempts, opportunities, attempts_per_opp, sb_perc) %>%
#   arrange(desc(sb_perc))

sb_info_seasons <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0,
         Season > 1930) %>%
  dplyr::select(playerid, Season, SB, CS) %>%
  collect(n=Inf) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  mutate(attempts = CS + SB,
         sb_perc = SB / attempts,
         decade = Season %/% 10 * 10) %>%
  filter(!is.na(sb_perc)) %>%  
  dplyr::select(playerid, batter_name, Season, decade, SB, attempts, 
                sb_perc) %>%
  arrange(desc(sb_perc))


#filtering out seasons of 100% is that OK???

```



```{r}
ggplot(sb_info_seasons, aes(decade, sb_perc, group = decade)) + geom_boxplot()

ggplot(sb_info_seasons, aes(decade, attempts, group = decade)) + geom_boxplot()


```


# test a couple different splines to see which one produces the best fit. it looks like ns(Season, 2) is decent.
helpful explanation of knots and splines: https://stats.stackexchange.com/questions/7316/setting-knots-in-natural-cubic-splines-in-r

```{r}
degrees <- 4
spline_model_seasons <- lm(cbind(sb_info_seasons$SB, sb_info_seasons$attempts - sb_info_seasons$SB) ~
                             ns(sb_info_seasons$Season, degrees))
plot(predict(spline_model_seasons))

```

# fit beta-binom model to each player-season


```{r}

#model sb%, allowing the number of attempts to according to the year of the season as well as the number of attempts
fit <- gamlss(cbind(SB, attempts - SB) ~ ns(Season, 4) * log(attempts),
              data = sb_info_seasons,
              family = BB(mu.link = "identity"))

td <- tidy(fit)

mu <- fitted(fit, parameter = "mu")
sigma <- fitted(fit, parameter="sigma")

eb_sb <- sb_info_seasons %>%
  ungroup() %>%
  mutate(mu = mu,
         alpha0 = mu / sigma,
         beta0 = (1 - mu) / sigma,
         alpha1 = alpha0 + SB,
         beta1 = beta0 + attempts - SB,
         est_sb_rate = alpha1 / (alpha1 + beta1),
         low_credible = qbeta(.025, alpha1, beta1), 
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  mutate(name_season = paste(batter_name, Season, sep = " ")) %>%
  arrange(desc(est_sb_rate))

ggplot(eb_sb %>% head(25), aes(est_sb_rate, reorder(name_season, est_sb_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated SB Success Rate with 95% Credible Interval") +
  ggtitle("Best Basestealing Seasons Since 1900") + fgt

eb_sb_career <- eb_sb %>%
  group_by(playerid, batter_name) %>%
  summarize(alpha1_sum = sum(alpha1),
            beta1_sum = sum(beta1)) %>%
  mutate(est_sb_rate = alpha1_sum / (alpha1_sum + beta1_sum),
         low_credible = qbeta(.025, alpha1_sum, beta1_sum), 
         high_credible = qbeta(.975, alpha1_sum, beta1_sum)) %>%
  arrange(desc(est_sb_rate))

ggplot(eb_sb_career %>% head(25), aes(est_sb_rate, reorder(batter_name, est_sb_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Career SB Success Rate with 95% Credible Interval") +
  ggtitle("Best Basestealers") + fgt

```





#prior graph ... need to look into how to do this.
```{r}
plot_gamlss_fit <- function(f) {
  sb_info_seasons %>%
    distinct() %>%
    mutate(attempts = 50) %>%
    augment(f, newdata = .) %>%
    rename(mu = .fitted) %>%
    mutate(sigma = fitted(fit, "sigma")[1],
           alpha0 = mu / sigma,
           beta0 = (1 - mu) / sigma,
           conf_low = qbeta(.025, alpha0, beta0),
           conf_high = qbeta(.975, alpha0, beta0)) %>%
    ggplot(aes(Season, mu, color = attempts, group = attempts)) +
    geom_line() +
    geom_ribbon(aes(ymin = conf_low, ymax = conf_high), linetype = 2, alpha = .1) +
    labs(x = "Year",
         y = "Prior (SB%, Median + 95% Credible Interval)") +
    ggtitle("SB% Prior Expectations, 50 Steal Attempts") +
    theme(legend.position="none") +
    fgt
}
plot_gamlss_fit(fit)


```

50 attempts means a lot more now than it does in 1950. back then, everyone was running wild. today, stolen bases have plummeted ... if you see a guy attempting 50 steals, you can assume he's a really good basestealer.


LIKELIHOOD

For each player-season, I combined the prior probabilities (computed using the model above) with their actual stolen-base success rates and summed the results across players' careers. The result is a set of probability density curves that show the estimated success rate for each player, given all the information we know about them over their entire careers.

The following curves show our estimated success rates for the two Titans of Swipe, Rickey Henderson and Tim Raines:

```{r}

coleman_list <- eb_sb_career %>% 
  ungroup() %>% 
  filter(playerid == 1002433) %>% 
  dplyr::select(alpha1_sum, beta1_sum) %>% 
  as.list()
 
coleman_alpha <- as.numeric(coleman_list[1])
coleman_beta <- as.numeric(coleman_list[2]) 

henderson_list <- eb_sb_career %>% 
  ungroup() %>% 
  filter(playerid == 194) %>% 
  dplyr::select(alpha1_sum, beta1_sum) %>% 
  as.list()
 
henderson_alpha <- as.numeric(henderson_list[1])
henderson_beta <- as.numeric(henderson_list[2]) 

ggplot() + geom_histogram(binwidth = 0.001, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = coleman_alpha, shape2 = coleman_beta),
                lwd=1.5,
                aes(color = "Vince Coleman")) +
  stat_function(fun = dbeta,
                args=list(shape1 = henderson_alpha, shape2 = henderson_beta),
                lwd=1.5,
                aes(color="Rickey Henderson")) +
  xlim(.75, 0.85) + labs(x="Estimated SB Success Rate") + 
  ggtitle("Comparing Two Stolen-Base Legends") + 
  labs(color = "Player") + fgt
```



```{r}
#simulation
coleman_sim <- rbeta(1e6, coleman_alpha, coleman_beta)
henderson_sim <- rbeta(1e6, henderson_alpha, henderson_beta)
mean(coleman_sim > henderson_sim)
# 70% chance coleman is the better basestealer than henderson
```

```{r}
#integration
x <- seq(.75, .825, .001)
crossing(coleman_x = x, henderson_x = x) %>%
  mutate(coleman_density = dbeta(coleman_x, coleman_alpha, coleman_beta),
         henderson_density = dbeta(henderson_x, henderson_alpha, henderson_beta),
         joint = coleman_density * henderson_density) %>%
  ggplot(aes(coleman_x, henderson_x, fill = joint)) +
  geom_tile() +
  geom_abline() +
  scale_fill_gradient2(low = "white", high = "red") +
  labs(x = "Coleman SB Success Rate",
       y = "Henderson SB Success Rate",
       fill = "Joint density") +
  #theme(legend.position = "none")
  fgt +
  ggtitle("Joint Distribution of SB Success Rates")

d <- .001
limits <- seq(.75, .95, d)
sum(outer(limits, limits, function(x, y) {
  (x > y) *
    dbeta(x, coleman_alpha, coleman_beta) *
    dbeta(y, henderson_alpha, henderson_beta) *
    d ^ 2
}))


```

### here's how coleman stacks up to other well-known base thieves:

```{r}
ggplot() + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = coleman_alpha, shape2 = coleman_beta),
                lwd=1.5,
                aes(color="Vince Coleman")) +
   stat_function(fun = dbeta,
                args=list(shape1 = henderson_alpha, shape2 = henderson_beta),
                lwd=1.5,
                aes(color="Rickey Henderson")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1791.8509, shape2 = 567.37504),
                lwd=1.5,
                aes(color = "Tim Raines")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1114.685, shape2 = 396.045),
                lwd=1.5,
                aes(color="Carlos Beltran")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1216.077, shape2 = 472.1578),
                lwd=1.5,
                aes(color="Maury Wills")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1796.182, shape2 = 598.5485),
                lwd=1.5,
                aes(color="Lou Brock")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1470.755, shape2 = 525.5968),
                lwd=1.5,
                aes(color="Barry Bonds")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 499.8613, shape2 = 115.5082),
                lwd=1.5,
                aes(color="Billy Hamilton")) +
  xlim(0.65, 0.90) + labs(x="Estimated SB Success Rate") + 
  ggtitle("Estimated Success Rates of Well-Known Basestealers") + 
  labs(color = "Player") + fgt
```

flattened ...

```{r}
ggplot(eb_sb_career %>% filter(batter_name %in% c("Barry Bonds", "Billy Hamilton",
                                                  "Carlos Beltran", "Lou Brock",
                                                  "Maury Wills", "Rickey Henderson",
                                                  "Tim Raines", "Vince Coleman")),
       aes(est_sb_rate, reorder(batter_name, est_sb_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Career SB Success Rate with 95% Credible Interval") +
  ggtitle("Estimated Success Rates of Well-Known Basestealers") + fgt
```


