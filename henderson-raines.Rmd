```{r}
library(tidyverse)
library(stringr)
library(plotly)
library(RMySQL)
library(broom)
library(lubridate)
library(gamlss)

tht_theme = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#8e001c"),
  strip.text = element_text(family="Lato", color="white")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```


```{r}
fg_info <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, LastGame) %>%
  collect(n=Inf) %>%
  unite(batter_name, FirstName, LastName, sep = " ")

# get data for SB opportunities from 1974 onward
steal_opportunities <- fg_db %>%
  tbl("wpa_log") %>%
  dplyr::select(GameDate, PlayerId, PlayDesc, contains("BId"), contains("BReplace")) %>%
  collect(n=Inf)

#find sb opportunities. using the l*Id and *BReplace fields accounts for when the player was inserted as a pinch runner

#caught stealings' are not represented in the data ... for example Keon Broxton on 9-22-2015 was caught, but no opp
steal_opportunities_processed <- steal_opportunities %>%
  dplyr::select(-BatterSubId, -PitcherSubId) %>%
  mutate(Season = year(GameDate),
         sb_opportunity = ifelse(
           (`1BId` == PlayerId & is.na(`2BId`)) |
             (`l1BId` == PlayerId & is.na(`l2BId`)) |
             #if there is an entry in 1BReplace, the PlayerID was a pinch runner. give them an opp if the next base is empty
             (`1BReplace` != 0 & is.na(`l2BId`)) |
             (`2BId` == PlayerId & is.na(`3BId`)) |
             (`l2BId` == PlayerId & is.na(`l3BId`)) |
             (`2BReplace` != 0 & is.na(`l3BId`)),
           1, 0)) %>%
  replace_na(sb_opportunity, replace=list(sb_opportunity = 0)) %>%
  group_by(PlayerId, Season) %>%
  summarize(sb_opportunities = sum(sb_opportunity))
  

# 
# sb_info_career <- fg_db %>%
#   tbl("stats_batting") %>%
#   filter(Type == -1) %>%
#   dplyr::select(playerid, SB, CS, singles = `1B`, BB) %>%
#   collect(n=Inf) %>%
#   inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
#   mutate(attempts = CS + SB,
#          sb_perc = SB / attempts,
#          opportunities = singles + BB,
#          attempts_per_opp = attempts /opportunities) %>%
#   filter(!is.na(sb_perc)) %>%
#   dplyr::select(playerid, batter_name, SB, attempts, opportunities, attempts_per_opp, sb_perc) %>%
#   arrange(desc(sb_perc))

sb_info_seasons <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0,
         Season > 1930) %>%
  dplyr::select(playerid, Season, Age, SB, CS) %>%
  collect(n=Inf) %>%
  inner_join(fg_info, by=c("playerid" = "PlayerId")) %>%
  mutate(attempts = CS + SB,
         sb_perc = SB / attempts,
         decade = Season %/% 10 * 10,
         age_bracket = Age %/% 10 * 10) %>%
  filter(!is.na(sb_perc)) %>%  
  dplyr::select(playerid, batter_name, Age, age_bracket, Season, decade, SB, attempts, 
                sb_perc) %>%
  arrange(desc(sb_perc))


#filtering out seasons of 100% is that OK???

```



```{r}
ggplot(sb_info_seasons %>% filter(Season >= 1950), aes(decade, sb_perc, group = decade)) + geom_boxplot() +
  tht_theme + ggtitle("Stolen Base Success Rates by Decade") + 
  labs(x="", y="SB%")

sb_info_seasons %>%
  filter(Season >= 1980) %>%
  group_by(Season) %>%
  summarize(mean_sb_perc = mean(sb_perc)) %>%
  ggplot(aes(Season, mean_sb_perc)) + geom_point(color="#8e001c") + geom_line(color="#8e001c") +
  tht_theme + labs(y="Average SB%")


```


# test a couple different splines to see which one produces the best fit. it looks like ns(Season, 2) is decent.
helpful explanation of knots and splines: https://stats.stackexchange.com/questions/7316/setting-knots-in-natural-cubic-splines-in-r

```{r}
degrees <- 5
spline_model_seasons <- lm(cbind(sb_info_seasons$SB, sb_info_seasons$attempts - sb_info_seasons$SB) ~
                             ns(sb_info_seasons$Season, degrees))
plot(predict(spline_model_seasons))


degrees_age <- 3
spline_model_age <- lm(cbind(sb_info_seasons$SB, sb_info_seasons$attempts - sb_info_seasons$SB) ~
                             ns(sb_info_seasons$Age, degrees_age))
plot(predict(spline_model_age))

```

# fit beta-binom model to each player-season


```{r}

#model sb%, allowing the number of attempts to according to the year of the season as well as the number of attempts
fit <- gamlss(cbind(SB, attempts - SB) ~ ns(Season, 5) * log(attempts),
              data = sb_info_seasons,
              family = BB(mu.link = "identity"))

td <- tidy(fit)

mu <- fitted(fit, parameter = "mu")
sigma <- fitted(fit, parameter="sigma")

eb_sb <- sb_info_seasons %>%
  ungroup() %>%
  mutate(mu = mu,
         alpha0 = mu / sigma,
         beta0 = (1 - mu) / sigma,
         alpha1 = alpha0 + SB,
         beta1 = beta0 + attempts - SB,
         est_sb_rate = alpha1 / (alpha1 + beta1),
         low_credible = qbeta(.025, alpha1, beta1), 
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  mutate(name_season = paste(batter_name, Season, sep = " ")) %>%
  arrange(desc(est_sb_rate))

ggplot(eb_sb %>% head(25), aes(est_sb_rate, reorder(name_season, est_sb_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated SB Success Rate with 95% Credible Interval") +
  ggtitle("Best Basestealing Seasons Since 1900") + tht_theme

eb_sb_career <- eb_sb %>%
  group_by(playerid, batter_name) %>%
  summarize(alpha1_sum = sum(alpha1),
            beta1_sum = sum(beta1)) %>%
  mutate(est_sb_rate = alpha1_sum / (alpha1_sum + beta1_sum),
         low_credible = qbeta(.025, alpha1_sum, beta1_sum), 
         high_credible = qbeta(.975, alpha1_sum, beta1_sum)) %>%
  arrange(desc(est_sb_rate))

ggplot(eb_sb_career %>% head(25), aes(est_sb_rate, reorder(batter_name, est_sb_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Career SB Success Rate with 95% Credible Interval") +
  ggtitle("Best Basestealers") + tht_theme

```

```{r}
# henderson 1992
ggplot() + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 49.25708, shape2 = 14.78096),
                lwd=1.5,
                aes(color="Prior Expectation")) +
   stat_function(fun = dbeta,
                args=list(shape1 = 97.25708, shape2 = 25.78096),
                lwd=1.5,
                aes(color="Posterior")) +
  xlim(0.55, 0.95) + labs(x="Estimated SB%") + 
  ggtitle("Rickey Henderson, 1992 (48 SB, 11 CS)") + 
  labs(color = "Distribution") + tht_theme

```

```{r}

# plot histograms of seasons

eb_sb %>%
  filter(batter_name %in% c("Rickey Henderson", "Tim Raines")) %>%
  ggplot(aes(Season, est_sb_rate)) +
  geom_point(color="#8e001c") + geom_line(color="#8e001c") + 
  facet_grid(~batter_name) + 
  tht_theme + labs(x="Season", y="Estimated SB%")

henderson_raines %>%
  group_by(batter_name) %>%
  summarize(mean_eb_sb_perc = mean(est_sb_rate))

# sb%
sb_info_seasons %>%
  filter(batter_name %in% c("Rickey Henderson", "Tim Raines")) %>%
  ggplot(aes(Season, sb_perc)) +
  geom_point(color="#8e001c") + geom_line(color="#8e001c") + 
  geom_smooth(method="lm", se=FALSE, color="black", linetype=2, lwd=0.5) +
  facet_grid(~batter_name) + 
  tht_theme + labs(x="Season", y="SB%")

# attempts: henderson and raines
sb_info_seasons %>%
  filter(batter_name %in% c("Rickey Henderson", "Tim Raines")) %>%
  ggplot(aes(Season, attempts)) +
  geom_point(color="#8e001c") + geom_line(color="#8e001c") + 
  geom_smooth(method="lm", se=FALSE, color="black", linetype=2, lwd=0.5) +
  facet_grid(~batter_name) + 
  tht_theme + labs(x="Season", y="SB Attempts")

# attempts: henderson and coleman
sb_info_seasons %>%
  filter(batter_name %in% c("Rickey Henderson", "Vince Coleman")) %>%
  ggplot(aes(Season, attempts)) +
  geom_point(color="#8e001c") + geom_line(color="#8e001c") + 
  geom_smooth(method="lm", se=FALSE, color="black", linetype=2, lwd=0.5) +
  facet_grid(~batter_name) + 
  tht_theme + labs(x="Season", y="SB Attempts")

# sb% henderson and coleman
sb_info_seasons %>%
  filter(batter_name %in% c("Rickey Henderson", "Vince Coleman")) %>%
  ggplot(aes(Season, sb_perc)) +
  geom_point(color="#8e001c") + geom_line(color="#8e001c") + 
  geom_smooth(method="lm", se=FALSE, color="black", linetype=2, lwd=0.5) +
  facet_grid(~batter_name) + 
  tht_theme + labs(x="Season", y="SB%")

# estimated sb%
eb_sb %>%
  filter(batter_name %in% c("Rickey Henderson", "Vince Coleman")) %>%
  ggplot(aes(Season, est_sb_rate)) +
  geom_point(color="#8e001c") + geom_line(color="#8e001c") + 
  geom_smooth(method="lm", se=FALSE, color="black", linetype=2, lwd=0.5) +
  facet_grid(~batter_name) + 
  tht_theme + labs(x="Season", y="Estimated SB%")

```

```{r}


sb_info_seasons %>%
  filter(batter_name %in% c("Rickey Henderson", "Vince Coleman")) %>%
  ggplot(aes(Season, attempts, size=sb_perc, color=batter_name)) +
  geom_point() + tht_theme + labs(y="Attempts", color="Player", size="SB%")

sb_info_seasons %>%
  filter(batter_name %in% c("Rickey Henderson", "Vince Coleman", "Tim Raines")) %>%
  ggplot(aes(Season, attempts, size=sb_perc, color=batter_name)) +
  geom_point() + tht_theme + labs(y="Attempts", color="Player", size="SB%")

```





#prior graph ... need to look into how to do this.
```{r}
plot_gamlss_fit <- function(f) {
  sb_info_seasons %>%
    filter(Season >= 1950) %>%
    distinct() %>%
    mutate(attempts = 20) %>%
    augment(f, newdata = .) %>%
    rename(mu = .fitted) %>%
    mutate(sigma = fitted(fit, "sigma")[1],
           alpha0 = mu / sigma,
           beta0 = (1 - mu) / sigma,
           conf_low = qbeta(.025, alpha0, beta0),
           conf_high = qbeta(.975, alpha0, beta0)) %>%
    ggplot(aes(Season, mu, color = attempts, group = attempts)) +
    geom_line(color="#8e001c") +
    geom_ribbon(aes(ymin = conf_low, ymax = conf_high), linetype = 2, alpha = .05, color="#8e001c") +
    labs(x = "Year",
         y = "Prior (SB%, Median + 95% Credible Interval)") +
    ggtitle("SB% Prior Expectations, 20 Steal Attempts in a Season") +
    theme(legend.position="none") + xlim(1950, 2020) +
    tht_theme
}
plot_gamlss_fit(fit)


```

For a player in the 1950's who attempted 50 steals, you'd expect their success rate to be about 70%. In those days, everyone ran wild without considering sucecss that much. Contrast that to today, when stolen base attempts are rarer due to increased awareness of the importance of outs. In 2017, if you see a guy attempting 50 steals, you'd guess his success rate to be closer to 80%.



50 attempts today tells you means a lot more now than it does in 1950. back then, everyone was running wild. today, stolen bases have plummeted ... if you see a guy attempting 50 steals, you can assume he's a really good basestealer.


LIKELIHOOD

For each player-season, I combined the prior probabilities (computed using the model above) with their actual stolen-base success rates and summed the results across players' careers. The result is a set of probability density curves that show the estimated success rate for each player, given all the information we know about them over their entire careers.

The following curves show our estimated success rates for the two Titans of Swipe, Rickey Henderson and Tim Raines:

```{r}

coleman_list <- eb_sb_career %>% 
  ungroup() %>% 
  filter(playerid == 1002433) %>% 
  dplyr::select(alpha1_sum, beta1_sum) %>% 
  as.list()

henderson_list <- eb_sb_career %>% 
  ungroup() %>% 
  filter(playerid == 194) %>% 
  dplyr::select(alpha1_sum, beta1_sum) %>% 
  as.list()

raines_list <- eb_sb_career %>%
  ungroup() %>%
  filter(playerid == 1406) %>%
  dplyr::select(alpha1_sum, beta1_sum) %>%
  as.list()
 
raines_alpha <- as.numeric(raines_list[1])
raines_beta <- as.numeric(raines_list[2])

henderson_alpha <- as.numeric(henderson_list[1])
henderson_beta <- as.numeric(henderson_list[2]) 

coleman_alpha <- as.numeric(coleman_list[1])
coleman_beta <- as.numeric(coleman_list[2]) 




ggplot() + geom_histogram(binwidth = 0.001, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = coleman_alpha, shape2 = coleman_beta),
                lwd=1.5,
                aes(color="Vince Coleman")) +
  stat_function(fun = dbeta,
                args=list(shape1 = henderson_alpha, shape2 = henderson_beta),
                lwd=1.5,
                aes(color="Rickey Henderson")) +
  xlim(.75, 0.825) + labs(x="Estimated Career SB%") + 
  ggtitle("Estimated SB%, Rickey Henderson and Vince Coleman") + 
  labs(color = "Player") + tht_theme

ggplot() + geom_histogram(binwidth = 0.001, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = coleman_alpha, shape2 = coleman_beta),
                lwd=1.5,
                aes(color="Vince Coleman")) +
  stat_function(fun = dbeta,
                args=list(shape1 = raines_alpha, shape2 = raines_beta),
                lwd=1.5,
                aes(color = "Tim Raines")) +
  stat_function(fun = dbeta,
                args=list(shape1 = henderson_alpha, shape2 = henderson_beta),
                lwd=1.5,
                aes(color="Rickey Henderson")) +
  xlim(.70, 0.85) + labs(x="Estimated Career SB%") + 
  ggtitle("Comparing Three Stolen-Base Legends") + 
  labs(color = "Player") + tht_theme
```



```{r}
#simulation
coleman_sim <- rbeta(1e6, coleman_alpha, coleman_beta)
henderson_sim <- rbeta(1e6, henderson_alpha, henderson_beta)
mean(coleman_sim > henderson_sim)
# 70% chance coleman is the better basestealer than henderson
```

```{r}
#A/B testing: raines vs. Henderson

# Joint densitiy: Raines vs. Henderson
x <- seq(.73, .81, .001)
crossing(raines_x = x, henderson_x = x) %>%
  mutate(raines_density = dbeta(raines_x, raines_alpha, raines_beta),
         henderson_density = dbeta(henderson_x, henderson_alpha, henderson_beta),
         joint = raines_density * henderson_density) %>%
  ggplot(aes(raines_x, henderson_x, fill = joint)) +
  geom_tile() +
  geom_abline() +
  scale_fill_gradient2(low = "white", high = "red") +
  labs(x = "Raines Estimated SB%",
       y = "Henderson Estimated SB%",
       fill = "Joint density") +
  #theme(legend.position = "none")
  tht_theme +
  ggtitle("Joint Distribution of Estimated SB%")

raines_sim <- rbeta(1e6, raines_alpha, raines_beta)
henderson_sim <- rbeta(1e6, henderson_alpha, henderson_beta)
mean(henderson_sim > raines_sim) * 100


# compare henderson to raines
d <- .001
limits <- seq(.75, .95, d)
sum(outer(limits, limits, function(x, y) {
  (x > y) *
    dbeta(x, henderson_alpha, henderson_beta) *
    dbeta(y, raines_alpha, raines_beta) *
    d ^ 2
}))

```


```{r}
#joint density: coleman vs. Henderson
x <- seq(.75, .825, .001)
crossing(coleman_x = x, henderson_x = x) %>%
  mutate(coleman_density = dbeta(coleman_x, coleman_alpha, coleman_beta),
         henderson_density = dbeta(henderson_x, henderson_alpha, henderson_beta),
         joint = coleman_density * henderson_density) %>%
  ggplot(aes(coleman_x, henderson_x, fill = joint)) +
  geom_tile() +
  geom_abline() +
  scale_fill_gradient2(low = "white", high = "#8e001c") +
  labs(x = "Coleman Estimated SB%",
       y = "Henderson Estimated SB%",
       fill = "Joint density") +
  #theme(legend.position = "none")
  tht_theme +
  ggtitle("Joint Distribution of Estimated SB%")


coleman_sim <- rbeta(1e6, coleman_alpha, coleman_beta)
henderson_sim <- rbeta(1e6, henderson_alpha, henderson_beta)
mean(coleman_sim > henderson_sim)


# compare henderson to coleman
d <- .001
limits <- seq(.75, .95, d)
sum(outer(limits, limits, function(x, y) {
  (x > y) *
    dbeta(x, coleman_alpha, coleman_beta) *
    dbeta(y, henderson_alpha, henderson_beta) *
    d ^ 2
}))


```

```{r}

# compare coleman to Raines
x <- seq(.73, .82, .001)
crossing(coleman_x = x, raines_x = x) %>%
  mutate(coleman_density = dbeta(coleman_x, coleman_alpha, coleman_beta),
         raines_density = dbeta(raines_x, raines_alpha, raines_beta),
         joint = coleman_density * raines_density) %>%
  ggplot(aes(coleman_x, raines_x, fill = joint)) +
  geom_tile() +
  geom_abline() +
  scale_fill_gradient2(low = "white", high = "red") +
  labs(x = "Coleman Estimated SB%",
       y = "Raines Estimated SB%",
       fill = "Joint density") +
  #theme(legend.position = "none")
  tht_theme +
  ggtitle("Joint Distribution of Estimated SB%")

mean(coleman_sim > raines_sim)


# compare henderson to coleman
d <- .001
limits <- seq(.75, .95, d)
sum(outer(limits, limits, function(x, y) {
  (x > y) *
    dbeta(x, coleman_alpha, coleman_beta) *
    dbeta(y, henderson_alpha, henderson_beta) *
    d ^ 2
}))

```






```

### here's how coleman stacks up to other well-known base thieves:

```{r}
ggplot() + geom_histogram(binwidth = 0.009, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = coleman_alpha, shape2 = coleman_beta),
                lwd=1.5,
                aes(color="Vince Coleman")) +
   stat_function(fun = dbeta,
                args=list(shape1 = henderson_alpha, shape2 = henderson_beta),
                lwd=1.5,
                aes(color="Rickey Henderson")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1793.88108, shape2 = 568.95598),
                lwd=1.5,
                aes(color = "Tim Raines")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1219.401, shape2 = 471.1316),
                lwd=1.5,
                aes(color="Maury Wills")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1799.015, shape2 = 598.6698),
                lwd=1.5,
                aes(color="Lou Brock")) + 
  stat_function(fun=dbeta,
                args=list(shape1 = 1285.863, shape2 = 508.8217),
                aes(color="Luis Aparicio"),
                lwd=1.5) + 
  xlim(0.65, 0.90) + labs(x="Estimated SB Success Rate") + 
  ggtitle("Estimated Success Rates of Well-Known Basestealers") + 
  labs(color = "Player") + tht_theme
```

flattened ...

```{r}
ggplot(eb_sb_career %>% filter(batter_name %in% c("Carlos Beltran", "Lou Brock",
                                                  "Maury Wills", "Rickey Henderson",
                                                  "Tim Raines", "Vince Coleman", "Joe Morgan")),
       aes(est_sb_rate, reorder(batter_name, est_sb_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Career SB Success Rate with 95% Credible Interval") +
  ggtitle("Estimated Success Rates of Well-Known Basestealers") + tht_theme
```


