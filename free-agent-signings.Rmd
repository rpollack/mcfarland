


```{r}
library(tidyverse)
library(lubridate)
library(rvest)
library(ggrepel)
library(glue)
library(ggridges)
library(plotly)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color = "black", family = "Lato")
)
```

```{r}
get_free_agents <- function(url) {
  signed_fas <- url %>%
    read_html() %>%
    html_node("table#fa_signings")

  # return empty tibble if no table was found
  tryCatch(html_table(signed_fas, header = TRUE),
    error = function(e) {
      tibble()
    }
  )
}

get_unsigned_batters <- function(url) {
  unsigned_bat <- url %>%
    read_html() %>%
    html_nodes(xpath = "//comment()") %>%
    html_text() %>%
    paste(collapse = "") %>%
    read_html() %>%
    html_node("table#fa_batting")

  # return empty tibble if no table was found
  tryCatch(html_table(unsigned_bat, header = TRUE),
    error = function(e) {
      tibble()
    }
  )
}

get_unsigned_pitchers <- function(url) {
  unsigned_pit <- url %>%
    read_html() %>%
    html_nodes(xpath = "//comment()") %>%
    html_text() %>%
    paste(collapse = "") %>%
    read_html() %>%
    html_node("table#fa_pitching")

  # return empty tibble if no table was found
  tryCatch(html_table(unsigned_pit, header = TRUE),
    error = function(e) {
      tibble()
    }
  )
}

get_fa_salaries <- function(year) {
  # read salaries from MLB Trade Rumors trackers
  # ignore players who didn't sign or for whom MLBTR does not know the signing amount
  # convert all salaries to major-league guaranteed millions USD
  # which means minor-league deals count as $0
  url <- str_c("https://www.mlbtraderumors.com/", year, "-mlb-free-agent-tracker/")

  read_html(url) %>%
    html_nodes("table") %>%
    .[[2]] %>%
    html_table(header = FALSE, fill = TRUE) %>%
    as_tibble() %>%
    filter(
      X1 != "Player",
      X5 > 0,
      X6 != "Unknown"
    ) %>%
    dplyr::select(name = X1, sign_years = X5, sign_salary = X6) %>%
    distinct(name, sign_years, sign_salary) %>% # remove duplicate entries
    mutate(
      offseason = year - 1,
      sign_salary = case_when(
        sign_salary == "Minor" ~ 0,
        str_detect(sign_salary, "MM") ~ as.numeric(str_extract(sign_salary, "[:digit:]+\\.{0,1}[:digit:]*")),
        str_detect(sign_salary, "K") ~ as.numeric(str_extract(sign_salary, "[:digit:]+")) / 1000
      )
    )
}

generate_csv <- function(df, year_min, year_max, position, player_type, age) {
  filename <- glue("{position}-{player_type}-{age}.csv")
  df %>%
    filter(
      offseason >= as.numeric(year_min),
      offseason <= as.numeric(year_max),
      Position == position,
      player_type == player_type,
      age_bucket == age
    ) %>%
    dplyr::select(offseason, name, age, three_year_war, days_to_sign, sign_salary) %>%
    arrange(offseason, days_to_sign) %>%
    write_csv(filename)
}

# generate_csv(all_free_agents, 2016, 2018, "Position Player", "Scrub", "34 - 36")
```

### get data

```{r}
start_year <- 2010
start_year_salaries <- 2011
current_year <- 2019


years <- tibble(year = start_year:current_year) %>%
  mutate(url = paste0("https://www.baseball-reference.com/leagues/MLB/", year, "-free-agents.shtml"))

fa_signings <-
  years %>%
  group_by(url) %>%
  do(get_free_agents(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, `To Team`, age = Age, sign_date = Date, three_year_war = `WAR3`, AB, G = `G...10`, GS, IP) %>%
  mutate(sign_type = "signed") %>%
  arrange(sign_date)

unsigned_batters <-
  years %>%
  group_by(url) %>%
  do(get_unsigned_batters(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, three_year_war = `WAR3`, AB) %>%
  mutate(
    sign_type = "unsigned",
    sign_date = NA_character_,
    GS = NA_character_,
    G = NA_character_,
    IP = 0,
    `To Team` = NA_character_
  )

unsigned_pitchers <- years %>%
  group_by(url) %>%
  do(get_unsigned_pitchers(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, three_year_war = `WAR3`, G, GS, IP) %>%
  mutate(
    sign_type = "unsigned",
    sign_date = NA_character_,
    `To Team` = NA_character_
  )

# check for invalid dates that month() will fail to convert. handle them manually later
invalid_dates <- which(is.na(ymd(as.character(fa_signings$sign_date), tz = "UTC")))
fa_signings %>%
  filter(row_number() %in% invalid_dates) %>%
  View()

# get FA salaries from MLBTR
# update some names to match formatting from baseball reference
fa_salaries <-
  seq(2011, 2020) %>%
  map_df(get_fa_salaries) %>%
  mutate(name = str_replace_all(name, c(
    "Jorge de la Rosa" = "Jorge De La Rosa",
    "Manual Corpas" = "Manny Corpas",
    "Hong-Chih Kuo" = "Hung-Chih Kuo",
    "Melvin Upton" = "Melvin Upton Jr.",
    "Zach Britton" = "Zack Britton",
    "Michael Dunn" = "Mike Dunn",
    "Michael Fiers" = "Mike Fiers",
    "Jung-ho Kang" = "Jung Ho Kang",
    "Matt Joyce" = "Matthew Joyce",
    "Alejandro de Aza" = "Alejandro De Aza",
    "Norichika Aoki" = "Nori Aoki",
    "Seung-hwan Oh" = "Seunghwan Oh",
    "David Bush" = "Dave Bush",
    "Samuel Deduno" = "Sam Deduno",
    "Johnathon Niese" = "Jon Niese",
    "J.B. Shuck" = "JB Shuck",
    "Chase D'Arnaud" = "Chase d'Arnaud",
    "Daniel Coulombe" = "Danny Coulombe",
    "Nick Castellanos" = "Nicholas Castellanos"
  ))) %>%
  arrange(desc(sign_salary))

# this code shows folks we have salaries for that we don't have an entry in FA signings for. perhaps we can combine? 
# in some cases is

fa_salaries %>% mutate(offseason = as.character(offseason)) %>% anti_join(fa_signings) %>% arrange(desc(sign_salary)) %>% View()


```

### clean data

```{r}

fa_signings_clean <-
  fa_signings %>%
  ungroup() %>%
  # remove transactions w/no valid date attached & for which I can't find info
  filter(
    !name %in% c(
      "Doug Gwosdz", "Kurt Kepshire", "Bill Scherrer", "Darryl Motley",
      "Steve Carter", "Guillermo Rodriguez"
    ),
    !str_detect(sign_date, "-00-")
  ) %>%

  # some guys have missing sign days, but we care only about the month, so fake it
  mutate(
    sign_date = ifelse(name == "Jay Baller" & offseason == 1989, "1990-01-01", sign_date),
    sign_date = ifelse(name == "Vic Rodriguez" & offseason == 1987, "1988-01-01", sign_date),
    sign_date = ifelse(name == "Max Venable" & offseason == "1987", "1988-02-01", sign_date),
    sign_date = as.Date(sign_date),
    sign_month = (month(sign_date, label = TRUE)),
    offseason = as.character(offseason),

    # re-order the months based on when we perceive the start of FA season to be
    sign_month = factor(sign_month, levels = c(
      "Sep", "Oct", "Nov", "Dec", "Jan", "Feb",
      "Mar", "Apr", "May", "Jun", "Jul", "Aug"
    ))
  )

# chagne some data types to match so the rows can be bound together.
unsigned_batters_clean <-
  unsigned_batters %>%
  mutate(
    sign_date = as.Date(sign_date),
    G = as.integer(G),
    GS = as.integer(GS)
  )

unsigned_pitchers_clean <-
  unsigned_pitchers %>%
  mutate(
    sign_date = as.Date(sign_date),
    G = as.integer(G),
    GS = as.integer(GS)
  )


# 1. combine all tibbles into one, so each offseason has the right signed and unsigned players
# 2. scrub duplicates from the data; i found that, for example, the 2017 offseason has many duplicates entries that inflate
# the real count of free agents
# 3. assign a label to each type of player, based on their position and their trailing three-year WAR total
# 4. bucket the player according to their age when they signed
# 5. compute the number of days it took the player to sign, starting from Nov 1st of that year
# 6. match up any salary/signing information i have with the player and the offseason

all_free_agents <-
  bind_rows(fa_signings_clean, unsigned_batters_clean, unsigned_pitchers_clean) %>%
  distinct() %>% # remove duplicate entries; many years have them
  replace_na(list(AB = 0, GS = 0, G = 0, IP = 0, three_year_war = 0)) %>%
  mutate(
    position = case_when(
      (IP < 10 | AB >= 800) ~ "Position Player", # prevent pos. players with relief appearances from being classified as pitchers #
      # and NL starters with lots of AB from being classified as position players
      GS / G >= 0.5 ~ "Starting Pitcher",
      TRUE ~ "Relief Pitcher"
    ),
    position =
      factor(position, levels = c("Position Player", "Starting Pitcher", "Relief Pitcher")),
    player_type = case_when(
      position %in% c("Starting Pitcher", "Position Player") ~ case_when(
        three_year_war < 1.5 ~ "Scrub",
        three_year_war >= 1.5 & three_year_war < 4.5 ~ "Role Player",
        three_year_war >= 4.5 & three_year_war < 7.5 ~ "Solid Starter",
        three_year_war >= 7.5 & three_year_war < 10.5 ~ "Good Player",
        three_year_war >= 10.5 & three_year_war < 13.5 ~ "All-Star",
        three_year_war >= 13.5 & three_year_war < 16.5 ~ "Superstar",
        three_year_war >= 16.5 ~ "MVP"
      ),
      position == "Relief Pitcher" ~ case_when(
        three_year_war >= 5 ~ "Superstar",
        three_year_war >= 2 ~ "Good Player",
        three_year_war >= 1 ~ "Role Player",
        TRUE ~ "Scrub"
      ),
    ),
    player_type = factor(player_type, levels = c("Scrub", "Role Player", "Solid Starter", "Good Player", "All-Star", "Superstar", "MVP")),
    age_bucket = case_when(
      age <= 27 ~ "<= 27",
      age >= 28 & age <= 30 ~ "28 - 30",
      age >= 31 & age <= 33 ~ "31 - 33",
      age >= 34 & age <= 36 ~ "34 - 36",
      age >= 37 & age <= 39 ~ "37 - 39",
      age >= 40 & age <= 42 ~ "40 - 42",
      age >= 43 ~ "43+"
    ),
    age_bucket = factor(age_bucket, levels = c("<= 27", "28 - 30", "31 - 33", "34 - 36", "37 - 39", "40 - 42", "43+")),
    offseason = as.integer(offseason),
    days_to_sign = as.period(interval(
      ymd(str_c(offseason, "11", "01", sep = "-")),
      sign_date
    )) %/% days(1),
  ) %>%
  left_join(fa_salaries, by = c("name", "offseason")) %>%

  # adjust for inflation relative to 2020 source: https://www.usinflationcalculator.com
  mutate(
    sign_salary = case_when(
      offseason == 2010 ~ sign_salary * 1.152,
      offseason == 2011 ~ sign_salary * 1.116,
      offseason == 2012 ~ sign_salary * 1.094,
      offseason == 2013 ~ sign_salary * 1.078,
      offseason == 2014 ~ sign_salary * 1.061,
      offseason == 2015 ~ sign_salary * 1.059,
      offseason == 2016 ~ sign_salary * 1.046,
      offseason == 2017 ~ sign_salary * 1.024,
      offseason == 2018 ~ sign_salary * 1.027,
      offseason == 2019 ~ sign_salary * 1.008,
      TRUE ~ sign_salary # catch-all for the current year AND if I forget to update the chart above
    ),
    sign_years = as.numeric(sign_years),
    sign_years = if_else(sign_salary == 0, 0, sign_years) # if player signs minor league deal, make it a 0-length deal so it'll bring down the avg
  ) %>%
  mutate(to_team = case_when(
    `To Team` == "Arizona Diamondbacks" ~ "ARI",
    `To Team` == "Atlanta Braves" ~ "ATL",
    `To Team` == "Baltimore Orioles" ~ "BAL",
    `To Team` == "Boston Red Sox" ~ "BOS",
    `To Team` == "Chicago Cubs" ~ "CHC",
    `To Team` == "Chicago White Sox" ~ "CHW",
    `To Team` == "Cincinnati Reds" ~ "CIN",
    `To Team` == "Cleveland Indians" ~ "CLE",
    `To Team` == "Colorado Rockies" ~ "COL",
    `To Team` == "Detroit Tigers" ~ "DET",
    `To Team` == "Houston Astros" ~ "HOU",
    `To Team` == "Kansas City Royals" ~ "KCR",
    str_detect(`To Team`, "Los Angeles Angels") ~ "LAA",
    `To Team` == "Los Angeles Dodgers" ~ "LAD",
    str_detect(`To Team`, "Marlins") ~ "MIA",
    `To Team` == "Milwaukee Brewers" ~ "MIL",
    `To Team` == "Minnesota Twins" ~ "MIN",
    `To Team` == "New York Mets" ~ "NYM",
    `To Team` == "New York Yankees" ~ "NYY",
    `To Team` == "Oakland Athletics" ~ "OAK",
    `To Team` == "Philadelphia Phillies" ~ "PHI",
    `To Team` == "Pittsburgh Pirates" ~ "PIT",
    `To Team` == "San Diego Padres" ~ "SDP",
    `To Team` == "San Francisco Giants" ~ "SFG",
    `To Team` == "Seattle Mariners" ~ "SEA",
    `To Team` == "St. Louis Cardinals" ~ "STL",
    `To Team` == "Tampa Bay Rays" ~ "TBR",
    `To Team` == "Texas Rangers" ~ "TEX",
    `To Team` == "Toronto Blue Jays" ~ "TOR",
    `To Team` == "Washington Nationals" ~ "WAS"
  )) %>%
  dplyr::select(-GS, -G, -AB, IP, -`To Team`)
```


# by team, over time
```{r, fig.height=3}


# TODO fix blank and NA teams.

fa_signing_plt <-
  all_free_agents %>%
  filter(sign_type == "signed", !is.na(sign_salary), sign_salary != 0) %>%
  mutate(
    player_salary = glue("{name} - ${round(sign_salary,1)}m"),
    offseason = as.character(offseason)
  ) %>%
  group_by(offseason, to_team) %>%
  arrange(desc(sign_salary)) %>%
  summarize(
    num_players_signed = n(),
    total_salary = round(sum(sign_salary, na.rm = TRUE), 1),
    players_signed = paste(player_salary, collapse = "\n")
  ) %>%
  ggplot(aes(offseason, total_salary, group = 1, label = players_signed)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(to_team)) +
  scale_x_discrete(breaks = c("2010", "2015", "2019")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(x = "", y = "Total FA Contracts Signed (USD Million, Adj. for Inflation")

ggplotly(fa_signing_plt, tooltip = c("offseason", "total_salary", "players_signed"))
```


show the average number of days it takes players to sign a FA contract

```{r}

# median time to sign, by offseason. using median since most years are skewed left or right
all_free_agents %>%
  group_by(offseason) %>%
  summarize(median_sign_days = median(days_to_sign, na.rm = TRUE)) %>%
  ggplot(aes(offseason, median_sign_days)) +
  geom_point() +
  geom_line() +
  expand_limits(y = 0) +
  fgt +
  labs(
    y = "Median # of Days 
       between Nov 1st and Contract Signing", x = "Offseason",
    caption = "Source: Baseball Reference"
  ) +
  scale_x_continuous(breaks = seq(start_year, current_year)) +
  ggtitle("Offseason vs. Median Time to Sign Contract",
    subtitle = "Free Agents through March 2020"
  ) +
  ggsave("free-agents-median-time-to-sign.png")


all_free_agents %>%
  group_by(offseason, position) %>%
  summarize(median_sign_days = median(days_to_sign, na.rm = TRUE)) %>%
  ggplot(aes(offseason, median_sign_days)) +
  facet_wrap(vars(position)) +
  geom_point() +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Speed",
    subtitle = "Median number of days between Nov 1st and player's sign date"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))

all_free_agents %>%
  group_by(offseason, position) %>%
  summarize(median_salary = round(median(sign_salary, na.rm = TRUE), 1)) %>%
  ggplot(aes(offseason, median_salary)) +
  facet_wrap(vars(position)) +
  geom_point() +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Salaries") +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year)) +
  labs(y = "Median Signing Salary (USD Millions)")

# mean time to sign by player talent type, by year
all_free_agents %>%
  filter(offseason >= 2010) %>%
  group_by(offseason, player_type) %>%
  summarize(median_sign_days = median(days_to_sign, na.rm = TRUE)) %>%
  ggplot(aes(offseason, median_sign_days)) +
  facet_wrap(vars(player_type)) +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Speed",
    subtitle = "Median number of days between Nov 1st and player's sign date"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))


# number of each types of player available
all_free_agents %>%
  count(offseason, position, player_type)
```

```{r}
signing_timeline <-
  all_free_agents %>%
  filter(sign_type == "signed", player_type != "Scrub", days_to_sign >= 0) %>%
  distinct() %>%
  group_by(offseason, player_type, sign_month) %>%
  summarize(
    num_players = n(),
    players = (paste(name, collapse = "\n"))
  ) %>%
  ggplot(aes(sign_month, num_players, fill = player_type, label = players)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(vars(offseason)) +
  labs(
    y = "Number of Players Signed", x = "Month Signed",
    caption = "Source: Baseball-Reference. Made with Plotly in R"
  ) +
  ggtitle("Offseason vs. Month when Free Agent Signed, by Player Talent Level",
    subtitle = "player_type calculated based on position & WAR total in the three years befor signing"
  )

# a ggplot with facets doesn't work with dynamic tick marks. sad. https://github.com/ropensci/plotly/issues/1416

ggplotly(signing_timeline, tooltip = c("player_type", "players")) %>%
  layout(title = list(text = paste0(
    "Ten Years of Free Agency in Baseball",
    "<br>",
    "<sup>",
    "Sign Month by offseason & player talent level. Source: Baseball-Reference",
    "<br>",
    "Player talent based on position & WAR total in the 3 years prior to signing",
    "</sup>"
  ))) %>%
  htmlwidgets::saveWidget("mlb-free-agency.html")

all_free_agents %>%
  filter(sign_type == "signed", offseason >= 2015, player_type %in% c("Good Player", "All-Star", "Superstar", "MVP")) %>%
  group_by(offseason, player_type, sign_month) %>%
  summarize(players = (paste(name, collapse = "\n"))) %>%
  ggplot(aes(sign_month, y = 1, color = player_type)) +
  geom_label(aes(label = players)) +
  facet_grid(vars(offseason))
#
#
#   ggplot(aes(sign_month, sign_salary, color = player_type)) +
#   geom_point() +
#   facet_grid(vars(offseason)) +
#   labs(x="", y="FA Contract Value (USD Millions)") +
#   geom_label_repel(aes(label=name), nudge_y = 0.5) +
#   ggsave("derp.png", width = 10, height = 10, units = "in")
```


add one more facet: the player's age bucket

```{r, fig.height=4, fig.width=5}

# mean time to sign by player type and age bucket, by year
fa_diff <-
  all_free_agents %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(mean_days_to_sign = round(mean(days_to_sign, na.rm = TRUE), 1))

# position players' time to sign
fa_diff %>%
  filter(
    offseason >= 2010,
    position == "Position Player"
  ) %>%
  ggplot(aes(offseason, mean_days_to_sign, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Mean Days to Sign FA Contract",
    subtitle = "Position Players"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))

# starters' time to sign
fa_diff %>%
  filter(
    offseason >= 2010,
    position == "Starting Pitcher"
  ) %>%
  ggplot(aes(offseason, mean_days_to_sign, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Mean Days to Sign FA Contract by Player Type",
    subtitle = "Starting Pitchers"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))

# relievers' time to sign
fa_diff %>%
  filter(
    offseason >= 2010,
    position == "Relief Pitcher"
  ) %>%
  ggplot(aes(offseason, mean_days_to_sign, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Mean Days to Sign FA Contract by Player Type",
    subtitle = "Relievers"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))
```

```{r, fig.height=3}

# find the largest year-to-year changes in mean days to sign, by player type by age bucket
# ignore multi-year intervals as fans don't perceive those as much; we remember the previous offseason mostly
# also ignore 1993-1994 and 1994-1995 as 1994 was a strike year
differences <-
  fa_diff %>%
  filter(offseason %in% c(2017, 2018)) %>%
  group_by(position, player_type, age_bucket) %>%
  arrange(offseason) %>%
  mutate(
    from_to = str_c(dplyr::lag(offseason), offseason, sep = " - "),
    diff_mean_days_to_sign = mean_days_to_sign - dplyr::lag(mean_days_to_sign)
  ) %>%
  filter(
    !is.na(diff_mean_days_to_sign)
  ) %>%
  arrange(diff_mean_days_to_sign) %>%
  dplyr::select(from_to, position, player_type, age_bucket, diff_mean_days_to_sign)

money_differences <-
  all_free_agents %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(median_signing_salary = round(median(sign_salary, na.rm = TRUE), 1)) %>%
  filter(offseason %in% c(2019, 2018)) %>%
  group_by(position, player_type, age_bucket) %>%
  arrange(offseason) %>%
  mutate(
    from_to = str_c(dplyr::lag(offseason), offseason, sep = " - "),
    diff_median_sign_salary = median_signing_salary - dplyr::lag(median_signing_salary)
  ) %>%
  filter(
    !is.na(diff_median_sign_salary)
  ) %>%
  arrange(desc(diff_median_sign_salary)) %>%
  dplyr::select(from_to, position, player_type, age_bucket, diff_median_sign_salary) %>%
  inner_join(differences, by = c("from_to", "position", "player_type", "age_bucket"))

# graph each group and its year-to-year change in zscore of time to sign and avg contract value. label points of interest
money_differences %>%
  ungroup() %>%
  # mutate(label = glue("{position}, {player_type}, {age_bucket}")) %>%
  mutate(label = case_when(
    (position == "Position Player" & player_type == "All-Star" & age_bucket == "28 - 30") |
      (position == "Position Player" & player_type == "Superstar" & age_bucket == "31 - 33") |
      (position == "Relief Pitcher" & player_type == "Good Player" & age_bucket == "31 - 33") |
      (position == "Position Player" & player_type == "Good Player" & age_bucket == "28 - 30") |
      (position == "Starting Pitcher" & player_type == "Role Player" & age_bucket == "37 - 39") |
      (position == "Starting Pitcher" & player_type == "Solid Starter" & age_bucket == "28 - 30")
    ~ glue("{position}
                                  {player_type}
                                  {age_bucket}"),
    TRUE ~ NA_character_
  )) %>%
  ggplot(aes(diff_mean_days_to_sign, diff_median_sign_salary)) +
  geom_point() +
  geom_label_repel(aes(label = label),
    na.rm = TRUE,
    show.legend = FALSE,
    segment.color = "black",
    nudge_y = -2
  ) +
  theme(legend.position = "none") +
  fgt +
  # xlim(-3, 3) + ylim(-3, 3) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_vline(xintercept = 0, color = "gray") +
  labs(x = "Difference in Mean Days to Sign", y = "Difference in Median Contract Amount (Millions USD)") +
  ggtitle("Difference in Median Contract Amount vs. Difference in Mean Time to Sign Contract",
    subtitle = "Free Agents, 2018 vs. 2017"
  )

differences_model <- lm(diff_median_sign_salary ~ diff_mean_days_to_sign,
  data = money_differences
)
```

```{r, fig.height=3}
# for offseasons 2016 - 2018, find average time to sign and avg $ signed for for position players
# only ployt groups where all 3 years are represented with data
position_player_diff <-
  all_free_agents %>%
  filter(
    offseason %in% c(2016, 2017, 2018),
    position == "Position Player",
    sign_type == "signed"
  ) %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(
    mean_days_to_sign = mean(days_to_sign, na.rm = TRUE),
    median_contract_value = median(sign_salary, na.rm = TRUE)
  ) %>%
  group_by(position, player_type, age_bucket) %>%
  filter((!is.na(mean_days_to_sign) & !is.na(median_contract_value))) %>%
  filter(n() == 3)

ggplot(position_player_diff, aes(factor(offseason), mean_days_to_sign, group = player_type)) +
  facet_wrap(vars(player_type, age_bucket)) +
  geom_point(aes(size = median_contract_value)) +
  geom_line() +
  ggtitle("Offseason vs. Average Time to Sign Contract and Median Contract Value",
    subtitle = "Free Agent Position Players by Talent Level and Age at Signing, 2016 - 2018"
  ) +
  labs(
    x = "Offseason", y = "Avg. # of Days 
       between Nov 1st and Contract Signing", size = "Median Contract Value ($MM)",
    caption = "Sources: Baseball Reference, MLB Trade Rumors"
  ) +
  expand_limits((y <- 0))

# starting pitchers
starting_pitcher_diff <-
  all_free_agents %>%
  filter(
    offseason %in% c(2016, 2017, 2018),
    position == "Starting Pitcher",
    sign_type == "signed"
  ) %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(
    mean_days_to_sign = mean(days_to_sign, na.rm = TRUE),
    median_contract_value = median(sign_salary, na.rm = TRUE)
  ) %>%
  group_by(position, player_type, age_bucket) %>%
  filter((!is.na(mean_days_to_sign) & !is.na(median_contract_value))) %>%
  filter(n() == 3)

ggplot(starting_pitcher_diff, aes(factor(offseason), mean_days_to_sign, group = player_type)) +
  facet_wrap(vars(player_type, age_bucket)) +
  geom_point(aes(size = median_contract_value)) +
  geom_line() +
  ggtitle("Offseason vs. Average Time to Sign Contract and Median Contract Value",
    subtitle = "Free Agent Starting Pitchers by Talent Level and Age at Signing, 2016 - 2018"
  ) +
  labs(
    x = "Offseason", y = "Avg. # of Days 
       between Nov 1st and Contract Signing", size = "Median Contract Value ($MM)",
    caption = "Sources: Baseball Reference, MLB Trade Rumors"
  ) +
  expand_limits((y <- 0))

# relief pitchers
relief_pitcher_diff <-
  all_free_agents %>%
  filter(
    offseason %in% c(2016, 2017, 2018),
    position == "Relief Pitcher",
    sign_type == "signed"
  ) %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(
    mean_days_to_sign = mean(days_to_sign, na.rm = TRUE),
    median_contract_value = median(sign_salary, na.rm = TRUE)
  ) %>%
  group_by(position, player_type, age_bucket) %>%
  filter((!is.na(mean_days_to_sign) & !is.na(median_contract_value))) %>%
  filter(n() == 3)

ggplot(relief_pitcher_diff, aes(factor(offseason), mean_days_to_sign, group = player_type)) +
  facet_wrap(vars(player_type, age_bucket)) +
  geom_point(aes(size = median_contract_value)) +
  geom_line() +
  ggtitle("Offseason vs. Average Time to Sign Contract and Median Contract Value",
    subtitle = "Free Agent Relievers by Talent Level and Age at Signing, 2016 - 2018"
  ) +
  labs(
    x = "Offseason", y = "Avg. # of Days 
       between Nov 1st and Contract Signing", size = "Median Contract Value ($MM)",
    caption = "Sources: Baseball Reference, MLB Trade Rumors"
  ) +
  expand_limits((y <- 0))
```

```{r, fig.height=3}
everyone <-
  bind_rows(position_player_diff, starting_pitcher_diff, relief_pitcher_diff) %>%
  arrange(offseason) %>%
  group_by(position, player_type, age_bucket) %>%
  arrange(offseason, .by_group = TRUE) %>%
  mutate(
    days_to_sign_diff = mean_days_to_sign - lag(mean_days_to_sign),
    contract_diff = median_contract_value - lag(median_contract_value)
  ) %>%
  filter(offseason != 2016) %>%
  unite(label, position, player_type, age_bucket, sep = ", ") %>%
  mutate(
    time_direction = case_when(
      days_to_sign_diff > 0 ~ "Waited Longer",
      days_to_sign_diff <= 0 ~ "Waited the Same\nor Shorter"
    ),
    money_direction = case_when(
      contract_diff >= 0 ~ "Received the Same\nor More Money",
      contract_diff < 0 ~ "Received Less Money"
    )
  )

# who was harmed the most in 2017?

everyone %>%
  mutate(g_label = case_when(
    label %in% c(
      "Position Player, All-Star, 31 - 33",
      "Position Player, Good Player, 28 - 30",
      "Starting Pitcher, Solid Starter, 28 - 30"
    ) ~ label,
    TRUE ~ NA_character_
  )) %>%
  ggplot(aes(days_to_sign_diff, contract_diff)) +
  geom_point() +
  fgt +
  labs(
    x = "Difference in Average Time to Sign Contract (Days)",
    y = "Difference in Median Contract Value ($M)"
  ) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_vline(xintercept = 0, color = "gray") +
  ggtitle("Difference in Average Signing Time vs. Difference in Median Contract Value",
    subtitle = "Free Agents, Offseason vs. the Year Prior"
  ) +
  facet_wrap(vars(offseason)) +
  geom_label_repel(aes(label = g_label),
    na.rm = TRUE,
    force = 5,
    nudge_y = -2
  )
```

```{r}
everyone %>%
  count(offseason, time_direction, money_direction) %>%
  ggplot(aes(time_direction, n, fill = money_direction)) +
  geom_col(position = "stack") +
  facet_grid(vars(offseason)) +
  coord_flip() +
  fgt +
  labs(x = "Length of Wait Compared to Prior Offseason", y = "Number of Player Groups", fill = "Money Received\nCompared to Prior Offseason") +
  ggtitle("Length of Wait and Contract Amount vs. Prior Offseason",
    subtitle = "Free Agents, 2017 and 2018 Offseasons"
  )

# unite(compared_to_previous_offseason, time_direction, money_direction, sep = ",\n") %>%
# ggplot(aes(reorder(compared_to_previous_offseason, -n), n)) + geom_col() +
# facet_wrap(vars(offseason)) + coord_flip() +labs(x="", y="Number of Groups") +
# fgt


# +
#   geom_label_repel(aes(label = graph_label),
#     nudge_x = 100,
#     na.rm = TRUE
#   )

# and how did they fare in 2018?


# arrange(position, player_type, age_bucket, mean_days_to_sign, median_contract_value, offseason)
```


```




# now do everyone together!
# all_free_agents %>%
#   filter(offseason >= 2016 & offseason <= 2018) %>%
#   mutate(offseason = factor(offseason, levels = c(2016, 2017, 2018))) %>%
#   group_by(offseason, position, player_type) %>%
#   summarize(mean_days_to_sign = round(mean(days_to_sign, na.rm = TRUE), 1),
#             median_contract = median(sign_salary, na.rm = TRUE)) %>%
#   ggplot(aes(offseason, mean_days_to_sign, group = position)) +
#   geom_point(aes(size = median_contract)) + geom_line() +
#   facet_wrap(vars(position, player_type)) +
#   ggtitle("Offseason vs. Average Time to Sign Contract",
#     subtitle = "Free Agents"
#   ) + fgt +
#   expand_limits(y = 0) +
#   labs(
#     y = "Avg. # of Days 
#        between Nov 1st and Contract Signing", x = "Offseason",
#     size = "Median Contract Value ($MM)",
#     caption = "Source: Baseball Reference"
#   )
```



```{r, fig.height=3}
money_differences %>%
  ungroup() %>%
  mutate(label = glue("{position}, {player_type}, Age {age_bucket}")) %>%
  ggplot(aes(reorder(label, -diff_mean_days_to_sign), diff_mean_days_to_sign)) +
  geom_col() +
  coord_flip() +
  fgt +
  labs(
    x = "",
    y = "Difference in Average Days Elapsed Before Signing Free Agent Contract",
    caption = "Source: Baseball-Reference"
  ) +
  ggtitle("Difference in Time Elapsed between November 1st and Signing a Contract",
    subtitle = "Free Agents, 2018 vs. 2017"
  )

money_differences %>%
  ungroup() %>%
  mutate(label = glue("{position}, {player_type}, Age {age_bucket}")) %>%
  ggplot(aes(reorder(label, -diff_median_sign_salary), diff_median_sign_salary)) +
  geom_col() +
  coord_flip() +
  fgt +
  labs(x = "", y = "Difference in Median FA Contract Value (Millions USD), 2018 vs. 2017") +
  ggtitle("The Typical Free Agent Took Home Less in 2018 than in 2017")
```

```{r, fig.height=5}
all_free_agents %>%
  ungroup() %>%
  mutate(label = glue("{position}, {player_type}, Age {age_bucket}")) %>%
  ggplot(aes(sign_salary)) +
  geom_histogram() +
  facet_wrap(vars(label))
```


```{r, fig.height = 5, fig.width=6}
all_free_agents %>%
  ggplot(aes(offseason, days_to_sign, group = offseason, color = age_bucket)) +
  geom_boxplot(outlier.size = 0.5, na.rm = TRUE) +
  facet_wrap(vars(player_type, age_bucket)) +
  fgt
```


fun with contract information

```{r, fig.height = 3}




all_free_agents %>%
  filter(!is.na(sign_salary)) %>%
  group_by(offseason) %>%
  summarize(
    avg_signing = round(mean(sign_salary, na.rm = TRUE), 1),
    median_signing = round(median(sign_salary, na.rm = TRUE), 1)
  ) %>%
  ggplot(aes(offseason, median_signing, group = 1)) +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Money", subtitle = "Adjusted for Inflation") +
  expand_limits(y = 0) +
  labs(y = "Median Signing Salary (Millions USD)", x = "Offseason") +
  fgt

# mean $ signed for, by player type by age bucket, over time
all_free_agents %>%
  filter(!is.na(sign_salary)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(avg_signing = round(mean(sign_salary, na.rm = TRUE), 1)) %>%
  ggplot(aes(offseason, avg_signing, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Money") +
  expand_limits(y = 0) +
  labs(y = "Average Signing Salary (Millions USD, Inflation-Adjusted to 2018)", x = "")

# contract length
all_free_agents %>%
  filter(!is.na(sign_salary)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(length_of_avg_contract = round(mean(sign_years, na.rm = TRUE), 1)) %>%
  ggplot(aes(offseason, length_of_avg_contract, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Contract Length") +
  expand_limits(y = 0) +
  labs(y = "Length of Average Contract (Years)", x = "")

# minor league deals
all_free_agents %>%
  filter(sign_salary == 0 & sign_type == "signed") %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(num_minor_league_deals = n()) %>%
  ggplot(aes(offseason, num_minor_league_deals, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Minor-League Free Agent Deals") +
  expand_limits(y = 0) +
  labs(y = "Number of Minor League Free Agent Deals", x = "")
```


relationship between days to sign and salary signed for, by player type and age bucket


```{r, fig.height=3}

length_salary_combined <-
  all_free_agents %>%
  filter(offseason >= 2010) %>%
  filter(!is.na(sign_salary)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(
    avg_salary = mean(sign_salary, na.rm = TRUE),
    avg_days_to_sign = mean(days_to_sign, na.rm = TRUE)
  )

length_salary_combined %>%
  ggplot(aes(offseason, avg_days_to_sign, color = avg_salary, size = avg_salary)) +
  facet_wrap(vars(player_type, age_bucket)) +
  expand_limits(y = 0) +
  scale_color_continuous(limits = c(0, 300), low = "red", high = "green") +
  scale_size_continuous(limits = c(0, 300)) +
  geom_point() +
  fgt +
  guides(color = guide_legend(), size = guide_legend())

length_salary_combined %>%
  group_by(player_type, age_bucket, avg_salary, avg_days_to_sign) %>%
  arrange(offseason) %>%
  mutate(
    salary_diff = avg_salary - lag(avg_salary),
    days_to_sign_diff = avg_days_to_sign - lag(avg_days_to_sign)
  ) %>%
  View()
```


the chunks below are useful but not as much now. the code above, that references mean time to sign, is much more useful as it can be updated daily

```{r}

current_month <- "Feb"

cumulative_sign_plt <-
  all_free_agents %>%
  group_by(offseason) %>%
  mutate(
    total_available_fas = n(), # get total available FA's in each offseason
    total_war_available = sum(three_year_war, na.rm = TRUE)
  ) %>% # get total WAR available in the offseason
  filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
  group_by(offseason, total_available_fas, total_war_available, sign_month) %>%
  summarize(
    num_signings = n(),
    war_signed = sum(three_year_war)
  ) %>%
  complete(offseason, sign_month, fill = list(num_signings = 0, war_signed = 0)) %>% # zero-pad months where no FA's were signed
  group_by(offseason) %>%
  arrange(offseason, sign_month) %>%
  mutate(
    percent_signed_this_month = 100 * (num_signings / total_available_fas),
    total_signings = cumsum(num_signings),
    signed_perc = 100 * (total_signings / total_available_fas),
    war_perc = 100 * (cumsum(war_signed) / total_war_available)
  )

cumulative_sign_plt %>%
  filter(sign_month < current_month) %>%
  mutate(label = ifelse(offseason %in% c(1985, 2018, 2017, 2004, 2016, 1994) &
    sign_month == max(sign_month),
  offseason, NA_character_
  )) %>%
  ggplot(aes(
    x = sign_month, y = signed_perc, color = offseason,
    group = offseason
  )) +
  geom_point() +
  geom_line() +
  labs(x = "", y = "% of FA's Signed", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  ggtitle("Free Agent Signing Progress, Visualized",
    subtitle = "% of free agents signed by month, through January of each year"
  ) +
  geom_label_repel(aes(label = label),
    nudge_x = 100,
    na.rm = TRUE
  ) +
  fgt +
  guides(color = guide_legend(ncol = 3)) +
  theme(legend.position = "none")

# ggplotly(cumulative_sign_plt)
```

```{r}
cumulative_sign_plt %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  mutate(offseason = as.numeric(offseason)) %>%
  ggplot(aes(offseason, signed_perc)) +
  geom_point() +
  geom_line() +
  ggtitle("Free Agent Signings",
    subtitle = "% of free agents signed through January of each offseason"
  ) +
  labs(x = "Offseason", y = "% of FA's Signed", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  fgt +
  theme(legend.position = "none")

# same plot as above, but with age buckets visualized
# doesn't work right now

# cumulative_sign_plt <-
#   all_free_agents %>%
#   group_by(offseason) %>%
#   mutate(
#     total_available_fas = n(), # get total available FA's in each offseason
#     total_war_available = sum(three_year_war, na.rm = TRUE)
#   ) %>% # get total WAR available in the offseason
#   filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
#   group_by(offseason, total_available_fas, total_war_available, sign_month) %>%
#   summarize(
#     num_signings = n(),
#     war_signed = sum(three_year_war)
#   ) %>%
#   complete(offseason, sign_month, fill = list(num_signings = 0, war_signed = 0)) %>% # zero-pad months where no FA's were signed
#   group_by(offseason) %>%
#   arrange(offseason, sign_month) %>%
#   mutate(
#     percent_signed_this_month = 100 * (num_signings / total_available_fas),
#     total_signings = cumsum(num_signings),
#     signed_perc = 100 * (total_signings / total_available_fas),
#     war_perc = 100 * (cumsum(war_signed) / total_war_available)
#   )

cumulative_sign_plt %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  mutate(offseason = as.numeric(offseason)) %>%
  ggplot(aes(offseason, war_perc)) +
  geom_point() +
  geom_line() +
  ggtitle("Free Agent Talent",
    subtitle = "% of free agents WAR3 signed through January of each offseason"
  ) +
  labs(x = "Offseason", y = "% of FA's Signed", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  fgt +
  theme(legend.position = "none")
```

```{r}

cumulative_sign_plt %>%
  ungroup() %>%
  gather(metric, value, signed_perc, war_perc) %>%
  mutate(
    metric = str_replace_all(metric, c(
      "signed_perc" = "% of Free Agents Signed",
      "war_perc" = "% of Free Agent Trailing 3-Year WAR Signed"
    )),
    offseason = as.numeric(offseason)
  ) %>%
  filter(sign_month == "Jan") %>%
  ggplot(aes(offseason, value)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(metric), scales = "free_y") +
  fgt +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  ggtitle("Trends in Free Agent Signing, through Janauary") +
  labs(x = "Offseason", y = "%", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com")
```


temporal distribution of signing %, over time

```{r, fig.height=7, fig.width=5}
cumulative_sign_plt %>%
  ungroup() %>%
  mutate(offseason = factor(offseason)) %>%
  ggplot(aes(x = sign_month, y = offseason, group = offseason, height = percent_signed_this_month)) +
  geom_density_ridges2(scale = 5, stat = "identity")
```



```{r, fig.height = 3}


fa_types_annual <-
  all_free_agents %>%
  group_by(offseason, player_type) %>%
  summarize(total_available_fas = n()) %>%
  complete(offseason,
    player_type = c("Scrub", "Role Player", "Solid Starter", "Good Player", "All-Star", "Superstar", "MVP"),
    fill = list(total_available_fas = 0)
  )

sign_type_plt <-
  all_free_agents %>%
  filter(sign_type == "signed") %>%
  group_by(offseason, sign_month, player_type) %>%
  summarize(num_signed = n()) %>%
  ungroup() %>%
  complete(offseason, sign_month, player_type, fill = list(num_signed = 0)) %>%
  left_join(fa_types_annual, by = c("offseason", "player_type")) %>%
  mutate(percent_signed = 100 * (num_signed / total_available_fas)) %>%
  group_by(offseason, player_type) %>%
  arrange(sign_month) %>%
  mutate(
    cume_signed = cumsum(num_signed),
    cume_percent_signed = 100 * (cume_signed / total_available_fas)
  )

sign_type_plt %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  mutate(
    offseason = as.numeric(offseason),
    player_type = factor(player_type, levels = c("Scrub", "Role Player", "Solid Starter", "Good Player", "All-Star", "Superstar", "MVP"))
  ) %>%
  ggplot(aes(offseason, cume_percent_signed)) +
  geom_point() +
  geom_line() +
  ggtitle("The Free Agency Decline has Hit All but the Very Best Players",
    subtitle = "% of free agents signed through January"
  ) +
  labs(
    x = "Offseason", y = "% of FA's Signed",
    caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com"
  ) +
  fgt +
  facet_wrap(vars(player_type)) +
  geom_smooth(method = "loess", linetype = "dashed", se = FALSE, lwd = 0.7)
```



same as above, only split out by age bucket
```{r, fig.height=3}
fa_types_annual_age_buckets <-
  all_free_agents %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(total_available_fas = n()) %>%
  ungroup() %>%
  complete(offseason,
    player_type,
    age_bucket,
    fill = list(total_available_fas = 0)
  )

sign_type_plt_ages <-
  all_free_agents %>%
  filter(sign_type == "signed") %>%
  group_by(offseason, sign_month, player_type, age_bucket) %>%
  summarize(num_signed = n()) %>%
  ungroup() %>%
  complete(offseason, sign_month, player_type, age_bucket, fill = list(num_signed = 0)) %>%
  left_join(fa_types_annual_age_buckets, by = c("offseason", "player_type", "age_bucket")) %>%
  mutate(percent_signed = 100 * (num_signed / total_available_fas)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  arrange(sign_month) %>%
  mutate(
    cume_signed = cumsum(num_signed),
    cume_percent_signed = 100 * (cume_signed / total_available_fas)
  )

sign_type_plt_ages %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  ggplot(aes(offseason, cume_percent_signed, color = age_bucket)) +
  geom_point() +
  geom_line() +
  ggtitle("The Free Agency Decline has Hit All but the Very Best Players",
    subtitle = "% of free agents signed through January"
  ) +
  labs(
    x = "Offseason", y = "% of FA's Signed",
    caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com"
  ) +
  fgt +
  facet_wrap(vars(player_type), scales = "free_y")
```





debugging is below

```{r}


# TODO: verify month by month signing ounts for 2017, 2018, and 1994
# this will be my final verification

all_free_agents %>%
  group_by(offseason) %>%
  mutate(total_available_fas = n()) %>% # get total available FA's in each offseason
  filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
  group_by(offseason, total_available_fas, sign_month) %>%
  summarize(num_signings = n()) %>%
  arrange(offseason, sign_month) %>%
  mutate(
    cume_fas_signed = cumsum(num_signings),
    cume_signed_perc = 100 * (cume_fas_signed / total_available_fas)
  ) %>%
  filter(offseason == 2017) %>%
  arrange(cume_signed_perc)
```
