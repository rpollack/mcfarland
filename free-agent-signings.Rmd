


```{r}
library(tidyverse)
library(lubridate)
library(rvest)
library(ggrepel)
library(plotly)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )


```

```{r}
get_free_agents <- function(url){
signed_fas <- url %>%
  read_html() %>%
  html_node("table#fa_signings")

# return empty tibble if no table was found
tryCatch(html_table(signed_fas, header = TRUE),
         error = function(e){
           tibble()
           }
         )  
}

get_unsigned_batters <- function(url){
unsigned_bat <- url %>%
  read_html() %>%
  html_nodes(xpath = "//comment()") %>%
  html_text() %>%
  paste(collapse = '') %>%
  read_html() %>%
  html_node('table#fa_batting') 

# return empty tibble if no table was found
tryCatch(html_table(unsigned_bat, header = TRUE),
         error = function(e){
           tibble()
           }
         )
}

get_unsigned_pitchers <- function(url) {
unsigned_pit <- url %>%
  read_html() %>%
  html_nodes(xpath = "//comment()") %>%
  html_text() %>%
  paste(collapse = '') %>%
  read_html() %>%
  html_node('table#fa_pitching')

# return empty tibble if no table was found
tryCatch(html_table(unsigned_pit, header = TRUE),
         error = function(e){
           tibble()
           }
         )
}
```


### get data

```{r}
start_year <- 1976
current_year <- 2018


years <- tibble(year = start_year:current_year) %>%
  mutate(url = paste0("https://www.baseball-reference.com/leagues/MLB/", year, "-free-agents.shtml"))

fa_signings <- years %>%
  group_by(url) %>%
  do(get_free_agents(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, sign_date = Date, three_year_war = `WAR3`) %>%
  mutate(sign_type = "signed") %>%
  arrange(sign_date)

unsigned_batters <- years %>%
  group_by(url) %>%
  do(get_unsigned_batters(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, three_year_war = `WAR3`) %>%
  mutate(sign_type = "unsigned",
         sign_date = NA_character_)

unsigned_pitchers <- years %>%
  group_by(url) %>%
  do(get_unsigned_pitchers(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, three_year_war = `WAR3`) %>%
  mutate(sign_type = "unsigned",
         sign_date = NA_character_)

#check for invalid dates that month() will fail to convert. handle them manually later
invalid_dates <- which( is.na( ymd(as.character(fa_signings$sign_date), tz="UTC") ) )
fa_signings %>% filter(row_number() %in% invalid_dates) %>% View()

```

### clean data

```{r}

fa_signings_clean <- 
  fa_signings %>%
  ungroup() %>%
  #remove transactions w/no valid date attached & for which I can't find info
  filter(!name %in% c("Doug Gwosdz", "Kurt Kepshire", "Bill Scherrer", "Darryl Motley",
                      "Steve Carter", "Guillermo Rodriguez"),
         !str_detect(sign_date, "-00-")) %>%
  
  #some guys have missing sign days, but we care only about the month, so fake it
  mutate(sign_date = ifelse(name == "Jay Baller" & offseason == 1989, "1990-01-01", sign_date),
         sign_date = ifelse(name == "Vic Rodriguez" & offseason == 1987, "1988-01-01", sign_date),
         sign_date = ifelse(name == "Max Venable" & offseason == "1987", "1988-02-01", sign_date),
         sign_date = as.Date(sign_date),
         sign_month = (month(sign_date, label = TRUE)),
         offseason = as.character(offseason),
         
         #re-order the months based on when we perceive the start of FA season to be
         sign_month = factor(sign_month, levels=c("Sep", "Oct", "Nov", "Dec", "Jan", "Feb",
                                                    "Mar", "Apr", "May", "Jun", "Jul", "Aug")))


# combine all tibbles into one, so each offseason has the right signed and unsigned players
# scrub duplicates from the data; i found that, for example, the 2017 offseason has many duplicates entries that inflate
# the real count of free agents

all_free_agents <- 
  bind_rows(fa_signings_clean, unsigned_batters, unsigned_pitchers) %>%
  distinct(name, offseason, age, sign_date, three_year_war, sign_type, sign_month)  # remove duplicate entries; for example, 2017 has a few

```



```{r}

current_month <- "Feb"

cumulative_sign_plt <- 
  all_free_agents %>% 
  group_by(offseason) %>%
  mutate(total_available_fas = n()) %>%  #get total available FA's in each offseason
  filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
  group_by(offseason, total_available_fas, sign_month) %>%
  summarize(num_signings = n()) %>%
  complete(offseason, sign_month, fill = list(num_signings = 0)) %>%  # zero-pad months where no FA's were signed
  filter(sign_month < current_month) %>%
  group_by(offseason) %>%
#  filter(offseason %in% c(1994, 2017, 1985, 2018, 2004)) %>%
  mutate(label = ifelse(offseason %in% c(1985, 2018, 2017, 2004, 2016, 1994) & 
                          sign_month == max(sign_month), 
                        offseason, NA_character_)) %>%
  arrange(offseason, sign_month) %>%
  mutate(signed_perc = 100 * (cumsum(num_signings) / total_available_fas))
    
    
cumulative_sign_plt %>%
  ggplot(aes(x = sign_month, y = signed_perc, color=offseason, 
             group = offseason)) +
  geom_point() + geom_line() +
  labs(x="", y="% of FA's Signed", caption="Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  ggtitle("The slow 2018 offseason, visualized",
          subtitle = "% of free agents signed by month since free agency began") +
  geom_label_repel(aes(label=label),
                       nudge_x = 100,
                       na.rm = TRUE) +
  fgt +
  guides(color=guide_legend(ncol=3)) +
  theme(legend.position = "none")

#ggplotly(cumulative_sign_plt)

```

```{r, fig.height=3}
cumulative_sign_plt %>%
  filter(sign_month == "Jan")  %>%
  ggplot(aes(reorder(offseason, signed_perc), signed_perc)) + 
  geom_col() + coord_flip() +
  ggtitle("% of Free Agents Signed through January") +
  labs(x="", y="% of Free Agents Signed")
```



debugging is below

```{r}
#debugging with the year 2017

# 2017 has 478 total FA"s

# TODO: now that the total count is correct, the next step is to manually verify all per-month signing counts


all_free_agents %>% 
  distinct(name, offseason, age, sign_date, three_year_war, sign_type, sign_month) %>%  # remove duplicate entries; for example, 2017 has a few
  group_by(offseason) %>%
  mutate(total_available_fas = n()) %>%  #get total available FA's in each offseason
  filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
  group_by(offseason, total_available_fas, sign_month) %>%
  summarize(num_signings = n()) %>%
  arrange(offseason, sign_month) %>%
  mutate(cume_fas_signed = cumsum(num_signings),
         cume_signed_perc = 100 * (cume_fas_signed / total_available_fas)) %>%
  filter(offseason == 2018) %>% 
  arrange(cume_signed_perc)
```

