
notes:
* WAR projections are done using FG WAR & Warcels (link).
* missing seasons are filled in with 1 WAR. this includes seasons prior to a player's debut as well as those #missed due to injury/ineffectiveness/whatever.
* players are assigned to the current team they're on. free agents are not assigned to any team.
* FA computations assume all options are picked up. e.g. starlin castro is given 4 years of control even #though he has three years remaining before his $16 team option in 2020.
* for pre-arb years, minimum salary is used: $535k.
* for arb players, MLBTR projections are used for 2017. for future arb years, including Arb-1's, 25%/40%/60% of FA salary is used to project.
* for Arb-4 players, 80% of salary is used to project
* for players with non-arb contracts, salary under control is computed as AAV of contract * number of years #of control
* for position players, only offensive & defensive WAR is counted. for pitchers, only pitching WAR is counted.
* players who are under contract for longer than 5 years are, for the purposes of this exercise, give 5 years of team control. this is because i only projected WAR out for 5 years. contracts that run more than 5 years contain only the first five years of the player's earnings.
* players who haven't reached arbitration yet use the same calculations but with the minimum salary as their base. so Arb 1 would be assuming a raise from the min. salary, etc.


Questions:

- Win Now-iest team in Baseball
- Worst contract in baseball (least surplus over next 5 years)
- Most efficiently-spending teams over next 5 years

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(stringr)
library(plotly)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```

#Define functions to read payroll data from bb-ref.

```{r}
# shared by bill petti in FG slack chat on 11.25.2016
# modified by ryan pollack on 1.3.2017 to get detailed payroll information 

getTeamabbr <- function(year) {
  team_tbl <- read_html(paste0("http://www.baseball-reference.com/leagues/MLB/", year, ".shtml"), stringsAsFactors=FALSE)
  tms <- team_tbl %>%
    html_nodes("table") %>%
    .[[1]] %>%
    html_table() %>%
    dplyr::select(Tm) %>%
    filter(Tm != "LgAvg", 
           Tm != "", 
           Tm != "Tm")
  tms$year <- year
  return(tms)
}

getPayrolls <- function(Tm, team_name) {
  url <- paste0("http://www.baseball-reference.com/teams/", Tm, "/", team_name, "-salaries-and-contracts.shtml")
  tms <- url %>%
    read_html() %>%
    html_nodes("table") %>%
    .[[length(.)]] %>%
    html_table(header=TRUE)
  
  next_year <- 2018
  tms <- tms %>%
    
    #remove unused cells in the 'Name' column
    filter(!Name %in% c("Name","","Arb Costs", "Arb Eligible", "Contract Options", 
                        "Dollars Committed", "Other Costs", "Option Values", "Other Players", 
                        "Payroll (no options)", "Payroll (options)", "Signed")) 
  
  #for each player, create multiple rows, one for each "Year", where "value" is either their salary that year, their arbitration status, or their FA status, or blank if the player won't be on the payroll.
  #the 2017, 2018, 2019, etc. columns are the ones collapsed into the 'value' column. because those are left when the others are unselected (with a minus sign)).
  tms_melt <- gather(tms, key = Year, salary, -Name, -Age, -Yrs, -Acquired, -SrvTm, -Agent, -`Contract Status`)
  tms_melt <- tms_melt %>%
    mutate(salary = ifelse(grepl("FA-\\*", salary) == TRUE, "", salary)) %>% #assume options won't happen
    filter(salary != "") %>%           #remove years where players aren't on a payroll                                   
    mutate(Team = Tm)
}
```

### Get data from FG DB

```{r}

this_year <- 2017
next_year <- this_year + 1

#player ID / Name data from FG. allows distinguishing b/w players with identical names
fg_players <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, TeamId, BirthDate, BISPosition, Position) %>%
  collect(n=Inf)

#projected team for this/next year. allows merging between FG and baseball-reference datasets
fg_projected_teams_batters <- fg_db %>% 
  tbl('proj_batting') %>% 
  filter(Type == "Steamer",
         Season == this_year + 1) %>%
  dplyr::select(PlayerId, Team) %>%
  collect(n=Inf)

fg_projected_teams_pitchers <- fg_db %>% 
  tbl('proj_pitching') %>% 
  filter(Type == "Steamer",
         Season == this_year + 1) %>%
  dplyr::select(PlayerId, Team) %>%
  collect(n=Inf)

#match team abbreviations to those of baseball reference, to allow merging b/w both datasets
fg_projected_teams_all <- bind_rows(fg_projected_teams_batters, fg_projected_teams_pitchers) %>%
  mutate(Team = ifelse(Team == "LAN", "LAD", Team),
         Team = ifelse(Team == "SFN", "SFG", Team),
         Team = ifelse(Team == "CHA", "CHW", Team),
         Team = ifelse(Team == "NYA", "NYY", Team),
         Team = ifelse(Team == "NYN", "NYM", Team),
         Team = ifelse(Team == "SDN", "SDP", Team),
         Team = ifelse(Team == "KCA", "KCR", Team),
         Team = ifelse(Team == "CHN", "CHC", Team),
         Team = ifelse(Team == "SLN", "STL", Team),
         Team = ifelse(Team == "WAS", "WSN", Team),
         Team = ifelse(Team == "TBA", "TAM", Team))

#get batting/fielding stats for position players
fg_bat <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Type == 0) %>%     #get only full-season stats for each player
  dplyr::select(playerid, Season, ValueW) %>%
  collect(n=Inf)

fg_batters <- inner_join(fg_players, fg_bat, by=c("PlayerId" = "playerid")) %>%
  filter(Position != "P",             #don't get batting WAR for pitchers
         BISPosition != "SP",
         BISPosition != "RP") %>%
  dplyr::select(PlayerId, FirstName, LastName, Season, BirthDate, ValueW, Position, TeamId)

#get pitching stats for pitchers
fg_pitch <- fg_db %>%
  tbl("stats_pitching") %>%
  filter(Type == 0) %>%
  dplyr::select(PlayerId, Season, TeamId, ValueW) %>%
  collect(n=Inf)

fg_pitchers <- inner_join(fg_players, fg_pitch, by="PlayerId") %>%
  filter(BISPosition %in% c("SP", "RP")) %>% #don't get pitching WAR for position players
  dplyr::select(PlayerId, FirstName, LastName, Season, BirthDate, ValueW, Position = BISPosition, 
         TeamId = TeamId.x)
```

### Combine gathered data into one frame and re-format some data

```{r}
all_players <- bind_rows(fg_batters, fg_pitchers)  %>%
  inner_join(fg_projected_teams_all, by="PlayerId") %>%
  select(-TeamId) %>%
  mutate(FullName = sprintf("%s %s", FirstName, LastName),
         birth_date = as.Date(as.POSIXct(BirthDate)),
         birth_year = format(birth_date, "%Y"),
         Team = ifelse(Team == "TAM", "TBR", Team)) %>%
  dplyr::select(PlayerId, Name = FullName, Season, Team, ValueW, birth_year, Position) %>%
  group_by(PlayerId) %>%
  arrange(desc(Season)) %>%
  filter(row_number() <= 3)   # only need the most recent 3 years of each player, for projection purposes
```

### Figure out a rough relationship between WAR and Arb-1 salaries, for the purposes of estimating Arb-1 salaries for other players. This section only needs to be run once.

```{r, echo=FALSE, eval=FALSE}

find_cumulative_war_through_year <- function(name, year){
  #search both batter & pitcher data frames for the player and return their cumulative
  #fWAR through the given year. this tactic works because each player appears in only one data frame.
  
  fname <- str_split(name, " ", simplify = TRUE, n=2)[1]
  lname <- str_split(name, " ", simplify = TRUE, n=2)[2]

  batter_search <- fg_batters %>%
    filter(FirstName == fname,
           LastName == lname,
           Season >= (year -4),   #restrict year floor to ensure we're getting the player we want
           Season < year)
  
  pitcher_search <- fg_pitchers %>%
    filter(FirstName == fname,
           LastName == lname,
           Season >= (year -4),
           Season < year)
  
  search_space <- bind_rows(batter_search, pitcher_search)
  
  return(sum(search_space$ValueW))
}
find_cumulative_war_through_year <- Vectorize(find_cumulative_war_through_year)

#arbitration data from MLBTR datafiles
arb_2016 <- read_tsv("arbitration-2016.txt")
arb_2016 <- arb_2016 %>%
  dplyr::select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2016)

arb_2015 <- read_tsv("arbitration-2015.txt")
arb_2015 <- arb_2015 %>%
  dplyr::select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2015)

arb_2014 <- read_tsv("arbitration-2014.txt")
arb_2014 <- arb_2014 %>%
  dplyr::select(Name, Team, SrvTm, SettledAmt) %>%
  filter(SettledAmt != "Extension") %>%
  mutate(Year = 2014)

all_arb <- bind_rows(arb_2015, arb_2016, arb_2014) %>%
  filter(SrvTm >= 2,
         SrvTm <= 3.9) %>%  #make sure I catch first-year arbs only
  select(-SrvTm)

all_arb$SettledAmt <- gsub("\\$", "", all_arb$SettledAmt)
all_arb$SettledAmt <- gsub("MM", "", all_arb$SettledAmt)
all_arb$SettledAmt <- as.double(all_arb$SettledAmt)

all_arb <- all_arb %>%
  mutate(war_at_signing = find_cumulative_war_through_year(Name, Year),
         predicted_arb = 1.36881 + (.26896 * war_at_signing))  #based on linear model of Arb-1 ~ WAR
```

### Project WAR each year for the next 5 years for each player
Methodology: http://tangotiger.com/index.php/site/article/war-marcels-...-warcels

Ideal DF:
PlayerId | Name | Team | Season | WAR | Salary | Surplus Value

```{r}

# project five-year WAR for all players, then gather into tidy DF

projected_war <- all_players %>%
  group_by(PlayerId, Name) %>%
  arrange(Season) %>%
  mutate(age_now = this_year - as.integer(birth_year),
         age_next_year = age_now + 1, 
         age_in_two_years = age_now + 2,
         age_in_three_years = age_now + 3,
         age_in_four_years = age_now + 4,
         `2017` = ifelse(is.na(ValueW) == FALSE, ValueW, 1),  #players w/o appearances in a season get 1 WAR for that year
         `2016` = ifelse(is.na(lag(ValueW)) == FALSE, lag(ValueW), 1),
         `2015` = ifelse(is.na(lag(ValueW, 2)) == FALSE, lag(ValueW, 2), 1)) %>%
  filter(Season == 2017) %>%  # this row contains the projections for the next 5 years, which is all we want
  mutate(step1 = (0.6 * `2017`) + (0.3 * `2016`) + (0.1 * `2015`),
         step2 = 0.8 * step1,
         `2018` = round(ifelse(Position == "SP" | Position == "RP", 
                               step2 + ((26 - age_now) * 0.1),
                               step2 + ((30 - age_now) * 0.1)), 1),
         `2019` = round(ifelse(Position == "SP" | Position == "RP", 
                               `2018` - 0.4,
                               `2018` - 0.4 + ((30-age_next_year) * .08)), 1),
         `2020` = round(ifelse(Position == "SP" | Position == "RP", 
                               `2019` - 0.4,
                               `2019` - 0.4 + ((30-age_in_two_years) * .03)), 1),
         `2021` = round(ifelse(Position == "SP" | Position == "RP",
                               `2020` - 0.4,
                               `2020` - 0.4 + ((30-age_in_three_years) * .03)), 1),
         `2022` = round(ifelse(Position == "SP" | Position == "RP", 
                               `2021` - 0.4,
                               `2021` - 0.4 + ((30-age_in_four_years) * .03)), 1)) %>% 
  dplyr::dplyr::select(PlayerId, Name, Team, birth_year, Position, `2018`, `2019`, `2020`, `2021`, `2022`) %>%
  gather(Season, ValueW, contains("20")) %>%
  mutate(Season = as.integer(Season)) %>%
  dplyr::dplyr::select(PlayerId, Name, Season, Team, ValueW, birth_year, Position)

```

### Get payroll information

```{r}
teamAbbr <- getTeamabbr(2017)

teamAbbr <- teamAbbr %>%
  arrange(Tm) %>%
  
  #some mutations to construct valid URLs for baseball-reference
  mutate(Tm = ifelse(Tm == "LAA", "ANA",
                     ifelse(Tm =="MIA", "FLA",
                            ifelse(Tm == "TBR", "TBD", Tm))),
         team_name = c("arizona-diamondbacks", "atlanta-braves", "baltimore-orioles", "boston-red-sox",
                       "chicago-cubs", "chicago-white-sox", "cincinnati-reds", "cleveland-indians",
                       "colorado-rockies", "detroit-tigers", "houston-astros", "kansas-city-royals",
                       "los-angeles-angels", "los-angeles-dodgers", "miami-marlins",
                       "milwaukee-brewers", "minnesota-twins", "new-york-mets", "new-york-yankees",
                       "oakland-athletics", "philadelphia-phillies", "pittsburgh-pirates",
                       "san-diego-padres", "seattle-mariners", "san-francisco-giants", 
                       "st-louis-cardinals", "tampa-bay-rays", "texas-rangers", "toronto-blue-jays",
                       "washington-nationals"))

all_teams_payroll <- teamAbbr %>% 
  group_by(Tm) %>%
  do(getPayrolls(.$Tm, .$team_name)) %>%
  dplyr::select(Team = Tm, Name, Age, Year, salary) %>%
  group_by(Name, Team) %>%
  top_n(-5, wt=Year) %>%  # take only up to the next 5 years because that's all we can project out with WARcels
  ungroup() %>%
  
  #put common abbreviations back in place
  mutate(Team = ifelse(Team == "ANA", "LAA",
                     ifelse(Team =="FLA", "MIA",
                            ifelse(Team == "TBD", "TBR", Team))))
```

```{r}

# extract salary from payroll information
# identify arb years that bb-ref didn't, so we can compute salary later
# combine payroll info with projected WAR. the resulting DF has one row per player per year of control
# FA's are omitted, as are years a player isn't under control
# TODO: Account for inflation
# TODO: Arb salaries seem high. Kris BRyant for $80M? in warcels 

millions_per_war <- 9

master_list <-
  all_teams_payroll %>%
  mutate(
    Season = as.numeric(Year),
    salary = ifelse(grepl("M", salary), as.double(str_extract(salary, "(?<=\\$)[:digit:]+\\.*[:digit:]*")), salary),
    salary = ifelse(grepl("k", salary), as.double(str_extract(salary, "(?<=\\$)[:digit:]+")) / 1000, salary),
    salary = ifelse(grepl("Pre-Arb", salary), 0.545, salary),
    
    # identify super two players (those w/4 years of arbitration)
    super_two = ifelse(Name %in% c(
      #2014 players: http://m.mlb.com/news/article/101257198/mlb-and-mlbpa-finalize-list-of-super-two-players/
      "Collin Cowgill", "Anthony Bass", "Alex Presley", "Martin Maldonado", "Shane Robinson", "Hector Sanchez", "Zach Britton",
      "Joe Wieland", "Vance Worley", "Jared Hughes", "Drew Smyly", "Louis Coleman", "Casy Fien", "Tommy Milone", "Kevin Gausman",
      #2015 players: https://www.mlbtraderumors.com/2015/10/list-of-2016-super-two-qualifiers.html
      "Dan Jennings", "George Kontos", "Justin Grimm", "Arodys Vizcaino", "Avisail Garcia", "Jurickson Profar", "Jedd Gyorko",
      "Juan Lagares", "Didi Gregorius", "Erasmo Ramirez", "Chris Archer", "Nolan Arenado", "Will Smith", "Jean Machi", "Seth Maness",
      "Scott Van Slyke", "David Lough", "Chris Hatcher", "Evan Scribner", "Nick Tepesch",
      "Zach Putnam", "Chris Withrow", "Kole Calhoun", "Jeff Manship", "Anthony Rendon",
      #2016 players: https://www.mlbtraderumors.com/2016/10/projected-super-two-cutoff-2016.html
      "George Springer", "Danny Salazar", "Matt Shoemaker", "Sam Dyson", "Marcus Stroman", "David Peralta", "Rougned Odor",
      "Kevin Kiermaier", "Brett Oberholtzer", "Ehire Adrianza",
      #baseball-reference lists several players as arb-eligible 4 times despite no official word on their status. I'll trust BB-ref here.
      "Addison Russell", "Cam Bedrosian", "Carlos Rodon", "Corey Knebel", "Felipe Rivero", "Hunter Strickland", "Kris Bryant",
      "Maikel Franco", "Michael Lorenzen", "Mike Foltynewicz", "Odrisamer Despaigne", "Austin Hedges", "Carlos Estevez",
      "Dario Alvarez", "Elias Diaz", "Jose Ramirez", "Justin Nicolino", "Mac Williamson", "Matt Boyd",
      "Michael Fulmer", "Nick Goody", "Tim Adleman", "Tyler Naquin",
      # 2017: https://www.mlbtraderumors.com/2017/10/projected-arbitration-salaries-for-2018.html
      "Andrew Heaney", "J.C. Ramirez", "Lance McCullers", "Dominic Leone", "Mike Foltynewicz", "Cory Knebel", "Kris Bryant",
      "Addison Russell", "Hunter Strickland", "Noah Syndergaard", "Matt Szczur", "Maikel Franco", "Felipe Rivero",
      "Michael Lorenzen", "Zach Rosscup", "Yolmer Sanchez", "Chasen Shreve"),
      TRUE, FALSE)) %>%
  group_by(Name) %>%
  arrange(Year) %>%
  mutate(
    salary = ifelse(super_two & salary == "Arb",
                    ifelse(lead(salary) == "FA",
                           "Arb-4",
                           ifelse(lead(salary, 2) == "FA",
                                  "Arb-3",
                                  ifelse(lead(salary, 3) == "FA",
                                         "Arb-2",
                                         ifelse(lead(salary, 4) == "FA", "Arb-1", salary)))),
                    salary),
    salary = ifelse(!super_two & salary == "Arb",
                    ifelse(lead(salary) == "FA",
                           "Arb-3",
                           ifelse(lead(salary, 2) == "FA",
                                  "Arb-2",
                                  ifelse(lead(salary, 3) == "FA", 
                                         "Arb-1", 
                                         salary))),
                    salary),
    # not all players with "Arb" listed have an FA year attached. no way to know which Arb year it is. so force it based on spotrac data
    # and occasionally bb-ref data
    salary = ifelse(Name == "Blake Treinen" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Blake Treinen" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Chris Martin" & Year == 2021, "Arb-1", salary),
    salary = ifelse(Name == "Chris Martin" & Year == 2022, "Arb-2", salary),
    salary = ifelse(Name == "Ehire Adrianza" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Ehire Adrianza" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Erisbel Arruebarrena" & Year == 2021, "Arb-1", salary),
    salary = ifelse(Name == "Erisbel Arruebarrena" & Year == 2022, "Arb-2", salary),
    salary = ifelse(Name == "Hansel Robles" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Hansel Robles" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Jacob deGrom" & Year == 2019, "Arb-3", salary),
    salary = ifelse(Name == "Jacob deGrom" & Year == 2020, "Arb-4", salary),
    salary = ifelse(Name == "Jake Smolinski" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Jake Smolinski" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Jorge Soler" & Year == 2021, "FA", salary),  #spotrac 
    salary = ifelse(Name == "Josh Phegley" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Josh Phegley" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Kendall Graveman" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Kendall Graveman" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Lance McCullers" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Lance McCullers" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Lance McCullers" & Year == 2021, "Arb-4", salary),
    salary = ifelse(Name == "Marcus Semien" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Marcus Semien" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Miles Mikolas" & Year == 2020, "Arb-1", salary),
    salary = ifelse(Name == "Miles Mikolas" & Year == 2021, "Arb-2", salary),
    salary = ifelse(Name == "Miles Mikolas" & Year == 2022, "Arb-3", salary),
    salary = ifelse(Name == "Noah Syndergaard" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Noah Syndergaard" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Robbie Grossman" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Robbie Grossman" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Rusney Castillo" & Year == 2021, "FA", salary),  #spotrac
    salary = ifelse(Name == "Rusney Castillo" & Year == 2022, "FA", salary),  #spotrac
    salary = ifelse(Name == "Trevor May" & Year == 2019, "Arb-2", salary),
    salary = ifelse(Name == "Trevor May" & Year == 2020, "Arb-3", salary),
    salary = ifelse(Name == "Yuli Gurriel" & Year == 2021, "FA", salary) #spotrac
  ) %>%
  filter(!salary %in% c("FA", "$0 [Arb-*]", 0)) %>%  # discard FA years and weird option years
  inner_join(projected_war, by=c("Name", "Team", "Season")) %>%
  dplyr::select(PlayerId, Name, Team, Position, Season, WAR = ValueW, Salary = salary) %>%
  group_by(PlayerId, Name) %>%
  mutate( #project arb-1 salaries, then use that to project future arb years
    Salary = ifelse(Salary == "Arb-1", 1.36881 + (.26896 * (cumsum(WAR))), Salary)) %>% # use linear model i computed elsewhere in this doc
  ungroup() %>%
  arrange(PlayerId, Name, Season) %>%
  mutate(
    Salary = ifelse(Salary == "Arb-2", (as.double(lag(Salary)) / .25) * .4, Salary),
    Salary = ifelse(Salary == "Arb-3", (as.double(lag(Salary)) / .4) * .6, Salary),
    Salary = ifelse(Salary == "Arb-4", (as.double(lag(Salary)) / .6) * .7, Salary),
    Salary = as.numeric(Salary),
    surplus_value = (millions_per_war * WAR) - Salary)

#filter out players with less than 1 WAR under control or whose AAV is over $5 mil
retain <- 
  master_list %>%
  group_by(PlayerId, Name, Team) %>%
  summarize(
    controlled_years = n(),
    war_under_control = round(sum(WAR), 1),
    salary_under_control = round(sum(Salary), 1),
    surplue_value_under_control = war_under_control - salary_under_control,
    aav = salary_under_control / controlled_years) %>%
  filter(war_under_control > 0 | aav > 5)

retain %>%
  group_by(Team) %>%
  summarize(total_surplue_value_under_control = sum(surplue_value_under_control)) %>%
  ggplot(aes(Team, total_surplue_value_under_control)) + geom_col() + coord_flip() 
```

    


### Compute surplus salary for each player

```{r}
millions_per_war <- 9

master_full <- master %>%
  mutate(Position = ifelse(Position == "SP", "Rotation",
                           ifelse(Position == "RP", "Bullpen", "Hitter"))) %>%
  #dplyr::select(Name, Team, Position, Year, years_of_control, war_under_control) %>%
  inner_join(payroll_info, by = c("Name", "Team")) %>%
  mutate(aav = round(salary_under_control / years_of_control, 1)) %>%
  filter(war_under_control > 1 | aav > 5)


# join back to master?

warcels <- master_full %>%
  group_by(Name, Team) %>%
  filter(Year == max(Year)) %>%
  mutate(controlled_surplus_value = round((millions_per_war * ((.05 * years_of_control) + 1)) * war_under_control -
           salary_under_control, 1)) %>%
  ungroup() %>%
  mutate(absolute_surplus_value = abs(controlled_surplus_value),
         surplus_value_rank = round(percent_rank(controlled_surplus_value) * 100, 2)) %>%
  select(-Year) %>%
  arrange(desc(controlled_surplus_value))

# save info for analysis next year
warcels %>%
  dplyr::select(Name, Team, years_of_control, Position, war_under_control, salary_under_control,
         controlled_surplus_value, absolute_surplus_value, surplus_value_rank) %>%
  write_csv("warcels-2018.csv")

```


# overall controlled surplus value plot and 2017-2017

```{r, echo = FALSE}
warcels_2018 <-
  warcels %>% 
  group_by(Team) %>% 
  summarize(total_controlled_surplus_value_2018 = sum(controlled_surplus_value))

#changes from 2017
warcels_changes_2017_2018 <- read_csv("warcels-2017.csv") %>%
  group_by(Team) %>%
  summarize(total_controlled_surplus_value_2017 = sum(controlled_surplus_value)) %>%
  inner_join(warcels_2018, by="Team") %>%
  mutate(change_yoy = total_controlled_surplus_value_2018 - total_controlled_surplus_value_2017) %>%
  arrange(desc(change_yoy))

#2018 surplue value graph
warcels_2018 %>%
ggplot(aes(reorder(Team, total_controlled_surplus_value_2018), total_controlled_surplus_value_2018)) +
  geom_col() + coord_flip() +
  labs(x="", y="Controlled Surplus Value (Millions USD)") + 
  ggtitle("Controlled Surplus Value, MLB Teams 2018–2022") + fgt

#YoY change 2017 to 2018
warcels_changes_2017_2018 %>%
  ggplot(aes(reorder(Team, change_yoy), change_yoy)) +
  geom_col() + coord_flip() +
  labs(x="", y="Change in Controlled Surplus Value (Millions USD)") + 
  ggtitle("Change in Controlled Surplus Value, MLB Teams 2017–2018") + fgt

```


```{r}
war_timeline <- master_full %>%
  ungroup() %>%
  dplyr::select(Name, Team, `2018` = war_next, `2019` = war_in_two_years, `2020` = war_in_three_years, 
         `2021` = war_in_four_years, `2022` = war_in_five_years) %>%
  gather(Year, player_WAR, contains("20")) %>% View()
  group_by(Team, Year) %>% View()
  summarize(WAR = sum(player_WAR) / 4) #divide by 4 because i goofed & each player has 4 entries for 1 year

war_time_plt <- ggplot(war_timeline, aes(Year, WAR, color=Team, group=Team)) + geom_point() + geom_line() + fgt +
  scale_color_manual(values = c("#A71930", "#002F5F", "#ED4C09",
                               "#C60C30", "#003279", "#000000", "#C6011F", "#003366",
                               "#000000", "#001742", "#072854", "#15317E", "#B71234",
                               "#083C6B", "#000000", "#182B49", "#072754", "#002C77",
                               "#1C2841", "#003831", "#BA0C2F", "#FDB829", "#002147",
                               "#002147", "#F2552C", "#0C2C56", "#C41E3A", "#00285D",
                               "#BD1021", "#003DA5", "#BA122B"))
war_time_plt

win_tbl <- war_timeline %>%
  mutate(Wins = WAR + 53)



ggplotly(war_time_plt)
```


### Group WAR per Year by Team

```{r}
team_war <- warcels %>%
  group_by(Team) %>%
  summarize(total_war_under_control = sum(war_under_control),
            total_years_of_control = sum(years_of_control),
            avg_war_under_control_pear_year = total_war_under_control / total_years_of_control,
            avg_years_of_control = mean(years_of_control))

ggplot(data=team_war, aes(avg_years_of_control, avg_war_under_control_pear_year, label=Team)) + geom_point() + 
  geom_text(aes(label=Team),hjust=0, vjust=0) + 
  labs(x="avg. years of control (entire team; 5 max)") + 
  ggtitle("MLB Team Control of WAR, 2018 - 2022")
```

### Group results by team & high-level position

```{r}
team_war_by_position <- warcels %>%
  group_by(Team, Position) %>%
  summarize(war_under_control_per_year = sum(war_under_control) / sum(years_of_control),
            years_of_control = round(mean(years_of_control), 2),
            salary_under_control = sum(salary_under_control),
            surplus_value_under_control = sum(controlled_surplus_value))

ggplot(data=team_war_by_position, aes(Team, war_under_control_per_year, fill=Position)) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + coord_flip()
```

### Plot teams' length of control vs. war per year they control

```{r}
ggplot(data=team_war_by_position %>% filter(Position == "Hitter"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (position players only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per year, Position Players")

ggplot(data=team_war_by_position %>% filter(Position == "Rotation"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (rotation only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per year, Rotation")

ggplot(data=team_war_by_position %>% filter(Position == "Bullpen"), aes(years_of_control, war_under_control_per_year, label=Team)) + geom_point() + geom_text(aes(label=Team),hjust=0, vjust=0) + labs(x="avg. years of control (bullpen only; 5 max)") + ggtitle("Avg. Length of Control vs. WAR per Year, Bullpen")
```


