---
title: "MLB Free Agency and Contract Extensions During the 2010's"
author: "Ryan Pollack, ryanpollack.com"
output: 
  html_document: 
    df_print: kable
    toc: yes
---



```{r setup, message = FALSE, warning = FALSE, include = FALSE}

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 8
)
library(tidyverse)
library(lubridate)
library(rvest)
library(glue)
library(tidytext)
library(plotly)
library(RMariaDB)

fgt <- theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color = "black", family = "Lato")
)

# define team colors. taken from warcels.Rmd
team_info <- tibble(
  team_name = c(
    "ARI", "ATL", "BAL", "BOS", "CHC",
    "CHW", "CIN", "CLE", "COL", "DET",
    "HOU", "KCR", "LAA", "LAD", "MIA",
    "MIL", "MIN", "NYM", "NYY", "OAK",
    "PHI", "PIT", "SDP", "SEA", "SFG",
    "STL", "TBR", "TEX", "TOR", "WSN"
  ),
  team_url = c(
    "arizona-diamondbacks", "atlanta-braves", "baltimore-orioles", "boston-red-sox", "chicago-cubs",
    "chicago-white-sox", "cincinnati-reds", "cleveland-indians", "colorado-rockies", "detroit-tigers",
    "houston-astros", "kansas-city-royals", "los-angeles-angels", "los-angeles-dodgers", "miami-marlins",
    "milwaukee-brewers", "minnesota-twins", "new-york-mets", "new-york-yankees", "oakland-athletics",
    "philadelphia-phillies", "pittsburgh-pirates", "san-diego-padres", "seattle-mariners", "san-francisco-giants",
    "st-louis-cardinals", "tampa-bay-rays", "texas-rangers", "toronto-blue-jays", "washington-nationals"
  ),
  team_color = c(
    "#A71930", "#002F5F", "#ED4C09", "#C60C30", "#003279",
    "#000000", "#C6011F", "#003366", "#333366", "#001742",
    "#072854", "#15317E", "#B71234", "#083C6B", "#F9423A",
    "#182B49", "#072754", "#002C77", "#1C2841", "#003831",
    "#BA0C2F", "#FDB829", "#473729", "#005C5C", "#F2552C",
    "#C41E3A", "#9ECEEE", "#BD1021", "#003DA5", "#BA122B"
  ),
  tv_households = c(
    1864420, 2341390, 1084180, 2364870, 3251370 / 2,
    3251370 / 2, 850030, 1399470, 1585270, 177240,
    2423360, 909420, 5276600 / 2, 5276600 / 2, 1697840,
    848420, 1713310, 7100300 / 2, 7100300 / 2, 2414470 / 2,
    2816850, 1108780, 987760, 1854810, 2414470 / 2,
    1164400, 1875420, 2622070, 6896551, 2482480

    # source: https://mediatracks.com/resources/nielsen-dma-rankings-2019/.
    # Toronto taken from https://www.newswire.ca/news-releases/the-fans-have-spoken-sportsnet-is-canadas-1-sports-media-brand-in-2016-609901805.html. Assume ALDS reached max number of people since it was massively popular. 20m canadians at 2.9 canadians per household is 6,896,551 households
  ),
  payroll_opening_day_2018 = c(
    131565116, 118284851, 148574615, 233200429, 183156139,
    71217000, 101357500, 134851566, 136953500, 125286000,
    160393900, 123233317, 166649999, 186220715, 99510143,
    90964571, 128713226, 150558844, 166111632, 65985833,
    95270301, 86340001, 94037733, 157903943, 200505278,
    159698667, 76007496, 133137626, 162037223, 180849056
  )
)

# define color scale used in plots below
team_colors <- team_info$team_color
names(team_colors) <- factor(team_info$team_name)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
get_free_agents <- function(url) {
  signed_fas <- url %>%
    read_html() %>%
    html_node("table#fa_signings")

  # return empty tibble if no table was found
  tryCatch(html_table(signed_fas, header = TRUE),
    error = function(e) {
      tibble()
    }
  )
}

get_unsigned_batters <- function(url) {
  unsigned_bat <- url %>%
    read_html() %>%
    html_nodes(xpath = "//comment()") %>%
    html_text() %>%
    paste(collapse = "") %>%
    read_html() %>%
    html_node("table#fa_batting")

  # return empty tibble if no table was found
  tryCatch(html_table(unsigned_bat, header = TRUE),
    error = function(e) {
      tibble()
    }
  )
}

get_unsigned_pitchers <- function(url) {
  unsigned_pit <- url %>%
    read_html() %>%
    html_nodes(xpath = "//comment()") %>%
    html_text() %>%
    paste(collapse = "") %>%
    read_html() %>%
    html_node("table#fa_pitching")

  # return empty tibble if no table was found
  tryCatch(html_table(unsigned_pit, header = TRUE),
    error = function(e) {
      tibble()
    }
  )
}

get_fa_salaries <- function(year) {
  # read salaries from MLB Trade Rumors trackers
  # ignore players who didn't sign or for whom MLBTR does not know the signing amount
  # convert all salaries to major-league guaranteed millions USD
  # which means minor-league deals count as $0
  url <- str_c("https://www.mlbtraderumors.com/", year, "-mlb-free-agent-tracker/")

  read_html(url) %>%
    html_nodes("table") %>%
    .[[2]] %>%
    html_table(header = FALSE, fill = TRUE) %>%
    as_tibble() %>%
    filter(
      X1 != "Player",
      X5 > 0,
      X6 != "Unknown"
    ) %>%
    dplyr::select(name = X1, sign_years = X5, `Contract Amount` = X6) %>%
    distinct(name, sign_years, `Contract Amount`) %>% # remove duplicate entries
    mutate(
      offseason = year - 1,
      `Contract Amount` = case_when(
        `Contract Amount` == "Minor" ~ 0,
        str_detect(`Contract Amount`, "MM") ~ as.numeric(str_extract(`Contract Amount`, "[:digit:]+\\.{0,1}[:digit:]*")),
        str_detect(`Contract Amount`, "K") ~ as.numeric(str_extract(`Contract Amount`, "[:digit:]+")) / 1000
      )
    )
}

get_international_signings <- function(year) {
  # spotrac.com has international FA signings in a nice clean format. MLBTR has them but also reports extensions which I don't want

  read_html(glue("https://www.spotrac.com/mlb/international/{year}")) %>%
    html_node("table") %>%
    html_table() %>%
    as_tibble() %>%
    filter(Amount != "") %>%
    dplyr::select(name = 1, `To Team` = Team, `Contract Amount` = Amount) %>%
    mutate(
      offseason = year,
      offseason = offseason - 1
    ) # correct for the way spotrac reports its years relative to bb-ref
}
```



```{r get data, message=FALSE, warning=FALSE, include=FALSE}

start_year <- 2010
start_year_salaries <- 2011
current_year <- 2019


years <- tibble(year = start_year:current_year) %>%
  mutate(url = paste0("https://www.baseball-reference.com/leagues/MLB/", year, "-free-agents.shtml"))

fa_signings <-
  years %>%
  group_by(url) %>%
  do(get_free_agents(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, `To Team`, age = Age, sign_date = Date, three_year_war = `WAR3`, AB, G = `G...10`, GS, IP) %>%
  mutate(sign_type = "Domestic Free Agent") %>%
  arrange(sign_date)

unsigned_batters <-
  years %>%
  group_by(url) %>%
  do(get_unsigned_batters(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, three_year_war = `WAR3`, AB) %>%
  mutate(
    sign_type = "Unsigned Domestic Free Agent",
    sign_date = NA_character_,
    GS = NA_character_,
    G = NA_character_,
    IP = 0,
    `To Team` = NA_character_
  )

unsigned_pitchers <- years %>%
  group_by(url) %>%
  do(get_unsigned_pitchers(.$url)) %>%
  mutate(offseason = str_extract(url, "[:digit:]{4}")) %>%
  ungroup() %>%
  dplyr::select(name = Name, offseason, age = Age, three_year_war = `WAR3`, G, GS, IP) %>%
  mutate(
    sign_type = "Unsigned Domestic Free Agent",
    sign_date = NA_character_,
    `To Team` = NA_character_
  )

# check for invalid dates that month() will fail to convert. handle them manually later
# invalid_dates <- which(is.na(ymd(as.character(fa_signings$sign_date), tz = "UTC")))
# fa_signings %>%
#   filter(row_number() %in% invalid_dates) %>%
#   View()

# get FA salaries from MLBTR
# update some names to match formatting from baseball reference
fa_salaries <-
  seq(2011, 2021) %>%
  map_df(get_fa_salaries) %>%
  mutate(name = str_replace_all(name, c(
    "Jorge de la Rosa" = "Jorge De La Rosa",
    "Manual Corpas" = "Manny Corpas",
    "Hong-Chih Kuo" = "Hung-Chih Kuo",
    "Melvin Upton" = "Melvin Upton Jr.",
    "Zach Britton" = "Zack Britton",
    "Michael Dunn" = "Mike Dunn",
    "Michael Fiers" = "Mike Fiers",
    "Jung-ho Kang" = "Jung Ho Kang",
    "Matt Joyce" = "Matthew Joyce",
    "Alejandro de Aza" = "Alejandro De Aza",
    "Norichika Aoki" = "Nori Aoki",
    "Seung-hwan Oh" = "Seunghwan Oh",
    "David Bush" = "Dave Bush",
    "Samuel Deduno" = "Sam Deduno",
    "Johnathon Niese" = "Jon Niese",
    "J.B. Shuck" = "JB Shuck",
    "Chase D'Arnaud" = "Chase d'Arnaud",
    "Daniel Coulombe" = "Danny Coulombe",
    "Nick Castellanos" = "Nicholas Castellanos",
    "A.J. Pollock" = "AJ Pollock",
    "Yoenis Cespedes" = "Yoenis CÃ©spedes",
    "Hyun-Jin Ryu" = "Hyun Jin Ryu"
  ))) %>%
  arrange(desc(`Contract Amount`))

# get international signings $10m or greater from spotrac. baseball-reference doesn't list these and MLBTR mixes them in with extensions.
# $10m is a good indication that the player will hit the majors soon and is of note
intl_fa <-
  seq(2010, 2020) %>%
  map_df(get_international_signings) %>%
  mutate(
    name = str_extract(name, "[A-Z][a-z]*[\\s|-][A-Z][a-z]*(\\s*[A-Z][a-z]*)*"),
    `Contract Amount` = str_remove_all(`Contract Amount`, c(",")),
    `Contract Amount` = str_remove(`Contract Amount`, "\\$"),
    `Contract Amount` = as.numeric(`Contract Amount`)
  ) %>%
  filter(`Contract Amount` >= 10000000) %>%
  mutate(`Contract Amount` = `Contract Amount` / 1000000) %>%

  # clean up some team names and correct some data inaccuracies
  mutate(
    `To Team` = case_when(
      `To Team` == "KC" ~ "KCR",
      `To Team` == "TB" ~ "TBR",
      `To Team` == "SD" ~ "SDP",
      name == "Aledmys Diaz" ~ "STL",
      name == "Jorge Ona" ~ "SDP",
      TRUE ~ `To Team`
    ),

    # some player signings need manual correcting because of the way spotrac lists their signings vs. bb-ref.
    # i've prioritized manually correcting deals at $10m or above
    offseason = case_when(
      name %in% c("Yasiel Puig", "Jorge Soler") ~ 2012,
      name == "Jose Abreu" ~ 2013,
      name == "Rusney Castillo" ~ 2014,
      name %in% c("Yulieski Gurriel", "Alfredo Rodriguez", "Adrian Morejon", "Jorge Ona") ~ 2016,
      name == "Luis Robert" ~ 2017,
      name == "Yoshitomo Tsutsugo" ~ 2019,
      TRUE ~ offseason
    )
  ) %>%

  # manually add int'l signings that were not in the dataset but were at least $10m
  bind_rows(tibble(
    name = c(
      "Yasmany Tomas", "Kenta Maeda", "Eric Thames", "Miles Mikolas", "Byung-ho Park", "Yaisel Sierra", "Alexander Guerrero",
      "Erisbel Arruebarrena"
    ),
    `To Team` = c("ARI", "LAD", "MIL", "STL", "MIN", "LAD", "LAD", "LAD"),
    `Contract Amount` = c(68.5, 25, 16, 15.5, 12.85, 30, 28, 25),
    offseason = c(2014, 2015, 2016, 2017, 2015, 2015, 2013, 2013)
  )) %>%
  mutate(sign_type = "International Free Agent")

# get contract extensions from 2010 onwards
extensions <-
  read_html("https://transactions.mlbtraderumors.com/widget/extension-tracker&link=true&widget=true&EXT_year_constraint=1&EXT_amount_constraint=1&EXT_options_constraint=1&EXT_startDate=01/01/2010") %>%
  html_node("table") %>%
  html_table() %>%
  as_tibble() %>%
  bind_rows(tibble(
    Date = c("7/22/2020", "3/6/2020"),
    Player = c("Mookie Betts", "Christian Yelich"),
    Team = c("LAD", "MIL"),
    Pos = c("RF", "RF"),
    Yrs = c("12", "9"),
    Amt = c("365", "215")
  )) %>%
  mutate(
    Date = mdy(Date),
    offseason = year(Date),
    `To Team` = case_when(
      Team == "ARZ" ~ "ARI",
      Team == "TAM" ~ "TBR",
      Team == "KAN" ~ "KCR",
      Team == "SFO" ~ "SFG",
      Team == "SDG" ~ "SDP",
      Team == "WAS" ~ "WSN",
      Team == "CWS" ~ "CHW",
      Team == "FLA" ~ "MIA",
      TRUE ~ Team
    ),
    name = str_remove_all(Player, "â"),
    `Contract Amount` = round(as.numeric(Amt), 1),
    sign_years = as.character(Yrs),
    sign_month = factor(month(Date, label = TRUE), levels = c(
      "Sep", "Oct", "Nov", "Dec", "Jan", "Feb",
      "Mar", "Apr", "May", "Jun", "Jul", "Aug"
    ), ordered = TRUE)
  ) %>%
  filter(!is.na(Date)) %>%
  dplyr::select(name, offseason, sign_month, sign_date = Date, `To Team`, `Contract Amount`, sign_years) %>%
  mutate(sign_type = "Contract Extension",
         offseason = case_when(
           sign_month %in% c("Jan", "Feb", "Mar") ~ offseason - 1,
           TRUE ~ offseason
         ))

# get team performance info
con <- dbConnect(RMariaDB::MariaDB(), group = "fg_db")
q_team_pct <- dbSendQuery(con, "select Season, AbbName, W, L from season_team
                          where Season >= 2019")
team_performance  <-
  dbFetch(q_team_pct) %>%
  as_tibble() %>%
  group_by(AbbName) %>%
  summarize(`Decade Winning %` = round(sum(W) / (sum(W)+sum(L)), 3))

dbDisconnect(con)
```


```{r clean data, include=FALSE}

fa_signings_clean <-
  fa_signings %>%
  ungroup() %>%
  # remove transactions w/no valid date attached & for which I can't find info
  filter(
    !name %in% c(
      "Doug Gwosdz", "Kurt Kepshire", "Bill Scherrer", "Darryl Motley",
      "Steve Carter", "Guillermo Rodriguez"
    ),
    !str_detect(sign_date, "-00-")
  ) %>%

  # some guys have missing sign days, but we care only about the month, so fake it
  mutate(
    sign_date = ifelse(name == "Jay Baller" & offseason == 1989, "1990-01-01", sign_date),
    sign_date = ifelse(name == "Vic Rodriguez" & offseason == 1987, "1988-01-01", sign_date),
    sign_date = ifelse(name == "Max Venable" & offseason == "1987", "1988-02-01", sign_date),
    sign_date = as.Date(sign_date),
    sign_month = (month(sign_date, label = TRUE)),
    offseason = as.character(offseason),

    # re-order the months based on when we perceive the start of FA season to be
    sign_month = factor(sign_month, levels = c(
      "Sep", "Oct", "Nov", "Dec", "Jan", "Feb",
      "Mar", "Apr", "May", "Jun", "Jul", "Aug"
    )),
    name = str_remove(name, "HOF"),
    name = str_trim(name)
  )

# chagne some data types to match so the rows can be bound together.
unsigned_batters_clean <-
  unsigned_batters %>%
  mutate(
    sign_date = as.Date(sign_date),
    G = as.integer(G),
    GS = as.integer(GS)
  )

unsigned_pitchers_clean <-
  unsigned_pitchers %>%
  mutate(
    sign_date = as.Date(sign_date),
    G = as.integer(G),
    GS = as.integer(GS)
  )


# 1. combine all tibbles into one, so each offseason has the right signed and unsigned players
# 2. scrub duplicates from the data; i found that, for example, the 2017 offseason has many duplicates entries that inflate
# the real count of free agents
# 3. assign a label to each type of player, based on their position and their trailing three-year WAR total
# 4. bucket the player according to their age when they signed
# 5. compute the number of days it took the player to sign, starting from Nov 1st of that year
# 6. match up any salary/signing information i have with the player and the offseason
# 7. add in contract extensions!

all_free_agents <-
  bind_rows(fa_signings_clean, unsigned_batters_clean, unsigned_pitchers_clean) %>%
  distinct() %>% # remove duplicate entries; many years have them
  replace_na(list(AB = 0, GS = 0, G = 0, IP = 0, three_year_war = 0)) %>%
  mutate(
    position = case_when(
      (IP < 10 | AB >= 800) ~ "Position Player", # prevent pos. players with relief appearances from being classified as pitchers #
      # and NL starters with lots of AB from being classified as position players
      GS / G >= 0.5 ~ "Starting Pitcher",
      TRUE ~ "Relief Pitcher"
    ),
    position =
      factor(position, levels = c("Position Player", "Starting Pitcher", "Relief Pitcher")),
    player_type = case_when(
      position %in% c("Starting Pitcher", "Position Player") ~ case_when(
        three_year_war < 1.5 ~ "Scrub",
        three_year_war >= 1.5 & three_year_war < 4.5 ~ "Role Player",
        three_year_war >= 4.5 & three_year_war < 7.5 ~ "Solid Starter",
        three_year_war >= 7.5 & three_year_war < 10.5 ~ "Good Player",
        three_year_war >= 10.5 & three_year_war < 13.5 ~ "All-Star",
        three_year_war >= 13.5 & three_year_war < 16.5 ~ "Superstar",
        three_year_war >= 16.5 ~ "MVP"
      ),
      position == "Relief Pitcher" ~ case_when(
        three_year_war >= 5 ~ "Superstar",
        three_year_war >= 2 ~ "Good Player",
        three_year_war >= 1 ~ "Role Player",
        TRUE ~ "Scrub"
      ),
    ),
    player_type = factor(player_type, levels = c("Scrub", "Role Player", "Solid Starter", "Good Player", "All-Star", "Superstar", "MVP")),
    age_bucket = case_when(
      age <= 27 ~ "<= 27",
      age >= 28 & age <= 30 ~ "28 - 30",
      age >= 31 & age <= 33 ~ "31 - 33",
      age >= 34 & age <= 36 ~ "34 - 36",
      age >= 37 & age <= 39 ~ "37 - 39",
      age >= 40 & age <= 42 ~ "40 - 42",
      age >= 43 ~ "43+"
    ),
    age_bucket = factor(age_bucket, levels = c("<= 27", "28 - 30", "31 - 33", "34 - 36", "37 - 39", "40 - 42", "43+")),
    offseason = as.integer(offseason),
    days_to_sign = as.period(interval(
      ymd(str_c(offseason, "11", "01", sep = "-")),
      sign_date
    )) %/% days(1),
  ) %>%
  left_join(fa_salaries, by = c("name", "offseason")) %>%
  bind_rows(intl_fa, extensions) %>%

  # adjust for inflation relative to 2020 source: https://www.usinflationcalculator.com
  mutate(
    `Contract Amount` = case_when(
      year(sign_date) == 2010 ~ `Contract Amount` * 1.182,
      year(sign_date) == 2011 ~ `Contract Amount` * 1.146,
      year(sign_date) == 2012 ~ `Contract Amount` * 1.123,
      year(sign_date) == 2013 ~ `Contract Amount` * 1.107,
      year(sign_date) == 2014 ~ `Contract Amount` * 1.089,
      year(sign_date) == 2015 ~ `Contract Amount` * 1.088,
      year(sign_date) == 2016 ~ `Contract Amount` * 1.074,
      year(sign_date) == 2017 ~ `Contract Amount` * 1.052,
      year(sign_date) == 2018 ~ `Contract Amount` * 1.027,
      year(sign_date) == 2019 ~ `Contract Amount` * 1.008,
      TRUE ~ `Contract Amount` # catch-all for the current year AND if I forget to update the chart above
    ),
    `Contract Amount` = round(`Contract Amount`, 1),
    sign_years = as.numeric(sign_years),
    sign_years = if_else(`Contract Amount` == 0, 0, sign_years) # if player signs minor league deal, make it a 0-length deal so it'll bring down the avg
  ) %>%
  mutate(to_team = case_when(
    `To Team` == "Arizona Diamondbacks" ~ "ARI",
    `To Team` == "Atlanta Braves" ~ "ATL",
    `To Team` == "Baltimore Orioles" ~ "BAL",
    `To Team` == "Boston Red Sox" ~ "BOS",
    `To Team` == "Chicago Cubs" ~ "CHC",
    `To Team` == "Chicago White Sox" ~ "CHW",
    `To Team` == "Cincinnati Reds" ~ "CIN",
    `To Team` == "Cleveland Indians" ~ "CLE",
    `To Team` == "Colorado Rockies" ~ "COL",
    `To Team` == "Detroit Tigers" ~ "DET",
    `To Team` == "Houston Astros" ~ "HOU",
    `To Team` == "Kansas City Royals" ~ "KCR",
    str_detect(`To Team`, "Los Angeles Angels") ~ "LAA",
    `To Team` == "Los Angeles Dodgers" ~ "LAD",
    str_detect(`To Team`, "Marlins") ~ "MIA",
    `To Team` == "Milwaukee Brewers" ~ "MIL",
    `To Team` == "Minnesota Twins" ~ "MIN",
    `To Team` == "New York Mets" ~ "NYM",
    `To Team` == "New York Yankees" ~ "NYY",
    `To Team` == "Oakland Athletics" ~ "OAK",
    `To Team` == "Philadelphia Phillies" ~ "PHI",
    `To Team` == "Pittsburgh Pirates" ~ "PIT",
    `To Team` == "San Diego Padres" ~ "SDP",
    `To Team` == "San Francisco Giants" ~ "SFG",
    `To Team` == "Seattle Mariners" ~ "SEA",
    `To Team` == "St. Louis Cardinals" ~ "STL",
    `To Team` == "Tampa Bay Rays" ~ "TBR",
    `To Team` == "Texas Rangers" ~ "TEX",
    `To Team` == "Toronto Blue Jays" ~ "TOR",
    `To Team` == "Washington Nationals" ~ "WSN",
    name == "Greg Dobbs" & offseason == 2011 ~ "MIA",
    TRUE ~ `To Team`
  )) %>%
  dplyr::select(-GS, -G, -AB, IP, -`To Team`) %>%
  bind_rows(tibble(
    name = c("Ted Lilly", "Clayton Kershaw"),
    offseason = c(2010, 2018),
    `Contract Amount` = c(33, 93),
    to_team = c("LAD", "LAD"),
    sign_type = "Domestic Free Agent"
  ))



# run this code to identify salary amounts i don't have in the master list.
# they should all be extensions, qualifying offers, or americans who signed from a foreign league. BB-Ref lists neither of these.
# i catch foreign-signed americans in intl_fa
# fa_salaries %>% mutate(offseason = as.double(offseason), sign_years = as.double(sign_years)) %>% anti_join(all_free_agents, by=c("name", "offseason")) %>% arrange(desc(`Contract Amount`)) %>% View()
```

# Introduction

This document contains interactive plots that analyze MLB team free agent and extension spending during the 2010-2019 seasons. 

# Data
The data come from three sources:

*   Free agent signing data, such as who was a free agent and when they signed the contract, comes from the ever-reliable [Baseball-Reference](http://www.baseball-reference.com).
*   Domestic free agent contract information (salaries) comes from [MLB Trade Rumors](http://www.mlbtraderumors.com).   
*   Contract extension information also comes from MLBTR.
*   International free agent contract information comes from [Spotrac](http://www.spotrac.com).

I adjusted all salaries to 2020 dollars using www.usinflationcalculator.com. 

What's included:

* All domestic free agents who signed MLB contracts that are in the above sources
* All contract extensions given out that are tracked in the above sources
* International free agents who signed for \$10m or more. Spotrac groups its data differently than MLBTR and Baseball-Reference, so I had to prioritize which contracts I'd manually inspect. Signings of \$10m or above are the ones that generate the most headlines and portend an appearance in MLB soon.

What's not included:

* Qualifying offers
* Option years
* International free agent signings under \$10m
* Anything I missed, which is likely something given I had to combine information from three data sources and manually add several deals in :-)

Also note that opt-outs are not handled well. For example Yoenis CÃ©spedes signed a three-year deal with the Mets during the 2015 offseason. The following winter he opted out of it and signed a four-year deal with the team. The plot below counts all seven years towards the Mets' total expenditures, even though that's not correct.  

With that out of the way, let's get to the graphs!

# Free Agency

## Spending by Team over Time

First up is a timeline of free agent spending for each team. Hover over a bullet point to see the total salary for that offseason, each player signed, and their salary. Remember all totals are adjusted for inflation.

```{r echo=FALSE, message=FALSE, warning=FALSE}

fa_signing_plt <-
  all_free_agents %>%
  filter(
    sign_type %in% c("Domestic Free Agent", "International Free Agent"), !is.na(`Contract Amount`), `Contract Amount` != 0,
    offseason >= 2010
  ) %>%
  mutate(
    player_salary = glue("{name} - ${round(`Contract Amount`,1)}m"),
    offseason = as.character(offseason)
  ) %>%
  group_by(offseason, to_team) %>%
  arrange(desc(`Contract Amount`)) %>%
  summarize(
    num_players_signed = n(),
    total_salary = round(sum(`Contract Amount`, na.rm = TRUE), 1),
    players_signed = paste(player_salary, collapse = "\n")
  ) %>%
  ungroup() %>%
  complete(offseason, to_team, fill = list(num_players_signed = 0, total_salary = 0, players_signed = "No one")) %>%
  ggplot(aes(offseason, total_salary, group = 1, label = players_signed, fill = to_team, color = to_team)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(to_team)) +
  scale_x_discrete(breaks = c("2010", "2015", "2019")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ggtitle("MLB Free Agent Spending, 2010â2019 Offseasons") +
  labs(x = "Offseason", y = "FA Contracts Signed (USD Million)") +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  fgt +
  theme(legend.position = "none")

ggplotly(fa_signing_plt, tooltip = c("offseason", "total_salary", "players_signed"))
```


## Total Spending by Team

Which teams spent the most and least in free agency during the decade? The ones you'd expect!

Hover over a team's bar to see the total salary given out and the number of players signed.

```{r, echo = FALSE, message=FALSE, warning=FALSE}
# by team for the entire decade
fa_signing_plot_total <-
  all_free_agents %>%
  filter(sign_type %in% c("Domestic Free Agent", "International Free Agent"), !is.na(`Contract Amount`), `Contract Amount` != 0) %>%
  mutate(
    player_salary = glue("{name} - ${round(`Contract Amount`,1)}m"),
    offseason = as.character(offseason)
  ) %>%
  group_by(to_team) %>%
  arrange(desc(`Contract Amount`)) %>%
  summarize(
    num_players_signed = n(),
    total_salary = round(sum(`Contract Amount`, na.rm = TRUE), 1),
    players_signed = paste(player_salary, collapse = "\n")
  ) %>%
  ggplot(aes(reorder(to_team, total_salary), total_salary, fill = to_team, label = num_players_signed)) +
  geom_col() +
  theme(legend.position = "none") +
  coord_flip() +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  fgt +
  labs(x = "", y = "Total FA Contracts Signed (USD Millions)") +
  ggtitle("Cumulative MLB Free Agent Spending by Team, 2010-2019 Offseasons")

ggplotly(fa_signing_plot_total, tooltip = c("to_team", "num_players_signed", "total_salary"))
```

## 25 Largest Contracts of the Decade

Now for the players' viewpoint. There are almost 5,000 signees in the decade, way too many to list here, so I'm showing just the 25 largest contracts handed out:

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Top 25 signings of the decade
top_signings_plt <-
  all_free_agents %>%
  filter(sign_type %in% c("Domestic Free Agent", "International Free Agent"), !is.na(`Contract Amount`), `Contract Amount` != 0) %>%
  mutate(player_label = glue("{name} - {offseason} - {to_team}")) %>%
  top_n(25, wt = `Contract Amount`) %>%
  ggplot(aes(reorder(player_label, `Contract Amount`), `Contract Amount`, label = player_label)) +
  geom_col() +
  coord_flip() +
  labs(x = "", y = "Contract Salary (USD Millions)") +
  ggtitle("MLB Top 25 Free Agent Contracts, 2010-2019", subtitle = "Adjusted to 2020 dollars") +
  fgt

ggplotly(top_signings_plt, tooltip = c("player_label", "Contract Amount"))
```


## 5 Largest Free Agent Contracts per Team

The following graph shows the top 5 contracts given out per team during this timeframe.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height = 20}
fa_team_plt <-
  all_free_agents %>%
  filter(
    sign_type %in% c("Domestic Free Agent", "International Free Agent"), !is.na(`Contract Amount`), `Contract Amount` != 0,
    offseason >= 2010
  ) %>%
  mutate(sign_label = glue("{name} - {offseason}")) %>%
  group_by(to_team) %>%
  top_n(5, wt = `Contract Amount`) %>%
  ggplot(aes(reorder_within(sign_label, `Contract Amount`, to_team), `Contract Amount`, fill = to_team)) +
  geom_col() +
  facet_wrap(vars(to_team), scales = "free_y", ncol = 2) +
  coord_flip() +
  scale_x_discrete(labels = function(x) gsub("__.+$", "", x)) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  fgt +
  theme(
    legend.position = "none"
  ) +
  labs(x = "", y = "Contract Amount (USD Millions)") +
  ggtitle("MLB Free Agents - Top 5 Contracts Per Team")

ggplotly(fa_team_plt, tooltip = "Contract Amount")
```

## Signing Time Trends

During the 2017 and 2018 offseasons, many people noticed that free agents were taking longer to sign. The following graph shows the median number of days elapsed between November 1st of each offseason and the day a player signed.

```{r echo=FALSE}

# median time to sign, by offseason. using median since most years are skewed left or right
all_free_agents %>%
  group_by(offseason) %>%
  summarize(median_sign_days = median(days_to_sign, na.rm = TRUE)) %>%
  ggplot(aes(offseason, median_sign_days)) +
  geom_point() +
  geom_line() +
  expand_limits(y = 0) +
  fgt +
  labs(
    y = "Median # of Days 
       between Nov 1st and Contract Signing", x = "Offseason",
    caption = "Source: Baseball Reference"
  ) +
  scale_x_continuous(breaks = seq(start_year, current_year)) +
  ggtitle("Offseason vs. Median Time to Sign Contract",
    subtitle = "Free Agents through March 2020"
  )
```

What we noticed in 2017 and 2018 was the result of a trend that started during the 2016 offseason. And although I saw fewer stories about a stagnant free agent market during the 2019 offseason, this graph shows it's still a long way from where we used to be.

### Signing Time Trends, by Player Type

Not all players are created equal. I was interested in how the different calibers of players experienced the slowdown. To do this I categorized each player according to their role (position player, starting pitcher, or reliever) and the rWAR they accumulated in their walk year and the two years prior.

You can hover over the data points to see players' names; others don't work because the list of players is too long.

```{r echo=FALSE, message=FALSE, warning=FALSE}

# mean time to sign by player talent type, by year
sign_time_plt_talent <-
  all_free_agents %>%
  filter(
    offseason >= 2010,
    sign_type == "Domestic Free Agent",
    !is.na(player_type)
  ) %>%
  group_by(offseason, player_type) %>%
  arrange(desc(name)) %>%
  summarize(
    median_sign_days = median(days_to_sign, na.rm = TRUE),
    player_names = paste(name, collapse = "\n")
  ) %>%
  complete(offseason, player_type) %>%
  ggplot(aes(offseason, median_sign_days, text = player_names, group = 1)) +
  facet_wrap(vars(player_type)) +
  geom_point() +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Speed by Player Talent Level",
    subtitle = "Median number of days between Nov 1st and player's sign date"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year)) +
  labs(x = "Offseason", y = "Median Days to Sign")

ggplotly(sign_time_plt_talent)
```

The Cold Stove of the 2017 offseason affected all kinds of players. But it affected Role Players, All Stars, and Superstars the most. I think that's why the baseball community felt so shocked. Guys we thought would get deals in December, no-brainers who'd had great runs and seemed primed to sign, waited far longer than we'd been used to.

### Signing Time Trends, by Age Group

MLB's youth movement is well-documented. Younger players save teams money, provide cost certainty, offer more freedom with respect to minor league options, and in some cases out-produce older players. So I broke the signing time trends down by age bucket. Note that not all players have this data available.

```{r echo=FALSE, message=FALSE, warning=FALSE}
age_type_plt <-
  all_free_agents %>%
  filter(
    !is.na(age_bucket),
    offseason >= 2010,
    sign_type %in% c("Domestic Free Agent", "International Free Agent")
  ) %>%
  mutate(age_group = case_when(
    age_bucket %in% c("<= 27", "28 - 30") ~ "30 and under",
    TRUE ~ "31_and_over"
  )) %>%
  group_by(offseason, age_group) %>%
  arrange(name) %>%
  summarize(
    median_days_to_sign = median(days_to_sign, na.rm = TRUE),
    players = paste(name, collapse = "\n")
  ) %>%
  ggplot(aes(as.character(offseason), median_days_to_sign, color = age_group, group = age_group, label = players)) +
  fgt +
  geom_point() +
  geom_line() +
  labs(x = "Offseason", y = "Median Days to Sign, since Nov 1st") +
  ggtitle("Median Time to Sign by Age Group")

ggplotly(age_type_plt)
```

Older players have always taken about 10â15 days longer to sign than the spring chickens. But in 2017, the typical older player waited more than 20 days longer to sign than they did in 2016, while players 30 and under waited just 10 days longer. 

### Signing Time Trends, By Month by Offseason

Let's take one more look at the slowdown. The following graph shows the number of players who signed in each month for each offseason in the decade.

```{r echo=FALSE}
all_free_agents %>%
  filter(sign_type == "Domestic Free Agent", player_type != "Scrub", days_to_sign >= 0) %>%
  distinct() %>%
  group_by(offseason, sign_month) %>%
  summarize(
    num_players = n(),
    players = (paste(name, collapse = "\n"))
  ) %>%
  ggplot(aes(sign_month, num_players, label = players)) +
  geom_col(stat = "identity") +
  facet_grid(vars(offseason)) +
  labs(
    y = "Number of Players Signed", x = "Month Signed",
    caption = "Source: Baseball-Reference. Made with Plotly in R"
  ) +
  ggtitle("Month when Free Agent Signed vs. Number of Players Signed", )
```
You can see the slowdown beginning in the 2015 and 2016 offseasons but really take off in the two years afterward.

# Contract Extensions

Now let's look at the sport's other big expenditures: contract extensions. Because of how extensions work I had to choose which 'offseason' to put them in. I settled on this rubric: Extensions signed in January, February, or March are attributed to the previous calendar year's offseason. Extensions signed in any later months are attributed to that current 'offseason'.

For example:

* Mike Trout signed his (second) contract extension in March 2019. I attributed this to the 2018 offseason.
* Joey Votto signed his contract extension in April 2012. I attributed this to the 2012 offseason.

## Contract Extensions by Team Over Time

```{r echo=FALSE, message=FALSE, warning=FALSE}
extension_plt <-
  all_free_agents %>%
  filter(
    sign_type == "Contract Extension",
    offseason <= 2019
  ) %>%
  mutate(label = glue("{name} - ${`Contract Amount`}m")) %>%
  group_by(to_team, offseason) %>%
  arrange(desc(`Contract Amount`)) %>%
  summarize(
    total_salary = round(sum(`Contract Amount`), 1),
    players = paste(label, collapse = "\n")
  ) %>%
  mutate(offseason = as.character(offseason)) %>%
  ungroup() %>%
  complete(to_team, offseason, fill = list(total_salary = 0, players = "No one")) %>%
  ggplot(aes(offseason, total_salary, group = 1, label = players, color = to_team)) +
  geom_point() +
  geom_line() +
  labs(x = "Season", y = "Total Extentions (Millions USD)") +
  facet_wrap(vars(to_team)) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
  ) +
  scale_x_discrete(breaks = c("2010", "2015", "2019")) +
  ggtitle("MLB Contract Extensions by Team, 2010-2019 OffSeasons") + fgt

ggplotly(extension_plt, tooltip = c("offseason", "total_salary", "players"))
```

## Top 25 Contract Extensions


```{r echo=FALSE, message=FALSE, warning=FALSE}

# Top 25 signings of the decade
top_extensions_plt <-
  all_free_agents %>%
  filter(
    sign_type == "Contract Extension",
    offseason <= 2019
  ) %>%
  mutate(player_label = glue("{name} - {offseason} - {to_team}")) %>%
  top_n(25, wt = `Contract Amount`) %>%
  ggplot(aes(reorder(player_label, `Contract Amount`), `Contract Amount`, label = player_label)) +
  geom_col() +
  coord_flip() +
  labs(x = "", y = "Contract Salary (USD Millions)") +
  ggtitle("MLB Top 25 Contract Extensions, 2010-2019", subtitle = "Adjusted to 2020 dollars") +
  fgt

ggplotly(top_extensions_plt, tooltip = c("player_label", "Contract Amount"))
```

## Top 5 Contract Extensions per Team

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height = 20}
top_5_extension_plt <-
  all_free_agents %>%
  filter(
    sign_type == "Contract Extension",
    offseason >= 2010, offseason <= 2019
  ) %>%
  mutate(sign_label = glue("{name} - {offseason}")) %>%
  group_by(to_team) %>%
  top_n(5, wt = `Contract Amount`) %>%
  ggplot(aes(reorder_within(sign_label, `Contract Amount`, to_team), `Contract Amount`, fill = to_team, label = age)) +
  geom_col() +
  facet_wrap(vars(to_team), scales = "free_y", ncol = 2) +
  coord_flip() +
  scale_x_discrete(labels = function(x) gsub("__.+$", "", x)) +
  scale_color_manual(values = team_colors) +
  scale_fill_manual(values = team_colors) +
  fgt +
  theme(
    legend.position = "none"
  ) +
  labs(x = "", y = "Contract Amount (USD Millions)") +
  ggtitle("MLB Contract Extensions - Top 5 Contracts Per Team, 2010-2019")

ggplotly(top_5_extension_plt, tooltip = "Contract Amount")

```

# Total Expenditure

## In Aggregate

The following graph shows each team's approach to free agency and contract extensions over the past decade. Note that international free agent signings are omitted. 

I also show the team's winning percentage during the years 2010-2019. This means the data doesn't include 2020 which means any correlation to 2019 offseason spending won't be visible. But the point isn't to show correlation, just to be informative.

The color gradient and size of each point turns from red to green as the winning percentage increases, so you can scan the graph to find interesting teams.

Hover over a point to see which team it is.

```{r echo=FALSE, message=FALSE, warning=FALSE}
cumulative_spend_plt <-
  all_free_agents %>%
  filter(
    sign_type %in% c("Domestic Free Agent", "Contract Extension"),
    !is.na(to_team),
    to_team != ""
  ) %>%
  group_by(to_team, sign_type) %>%
  summarize(total = sum(`Contract Amount`, na.rm = TRUE)) %>%
  pivot_wider(names_from = sign_type, values_from = total) %>%
  inner_join(team_performance, by = c("to_team" = "AbbName")) %>%
  mutate(Information = glue("Team: {to_team}
                            Free Agent Spending: ${`Domestic Free Agent`}m
                            Extension Spending: ${`Contract Extension`}m
                            Decade Winning %: {`Decade Winning %`}")) %>%
  ggplot(aes(`Domestic Free Agent`, `Contract Extension`, color = `Decade Winning %`, size = `Decade Winning %`, text = Information)) +
  geom_point() +
  # geom_text(aes(label = to_team)) +
  labs(x = "Free Agent Spending (USD Millions)", y = "Contract Extension Spending (USD Millions)",
       caption = "Winning% is for the 2010 - 2019 seasons") +
  ggtitle("Free Agent vs. Contract Extension Spending, MLB Teams 2010-2019 Offseasons") +
  fgt +
  # scale_color_manual(values = team_colors) +
  scale_color_gradient2(low = "red", high = "green", mid = "yellow", midpoint = 0.5)
# theme(legend.position = "none")

ggplotly(cumulative_spend_plt, tooltip = "Information")
```

## Over Time

The next graph shows the same info as above, only over time, and with international free agency added back in. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
cume_plt <-
  all_free_agents %>%
  filter(sign_type %in% c("Domestic Free Agent", "International Free Agent", "Contract Extension"),
         offseason >= 2010, offseason <= 2019,
         !is.na(to_team),
         to_team != "") %>%
  group_by(offseason, to_team, sign_type) %>%
  arrange(name) %>%
  summarize(
    total_spending = sum(`Contract Amount`, na.rm = TRUE),
    players = paste(name, collapse = "\n")
  ) %>%
  ungroup() %>%
  complete(offseason, to_team, sign_type, fill = list(total_spending = 0)) %>% 
  ggplot(aes(as.character(offseason), total_spending, group = sign_type, fill = sign_type, label = players)) +
  geom_area() +
  facet_wrap(vars(to_team)) +
  scale_x_discrete(breaks = c("2010", "2015", "2019")) + fgt +
  ggtitle("Offseason vs. Total Contracts Given by Type, by Team 2010-2019") +
  labs(x="Offseason", y="Total Spending (USD Millions)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))


ggplotly(cume_plt, tooltip = c("offseason", "group", "players"))
```






```{r eval=FALSE, fig.height=4, fig.width=5, include=FALSE}

# add one more facet: the player's age bucket


# mean time to sign by player type and age bucket, by year
fa_diff <-
  all_free_agents %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(mean_days_to_sign = round(mean(days_to_sign, na.rm = TRUE), 1))

# position players' time to sign
fa_diff %>%
  filter(
    offseason >= 2010,
    position == "Position Player"
  ) %>%
  ggplot(aes(offseason, mean_days_to_sign, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Mean Days to Sign FA Contract",
    subtitle = "Position Players"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))

# starters' time to sign
fa_diff %>%
  filter(
    offseason >= 2010,
    position == "Starting Pitcher"
  ) %>%
  ggplot(aes(offseason, mean_days_to_sign, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Mean Days to Sign FA Contract by Player Type",
    subtitle = "Starting Pitchers"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))

# relievers' time to sign
fa_diff %>%
  filter(
    offseason >= 2010,
    position == "Relief Pitcher"
  ) %>%
  ggplot(aes(offseason, mean_days_to_sign, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Mean Days to Sign FA Contract by Player Type",
    subtitle = "Relievers"
  ) +
  fgt +
  expand_limits(y = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_x_continuous(breaks = seq(start_year, current_year))
```

```{r eval=FALSE, fig.height=3, include=FALSE}

# find the largest year-to-year changes in mean days to sign, by player type by age bucket
# ignore multi-year intervals as fans don't perceive those as much; we remember the previous offseason mostly
# also ignore 1993-1994 and 1994-1995 as 1994 was a strike year
differences <-
  fa_diff %>%
  filter(offseason %in% c(2017, 2018)) %>%
  group_by(position, player_type, age_bucket) %>%
  arrange(offseason) %>%
  mutate(
    from_to = str_c(dplyr::lag(offseason), offseason, sep = " - "),
    diff_mean_days_to_sign = mean_days_to_sign - dplyr::lag(mean_days_to_sign)
  ) %>%
  filter(
    !is.na(diff_mean_days_to_sign)
  ) %>%
  arrange(diff_mean_days_to_sign) %>%
  dplyr::select(from_to, position, player_type, age_bucket, diff_mean_days_to_sign)

money_differences <-
  all_free_agents %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(median_signing_salary = round(median(`Contract Amount`, na.rm = TRUE), 1)) %>%
  filter(offseason %in% c(2019, 2018)) %>%
  group_by(position, player_type, age_bucket) %>%
  arrange(offseason) %>%
  mutate(
    from_to = str_c(dplyr::lag(offseason), offseason, sep = " - "),
    diff_median_`Contract Amount` = median_signing_salary - dplyr::lag(median_signing_salary)
  ) %>%
  filter(
    !is.na(diff_median_`Contract Amount`)
  ) %>%
  arrange(desc(diff_median_`Contract Amount`)) %>%
  dplyr::select(from_to, position, player_type, age_bucket, diff_median_`Contract Amount`) %>%
  inner_join(differences, by = c("from_to", "position", "player_type", "age_bucket"))

# graph each group and its year-to-year change in zscore of time to sign and avg contract value. label points of interest
money_differences %>%
  ungroup() %>%
  # mutate(label = glue("{position}, {player_type}, {age_bucket}")) %>%
  mutate(label = case_when(
    (position == "Position Player" & player_type == "All-Star" & age_bucket == "28 - 30") |
      (position == "Position Player" & player_type == "Superstar" & age_bucket == "31 - 33") |
      (position == "Relief Pitcher" & player_type == "Good Player" & age_bucket == "31 - 33") |
      (position == "Position Player" & player_type == "Good Player" & age_bucket == "28 - 30") |
      (position == "Starting Pitcher" & player_type == "Role Player" & age_bucket == "37 - 39") |
      (position == "Starting Pitcher" & player_type == "Solid Starter" & age_bucket == "28 - 30")
    ~ glue("{position}
                                  {player_type}
                                  {age_bucket}"),
    TRUE ~ NA_character_
  )) %>%
  ggplot(aes(diff_mean_days_to_sign, diff_median_`Contract Amount`)) +
  geom_point() +
  geom_label_repel(aes(label = label),
    na.rm = TRUE,
    show.legend = FALSE,
    segment.color = "black",
    nudge_y = -2
  ) +
  theme(legend.position = "none") +
  fgt +
  # xlim(-3, 3) + ylim(-3, 3) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_vline(xintercept = 0, color = "gray") +
  labs(x = "Difference in Mean Days to Sign", y = "Difference in Median Contract Amount (Millions USD)") +
  ggtitle("Difference in Median Contract Amount vs. Difference in Mean Time to Sign Contract",
    subtitle = "Free Agents, 2018 vs. 2017"
  )

differences_model <- lm(diff_median_`Contract Amount` ~ diff_mean_days_to_sign,
  data = money_differences
)
```

```{r eval=FALSE, fig.height=3, include=FALSE}
# for offseasons 2016 - 2018, find average time to sign and avg $ signed for for position players
# only ployt groups where all 3 years are represented with data
position_player_diff <-
  all_free_agents %>%
  filter(
    offseason %in% c(2016, 2017, 2018),
    position == "Position Player",
    sign_type == "Domestic Free Agent"
  ) %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(
    mean_days_to_sign = mean(days_to_sign, na.rm = TRUE),
    median_contract_value = median(`Contract Amount`, na.rm = TRUE)
  ) %>%
  group_by(position, player_type, age_bucket) %>%
  filter((!is.na(mean_days_to_sign) & !is.na(median_contract_value))) %>%
  filter(n() == 3)

ggplot(position_player_diff, aes(factor(offseason), mean_days_to_sign, group = player_type)) +
  facet_wrap(vars(player_type, age_bucket)) +
  geom_point(aes(size = median_contract_value)) +
  geom_line() +
  ggtitle("Offseason vs. Average Time to Sign Contract and Median Contract Value",
    subtitle = "Free Agent Position Players by Talent Level and Age at Signing, 2016 - 2018"
  ) +
  labs(
    x = "Offseason", y = "Avg. # of Days 
       between Nov 1st and Contract Signing", size = "Median Contract Value ($MM)",
    caption = "Sources: Baseball Reference, MLB Trade Rumors"
  ) +
  expand_limits((y <- 0))

# starting pitchers
starting_pitcher_diff <-
  all_free_agents %>%
  filter(
    offseason %in% c(2016, 2017, 2018),
    position == "Starting Pitcher",
    sign_type == "Domestic Free Agent"
  ) %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(
    mean_days_to_sign = mean(days_to_sign, na.rm = TRUE),
    median_contract_value = median(`Contract Amount`, na.rm = TRUE)
  ) %>%
  group_by(position, player_type, age_bucket) %>%
  filter((!is.na(mean_days_to_sign) & !is.na(median_contract_value))) %>%
  filter(n() == 3)

ggplot(starting_pitcher_diff, aes(factor(offseason), mean_days_to_sign, group = player_type)) +
  facet_wrap(vars(player_type, age_bucket)) +
  geom_point(aes(size = median_contract_value)) +
  geom_line() +
  ggtitle("Offseason vs. Average Time to Sign Contract and Median Contract Value",
    subtitle = "Free Agent Starting Pitchers by Talent Level and Age at Signing, 2016 - 2018"
  ) +
  labs(
    x = "Offseason", y = "Avg. # of Days 
       between Nov 1st and Contract Signing", size = "Median Contract Value ($MM)",
    caption = "Sources: Baseball Reference, MLB Trade Rumors"
  ) +
  expand_limits((y <- 0))

# relief pitchers
relief_pitcher_diff <-
  all_free_agents %>%
  filter(
    offseason %in% c(2016, 2017, 2018),
    position == "Relief Pitcher",
    sign_type == "Domestic Free Agent"
  ) %>%
  group_by(offseason, position, player_type, age_bucket) %>%
  summarize(
    mean_days_to_sign = mean(days_to_sign, na.rm = TRUE),
    median_contract_value = median(`Contract Amount`, na.rm = TRUE)
  ) %>%
  group_by(position, player_type, age_bucket) %>%
  filter((!is.na(mean_days_to_sign) & !is.na(median_contract_value))) %>%
  filter(n() == 3)

ggplot(relief_pitcher_diff, aes(factor(offseason), mean_days_to_sign, group = player_type)) +
  facet_wrap(vars(player_type, age_bucket)) +
  geom_point(aes(size = median_contract_value)) +
  geom_line() +
  ggtitle("Offseason vs. Average Time to Sign Contract and Median Contract Value",
    subtitle = "Free Agent Relievers by Talent Level and Age at Signing, 2016 - 2018"
  ) +
  labs(
    x = "Offseason", y = "Avg. # of Days 
       between Nov 1st and Contract Signing", size = "Median Contract Value ($MM)",
    caption = "Sources: Baseball Reference, MLB Trade Rumors"
  ) +
  expand_limits((y <- 0))
```

```{r eval=FALSE, fig.height=3, include=FALSE}
everyone <-
  bind_rows(position_player_diff, starting_pitcher_diff, relief_pitcher_diff) %>%
  arrange(offseason) %>%
  group_by(position, player_type, age_bucket) %>%
  arrange(offseason, .by_group = TRUE) %>%
  mutate(
    days_to_sign_diff = mean_days_to_sign - lag(mean_days_to_sign),
    contract_diff = median_contract_value - lag(median_contract_value)
  ) %>%
  filter(offseason != 2016) %>%
  unite(label, position, player_type, age_bucket, sep = ", ") %>%
  mutate(
    time_direction = case_when(
      days_to_sign_diff > 0 ~ "Waited Longer",
      days_to_sign_diff <= 0 ~ "Waited the Same\nor Shorter"
    ),
    money_direction = case_when(
      contract_diff >= 0 ~ "Received the Same\nor More Money",
      contract_diff < 0 ~ "Received Less Money"
    )
  )

# who was harmed the most in 2017?

everyone %>%
  mutate(g_label = case_when(
    label %in% c(
      "Position Player, All-Star, 31 - 33",
      "Position Player, Good Player, 28 - 30",
      "Starting Pitcher, Solid Starter, 28 - 30"
    ) ~ label,
    TRUE ~ NA_character_
  )) %>%
  ggplot(aes(days_to_sign_diff, contract_diff)) +
  geom_point() +
  fgt +
  labs(
    x = "Difference in Average Time to Sign Contract (Days)",
    y = "Difference in Median Contract Value ($M)"
  ) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_vline(xintercept = 0, color = "gray") +
  ggtitle("Difference in Average Signing Time vs. Difference in Median Contract Value",
    subtitle = "Free Agents, Offseason vs. the Year Prior"
  ) +
  facet_wrap(vars(offseason)) +
  geom_label_repel(aes(label = g_label),
    na.rm = TRUE,
    force = 5,
    nudge_y = -2
  )
```

```{r eval=FALSE, include=FALSE}
everyone %>%
  count(offseason, time_direction, money_direction) %>%
  ggplot(aes(time_direction, n, fill = money_direction)) +
  geom_col(position = "stack") +
  facet_grid(vars(offseason)) +
  coord_flip() +
  fgt +
  labs(x = "Length of Wait Compared to Prior Offseason", y = "Number of Player Groups", fill = "Money Received\nCompared to Prior Offseason") +
  ggtitle("Length of Wait and Contract Amount vs. Prior Offseason",
    subtitle = "Free Agents, 2017 and 2018 Offseasons"
  )

```


```{r eval=FALSE, fig.height=3, include=FALSE}
money_differences %>%
  ungroup() %>%
  mutate(label = glue("{position}, {player_type}, Age {age_bucket}")) %>%
  ggplot(aes(reorder(label, -diff_mean_days_to_sign), diff_mean_days_to_sign)) +
  geom_col() +
  coord_flip() +
  fgt +
  labs(
    x = "",
    y = "Difference in Average Days Elapsed Before Signing Free Agent Contract",
    caption = "Source: Baseball-Reference"
  ) +
  ggtitle("Difference in Time Elapsed between November 1st and Signing a Contract",
    subtitle = "Free Agents, 2018 vs. 2017"
  )

money_differences %>%
  ungroup() %>%
  mutate(label = glue("{position}, {player_type}, Age {age_bucket}")) %>%
  ggplot(aes(reorder(label, -diff_median_`Contract Amount`), diff_median_`Contract Amount`)) +
  geom_col() +
  coord_flip() +
  fgt +
  labs(x = "", y = "Difference in Median FA Contract Value (Millions USD), 2018 vs. 2017") +
  ggtitle("The Typical Free Agent Took Home Less in 2018 than in 2017")
```

```{r eval=FALSE, fig.height=5, fig.width=6, include=FALSE}
all_free_agents %>%
  ungroup() %>%
  mutate(label = glue("{position}, {player_type}, Age {age_bucket}")) %>%
  ggplot(aes(`Contract Amount`)) +
  geom_histogram() +
  facet_wrap(vars(label))

all_free_agents %>%
  ggplot(aes(offseason, days_to_sign, group = offseason, color = age_bucket)) +
  geom_boxplot(outlier.size = 0.5, na.rm = TRUE) +
  facet_wrap(vars(player_type, age_bucket)) +
  fgt
```


```{r eval=FALSE, include=FALSE}




all_free_agents %>%
  filter(!is.na(`Contract Amount`)) %>%
  group_by(offseason) %>%
  summarize(
    avg_signing = round(mean(`Contract Amount`, na.rm = TRUE), 1),
    median_signing = round(median(`Contract Amount`, na.rm = TRUE), 1)
  ) %>%
  ggplot(aes(offseason, median_signing, group = 1)) +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Money", subtitle = "Adjusted for Inflation") +
  expand_limits(y = 0) +
  labs(y = "Median Signing Salary (Millions USD)", x = "Offseason") +
  fgt

# mean $ signed for, by player type by age bucket, over time
all_free_agents %>%
  filter(!is.na(`Contract Amount`)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(avg_signing = round(mean(`Contract Amount`, na.rm = TRUE), 1)) %>%
  ggplot(aes(offseason, avg_signing, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Signing Money") +
  expand_limits(y = 0) +
  labs(y = "Average Signing Salary (Millions USD, Inflation-Adjusted to 2018)", x = "")

# contract length
all_free_agents %>%
  filter(!is.na(`Contract Amount`)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(length_of_avg_contract = round(mean(sign_years, na.rm = TRUE), 1)) %>%
  ggplot(aes(offseason, length_of_avg_contract, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Free Agent Contract Length") +
  expand_limits(y = 0) +
  labs(y = "Length of Average Contract (Years)", x = "")

# minor league deals
all_free_agents %>%
  filter(`Contract Amount` == 0 & sign_type == "Domestic Free Agent") %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(num_minor_league_deals = n()) %>%
  ggplot(aes(offseason, num_minor_league_deals, group = 1, color = age_bucket)) +
  facet_wrap(vars(player_type, age_bucket), scales = "free_y") +
  geom_point(size = 0.7) +
  geom_line() +
  ggtitle("Trends in Minor-League Free Agent Deals") +
  expand_limits(y = 0) +
  labs(y = "Number of Minor League Free Agent Deals", x = "")
```




```{r eval=FALSE, fig.height=3, include=FALSE}

# relationship between days to sign and salary signed for, by player type and age bucket


length_salary_combined <-
  all_free_agents %>%
  filter(offseason >= 2010) %>%
  filter(!is.na(`Contract Amount`)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(
    avg_salary = mean(`Contract Amount`, na.rm = TRUE),
    avg_days_to_sign = mean(days_to_sign, na.rm = TRUE)
  )

length_salary_combined %>%
  ggplot(aes(offseason, avg_days_to_sign, color = avg_salary, size = avg_salary)) +
  facet_wrap(vars(player_type, age_bucket)) +
  expand_limits(y = 0) +
  scale_color_continuous(limits = c(0, 300), low = "red", high = "green") +
  scale_size_continuous(limits = c(0, 300)) +
  geom_point() +
  fgt +
  guides(color = guide_legend(), size = guide_legend())

length_salary_combined %>%
  group_by(player_type, age_bucket, avg_salary, avg_days_to_sign) %>%
  arrange(offseason) %>%
  mutate(
    salary_diff = avg_salary - lag(avg_salary),
    days_to_sign_diff = avg_days_to_sign - lag(avg_days_to_sign)
  )
```



```{r eval=FALSE, include=FALSE}

# the chunks below are useful but not as much now. the code above, that references mean time to sign, is much more useful as it can be updated daily


current_month <- "Feb"

cumulative_sign_plt <-
  all_free_agents %>%
  group_by(offseason) %>%
  mutate(
    total_available_fas = n(), # get total available FA's in each offseason
    total_war_available = sum(three_year_war, na.rm = TRUE)
  ) %>% # get total WAR available in the offseason
  filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
  group_by(offseason, total_available_fas, total_war_available, sign_month) %>%
  summarize(
    num_signings = n(),
    war_signed = sum(three_year_war)
  ) %>%
  complete(offseason, sign_month, fill = list(num_signings = 0, war_signed = 0)) %>% # zero-pad months where no FA's were signed
  group_by(offseason) %>%
  arrange(offseason, sign_month) %>%
  mutate(
    percent_signed_this_month = 100 * (num_signings / total_available_fas),
    total_signings = cumsum(num_signings),
    signed_perc = 100 * (total_signings / total_available_fas),
    war_perc = 100 * (cumsum(war_signed) / total_war_available)
  )

cumulative_sign_plt %>%
  filter(sign_month < current_month) %>%
  mutate(label = ifelse(offseason %in% c(1985, 2018, 2017, 2004, 2016, 1994) &
    sign_month == max(sign_month),
  offseason, NA_character_
  )) %>%
  ggplot(aes(
    x = sign_month, y = signed_perc, color = offseason,
    group = offseason
  )) +
  geom_point() +
  geom_line() +
  labs(x = "", y = "% of FA's Signed", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  ggtitle("Free Agent Signing Progress, Visualized",
    subtitle = "% of free agents signed by month, through January of each year"
  ) +
  geom_label_repel(aes(label = label),
    nudge_x = 100,
    na.rm = TRUE
  ) +
  fgt +
  guides(color = guide_legend(ncol = 3)) +
  theme(legend.position = "none")

# ggplotly(cumulative_sign_plt)
```

```{r eval=FALSE, include=FALSE}
cumulative_sign_plt %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  mutate(offseason = as.numeric(offseason)) %>%
  ggplot(aes(offseason, signed_perc)) +
  geom_point() +
  geom_line() +
  ggtitle("Free Agent Signings",
    subtitle = "% of free agents signed through January of each offseason"
  ) +
  labs(x = "Offseason", y = "% of FA's Signed", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  fgt +
  theme(legend.position = "none")

# same plot as above, but with age buckets visualized
# doesn't work right now

# cumulative_sign_plt <-
#   all_free_agents %>%
#   group_by(offseason) %>%
#   mutate(
#     total_available_fas = n(), # get total available FA's in each offseason
#     total_war_available = sum(three_year_war, na.rm = TRUE)
#   ) %>% # get total WAR available in the offseason
#   filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
#   group_by(offseason, total_available_fas, total_war_available, sign_month) %>%
#   summarize(
#     num_signings = n(),
#     war_signed = sum(three_year_war)
#   ) %>%
#   complete(offseason, sign_month, fill = list(num_signings = 0, war_signed = 0)) %>% # zero-pad months where no FA's were signed
#   group_by(offseason) %>%
#   arrange(offseason, sign_month) %>%
#   mutate(
#     percent_signed_this_month = 100 * (num_signings / total_available_fas),
#     total_signings = cumsum(num_signings),
#     signed_perc = 100 * (total_signings / total_available_fas),
#     war_perc = 100 * (cumsum(war_signed) / total_war_available)
#   )

cumulative_sign_plt %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  mutate(offseason = as.numeric(offseason)) %>%
  ggplot(aes(offseason, war_perc)) +
  geom_point() +
  geom_line() +
  ggtitle("Free Agent Talent",
    subtitle = "% of free agents WAR3 signed through January of each offseason"
  ) +
  labs(x = "Offseason", y = "% of FA's Signed", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com") +
  fgt +
  theme(legend.position = "none")
```

```{r eval=FALSE, include=FALSE}

cumulative_sign_plt %>%
  ungroup() %>%
  gather(metric, value, signed_perc, war_perc) %>%
  mutate(
    metric = str_replace_all(metric, c(
      "signed_perc" = "% of Free Agents Signed",
      "war_perc" = "% of Free Agent Trailing 3-Year WAR Signed"
    )),
    offseason = as.numeric(offseason)
  ) %>%
  filter(sign_month == "Jan") %>%
  ggplot(aes(offseason, value)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(metric), scales = "free_y") +
  fgt +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  ggtitle("Trends in Free Agent Signing, through Janauary") +
  labs(x = "Offseason", y = "%", caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com")
```



```{r eval=FALSE, include=FALSE}

# temporal distribution of signing %, over time

cumulative_sign_plt %>%
  ungroup() %>%
  mutate(offseason = factor(offseason)) %>%
  ggplot(aes(x = sign_month, y = offseason, group = offseason, height = percent_signed_this_month)) +
  geom_density_ridges2(scale = 5, stat = "identity")
```



```{r eval=FALSE, include=FALSE}


fa_types_annual <-
  all_free_agents %>%
  group_by(offseason, player_type) %>%
  summarize(total_available_fas = n()) %>%
  complete(offseason,
    player_type = c("Scrub", "Role Player", "Solid Starter", "Good Player", "All-Star", "Superstar", "MVP"),
    fill = list(total_available_fas = 0)
  )

sign_type_plt <-
  all_free_agents %>%
  filter(sign_type == "Domestic Free Agent") %>%
  group_by(offseason, sign_month, player_type) %>%
  summarize(num_signed = n()) %>%
  ungroup() %>%
  complete(offseason, sign_month, player_type, fill = list(num_signed = 0)) %>%
  left_join(fa_types_annual, by = c("offseason", "player_type")) %>%
  mutate(percent_signed = 100 * (num_signed / total_available_fas)) %>%
  group_by(offseason, player_type) %>%
  arrange(sign_month) %>%
  mutate(
    cume_signed = cumsum(num_signed),
    cume_percent_signed = 100 * (cume_signed / total_available_fas)
  )

sign_type_plt %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  mutate(
    offseason = as.numeric(offseason),
    player_type = factor(player_type, levels = c("Scrub", "Role Player", "Solid Starter", "Good Player", "All-Star", "Superstar", "MVP"))
  ) %>%
  ggplot(aes(offseason, cume_percent_signed)) +
  geom_point() +
  geom_line() +
  ggtitle("The Free Agency Decline has Hit All but the Very Best Players",
    subtitle = "% of free agents signed through January"
  ) +
  labs(
    x = "Offseason", y = "% of FA's Signed",
    caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com"
  ) +
  fgt +
  facet_wrap(vars(player_type)) +
  geom_smooth(method = "loess", linetype = "dashed", se = FALSE, lwd = 0.7)
```



```{r eval=FALSE, fig.height=3, include=FALSE}
# same as above, only split out by age bucket


fa_types_annual_age_buckets <-
  all_free_agents %>%
  group_by(offseason, player_type, age_bucket) %>%
  summarize(total_available_fas = n()) %>%
  ungroup() %>%
  complete(offseason,
    player_type,
    age_bucket,
    fill = list(total_available_fas = 0)
  )

sign_type_plt_ages <-
  all_free_agents %>%
  filter(sign_type == "Domestic Free Agent") %>%
  group_by(offseason, sign_month, player_type, age_bucket) %>%
  summarize(num_signed = n()) %>%
  ungroup() %>%
  complete(offseason, sign_month, player_type, age_bucket, fill = list(num_signed = 0)) %>%
  left_join(fa_types_annual_age_buckets, by = c("offseason", "player_type", "age_bucket")) %>%
  mutate(percent_signed = 100 * (num_signed / total_available_fas)) %>%
  group_by(offseason, player_type, age_bucket) %>%
  arrange(sign_month) %>%
  mutate(
    cume_signed = cumsum(num_signed),
    cume_percent_signed = 100 * (cume_signed / total_available_fas)
  )

sign_type_plt_ages %>%
  ungroup() %>%
  filter(sign_month == "Jan") %>%
  ggplot(aes(offseason, cume_percent_signed, color = age_bucket)) +
  geom_point() +
  geom_line() +
  ggtitle("The Free Agency Decline has Hit All but the Very Best Players",
    subtitle = "% of free agents signed through January"
  ) +
  labs(
    x = "Offseason", y = "% of FA's Signed",
    caption = "Source: baseball-reference.com\nRetirees are considered unsigned FA's\nGraph by Ryan Pollack: ryanpollack.com"
  ) +
  fgt +
  facet_wrap(vars(player_type), scales = "free_y")
```






```{r eval=FALSE, include=FALSE}

# debugging is below

# TODO: verify month by month signing ounts for 2017, 2018, and 1994
# this will be my final verification

all_free_agents %>%
  group_by(offseason) %>%
  mutate(total_available_fas = n()) %>% # get total available FA's in each offseason
  filter(!is.na(sign_month)) %>% # discard unsigned FA"s, now that we have the total number, don't need them anymore
  group_by(offseason, total_available_fas, sign_month) %>%
  summarize(num_signings = n()) %>%
  arrange(offseason, sign_month) %>%
  mutate(
    cume_fas_signed = cumsum(num_signings),
    cume_signed_perc = 100 * (cume_fas_signed / total_available_fas)
  ) %>%
  filter(offseason == 2017) %>%
  arrange(cume_signed_perc)
```
