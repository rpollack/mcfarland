```{r setup, include=FALSE, echo=FALSE}

#library(devtools)
library(tidyverse)
library(rvest)
library(stringr)
library(plotly)
library(lubridate)
library(RMySQL)
library(stats4)
library(VGAM)
library(gamlss)
library(broom)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))

estBetaParams <- function(mu, var) {
  alpha <- ((1 - mu) / var - 1 / mu) * mu ^ 2
  beta <- alpha * (1 / mu - 1)
  return(params = list(alpha = alpha, beta = beta))
}
```


### Get Data

```{r}

id_info <- fg_db %>%
  tbl("playerid_lookup") %>%
  select(mlbamid, playerid) %>%
  collect(n=Inf)

batter_info <- fg_db %>%
  tbl("stats_batting") %>%
  filter(Season >= 2015,
         Type == 0) %>%
  select(playerid, Season, PA) %>%
  collect(n=Inf)

fg_info <- fg_db %>%
  tbl("player_info") %>%
  filter(!BISposition %in% c("SP", "RP")) %>%   #remove pitchers from sample
  select(PlayerId, FirstName, LastName) %>%
  collect(n=Inf) %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  select(PlayerId, Name) %>%
  collect(n=Inf) %>%
  inner_join(batter_info, by=c("PlayerId" = "playerid")) %>%
  inner_join(id_info, by=c("PlayerId" = "playerid"))

savant_data <- fg_db %>%
  tbl("gd_savant_new") %>%
  select(batter, player_name, game_date, game_year, pitch_type, release_speed, events, description, des, plate_x, plate_z, 
         hc_x, hc_y, launch_speed, launch_angle, hit_distance_sc, home_team, away_team, inning_top_bottom, xwoba, stand) %>%
  collect(n=Inf) %>%
  inner_join(fg_info, by=c("batter" = "mlbamid", "game_year" = "Season"))

```

```{r}
savant_data_clean <- savant_data %>%
  #compute batting team & fielding team
  mutate(batting_team = ifelse(inning_top_bottom == "N", home_team, away_team),
         fielding_team = ifelse(batting_team == away_team, home_team, away_team),
         
         #convert numbers to numeric, leaving 'null' values as NA

         launch_speed = as.numeric(launch_speed),
         hit_distance_sc = as.numeric(hit_distance_sc),
         launch_angle = as.numeric(launch_angle),
         plate_x = as.numeric(plate_x),
         plate_z = as.numeric(plate_z),
         spray_angle = round(tan((hc_x - 125.42)/ (198.27-hc_y)) * 180/pi*.75, 1),
         
         #from bill petti
         barrel = ifelse(launch_angle <= 50 & launch_speed >= 98 & launch_speed * 1.5 - launch_angle >= 11 &
                           launch_speed + launch_angle >= 124, 1, 0),
        
         #assign correct wOBA value to walks & HBP
         xwoba = ifelse(events == "walk", 0.69,
                        ifelse(events == "hit_by_pitch", 0.72, xwoba)))

barrel_data_seasonal <- savant_data_clean %>%
  group_by(PlayerId, Name, game_year, PA, stand) %>%
  summarize(num_barrels = sum(barrel, na.rm = TRUE)) %>%
  mutate(barrel_rate = num_barrels / PA) %>%
  filter(PA >= 2)

barrel_data_totals <- barrel_data_seasonal %>%
  group_by(PlayerId, Name, stand) %>%
  summarize(barrels = sum(num_barrels),
            PA = sum(PA)) %>%
  mutate(stand = factor(stand, levels=c("R", "L")),
         stand = relevel(stand, "R"))

```


### fit beta-binomial regression using maximum-likelihood
allow PA to influence priors. this gives more weight to players with more plate appearances. 

```{r}
fit <- gamlss(cbind(barrels, PA - barrels) ~ log(PA) + stand,
              data = barrel_data_totals,
              family = BB(mu.link = "identity"))

td <- tidy(fit)

mu <- fitted(fit, parameter = "mu")
sigma <- fitted(fit, parameter="sigma")

barrels_accounting_for_pa <- barrel_data_totals %>%
  ungroup() %>%
  dplyr::select(PlayerId, Name, barrels, PA) %>%
  mutate(mu = mu,
         alpha0 = mu / sigma,
         beta0 = (1 - mu) / sigma,
         alpha1 = alpha0 + barrels,
         beta1 = beta0 + PA - barrels,
         est_barrel_rate = alpha1 / (alpha1 + beta1),
         low_credible = qbeta(.025, alpha1, beta1), 
         high_credible = qbeta(.975, alpha1, beta1),
         interval_dist = high_credible - low_credible) %>%
  arrange(desc(est_barrel_rate))


# sigma <- fitted(fit2, "sigma")[1]
# 
# barrel_priors <- 
# 
# crossing(bats = c("L", "R"),
#          AB = c(1, 10, 100, 1000, 10000)) %>%
#   augment(fit2, newdata = .) %>%
#   rename(mu = .fitted) %>%
#   crossing(x = seq(.1, .36, .0005)) %>%
#   mutate(alpha = mu / sigma,
#          beta = (1 - mu) / sigma,
#          density = dbeta(x, alpha, beta)) %>%
#   ggplot(aes(x, density, color = factor(AB), lty = bats)) +
#   geom_line() +
#   labs(x = "Batting average",
#        y = "Prior density",
#        color = "AB",
#        lty = "Batting hand")

```

### Plots

```{r}
#calculate prior distributions, based on PA

mu_0 <- td$estimate[1]
mu_PA <- td$estimate[2]
sigma <- exp(td$estimate[3])

barrel_rate_priors <- crossing(x = seq(0, .2, .001), PA = c(250, 500, 750, 1000, 1250)) %>%
  mutate(density = dbeta(x, (mu_0 + mu_PA * log(PA)) / sigma,
                         (1 - (mu_0 + mu_PA * log(PA))) / sigma)) %>%
  mutate(PA = factor(PA))

#plot prior distributions
# ggplot(barrel_rate_priors, aes(x, density, color = PA, group = PA)) +
#   geom_line(group=1) + labs(x="Barrel Rate", y="Prior Density") + xlim(-.1, .2) + fgt +
#   ggtitle("More PA = Increased Probability of Higher Barrel Rate")

# plot barrel rate leaders & laggards based on expected rate. also show credible intervals
ggplot(barrels_accounting_for_pa %>% head(25), aes(est_barrel_rate, reorder(Name, est_barrel_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Barrels / PA with 95% Credible Interval") +
  ggtitle("Estimated Barrel Rate Leaders, 2015 – 2017: Top 25") + fgt

ggplot(barrels_accounting_for_pa %>% tail(25), aes(est_barrel_rate, reorder(Name, est_barrel_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Barrels / PA, with 95% Credible Interval") +
  ggtitle("Estimated Barrel Rate Laggards, 2015 – 2017: Bottom 25") + fgt


```



### EVERYTHING BELOW HERE IS JUNK BECAUSE IT DOESN'T USE BETA-BINOMIAL REGRESSION!!! :-)

### define & plot prior. 

```{r}
#estBetaParams(mean(barrel_data_batters$barrel_rate), var(barrel_data_batters$barrel_rate))

ll <- function(alpha, beta) {
  x <- barrel_data_batters$num_barrels
  total <- barrel_data_batters$PA
  -sum(VGAM::dbetabinom.ab(x, total, alpha, beta, log = TRUE))
}

# maximum likelihood estimation
m <- mle(ll, start = list(alpha = 1, beta = 10), method = "L-BFGS-B", lower = c(0.0001, .1))

ab <- coef(m)
alpha0_barrels <- ab[1]
beta0_barrels <- ab[2]

ggplot(barrel_data_batters, aes(barrel_rate)) + geom_histogram(binwidth = .01, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = alpha0_barrels, shape2 =  beta0_barrels),
                lwd=2,
                aes(color="MLB Hitters")) + 
  ggtitle("Probability Distribution for Barrels / PA, 2015 – 2017") +
  labs(color = "Distributions") +
  scale_color_brewer(palette="Set1", direction= -1) +
  labs(x="Barrels / PA") + xlim(0,.2)

```

### Barrel Rate Leaders, 2017

```{r}

barrels_2017 <- barrel_data_batters %>%
  filter(game_year == 2017) %>%
  arrange(desc(barrel_rate))

ggplot(barrels_2017 %>% head(25), aes(reorder(Name, barrel_rate), barrel_rate)) + geom_bar(stat="identity") +
  coord_flip() + labs(y="Barrels / PA", x="") + ggtitle("Barrel Rate Leaders, 2017\n(Batters with at least 80 PA)")

```


```{r}

#compute estimated barrel rates (using the mode) plus parameters for posterior distributions & credible intervals

barrel_data_totals <- barrel_data_batters %>%
  group_by(PlayerId, Name) %>%
  summarize(barrels = sum(num_barrels),
            PA = sum(PA)) %>%
  mutate(est_barrel_rate = ((barrels + alpha0_barrels) - 1) / ((PA + alpha0_barrels + beta0_barrels) -2),
         alpha1 = barrels + alpha0_barrels,
         beta1 = PA + beta0_barrels - barrels,
         low_credible = qbeta(.025, alpha1, beta1), 
         high_credible = qbeta(.975, alpha1, beta1),
         interval_dist = high_credible - low_credible) %>%
  arrange(desc(est_barrel_rate))

ggplot(barrel_data_totals %>% head(25), aes(est_barrel_rate, reorder(Name, est_barrel_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Barrels / PA with 95% Credible Interval") +
  ggtitle("Barrel Rate Leaders, 2015 – 2017: Top 25") + fgt

ggplot(barrel_data_totals %>% tail(25), aes(est_barrel_rate, reorder(Name, est_barrel_rate))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated Barrels / PA, with 95% Credible Interval") +
  ggtitle("Barrel Rate Laggards, 2015 – 2017: Bottom 25") + fgt

```

```{r}
hoskins_alpha1 <- 16.59423
hoskins_beta1 <- 129.4645
  
  
ggplot(barrel_data_batters, aes(barrel_rate)) + geom_histogram(binwidth = .01, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = alpha0_barrels, shape2 =  beta0_barrels),
                lwd=2,
                aes(color="MLB Hitters (Prior)")) +
  stat_function(fun = dbeta,
                args =list(shape1 = hoskins_alpha1, shape2 = hoskins_beta1),
                lwd=2,
                aes(color = "Rhys Hoskins (Posterior)")) +
  labs(color = "Distributions") +
  scale_color_brewer(palette="Set1", direction= -1) +
  labs(x="Barrels / PA") + ggtitle("Rhys Hoskins's Prior & Posterior Barrel Rates") + xlim(0, .2)
  
```


```{r}
hoskins_barrels <- 14
hoskins_pa <- 96

#alpha0_barrels <-
#beta0_barrels <- 

est_hoskins_barrel_rate <- ((hoskins_barrels + alpha0_barrels) - 1) / ((hoskins_pa + alpha0_barrels + beta0_barrels) - 2)
est_hoskins_barrel_rate <- round(est_hoskins_barrel_rate, 3)

hoskins_sim <- as_tibble(rbeta(10000, hoskins_alpha1, hoskins_beta1))

ggplot(hoskins_sim, aes(value, y = ..density..)) + geom_histogram(binwidth = .001) +
  annotate("text", x = .05, y = 19.2, label=sprintf("Expected Barrels/PA in 2017: %s", est_hoskins_barrel_rate)) +
  labs(x="Simulated Barrels/PA") + ggtitle("10,000 Simulated Rhys Hoskins Seasons") +
  scale_fill_brewer(palette="Set1", direction = -1) + xlim(0, .2) +
  geom_vline(aes(xintercept=est_hoskins_barrel_rate), color="red", linetype="dashed")

# 95% confidence interval
quantile(hoskins_sim$value, c(.025, .975))
```




```{r}

# I think all this is right, except I need to weight the the endpoints of the 95% confidence intervals, too.


  #scheme to weight past years --- not 100% sure this is right yet.
  #project barrel rate by regressing to mean + weighting past 2 years at .6 and .3, respectively.
  #for missing years, assume average performance: alpha0_barrels -1 / (alpha0_barrels + beta0_barrels)
   
barrel_data_batters_weighted <- barrel_data_batters %>%
  mutate(est_barrels_this_year = (num_barrels + alpha0_barrels) - 1,
         est_barrels_last_year = ifelse(is.na(lag(num_barrels)), alpha0_barrels * .6, .6 * lag(num_barrels) + alpha0_barrels),
         est_barrels_two_years_ago = ifelse(is.na(lag(num_barrels, 1)), alpha0_barrels * .3, .3 * lag(num_barrels, 1) + alpha0_barrels),
         est_pa_this_year = PA + alpha0_barrels + beta0_barrels,
         est_pa_last_year = ifelse(is.na(lag(PA)), alpha0_barrels + beta0_barrels, .6 * lag(PA) + alpha0_barrels + beta0_barrels),
         est_pa_two_years_ago = ifelse(is.na(lag(PA, 1)), alpha0_barrels + beta0_barrels, .3 * lag(PA, 1) + alpha0_barrels + beta0_barrels),
         est_barrel_rate_weighted = (est_barrels_this_year + est_barrels_last_year +
                                       est_barrels_two_years_ago) - 1 / (est_pa_this_year + est_pa_last_year +
                                                                           est_pa_two_years_ago))
   #ungroup() %>%
   #select(Name, Season = game_year, barrel_rate, est_barrel_rate_weighted) %>%
   #arrange(desc(est_barrel_rate_weighted))
# 
# 
# b
# 
barrels_weighted_2017 <- barrel_data_batters_weighted %>%
  filter(Season == 2017) %>%
  mutate(alpha1 = est_barrels_this_year,
         beta1 = beta0_barrels + PA - est_barrels_this_year) %>%
  crossing(x = seq(.01, .20, .00025)) %>%
  select(Name, Season, alpha1, beta1, est_barrel_rate_weighted) %>%
  mutate(density = dbeta(est_barrel_rate_weighted, alpha1, beta1),
         low = qbeta(.025, alpha1, beta1),
         high = qbeta(.975, alpha1, beta1)) %>%
  head(25)
# 
# 
ggplot(barrels_weighted_2017, aes(reorder(Name, est_barrel_rate_weighted), est_barrel_rate_weighted)) +
  geom_point() +
  geom_errorbar(aes(ymin = low, ymax = high)) +
  coord_flip() +
  labs(y="Est. Barrels per PA, Weighted, w/95% Credible Interval", x="")

```

#ggplot(barrels)

# 
# #  head(10)
#   #gather(parameter, value, alpha1, beta1)
# 
# #foo <- plyr::ddply(barrels_weighted_2017, "batter_name", fun = rbeta, n = 10000, shape1 = alpha1, shape2 = beta1)
# 
# judge_sim <- as_tibble(rbeta(10000, 50.81244, 297.4897))
# judge_sim$name <- "Aaron Judge"
# 
# 
# martinez_sim <- rbeta(10000, 25.81244, 179.4897)
# martinez_sim$name <- "J.D. Martinez"
# 
# 
# 
# 
# barrels_plt <- judge_compares
# 
# 
# 
# sim_barrels <- rbeta(10000, barrels_weighted_2017$alpha1, barrels_weighted_2017$beta1)
# 


#ggplot(barrels_weighted_2017, aes(x=est_barrel_rate_weighted))
  

#regression toal is 51 PA. Pretty low. Indicates barrel rate is fairly stable.

```

