---
title: "Hof-voting-bayes"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
#library(plotly)
library(RMySQL)
library(broom)
library(gamlss)
library(glue)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))

get_voting_results_bayes <- function(year) {
  # get player data and (if available) HOF voting results for a particular year
  # also get total ballots cast that year
  url <- str_c("https://www.baseball-reference.com/awards/hof_", year, ".shtml")

html <- read_html(url)

ballot_text <-
  html %>%
  html_nodes("li") %>% 
  html_text() %>%
  as_tibble() %>% 
  filter(str_detect(value, "total ballots")) %>%
  distinct(value) # needed because some years, like 2011, have a vote total listed twice. also years like 1967 had 2 elections

total_votes <- as.numeric(str_extract(ballot_text$value, "[:digit:]{3}"))
# print(glue("year: {year}, total ballots: {total_votes}"))

html %>%
    html_nodes("table") %>%
    .[[1]] %>%
    html_table(header = FALSE) %>%
    as_tibble() %>%
    mutate(vote_year = as.numeric(year),
           total_ballots = total_votes)
}

fix_name <- function(name) {
  # scrub player's name of weird characters that BB-Ref puts in their HOF voting data tables
  str_replace_all(str_replace(name, "y ", ""),
                  c(
                    "X-" = "",
                    "\\sHOF" = ""))
}

```


```{r}
# foo <-
#   read_html("https://www.baseball-reference.com/awards/hof_2011.shtml") %>% 
#   html_nodes("li") %>% 
#   html_text() %>%
#   as_tibble() %>% 
#   filter(str_detect(value, "total ballots"))
# 
# as.numeric(str_extract(foo$value, "[:digit:]{3}"))[1]
# 

```


get voting results so we can estimate beta prior parameters

for each player, get: 
- year on ballot
- playing position
- JAWS
- # votes that year
- # total votes 


```{r}
hof_voting_data_bayes <- seq(1980, 2018) %>%
  map_df(get_voting_results_bayes)
```

clean and transform data so it can be processed correctly
```{r}
hof_voting_data_bayes_clean <-
  hof_voting_data_bayes %>% 
  dplyr::select(Name = X2,
                num_votes_received = X4,
                year_on_ballot = X3,
                vote_year,
                total_ballots,
                bj_hof_monitor = X6,
                best_seven_war = X10,
                position = X39,
                G_pitch = X30,
                GS = X31,
                SV = X32
  ) %>%
  filter(!Name %in% c("Name", "")) %>% # remove informational and spacer rows
  mutate(Name = fix_name(Name),
         num_votes_received = as.numeric(num_votes_received),
         year_on_ballot = as.numeric(str_extract(year_on_ballot, "[:digit:]{1,2}")),
         bj_hof_monitor = as.numeric(bj_hof_monitor),
         narrative_score = set_narrative(Name),
         G_pitch = as.numeric(G_pitch),
         GS = as.numeric(GS),
         SV = as.numeric(SV),
         best_seven_war = as.numeric(best_seven_war),
         position = str_extract(position, "[:digit:]"),
         position_class = case_when(
           position == 1 & GS / G_pitch >= 0.5 ~ "Starting pitcher",
           position == 1 & GS / G_pitch <= 0.5 ~ "Relief pitcher",
           TRUE ~ "Position player")) %>%
  dplyr::select(-position)

# get ballot and stat information for those on the next ballot. 
# year_to_predict <- 2019
# current_url <- str_c("https://www.baseball-reference.com/awards/hof_", year_to_predict, ".shtml")
# current_hof_voting <-
#   read_html(current_url) %>%
#   html_nodes("table") %>%
#   .[[1]] %>%
#     html_table(header = FALSE) %>%
#     as_tibble() %>%
#     mutate(vote_year = as.numeric(year_to_predict)) %>%
#   dplyr::select(
#     Name = X2,
#          year_on_ballot = X3,
#          vote_year,
#          jaws = X10,
#          jpos = X11,
#     bj_hof_monitor = X5,
#     position = X38,) %>%
#   filter(!Name %in% c("Name", "")) %>% # remove informational and spacer rows
#   mutate(Name = fix_name(Name),
#          year_on_ballot = as.numeric(str_extract(year_on_ballot, "[:digit:]{1,2}")),
#          jaws = as.numeric(jaws),
#          jpos = as.numeric(jpos),
#          jaws_plus = round(100 * (jaws / jpos), 0),
#   bj_hof_monitor = as.numeric(bj_hof_monitor)) %>%
#   dplyr::select(-jaws, -jpos)

#should just be able to use hof_voting_data_future_clean;it has the same pieces to it

# get to-date voting information from HOF Tracker and combine with BB-Ref stats, and join to previously scraped data
current_voting_data <-
  read_csv("2019 BBHOF Tracker-2/Summary-Table 1.csv")
known_votes <- as.numeric(current_voting_data[2,3]) + as.numeric(current_voting_data[1,3])

voting_info_to_date <-
  current_voting_data %>%
  filter(row_number() >= 5) %>% # remove metadata
  dplyr::select(Name = X1,
                vote_share = X2) %>%
  mutate(vote_share = as.numeric(str_extract(vote_share, "[:digit:]{1,3}.{1}")) / 100,
         total_ballots = known_votes,
         num_votes_received = ceiling(vote_share * total_ballots)) %>%
  inner_join(hof_voting_data_future_clean, by="Name") %>%
  dplyr::select(Name, num_votes_received, year_on_ballot, vote_year, total_ballots, bj_hof_monitor,
                best_seven_war = best_war_years, G_pitch, GS, SV, narrative_score, position_class)


master_bayes <- 
  bind_rows(hof_voting_data_bayes_clean, voting_info_to_date) %>%
  # group_by(Name) %>%
  # arrange(year_on_ballot) %>%
  # mutate(prev_year_vote_share = lag(num_votes_received) / lag(total_ballots)) %>%
  dplyr::select(Name, num_votes_received, year_on_ballot, vote_year, total_ballots, bj_hof_monitor, 
                narrative_score, SV, position_class) %>%  
  mutate(vote_share = num_votes_received / total_ballots) %>%
  ungroup() 

```

observe voteshare relationship between year on ballot & JAWS


```{r}

# %>%
#   group_by(Name) %>%
#   summarize(total_votes = sum(num_votes_received),
#             total_ballots = sum(total_ballots),
#             years_on_ballot = n())

master_repeat <- 
  master %>%
  group_by(Name) %>%
  arrange(Name, year_on_ballot) %>%
  mutate(prev_vote_share = lag(vote_share)) %>%
  filter(year_on_ballot != 1,
         !is.na(prev_vote_share)) %>%
  ungroup()

fit <- gamlss(cbind(num_votes_received, total_ballots - num_votes_received) ~ prev_vote_share,
              data = master_repeat,
              family = BB(mu.link = "logit"))

td <- tidy(fit)
mu <- fitted(fit, parameter = "mu")
sigma <- fitted(fit, parameter = "sigma")

est_hof_repeat_players <- 
  master_repeat %>%
  mutate(mu = mu,
         alpha0 = mu / sigma,
         beta0 = (1 - mu) / sigma,
         est_prior_hof_vote_share = alpha0 / (alpha0 + beta0),
         alpha1 = alpha0 + num_votes_received,
         beta1 = beta0 + total_ballots - num_votes_received,
         est_hof_vote_share = alpha1 / (alpha1 + beta1),
         low_credible = qbeta(.025, alpha1, beta1),
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  filter(vote_year == 2019)

#edgar in 2019
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 39.97636, shape2 = 9.957576),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 157.97636, shape2 = 20.95758),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Edgar Martinez HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt

# barry bonds in 2019
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 32.1702, shape2 = 17.76373),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 128.1702, shape2 = 50.76373),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Barry Bonds HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt


```

goal here is to get voting data, bj_hof_monitor, and narrative_score for all starters so I can fit a model to get priors

df needs to have:

Name | vote_year | total_ballots | num_votes_received | vote_share | bj_hof_monitor | narrative_score

for first-year-starting pitchers only
including those from the past and those in the future

```{r}

master_starters <-
  master_bayes %>%
  filter(year_on_ballot == 1,
         position_class == "Starting pitcher")

fit_starters <- 
  gamlss(cbind(num_votes_received, total_ballots - num_votes_received) ~ bj_hof_monitor + narrative_score,
         data = master_starters,
         family = BB(mu.link = "logit"))

td_starters <- tidy(fit_starters)
mu_starters <- fitted(fit_starters, parameter = "mu")
sigma_starters <- fitted(fit_starters, parameter = "sigma")

est_hof_first_year_starters <-
  master_starters %>%
  mutate(mu = mu_starters,
         alpha0 = mu / sigma_starters,
         beta0 = (1 - mu) / sigma_starters,
         alpha1 = alpha0 + num_votes_received,
         beta1 = beta0 + total_ballots - num_votes_received,
         est_hof_vote_share = alpha1 / (alpha1 + beta1),
         low_credible = qbeta(.025, alpha1, beta1),
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  filter(vote_year == 2019)

# roy halladay 2019
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 9.43963307, shape2 = 0.533622),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 156.47159904, shape2 = 9.554338),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Roy Halladay HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt

# do andy pettite
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 2.50328726, shape2 = 7.469968),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 13.52017896, shape2 = 152.505758),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Andy Pettite HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt



  # vote_share ~ bj_hof_monitor + narrative_score,
  #                  data = first_year_starters
```


```{r}


# plot prior distirbutions for players' HOF voting, based on their year on the ballot and JAWS. 
# note these are just the medians.
# TODO: might be better to quantize JAWS and show ACTUAL CURVES for players with 10, 50, and 100 JAWS to get the point across.

# sigma <- fitted(fit, "sigma")[1]
# crossing(jaws = c(25, 50, 75, 100),
#          year_on_ballot = c(1, 5, 10)) %>%
#   augment(fit, newdata = .) %>%
#   rename(mu = .fitted) %>%
#   crossing(x = seq(0, 1, .1)) %>%
#   mutate(alpha = mu / sigma,
#          beta = (1 - mu) / sigma,
#          density = dbeta(x, alpha, beta)) %>%
#   ggplot(aes(x, density, color = factor(year_on_ballot), group = jaws)) +
#   geom_line() +
#   labs(x = "Estimated HOF",
#        y = "Prior density",
#        color = "AB",
#        lty = "Batting hand")


# plot medians of prior distributions of vote share totals, given player's jaws & the year they are on the ballot 
# TODO: I want to show the actual distro curves but haven't figured out how to do that successfully. some code for it is in my NOTES
master_repeat %>%
    augment(fit, newdata = .) %>%
    rename(mu = .fitted) %>%
    mutate(sigma = fitted(fit, "sigma")[1],
           alpha0 = mu / sigma,
           beta0 = (1 - mu) / sigma,
           conf_low = qbeta(.025, alpha0, beta0),
           conf_high = qbeta(.975, alpha0, beta0)) %>%
    ggplot(aes(y=mu)) + geom_col()

```


```{r}
# td <- tidy(fit)
# 
# mu <- fitted(fit, parameter = "mu")
# sigma <- fitted(fit, parameter="sigma")

# combine prior distributions with likelihoods to produce posterior distributions.
# simplify visualizations to most likely values + credible intervals instead of probability distributions
est_hof_voting <- 
  master %>%
  ungroup() %>%
  mutate(mu = predict(fit, what = "mu", newdata = master),
         sigma = predict(fit, what = "sigma", newdata = master, type = "response"),
         alpha0 = mu / sigma,
         beta0 = (1 - mu) / sigma,
         alpha1 = alpha0 + num_votes_received,
         beta1 = beta0 + total_ballots - num_votes_received,
         est_hof_vote_share = alpha1 / (alpha1 + beta1),
         low_credible = qbeta(.025, alpha1, beta1), 
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  mutate(name_year = paste(Name, vote_year, sep = " "),
         residual = round(est_hof_vote_share - vote_share, 3)) %>%
  arrange(desc(est_hof_vote_share))

# ken griffey jr. prior vs. posterior
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 0.5049117, shape2 = 1.866626),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 437.50491, shape2 = 4.866626),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Ken Griffey Jr. HOF Voting:  Prior Expectations vs. Posterior Probabilities") +
  fgt

#barry bonds in 2019: prior vs. posterior
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 2.479130, shape2 = 1.719731),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 98.47913, shape2 = 34.71973),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Barry Bonds HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt

#barry bonds in 2019: prior vs. posterior
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 2.479130, shape2 = 1.719731),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 98.47913, shape2 = 34.71973),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Barry Bonds HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt


#edgar in 2019
ggplot() + geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 1.598705, shape2 = 2.600155),
                aes(color = "Prior")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 119.5987, shape2 = 13.60016),
                aes(color="Posterior")) +
  xlim(0, 1) + labs(x="Est. HOF Vote Share") + 
  ggtitle("Edgar Martinez HOF Voting in 2019: Prior Expectations vs. Posterior Probabilities") +
  fgt



```

```{r, fig.height=3}
ggplot(est_hof_voting %>% filter(vote_year == 2019), aes(est_hof_vote_share, reorder(Name, est_hof_vote_share))) +
  geom_point() +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible)) +
  labs(y="", x="Estimated HOF Vote % with 95% Credible Interval", 
       caption = "Sources: \nPast voting: Baseball Reference\n2019 voting: bbhoftracker.com") +
  ggtitle("Projected HOF Voting, Class of 2019",
          subtitle = glue("After {known_votes} votes tallied")) + fgt +
  geom_vline(xintercept = 0.75, linetype = "dashed", color = "green") +
  geom_vline(xintercept = .05, linetype = "dashed", color = "red")


# TODO: next step is to draw 10,000 vote shares from each players' posterior curve and see how many are at 0.75 or above
# this is the probability that the player will reach the HOF
# use rbeta to do this

# simulate 10,000 HOF voting elections using his posterior distribution and calculate the percentage that end with him gaining election
clemens_sim <- rbeta(10000, 99.13296, 34.0659)
sum(clemens_sim >= 0.75) / 10000
# 44.5% chance of Clemens gaining induction this year
# could also do this: 1 - pbeta(0.75,  99.13296, 34.0659)


#edgar
martinez_sim <- rbeta(10000, 119.5987, 13.60016)
sum(martinez_sim >= 0.75) / 10000
# 100% chance of Edgar getting in

# larry walker
walker_sim <- rbeta(10000, 87.58949, 45.60937)
sum(walker_sim >= 0.75) / 10000
#1% chance of walker getting in


```




ahhhh but i can't estimate a prior for players w/o any voting results ... can i??

they DO have some ACTUAL voting results (likelihood). perhaps I can use a naive prior? beta with alpha = 1 and beta = 1? or comparable players?



do empirical analysis for first-year players. they haven't had any results to observe yet ... or have they?

