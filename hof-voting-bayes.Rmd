---
title: "Hof-voting-bayes"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
#library(plotly)
library(RMySQL)
library(rvest)
library(broom)
library(gamlss)
library(glue)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))

get_voting_results_bayes <- function(year) {
  # get player data and (if available) HOF voting results for a particular year
  # also get total ballots cast that year
  url <- str_c("https://www.baseball-reference.com/awards/hof_", year, ".shtml")

html <- read_html(url)

ballot_text <-
  html %>%
  html_nodes("li") %>% 
  html_text() %>%
  as_tibble() %>% 
  filter(str_detect(value, "total ballots")) %>%
  distinct(value) # needed because some years, like 2011, have a vote total listed twice. also years like 1967 had 2 elections

total_votes <- as.numeric(str_extract(ballot_text$value, "[:digit:]{3}"))
# print(glue("year: {year}, total ballots: {total_votes}"))

html %>%
    html_nodes("table") %>%
    .[[1]] %>%
    html_table(header = FALSE) %>%
    as_tibble() %>%
    mutate(vote_year = as.numeric(year),
           total_ballots = total_votes)
}

fix_name <- function(name) {
  # scrub player's name of weird characters that BB-Ref puts in their HOF voting data tables
  str_replace_all(str_replace(name, "y ", ""),
                  c(
                    "X-" = "",
                    "\\sHOF" = ""))
}

plot_prior_posterior <- function(Name, alpha0, beta0, alpha1, beta1, est_hof_vote_share) {

  ggplot() + 
  geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = alpha0, shape2 = beta0),
                aes(color="Prior")) +
    stat_function(fun = dbeta,
                args=list(shape1 = alpha1, shape2 = beta1),
                aes(color = "Posterior")) +
  xlim(0, 1) + labs(x="Estimated HOF Vote Share",
                    color = "Distribution",
                    caption = "Sources:\nPast voting: Baseball Reference\n2019 voting: bbhoftracker.com") + 
  ggtitle(glue("{Name} HOF Voting 2021"),
          subtitle = glue("Estimated vote share: {est_hof_vote_share * 100}%" )) + fgt +
      geom_vline(xintercept = 0.75, linetype = "dashed", color = "green", lwd = 1.1) +
  geom_vline(xintercept = .05, linetype = "dashed", color = "red", lwd = 1.1)
}


```


get voting results so we can estimate beta prior parameters

```{r}
hof_voting_data_bayes <- seq(1980, 2020) %>%
  map_df(get_voting_results_bayes)
```

clean and transform data so it can be processed correctly
```{r}
hof_voting_data_bayes_clean <-
  hof_voting_data_bayes %>% 
  dplyr::select(Name = X2,
                num_votes_received = X4,
                year_on_ballot = X3,
                vote_year,
                total_ballots,
                bj_hof_monitor = X6,
                best_seven_war = X10,
                position = X39,
                G_pitch = X31,
                GS = X32,
                SV = X33
  ) %>%
  filter(!Name %in% c("Name", "")) %>% # remove informational and spacer rows
  mutate(Name = fix_name(Name),
         num_votes_received = as.numeric(num_votes_received),
         year_on_ballot = as.numeric(str_extract(year_on_ballot, "[:digit:]{1,2}")),
         bj_hof_monitor = as.numeric(bj_hof_monitor),
         G_pitch = as.numeric(G_pitch),
         GS = as.numeric(GS),
         SV = as.numeric(SV),
         best_seven_war = as.numeric(best_seven_war),
         position = str_extract(position, "[:digit:]"),
         position_class = case_when(
           position == 1 & GS / G_pitch >= 0.5 ~ "Starting pitcher",
           position == 1 & GS / G_pitch <= 0.5 ~ "Relief pitcher",
           TRUE ~ "Position player")) %>%
  dplyr::select(-position)

# get to-date voting information from BB HOF Tracker and combine with BB-Ref stats, and join to previously scraped data
current_voting_data <-
  read_csv("~/Downloads/2021 BBHOF Tracker/Summary-Table 1.csv")
known_votes <- as.numeric(current_voting_data[2,3]) + as.numeric(current_voting_data[1,3])

# attach current voting into to player's statistics and combine with data scraped above
# the variable 'hof_voting_data_future_clean' is contained in hof-voting.Rmd; i used it for the machine learning piece
voting_info_to_date <-
  current_voting_data %>%
  filter(row_number() >= 5) %>% # remove metadata
  dplyr::select(Name = X1,
                vote_share = X2) %>%
  mutate(vote_share = as.numeric(str_extract(vote_share, "[:digit:]{1,3}.{1}")) / 100,
         total_ballots = known_votes,
         num_votes_received = ceiling(vote_share * total_ballots)) %>%
  inner_join(hof_voting_data_future_clean, by="Name") %>%
  dplyr::select(Name, num_votes_received, year_on_ballot, vote_year, total_ballots, bj_hof_monitor,
                best_seven_war = best_war_years, G_pitch, GS, SV, position_class)

master_bayes <- 
  bind_rows(hof_voting_data_bayes_clean, voting_info_to_date) %>%
  group_by(Name) %>%
  arrange(year_on_ballot) %>%
  mutate(prev_year_vote_share = lag(num_votes_received) / lag(total_ballots)) %>%
  dplyr::select(Name, num_votes_received, year_on_ballot, vote_year, total_ballots, bj_hof_monitor, 
                SV, position_class, prev_year_vote_share) %>%
  ungroup() 

```

for players returning to the ballot, voting heavily depends on the prior year's voting (r^2 = 0.93)
i can prove this with a scatterplot
use this info to fit model for returning players and estimate their 2019 vote share distribution 

```{r}

# remove saves column; it's not needed to fit the model, and gamlss() will complain about it having NA values
repeat_players <-
  master_bayes %>%
  filter(year_on_ballot != 1,
         !is.na(prev_year_vote_share)) %>%
  dplyr::select(-SV) %>%
  ungroup()

fit <- gamlss(cbind(num_votes_received, total_ballots - num_votes_received) ~ prev_year_vote_share,
              data = repeat_players,
              family = BB(mu.link = "logit"))

td <- tidy(fit)
mu <- fitted(fit, parameter = "mu")
sigma <- fitted(fit, parameter = "sigma")

est_hof_repeat_players <- 
  repeat_players %>%
  mutate(mu = mu,
         alpha0 = mu / sigma,
         beta0 = (1 - mu) / sigma,
         est_prior_hof_vote_share = alpha0 / (alpha0 + beta0),
         alpha1 = alpha0 + num_votes_received,
         beta1 = beta0 + total_ballots - num_votes_received,
         est_hof_vote_share = round(alpha1 / (alpha1 + beta1), 3) ,
         low_credible = qbeta(.025, alpha1, beta1),
         high_credible = qbeta(.975, alpha1, beta1),
         min_probable = qbeta(0.001, alpha1, beta1),
         max_probable = qbeta(.999, alpha1, beta1)) %>%
  filter(vote_year == 2021)

# larry walker prior graph
# ggplot() + 
#   geom_histogram(binwidth = 0.1, aes(y=..density..)) +
#   stat_function(fun = dbeta,
#                 args=list(shape1 = 13.64886, shape2 = 27.17663),
#                 aes(color="Prior")) +
#   xlim(0, 1) + labs(x="Estimated HOF Vote Share",
#                     color = "Distribution") + 
#   ggtitle("Larry Walker HOF Voting 2019: Prior Expectations",
#           subtitle = "Estimated vote share: 33.4%") + fgt +
#     geom_vline(xintercept = 0.75, linetype = "dashed", color = "green", lwd = 1.1) +
#   geom_vline(xintercept = .05, linetype = "dashed", color = "red", lwd = 1.1) +
#   ggsave("walker-prior.png", units = "in", width = 7, height = 5)
# 
# ggplot() + 
#   geom_histogram(binwidth = 0.1, aes(y=..density..)) +
#   stat_function(fun = dbeta,
#                 args=list(shape1 = 13.64886, shape2 = 27.17663),
#                 aes(color="Prior")) +
#   stat_function(fun = dbeta,
#                 args=list(shape1 = 155.6397, shape2 = 102.1611),
#                 aes(color="Posterior")) +
#   xlim(0, 1) + labs(x="Estimated HOF Vote Share",
#                     color = "Distribution") + 
#   ggtitle("Larry Walker HOF Voting 2019: Posterior Expectations",
#           subtitle = "Estimated vote share: 60.4%") + fgt +
#     geom_vline(xintercept = 0.75, linetype = "dashed", color = "green", lwd = 1.1) +
#   geom_vline(xintercept = .05, linetype = "dashed", color = "red", lwd = 1.1) +
#   ggsave("walker-prior-posterior.png", units = "in", width = 7, height = 5)


# plot priors and posteriors for interesting players
est_hof_repeat_players %>% 
  dplyr::select(Name, alpha0, beta0, alpha1, beta1, est_hof_vote_share) %>% 
  filter(Name %in% c("Curt Schilling", "Barry Bonds", "Todd Helton", "Omar Vizquel")) %>%
  pmap(plot_prior_posterior)


```


all of the above works only for players returning to the ballot
for first-year players, I fit separate models for starting pitchers, position player, and relievers
each class uses somewhat different stats

```{r echo=FALSE, message=FALSE, warning=FALSE}

master_starters <-
  master_bayes %>%
  filter(year_on_ballot == 1,
         position_class %in% c("Starting pitcher", "Position player")) %>%
  dplyr::select(-SV, -prev_year_vote_share)

fit_starters <- 
  gamlss(cbind(num_votes_received, total_ballots - num_votes_received) ~ bj_hof_monitor,
         data = master_starters,
         family = BB(mu.link = "logit"))

td_starters <- tidy(fit_starters)
mu_starters <- fitted(fit_starters, parameter = "mu")
sigma_starters <- fitted(fit_starters, parameter = "sigma")

est_hof_first_year_starters <-
  master_starters %>%
  mutate(mu = mu_starters,
         alpha0 = mu / sigma_starters,
         beta0 = (1 - mu) / sigma_starters,
         alpha1 = alpha0 + num_votes_received,
         beta1 = beta0 + total_ballots - num_votes_received,
         est_hof_vote_share = round(alpha1 / (alpha1 + beta1), 3),
         low_credible = qbeta(.025, alpha1, beta1),
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  filter(vote_year == 2021)

est_hof_first_year_starters %>% 
  dplyr::select(Name, alpha0, beta0, alpha1, beta1, est_hof_vote_share) %>% 
  filter(Name %in% c("Mark Buehrle", "Tim Hudson")) %>%
  pmap(plot_prior_posterior)
```


```{r}

master_relievers <-
  master_bayes %>%
  filter(year_on_ballot == 1,
         position_class == "Relief pitcher",
         vote_year == 2021) %>%
  dplyr::select(-prev_year_vote_share)

fit_relievers <- 
  gamlss(cbind(num_votes_received, total_ballots - num_votes_received) ~ bj_hof_monitor + SV,
         data = master_relievers,
         family = BB(mu.link = "logit"))

td_relievers <- tidy(fit_relievers)
mu_relievers <- fitted(fit_relievers, parameter = "mu")
sigma_relievers <- fitted(fit_relievers, parameter = "sigma")

est_hof_first_year_relievers <-
  master_relievers %>%
  mutate(mu = mu_relievers,
         alpha0 = mu / sigma_relievers,
         beta0 = (1 - mu) / sigma_relievers,
         alpha1 = alpha0 + num_votes_received,
         beta1 = beta0 + total_ballots - num_votes_received,
         est_hof_vote_share = round(alpha1 / (alpha1 + beta1), 3),
         low_credible = qbeta(.025, alpha1, beta1),
         high_credible = qbeta(.975, alpha1, beta1)) %>%
  filter(vote_year == 2019)

est_hof_first_year_relievers %>% 
  dplyr::select(Name, alpha0, beta0, alpha1, beta1, est_hof_vote_share) %>% 
  filter(Name %in% c("Mariano Rivera", "Darren Oliver")) %>%
  pmap(plot_prior_posterior)
```


```{r, fig.height=3}

# plot posterior curves of some players, to show what pre-flattening looks like

ggplot() + 
  geom_histogram(binwidth = 0.1, aes(y=..density..)) +
  stat_function(fun = dbeta,
                args=list(shape1 = 48.59796, shape2 = 209.2028),
                aes(color="Scott Rolen")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 181.7613, shape2 = 76.03944),
                aes(color = "Roger Clemens")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 91.63613, shape2 = 166.1647),
                aes(color = "Fred McGriff")) +
  stat_function(fun = dbeta,
                args=list(shape1 = 21.97254, shape2 = 235.8282),
                aes(color = "Andruw Jones")) +
  stat_function(fun = dbeta,
                args = list(shape1 = 155.6397, shape2 = 102.1611),
                aes(color ="Larry Walker")) +
  xlim(0, 1) + labs(x="Estimated HOF Vote Share",
                    color = "Player",
                    caption = "Sources:\nPast voting: Baseball Reference\n2019 voting: bbhoftracker.com") + 
  ggtitle(glue("HOF Voting 2019: Example Posterior Distributions",
               subtitle = glue("After {known_votes} ballots revealed"))) + fgt +
  geom_vline(xintercept = 0.75, linetype = "dashed", color = "green", lwd = 1.1) +
  geom_vline(xintercept = .05, linetype = "dashed", color = "red", lwd = 1.1) +
  ggsave("repeat_posteriors.png", units = "in", width = 7, height = 5)
```


```{r, fig.width=3, fig.height=5}
# final plot of all voting
est_hof_all <-
  bind_rows(est_hof_repeat_players, est_hof_first_year_starters, est_hof_first_year_relievers)

ggplot(est_hof_all, aes(est_hof_vote_share, reorder(Name, est_hof_vote_share))) +
  geom_point(size=2) +
  geom_errorbarh(aes(xmin = low_credible, xmax = high_credible), lwd = 1.1) +
  labs(y="", x="Estimated HOF Vote Share with 95% Credible Interval", 
       caption = "Sources:\nPast voting: Baseball Reference\n2021 voting: bbhoftracker.com") +
  ggtitle("Projected 2021 HOF Voting",
          subtitle = glue("As of 1/11/21 at 7:13 PM")) + fgt +
   geom_vline(xintercept = 0.75, linetype = "dashed", color = "green", lwd = 1.1) +
  geom_vline(xintercept = .05, linetype = "dashed", color = "red", lwd = 1.1) +
  theme(text=element_text(size=20)) +
  ggsave("est_hof_voting_20212.png", units = "in", width = 9, height = 10)

# condense to just a table of point estimates, chances of induction, and chances of elimination
est_hof_all %>%
  mutate(`Estimated Vote Share (%)` = round(est_hof_vote_share * 100, 3),
         `Chance of Induction (%)` = round(1 - pbeta(.75, alpha1, beta1), 3) * 100,
         `Chance of Elimination (%)` = round(pbeta(.049, alpha1, beta1), 3) * 100)  %>%
  dplyr::select(Name, contains("%")) %>%
  arrange(desc(`Estimated Vote Share (%)`)) %>%
  write_csv("est-hof-bayes-2019.csv")


```



```{r}

# evaluate model using actual 2019 voting

hof_voting_2019 <- seq(2019, 2019) %>%
  map_df(get_voting_results_bayes)

hof_voting_2019_clean <-
  hof_voting_2019 %>% 
  dplyr::select(Name = X2,
                actual_vote_share = X5) %>%
  filter(!Name %in% c("Name", "")) %>% # remove informational and spacer rows
  mutate(Name = fix_name(Name),
         actual_vote_share = as.numeric(str_extract(actual_vote_share, "[:digit:]{1,3}.[:digit:]")) / 100)

final_data <-
  est_hof_all %>%
  inner_join(hof_voting_2019_clean, by="Name") %>%
  dplyr::select(Name, est_hof_vote_share, actual_vote_share) %>%
  mutate(residual = actual_vote_share - est_hof_vote_share)

bayes_model_r_sq <-
  summary(lm(actual_vote_share ~ est_hof_vote_share,
     data = final_data))$r.squared %>%
  round(3)

bayes_model_rmse <- 
  RMSE(final_data$est_hof_vote_share, final_data$actual_vote_share) %>%
  round(3)

ggplot(final_data, aes(est_hof_vote_share, actual_vote_share)) +
  geom_point() +
  geom_smooth(method="lm") + fgt +
  geom_abline(linetype = "dashed") +
  labs(x="Predicted Vote Share", y="Actual Vote Share",
       caption = "Source: https://tht.fangraphs.com/2019-hall-of-fame-voting-edgar-martinez-roy-halladay-mariano-rivera/") +
  ggtitle("Evaluating Bayesian HOF Model",
          subtitle=glue("R^2: {bayes_model_r_sq}, RMSE = {bayes_model_rmse}"))

ggplot(final_data, aes(est_hof_vote_share, residual)) +
  geom_point() + fgt +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x="Predicted Vote Share", y="Residual",
       caption = "Source: https://tht.fangraphs.com/2019-hall-of-fame-voting-edgar-martinez-roy-halladay-mariano-rivera/") +
  ggtitle("Evaluating Bayesian HOF Model: Residuals")



```

