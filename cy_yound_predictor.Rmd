```{r}
library(tidyverse)
library(RMySQL)
library(lubridate)
library(xgboost)
library(caret)
library(twilio)
library(PRROC) #for P-R curve


fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  # strip.background = element_rect(fill = "#8e001c"),
  strip.text = element_text(family="Lato")
)

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                          host = Sys.getenv("FG_HOST"), 
                          user = Sys.getenv("FG_USER"),
                          password = Sys.getenv("FG_PW"))

TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg){
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}



```

get, clean, mutate, and join data

```{r, message=FALSE}

year_to_predict <- 2018
data_min <- year_to_predict - 11
data_max <- year_to_predict - 1

player_info <- fg_db %>%
  tbl("player_info") %>%
  filter(Position == "P") %>% 
  dplyr::select(playerid = PlayerId, FirstName, LastName) %>%
  collect(n=Inf) %>%
  unite(player_name, FirstName, LastName, sep = " ")

team_info <- fg_db %>%
  tbl("season_team") %>%
  filter(Season >= data_min,
         Season <= year_to_predict) %>%   
  select(teamid = TeamId, Season, League, team_games = G, team_wins = W, team_losses = L) %>%
  collect(n=Inf) %>%
  mutate(team_PCT = team_wins / (team_wins + team_losses),
         League = factor(League)) %>%
  select(-team_wins, -team_losses)

player_stats <- fg_db %>%
  tbl("stats_pitching_master_pfx") %>%
  filter(Type == 0,
         Season >= data_min,
         Season <= year_to_predict) %>%
  select(playerid = PlayerId, Season, teamid = TeamId, W, L, G, GS, IP, 
         SO, BB, HR, TBF, fip_war = ValueW, 
         era = ERA, fip = FIP, xfip = `xFIP`, SV, BS, HLD) %>%
  collect(n=Inf) %>%
  inner_join(player_info, by="playerid") %>%
  select(playerid, player_name, everything()) %>%
  mutate(is_reliever = if_else(GS / G < 0.5, 1, 0),
         so_rate = SO / TBF,
         bb_rate = BB / TBF,
         k_minus_bb = so_rate - bb_rate,
         hr_per_9 = HR / (IP /9),
         pitcher_PCT = W / (W+L)) %>%
  filter(is_reliever == 0)

# read list of Cy Young winners during the time period we're examining
cy_list <- read_csv("~/Downloads/mlb season awards - Cy_yong.csv") %>%
  gather(League, player_name, AL, NL) %>%
  select(Season = Year, everything()) %>%
  filter(Season >= data_min,
         Season <= year_to_predict) %>%
  mutate(is_cy = "Yes",
         League = factor(League))



master_df <- inner_join(player_stats, team_info, by=c("Season", "teamid")) %>%
  full_join(cy_list, by=c("Season", "player_name", "League")) %>%
  replace_na(list(is_cy = "No")) %>%
  filter(IP >= 175) %>%      # filter this low to catch blake snell in 2018. lowest prior was Kershaw in 2014
  group_by(Season, League) %>%
  mutate(`Win Rank` = min_rank(-W),
         `Loss Rank` = min_rank(L),
         `ERA Rank` = min_rank(era),
         `FIP Rank` = min_rank(fip),
         `K Rank` = min_rank(-SO),
         `BB Rank` = min_rank(BB),
         `HR Rank` = min_rank(HR),
         `fWAR Rank` = min_rank(-fip_war),
         `K% Rank` = min_rank(-so_rate),
         `BB% Rank` = min_rank(bb_rate),
         `K-BB% Rank` = min_rank(-k_minus_bb),
         `HR/9 Rank` = min_rank(hr_per_9)) %>%
  select(playerid, player_name, Season, League, team_PCT, IP, is_cy, contains("Rank"))
  
```

```{r, message=FALSE, echo=FALSE}

set.seed(12345)

# remove informational paramters i don't want the model to look at
# cross-validate model on data 10 years prior to the one we want to predict
#do 10-fold cross validation repeated 5 times

train_df <- master_df %>%
  filter(Season != year_to_predict) %>% # train & test on data prior to prediction year
  select(-playerid, -player_name)

control_parameters <- trainControl(method = "cv",
                                   number = 10,
                                   search = "grid",
                                   allowParallel = TRUE,
                                   classProbs = TRUE,
                                   summaryFunction = twoClassSummary)

parameter_grid <- expand.grid(
  nrounds = c(50, 75, 100), 
  eta = c(0, .01, 0.1),
  max_depth = c(5, 10, 15, 20),
  gamma = c(0, 1, 2, 5),
  colsample_bytree = c(0.1, 0.5, 0.9),
  min_child_weight = c(0, 0.1),
  subsample = c(0.1, 0.2, 0.5, 0.7))

cy_predictor <- train(is_cy ~ .,
                       data = train_df, 
                       method = "xgbTree", 
                       trControl = control_parameters,
                       tuneGrid = parameter_grid,
                       metric = "ROC")

send_message("Cy Young predictor model is finished training!")
```

evaluate model using "most likely CY season" as "predicted CY". favor using precision/recall/F1 over sens/spec/AUC due to strong class imbalance.

```{r}

# predict probability of CY election for each player-season
evaluation_prediction <-
  master_df %>%
  filter(Season != year_to_predict) %>%
  select(-playerid, -player_name, -is_cy) %>%
  predict(cy_predictor, newdata = ., type = "prob")

# within each season-league, find the CY player-season with the highest probability. 
# label this person as the predicted CY winner, for the purposes of evaluating the model's predictions
eval_df <-
  master_df %>% 
  filter(Season != year_to_predict) %>% 
  bind_cols(evaluation_prediction) %>%
  group_by(Season, League) %>%
  mutate(pred_cy = if_else(Yes == max(Yes), "Yes", "No"),
         is_cy = factor(is_cy, levels = c("Yes", "No")),
         pred_cy = factor(pred_cy, levels=c("Yes", "No")))

confusionMatrix(eval_df$is_cy, 
                eval_df$pred_cy,
                mode = "prec_recall")

# precision-recall curve adapted from https://stackoverflow.com/questions/25020788/in-r-calculate-area-under-precision-recall-curve-aupr
# note that a predicted result of "Is Cy Young" is considered a "positive" result
cy_scores <- eval_df %>%
  ungroup() %>%
  select(prob_cy = Yes, is_cy) %>%
  mutate(is_cy = if_else(is_cy == "Yes", 1, 0)) %>%
  as.data.frame()

cy_pr_curve <- pr.curve(
  scores.class0 = cy_scores[cy_scores$is_cy == "1",]$prob_cy,
  scores.class1 = cy_scores[cy_scores$is_cy == "0",]$prob_cy,
  curve = TRUE,
  rand.compute = TRUE)

y <- as.data.frame(cy_pr_curve$curve)

ggplot(y, aes(y$V1, y$V2))+
  geom_path(color="#8e001c")+
  ylim(0,1) + fgt + 
  labs(x="Recall", y="Precision", caption=sprintf("Area Under Precision-Recall Curve: %s", round(cy_pr_curve$auc.integral, 3))) +
  ggtitle("Precision vs. Recall for Cy Young Predictor Model") 

# show names of predicted winners vs. actual winners
eval_df %>% 
  filter(pred_cy == "Yes" | is_cy == "Yes") %>% 
  arrange(Season, League) %>% 
  select(Season, League, player_name, pred_cy, is_cy) %>%
  mutate(predicted_cy = if_else(pred_cy == "Yes", player_name, ""),
         actual_cy = if_else(is_cy == "Yes", player_name, "")) %>%
  group_by(Season, League) %>%
  summarize(`Predicted Cy Young Winner` = paste(predicted_cy, sep = "", collapse= ""),
            `Actual Cy Young Winner` = paste(actual_cy, sep = "", collapse = "")) %>%
  mutate(`Accurate?` = if_else(`Predicted Cy Young Winner` == `Actual Cy Young Winner`, "Yes", "No"))

```

show importance plot and top 10 predictions

```{r, message=FALSE}

predict_df <- master_df %>%
  filter(Season == year_to_predict) %>%
  select(-playerid, -player_name, -is_cy)

cy_predictions <- predict(cy_predictor, newdata = predict_df, type ="prob") %>%
  mutate(prob_cy = round(100 * Yes, 2)) %>%
  as_tibble() %>%
  select(prob_cy) %>%
  bind_cols(predict_df) %>%
  inner_join(master_df) %>%
  select(playerid, player_name, League, prob_cy, everything()) %>%
  select(-is_cy) %>%
  arrange(desc(prob_cy))

# plot variable importance
bind_cols(row.names(varImp(cy_predictor)$importance) %>% as_tibble(),
          varImp(cy_predictor)$importance %>% as_tibble()) %>%
  mutate(value = str_replace_all(value, "`", "")) %>%
  ggplot(aes(reorder(value, Overall), Overall)) + geom_col(fill="#8e001c") + coord_flip() + fgt +
  labs(x="", y="Relative Importance") + 
  ggtitle(sprintf("What Factors are Important in Cy Young Voting? (%s - %s)", data_min, data_max))

# top 10 contenders in each league
cy_predictions %>%
  group_by(League) %>%
  filter(row_number() <= 10) %>%
  ggplot(aes(reorder(player_name, prob_cy), prob_cy)) + geom_col(fill="#8e001c") + coord_flip() + 
  facet_wrap(~League, scales = "free_y") + fgt + 
  labs(x="", y="Probability of Season Winning the Cy Young (%)") +
  ggtitle(sprintf("%s Player-Seasons with the Highest Cy Young Probabilities", year_to_predict))

```



```{r}
cy_predictions %>%
  filter(player_name %in% c("Justin Verlander", "Blake Snell", "Corey Kluber")) %>%
  select(-playerid, -League, -Season) %>%
  select(player_name, team_PCT, IP, contains("rank"), prob_cy)

cy_predictions %>%
  filter(player_name %in% c("Max Scherzer", "Jacob deGrom", "Aaron Nola")) %>%
  select(-playerid, -League, -Season) %>%
  select(player_name, team_PCT, IP, contains("rank"), prob_cy)
```


for informational purposes, show some rows from the training dataset 

```{r}

master_df %>%
  select(player_name, Season, League, IP, team_PCT, contains("rank"), is_cy) %>%
  filter(Season != year_to_predict) %>%
  mutate(team_PCT = round(team_PCT, 3)) %>%
  ungroup() %>%
  sample_n(5) %>%
  write_csv("cy_predictor_informational.csv")
 

```