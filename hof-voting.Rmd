```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(RMySQL)
library(caret)
library(broom)
library(rvest)
library(twilio)
library(janitor)
library(ggrepel)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  #strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))

TWILIO_SID <- Sys.getenv("TWILIO_SID")
TWILIO_TOKEN <- Sys.getenv("TWILIO_TOKEN")
twilio_number <- Sys.getenv("twilio_number")

send_message <- function(msg){
  tw_send_message(from = twilio_number, to = "5123505107", body = msg)
}

# train a model on a specified algorithm
train_model <- function(train_df, algorithm){
  # train a model to predict HOF voting share. create model variable inside global environment
  mdl<- train(vote_share ~ .,
              data = train_df,
              method = algorithm,
              trControl = trainControl(method = "cv",
                                       number = 10,
                                       allowParallel = TRUE),
              metric = "MAE")
            #  preProcess = c("center", "scale"))
  
  model_name <- paste("hof_voting_model", algorithm, sep = "_")
  assign(model_name, mdl, envir = globalenv())
}

# get player data and (if available) HOF voting results for a particular year
get_voting_results <- function(year){
  # get HOF voting results from bb-ref for a single year
  url <- str_c("https://www.baseball-reference.com/awards/hof_", year, ".shtml")
  
  read_html(url) %>%
    html_nodes("table") %>%
    .[[1]] %>%
    html_table(header=FALSE) %>%
    as_tibble() %>%
    mutate(vote_year = year)
}

# mark players who have a PED scandal asoscaited with them
get_ped_scandal <- function(name){
  if_else(name %in% c("Barry Bonds", "Roger Clemens", "Alex Rodriguez", 
                      "Gary Sheffield", "Rafael Palmeiro",
                      "Sammy Sosa", "Mark McGwire", "Andy Pettite", "David Ortiz",
                      "Manny Ramirez"), 1, 0)
}

```


get data

```{r}

year_to_predict <- 2019
num_years_to_train_on <- 15
first_training_year <- year_to_predict - num_years_to_train_on
last_training_year <- year_to_predict - 1

hof_voting_data <- seq(first_training_year, last_training_year) %>%
  map_df(get_voting_results)

```

transform and clean data

specifically DO NOT select the X4 column 'vote total'.

leave all highly correlated predictors intact. i tried removing ones correlated below 0.9 and again at below 0.75. each time the models got worse.

```{r message=FALSE, warning=FALSE}

# TODO: Perhaps train models independently, allowing the use of (say) early_stopping_rounds for xgb, and other parameters for other algorithms
# TODO: Examine residual outliers & see if there is any trend I can identify
# TODO: See if major awards (batting titles, MVP's) affect results
# TODO: see if dist_from_3000_H and dist_from_500_HR affect results
# TODO: modify train_model function to both train and predict, returning the predictions that I can combine using map_dfc.
# TODO: see if adding the player's primary position back in has any effect.
# TODO: ensure train and test splits are equally distributed in terms of vote_share & other data points

# best tune: XGBlinear, R^S of 0.94, RMSE Of 7.1, MAE of 4

data_clean <- 
  hof_voting_data %>%
  select(-X1, -X4, Name = X2, year_on_ballot = X3, vote_share = X5, 
         bj_hof_monitor = X6, bj_hof_standards = X7, career_length = X8, career_rWAR = X9, 
         best_war_years = X10, jaws = X11, jpos = X12, G_bat = X13, AB = X14, R = X15, H = X16, HR = X17, RBI = X18,
         SB = X19, BB = X20, BA = X21, OBP = X22, SLG = X23, OPS = X24, OPS_plus = X25,
         W = X26, L = X27, ERA = X28, ERA_plus = X29, WHIP = X30, G_pitch = X31, GS = X32, SV = X33, IP = X34,
         H_allowed = X35, HR_allowed = X36, BB_allowed = X37, SO = X38, position = X39) %>%
  mutate(Name = str_replace(Name, "y ", ""),
         Name = str_replace_all(Name, c("X-" = "",
                                        "\\sHOF" = "")),
         year_on_ballot = as.integer(str_extract(year_on_ballot, "[:digit:]{1,2}")),
         vote_share = as.double(str_extract(vote_share, "[:digit:]{1,3}.[:digit:]")),
         bj_hof_monitor = as.integer(bj_hof_monitor),
         bj_hof_standards = as.integer(bj_hof_standards),
         career_length = as.integer(career_length),
         career_rWAR = as.double(career_rWAR),
         best_war_years = as.double(best_war_years),
         jaws = as.double(jaws), jpos = as.double(jpos),
         G_bat = as.integer(G_bat),
         AB = as.integer(AB),
         R = as.integer(R),
         H = as.integer(H),
         HR = as.integer(HR),
         RBI = as.integer(RBI),
         SB = as.integer(SB),
         BB = as.integer(BB),
         BA = as.double(BA),
         OBP = as.double(OBP),
         SLG = as.double(SLG),
         OPS = as.double(OPS),
         OPS_plus = as.integer(OPS_plus),
         W = as.integer(W),
         L = as.integer(L),
         ERA = as.double(ERA), 
         ERA_plus = as.integer(ERA_plus),
         WHIP = as.double(WHIP),
         G_pitch = as.integer(G_pitch),
         GS = as.integer(GS),
         SV = as.integer(SV),
         IP = as.double(IP),
         H_allowed = as.integer(H_allowed),
         HR_allowed = as.integer(HR_allowed),
         BB_allowed = as.integer(BB_allowed),
         SO = as.integer(SO),
         position = as.numeric(str_extract(position, "[:digit:]")), # encode position as where they played the most often
         ped_scandal = map_dbl(Name, get_ped_scandal)) %>% 
  filter(!is.na(year_on_ballot)) %>%  # remove spurious rows caused by BB-Ref table formatting
  group_by(Name) %>%
  arrange(Name, year_on_ballot) %>%
  mutate(prev_three_year_vote_share_trend = round((lag(vote_share) - lag(vote_share, 3)) / 3, 1)) %>%
         #prev_three_year_vote_share_trend = replace_na(prev_three_year_vote_share_trend, 0)) %>%
  filter(position != 1) %>%
  select(-position, Name, year_on_ballot, vote_share, prev_three_year_vote_share_trend, everything()) %>%
  ungroup() %>%
  select(-W, -L, -ERA, -ERA_plus, -WHIP, -G_pitch, -GS, -SV, -IP, -H_allowed, 
         -HR_allowed, -BB_allowed, -SO, -position, -career_length, -BB, -AB, 
         -OBP, -SLG, -R, -OPS, -RBI, -HR, -OPS_plus)

# remove response variable & binary variable from cleaned data, preprocess remaining data & re-join
# to removed columns
data_pre <- data_clean %>%
  select(-vote_share, -ped_scandal, -year_on_ballot, -vote_year)
preprocess_params <- preProcess(data_pre, method = c("center", "scale", "knnImpute"))
data_clean_processed <- predict(preprocess_params, data_pre) %>%
  bind_cols(data_clean %>% select(vote_share), 
            data_clean %>% select(ped_scandal),
            data_clean %>% select(year_on_ballot),
            data_clean %>% select(vote_year))
```

# train and predict batter voting totals

```{r}

seed <- 1

# make training and test DF's. use seed to keep the splits the same between runs
set.seed(seed)
batter_test_df_rows <- createDataPartition(data_clean_processed$vote_share, p = 0.3, list = FALSE)

batter_hof_test <- 
  batter_hof %>%
  select(-Name) %>%
  filter(row_number() %in% batter_test_df_rows)

batter_hof_train <- 
  batter_hof %>%
  select(-Name) %>%
  filter(!row_number() %in% batter_test_df_rows)

train_model(batter_hof_train, "lm")
train_model(batter_hof_train, "svmRadial")
train_model(batter_hof_train, "xgbTree")
train_model(batter_hof_train, "xgbLinear")
train_model(batter_hof_train, "xgbDART")
train_model(batter_hof_train, "knn")
train_model(batter_hof_train, "lasso")

#train_model(batter_hof_train, "nnet")

batter_model_evaluation <-
  batter_hof_test %>% 
  mutate(predict_xgbtree = as.numeric(predict(hof_voting_model_xgbTree, newdata =.)),
         predict_lm = as.numeric(predict(hof_voting_model_lm, newdata =.)),
         predict_svm = as.numeric(predict(hof_voting_model_svmRadial, newdata = .)),
         predict_xgblinear = as.numeric(predict(hof_voting_model_xgbLinear, newdata=.)),
         predict_knn = as.numeric(predict(hof_voting_model_knn, newdata=.)),
         predict_lasso = as.numeric(predict(hof_voting_model_lasso, newdata = .)),
         predict_xgbDART = as.numeric(predict(hof_voting_model_xgbDART, newdata = .))) %>%
  select(vote_share, contains("predict_")) %>%
  gather(model_type, predicted_vote_share, contains("predict_")) %>%
  select(vote_share, model_type, predicted_vote_share) %>%
  mutate(residual = vote_share - predicted_vote_share)

batter_model_evaluation %>%
ggplot(aes(vote_share, predicted_vote_share)) +
  geom_point() + geom_smooth(method ="lm") +
  fgt + facet_wrap(vars(model_type)) +
  expand_limits(x=0,y=0) +
  geom_abline(linetype = "dashed") + ggtitle("Model Evaluation: Position Player Voting %")

batter_model_evaluation %>% 
  ggplot(aes(predicted_vote_share, residual)) + geom_point() +
  facet_wrap(vars(model_type)) + fgt +
  geom_hline(yintercept = 0, linetype = "dashed") + ggtitle("Model Evaluation: Position Player Voting %")

batter_r_squared <- 
  batter_model_evaluation %>%
  split(.$model_type) %>%
  map(~lm(vote_share ~ predicted_vote_share, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared") %>%
  tidy() %>% 
  select(model_type = names, r_squared = x)

# display table of model evaluation statistics  
batter_model_metrics <-
  batter_model_evaluation %>%
  group_by(model_type) %>%
  summarize(RMSE = RMSE(predicted_vote_share, vote_share),
            MAE = mean(abs(predicted_vote_share - vote_share))) %>%
  inner_join(batter_r_squared, by="model_type") %>%
  ungroup() %>%
  mutate(zr_squared = (r_squared - mean(r_squared)) / sd(r_squared),
         zRMSE = (RMSE - mean(RMSE)) / sd(RMSE),
         zMAE = (MAE - mean(MAE)) / sd(MAE),
         label = str_c("Model Type:", str_c(str_replace(model_type, "predict_", ""), ","),
                       "R^2:", str_c(round(r_squared, 1), ","), 
                       "MAE:", round(MAE, 1), sep = " ")) %>%
  select(`Model Type` = model_type, `R^2` = r_squared, RMSE, `zR^2` = zr_squared, zRMSE, MAE, zMAE, label)

batter_model_metrics

ggplot(batter_model_metrics, aes(`zR^2`, zMAE)) + geom_point() + fgt +
  geom_vline(xintercept = 0, linetype = "dashed") + geom_hline(yintercept = 0, linetype ="dashed") +
  geom_label_repel(aes(label = label)) +
  ggtitle("Evaluation Metrics of Models")

```

xgbLinear is consistently the best-performing model in the above analysis. tweak its tuning parameters to get an even better fit
```{r}

```


position players: after selecting the best model, use it to predict future results

```{r}

url <- str_c("https://www.baseball-reference.com/awards/hof_", year_to_predict, ".shtml")

player_data <- read_html(url) %>%
  html_nodes("table") %>%
  .[[1]] %>%
  html_table(header=FALSE) %>%
  as_tibble() %>%
  mutate(vote_year = year_to_predict)

```

Transform and clean data, predict `r year_to_predict` voting share for position players

```{r message=FALSE, warning=FALSE}

# compute three-year vote share trend in the three years running up to the year we want to predict
# for example if we're predicting HOF voting in 2019, get vote shares from 2016 and 2018. use data points to compute slope of trend line
voting_trends <-
  data_clean %>%
  filter(vote_year %in% c(year_to_predict - 3, year_to_predict - 1)) %>%
  group_by(Name) %>%
  arrange(Name, vote_year) %>%
  mutate(prev_three_year_vote_share_trend = round((vote_share) - lag(vote_share) / 3, 1),
         prev_three_year_vote_share_trend = replace_na(prev_three_year_vote_share_trend, 0)) %>%
  filter(vote_year == max(vote_year)) %>%
  select(Name, prev_three_year_vote_share_trend)

hof_predictions <-
  player_data %>%
  select(-X1, -X4, Name = X2, year_on_ballot = X3, bj_hof_monitor = X5, 
         bj_hof_standards = X6, career_length = X7, career_rWAR = X8, best_war_years = X9,
         jaws = X10, jpos = X11, G_bat = X12, AB = X13, R = X14, H = X15, HR = X16, RBI = X17,
         SB = X18, BB = X19, BA = X20, OBP = X21, SLG = X22, OPS = X23, OPS_plus = X24,
         W = X25, L = X26, ERA = X27, ERA_plus = X28, WHIP = X29, G_pitch = X30, GS = X31, SV = X32, IP = X33,
         H_allowed = X34, HR_allowed = X35, BB_allowed = X36, SO = X37, position = X38) %>%
  mutate(Name = str_replace(Name, "y ", ""),
         Name = str_replace_all(Name, c("X-" = "",
                                        "\\sHOF" = "")),
         year_on_ballot = as.integer(str_extract(year_on_ballot, "[:digit:]{1,2}")),
         bj_hof_monitor = as.integer(bj_hof_monitor),
         bj_hof_standards = as.integer(bj_hof_standards),
         career_length = as.integer(career_length),
         career_rWAR = as.double(career_rWAR),
         best_war_years = as.double(best_war_years),
         jaws = as.double(jaws), 
         jpos = as.double(jpos),
         G_bat = as.integer(G_bat),
         AB = as.integer(AB),
         R = as.integer(R),
         H = as.integer(H),
         HR = as.integer(HR),
         RBI = as.integer(RBI),
         SB = as.integer(SB),
         BB = as.integer(BB),
         BA = as.double(BA),
         OBP = as.double(OBP),
         SLG = as.double(SLG),
         OPS = as.double(OPS),
         OPS_plus = as.integer(OPS_plus),
         position = as.numeric(str_extract(position, "[:digit:]")),
         ped_scandal = map_dbl(Name, get_ped_scandal)) %>%
  filter(!is.na(year_on_ballot))
 
batter_predictions <-
  hof_predictions %>%
  filter(position != "1") %>%
  left_join(voting_trends, by="Name") %>%
  mutate(prev_three_year_vote_share_trend = replace_na(prev_three_year_vote_share_trend, 0))

predictions_pre <- batter_predictions %>%
  select(-ped_scandal, -year_on_ballot, -vote_year)
preprocess_params_2 <- preProcess(predictions_pre, method = c("center", "scale", "knnImpute"))
predictions_processed <- predict(preprocess_params_2, predictions_pre) %>%
  bind_cols(batter_predictions %>% select(ped_scandal),
            batter_predictions %>% select(year_on_ballot), 
            batter_predictions %>% select(vote_year)) %>%
  select(-W, -L, -ERA, -ERA_plus, -WHIP, -G_pitch, -GS, -SV, -IP, -H_allowed, 
         -HR_allowed, -BB_allowed, -SO, -position, -career_length, -BB, -AB, -OBP, -SLG, -R, -OPS, -RBI, -OPS_plus)

predict(hof_voting_model_xgbLinear, newdata = predictions_processed) %>%
  as_tibble() %>%
  select(predicted_vote_share = value) %>%
  bind_cols(predictions_processed) %>%
  select(Name, predicted_vote_share, everything()) %>%
  mutate(predicted_vote_share = round(predicted_vote_share, 1)) %>%
  select(Name, year_on_ballot, predicted_vote_share) %>%
  arrange(desc(predicted_vote_share))

```

# now do it for starting pitchers!!

```{r}
# get number of cy youngs won by each pitcher
cy_young_winner_count <- read_csv("~/Downloads/mlb season awards - Cy_yong.csv") %>%
  gather(League, player_name, AL, NL) %>%
  group_by(player_name) %>%
  summarize(num_cy_youngs = n())

pitcher_hof <- data_clean %>%
  filter(position == 1,
         GS / G_pitch >= 0.5) %>%
  select(-position) %>%
  remove_empty("cols") %>%
  left_join(cy_young_winner_count, by=c("Name" = "player_name")) %>%
  mutate(num_cy_youngs = replace_na(num_cy_youngs, 0),
         dist_from_300_w = W - 300,
         k_bb_ratio = SO/BB_allowed,
         dist_from_3000k = SO - 3000) %>%
  select(year_on_ballot, bj_hof_monitor, bj_hof_standards, career_rWAR, best_war_years, jaws,
         W, L, ERA, ERA_plus, WHIP, IP, SO, num_cy_youngs, k_bb_ratio, dist_from_300_w,
         dist_from_3000k, ped_scandal, vote_share)

pitcher_test_df_rows <- createDataPartition(pitcher_hof$vote_share, p = 0.25, list = FALSE)

pitcher_hof_test <- 
  pitcher_hof %>%
  filter(row_number() %in% batter_test_df_rows)

pitcher_hof_train <- 
  pitcher_hof %>%
  filter(!row_number() %in% batter_test_df_rows)

# algorithms <- c("nnet", "xgbTree", "svmRadial", "xgbLinear"). later on, use map() to do this

# batter_hof_train %>% 
#   map(train_model(train_df = .,
#                   algorithm=c("glm", "svmRadial", "xgbTree", "xgbLinear", "knn")))

train_model(pitcher_hof_train, "glm")
train_model(pitcher_hof_train, "svmRadial")
train_model(pitcher_hof_train, "xgbTree")
train_model(pitcher_hof_train, "xgbLinear")
train_model(pitcher_hof_train, "knn")
train_model(pitcher_hof_train, "lasso")

# TODO: I can do all this work inside of a function, instead of outside it. the output of the function should be the model's predictions, not the model itself. maybe also a df of what the model thinks is important, since I don't know what the winning one is yet. then I can just use map_df() to combine the predictions into a tibble.

pitcher_model_evaluation <-
  pitcher_hof_test %>% 
  mutate(predict_xgbtree = as.numeric(predict(hof_voting_model_xgbTree, newdata =.)),
         predict_glm = as.numeric(predict(hof_voting_model_glm, newdata =.)),
         predict_svm = as.numeric(predict(hof_voting_model_svmRadial, newdata = .)),
         predict_xgblinear = as.numeric(predict(hof_voting_model_xgbLinear, newdata=.)),
         predict_knn = as.numeric(predict(hof_voting_model_knn, newdata=.)),
         predict_lasso = as.numeric(predict(hof_voting_model_lasso, newdata = .))) %>%
  select(vote_share, contains("predict_")) %>%
  gather(model_type, predicted_vote_share, contains("predict_")) %>%
  select(vote_share, model_type, predicted_vote_share) %>%
  mutate(residual = vote_share - predicted_vote_share)

pitcher_model_evaluation %>%
ggplot(aes(vote_share, predicted_vote_share)) +
  geom_point() + geom_smooth(method ="lm") +
  fgt + facet_wrap(vars(model_type)) +
  expand_limits(x=0,y=0) +
  geom_abline(linetype = "dashed") + ggtitle("Model Evaluation: Position Player Voting %")

pitcher_model_evaluation %>% 
  ggplot(aes(predicted_vote_share, residual)) + geom_point() +
  facet_wrap(vars(model_type)) + fgt +
  geom_hline(yintercept = 0, linetype = "dashed") + ggtitle("Model Evaluation: Position Player Voting %")

pitcher_r_squared <- 
  pitcher_model_evaluation %>%
  split(.$model_type) %>%
  map(~lm(vote_share ~ predicted_vote_share, data = .)) %>%
  map(summary) %>%
  map_dbl("r.squared") %>%
  tidy() %>% 
  select(model_type = names, r_squared = x)


# TODO: calc. MAE instead of RMSE

# display table of model evaluation statistics  
pitcher_model_metrics <-
  pitcher_model_evaluation %>%
  group_by(model_type) %>%
  summarize(RMSE = RMSE(predicted_vote_share, vote_share),
            MAE = mean(abs(predicted_vote_share - vote_share))) %>%
  inner_join(pitcher_r_squared, by="model_type") %>%
  ungroup() %>%
  mutate(zr_squared = (r_squared - mean(r_squared)) / sd(r_squared),
         zRMSE = (RMSE - mean(RMSE)) / sd(RMSE),
         zMAE = (MAE - mean(MAE)) / sd(MAE)) %>%
  select(`Model Type` = model_type, `R^2` = r_squared, RMSE, `zR^2` = zr_squared, zRMSE, zMAE)

pitcher_model_metrics

ggplot(pitcher_model_metrics, aes(`zR^2`, zRMSE)) + geom_point() + fgt +
  geom_vline(xintercept = 0, linetype = "dashed") + geom_hline(yintercept = 0, linetype ="dashed") +
  xlim(-3, 3) + ylim(-3, 3) + 
  geom_label(aes(label=str_c(str_replace(`Model Type`, "predict_", ""), ": R^2 = ", round(`R^2`, 2), ", RMSE = ", round(RMSE, 1)))) +
  ggtitle("Evaluation Metrics of Models")

```

after selecting the best model ...
```{r}
pitcher_predictions <-
  hof_predictions %>%
  filter(position == 1,
         GS / G_pitch >= 0.5) %>%
  remove_empty("cols") %>%
  left_join(cy_young_winner_count, by=c("Name" = "player_name")) %>%
  mutate(num_cy_youngs = replace_na(num_cy_youngs, 0),
         dist_from_300_w = W - 300,
         dist_from_3000k = SO - 3000,
         k_bb_ratio = SO / BB_allowed,
         ped_scandal = map_dbl(Name, get_ped_scandal)) %>%
  select(Name, year_on_ballot, bj_hof_monitor, bj_hof_standards, career_rWAR, best_war_years, jaws,
         W, L, ERA, ERA_plus, WHIP, IP, SO, num_cy_youngs, k_bb_ratio, dist_from_300_w, dist_from_3000k, ped_scandal)
         
predict(hof_voting_model_lasso, newdata = pitcher_predictions) %>%
  as_tibble() %>%
  select(predicted_voting_percentage = value) %>%
  bind_cols(pitcher_predictions) %>%
  select(Name, predicted_voting_percentage, everything()) %>%
  mutate(predicted_voting_percentage = round(predicted_voting_percentage, 1)) %>%
  arrange(desc(predicted_voting_percentage))
```



