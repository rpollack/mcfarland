---
title: "orioles-payroll"
output: html_document
---

this is throwaway code to get the Baltimore Orioles' payroll year-by-year instead of back-computing each year from bill petti's code

```{r}

url <- "http://www.baseball-reference.com/teams/BAL/2016-payroll-salaries.shtml"


bal_payroll <- url %>%
  read_html() %>%
  html_nodes("table") %>%
  .[[length(.)]] %>%
  html_table(header=TRUE)
  
if (!"2021" %in% names(tms)) {
  tms$`2021` <- NA
}

#remove unused cells in the 'Name' column
bal_payroll <- bal_payroll %>%
  filter(!Name %in% c("Name","","Arb Costs", "Arb Eligible", "Contract Options", 
                        "Dollars Committed", "Other Costs", "Option Values", "Other Players", 
                        "Payroll (no options)", "Payroll (options)", "Signed")) 

#for each player, create a single row, one for each "Year", "value" is either their salary that year, their arbitration status, or their FA status, or blank if the player won't be on the payroll.

get_salary <- function(txt){
  
  if(grepl("M", txt)){
    salary <- str_extract(txt, "\\$.*M")
    salary <- str_replace(salary, "\\$", "")
    salary <- str_replace(salary, "M", "")
    salary <- as.double(salary)
  }
  
  if(grepl("k", txt)) {
    salary <- str_extract(txt, "\\$.*k")
    salary <- str_replace(salary, "\\$", "")
    salary <- str_replace(salary, "k", "")
    salary <- as.double(salary)
    salary <- salary / 1000 #convert to millions
  }
  
  #need to handle salaries of $650k

  
  return(salary)
}

bal_melt <- gather(bal_payroll, key = Year, value, -Name, -Age, -Yrs, -Acquired, -SrvTm, -Agent, -`Contract Status`)

#remove rows where the player isn't under control
bal_melt <- bal_melt %>%
  filter(value != "") %>%
  
  #replace pre-arb years with the minimum salary for 2017 and non-arb salaries with their values
  mutate(value = ifelse(grepl("Pre-Arb", value), 0.535, value),
         value = ifelse(grepl("M", value), as.double(str_extract(value, "(?<=\\$)[:digit:]+\\.*[:digit:]*")), value),
         value = ifelse(grepl("k", value), as.double(str_extract(value, "(?<=\\$)[:digit:]+")) / 1000, value)) %>%
  arrange(Name, Year)



situations for player in 2017:
  player has never had an arb projection made
player has an arb-3 projection and will be an FA next year (Tillman)
player has an arb-2 projection and will be arb-3 next year (britton).
player has an arb-1 projection and will be arb-2, arb-3 next 2 yrs (schoop)



player is arb-1 and that's their projection we have
player is has had an arb1 projection made
player has had an arb2 projection made
player has had an arb3 projection made
  



#How to project arbitration raises?? don't want to bother with players who aren't arb-eligible this year.
# but for players who are (like Joseph), how to project future arb years?




(?<!a)b matches a "b" that is not preceded by an "a", using negative lookbehind. 

#cannot predict arb salaries for pre-arb players
#leave future arb 

   
    
# have to also 


```

if value contains "pre-arb"", replace with min salary
  else, replace with any number that's in there
  
  group by player and order by year. then replace future Arb- salaries with estimates. 



#get the salaries here -- can gsub for the FA contracts, replace pre-arbs with minimum salaries, grep MLBTR estimates from parentheses, etc. 



#for each player, discard all rows except their last one (which is indicated by max(rank)).   

bal_melt <- bal_melt %>%
  filter(value != "") %>%
  #mutate(Team = Tm) %>%
  #group_by(Team, Name) %>%
  mutate(rank = row_number()) %>%
  filter(rank == max(rank)) %>%
  select(Name, everything(), -rank)



```