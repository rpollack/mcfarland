```{r setup, include=FALSE, echo=FALSE}


library(tidyverse)
library(rvest)
library(stringr)
library(plotly)
library(lubridate)
library(RMySQL)

fgt = theme(
  panel.background = element_rect(color = "lightgrey", fill = "white"),
  axis.title = element_text(family = "Lato"),
  axis.text = element_text(family = "Lato"),
  legend.title = element_text(family = "Lato"),
  legend.text = element_text(family = "Lato"),
  legend.background = element_rect(fill = "white"),
  legend.key = element_rect(fill = "white"),
  plot.title = element_text(family = "Lato"),
  panel.grid.major = element_line(size = .1, color = "lightgrey"),
  panel.grid.minor = element_line(size = 0),
  strip.background = element_rect(fill = "#50ae26"),
  strip.text = element_text(color="white", family="Lato")
  )

fg_db <- dplyr::src_mysql(dbname = Sys.getenv("FG_DB"), 
                            host = Sys.getenv("FG_HOST"), 
                            user = Sys.getenv("FG_USER"),
                            password = Sys.getenv("FG_PW"))
```



```{r}
fg_info <- fg_db %>%
  tbl("player_info") %>%
  dplyr::select(PlayerId, FirstName, LastName, BirthDate) %>%
  collect(n=Inf) %>%
  unite(Name, FirstName, LastName, sep = " ") %>%
  mutate(birth_year = year(BirthDate))

gmli <- fg_db %>%
  tbl("stats_pitching_master") %>%
  filter(Type == 0,
         Season >= 1974,
         Season <= 2019) %>%
  dplyr::select(PlayerId, Season, Age, G, GS, TBF, SO, BB, ValueW, gmLI) %>%
  collect(n=Inf) %>%
  inner_join(fg_info, by="PlayerId") %>%
  filter(GS/G < .5) %>%   #get relievers only
  mutate(k_minus_bb_relief = 100 * ((SO/TBF) - (BB/TBF)), #k-bb% is now relative to relievers only
         proj_age = Season - birth_year) %>%    
  group_by(Season) %>%
  #mutate(k_minus_bb_plus_relief = 100 * (k_minus_bb_relief / mean(k_minus_bb_relief))) %>%
  dplyr::select(PlayerId, Name, Season, proj_age, GS, G, TBF, k_minus_bb_relief, ValueW, gmLI)

```


```{r}

# find gmLI changes for only relievers who faced 150 batters in back-to-back years

#we need all seasons in order to compute projected WAR difference.

#then filter for TBF >= 150 3 years straight to get the gmLI folks

reliever_trust_changes <- gmli %>%
  filter(TBF >= 150) %>%   
  group_by(PlayerId) %>%
  arrange(Season) %>%
  mutate(gmli_diff = gmLI - lag(gmLI),
         from_year = lag(Season),
         to_year = Season) %>%
  filter(to_year - from_year == 1) %>%
  mutate(display = sprintf("%s %s – %s", Name, from_year, to_year),
   
         #project WAR using Warcels: http://tangotiger.com/index.php/site/comments/war-marcels-...-warcels
         proj_war_after_trust_change = (((.6 * ValueW) + (.3 * (lag(ValueW))) + (.1 * lag(ValueW, 1))) * .8) - 
           ((proj_age - 26) * .1),
         actual_war_after_trust_change = lead(ValueW),
         war_diff_year_after_trust_change = actual_war_after_trust_change - proj_war_after_trust_change) %>%
  dplyr::select(PlayerId, Name, from_year, to_year, proj_age, gmli_diff, ValueW, actual_war_after_trust_change, proj_war_after_trust_change,
         war_diff_year_after_trust_change) %>%
  arrange(desc(gmli_diff)) %>%
  filter(!is.na(war_diff_year_after_trust_change)) %>%
  ungroup()


high_gain_or_drop <- reliever_trust_changes %>%
  mutate(type = ifelse(gmli_diff <= -1, "BIG DROP",
                       ifelse(gmli_diff >= 1, "BIG GAIN", "OTHER"))) %>%
  group_by(type) %>%
  summarize(num = n()) %>%
  mutate(percent = 100 * num / sum(num))

# if actual - proj is positive, 50 - 20, then player performed better than expected.
# if actual - proj is negative, 20 - 50, then player performed worse than expected.
```





HOW DO RELIEVERS RESPOND TO CHANGES IN TRUST?

DO BULLPEN PROMOTIONS AND DEMOTIONS AFFECT RELIEVER PERFORMANCE?




INTRO

MAKE THIS ABOUT SAM DYSON...?

Every year, we see a few major-league relievers get shunted to a lesser role while others get increased responsibilities. In 2017 Sam Dyson received a lot of coverage for his demotion, but Kevin Siegrist and Luke Gregerson have lost the most gmLI since last year. Meanwhile, Chris Devenski has gained the most gmLI since last season, followed by Matt Belisle. In 2016, J.P. Howell and Mark Lowe lost the most trust while Tyler Thornburg and Jeanmar Gomez received opportunities to shine.

My last article [http://www.hardballtimes.com/relievers-who-gained-or-lost-the-most-trust-in-a-single-year/] explored the relievers who gained or lost the most trust in a single offseason since 1974. Some were acquired by new teams, some were put under new managers, and others simply pitched better. It was a fun list to compile, and I learned some interesting stories about guys like Mike Timlin and Donne Wall.

Talking about relievers losing or gaining trust can be fun and interesting from a historical perspective. Sometimes that's enough. Other times, we want to dig deeper. To that effect, one specific Internet citizen suggested some future research to me:

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">In other words, following a year of trust (or lack thereof), did the reliever respond any differently than he would have otherwise?</p>&mdash; Tangotiger (@tangotiger) <a href="https://twitter.com/tangotiger/status/880431118574637056">June 29, 2017</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

The question is a fine one. Answering it will help us understand what effect a demotion or promotion has on actual relief performance. Given today's focus on relief pitcher roles, which despite Andrew Miller's 2016 posteason are still the norm in Majoe League Baseball, knowing this information could guide bullpen construction and roster management. Plus, the question is just plain interesting. So I decided to dig deeper. 

METHODOLOGY

For this study I used the same Year 1 and Year 2 gmLI measurements and data as I did in my last article. I also added in my interpretation of "did the reliever respond any differently than he would have otherwise?" A subsequent tweet by Tango clarifies "following" as Year 3 in this Year 1 to Year 2 sequence. I interpresed "otherwise" to be the player's Year 3 WAR projections.And I substituted Year 3 WAR for "respond".

Finding Actual WAR was easy. To compute Projected WAR, I used Tango's own WARcels method [link]. This method has many caveats, especially for relievers, but it's the only one I have. 

I set the threshold at 150 batters faced for three straight seasons because I wanted to include as many relievers as possible while ignoring flukes. As with many studies, selection bias rears its head here. The study includes only relievers who were good enough to be sent to a major-league mound three years in a row. But it's the data we have. Lowering the threshold any further opens us up to chance changes in gmLI or partial seasons, and I'm not equipped to incorporate those yet.

EXAMPLES

Recall from my last article that Mike Timlin's gmLI increased by 1.40 from 1994 to 1995. He didn't change teams or managers; he just pitched better, earning a more important role on the team. The question I answered was: how well did Timlin pitch in 1996, the year following his "promotion", vs. his 1996 projection, which is what we'd otherwise expect of him?

Tango's WARcels method projected Timlin for 0.38 WAR in 1996. This projection seems quite low until you glance at the WAR values it's using. From 1993 - 1995 Timlin recorded WARs of 0.2, 0.2, and 1.3. 1996 was also his age-30 season, making him old (for a pitcher, anyway). So any reasonable manager, let alone an algorithm, would've had reason to doubt he could've maintained his 1995 breakout into 1996.

But maintain it he did: in 1996 Timlin recorded 1.42 WAR. So after seeing a Year 1 to Year 2 increase of 1.40 gmLI, he overperformed his Year 3 projections by 1.04 WAR. In the scatterplot you'll see below, I'll place a point at (1.40, 1.04).

Another example: from 2013 to 2014, Pat Neshek moved from the Athletics to the Cardinals and gained 1.15 gmLI along the way. After a solid season in St. Louis his projected WAR for Year 3, his 2015 season with the Astros, was 0.42 WAR. He instead compiled only 0.21 WAR. So we add another data point, but this time at (1.15, -0.21).

Last one: Sparky Lyle lost 0.46 gmLI in between 1977, his Cy Young season, and 1978. His 1979 season projected for a 0.23 WAR. Lyle instead recorded 0.57 WAR. Slap a data point at (-0.46, 0.34).

RESULTS

The following scatterplot shows all 2,279 qualifying season-trios:

```{r}
ggplot(reliever_trust_changes, aes(gmli_diff, war_diff_year_after_trust_change)) + geom_point(color="#8e001c") + geom_smooth(method = "lm",) +
  fgt + ggtitle("Given More Trust in Year 2, Relievers Overperform by Less in Year 3\n(Relievers who pitched 3 straight years, 1974 - 2016)") + labs(x="Change in gmLI Year 1 to Year 2", y="WAR Overperformance in Year 3")

war_trust_mdl <- with(reliever_trust_changes, lm(war_diff_year_after_trust_change ~ gmli_diff))
summary(war_trust_mdl)

#r2 = .001 or .1%
#r = .032. weak relationship

#overperformance in Year 3 = 0.498 - 0.098 * (gmli_diff)
```

That's a pretty blob of randomness. The line of best fit shows a miniscule (r = -0.032) relationship between the gmLI change from Year 1 to Year 2 and WAR overperformance in Year 3. Note that the tiny relationship that's there is negative; relievers who gained trust in Year 2 of a three-year stretch overperformed their Year 3 WAR by _less_ than those who lost trust in Year 2; conversely, relievers who lost trust year-to-year overperformebd their Year 3 WAR by more.
 

The effect on player performance also isn't large. For every 1 point gained (or lost) in gmLI, overperformance decreased (or increased) by .098 WAR. That's about one-tenth of a win, which isn't a lot. WAR isn't so precise that (for example) 5.4 WAR is meaningfully different from 5.3 or 5.5 WAR. The best you could say is that players who get demoted in Year 2 tend to rise a spot or two in the FanGraphs WAR leaderboard rankings in Year 3.

Why is a demotion associated with a WAR overperformance increase anyway? Why's the relationship _negative_? The best reason I can think of is simple regression to the mean. Players who got demoted in Year 2 were likely not as bad as they appeared to be; meanwhile, managers may tend to promote players based on luck masquerading as an improvement in skill. This situation reminds me of Daniel Kahneman describing his experience with regression to the mean. As Robert Matthews writes in The National:

Kahneman is famed for witnessing a classic example of its effects while working with fighter-pilot instructors in the 1960s.

Kahneman tried to convince the instructors that praising trainee pilots worked better than punishment. One of the veteran instructors was having none of this, however. He insisted that whenever he praised cadet pilots for doing well, they did worse on the next outing. In contrast, whenever he screamed at them for blunders, they usually did better.

“So please do not tell us that reward works and punishment does not,” intoned the instructor, “because the opposite is the case”.

Kahneman realised that this apparent refutation of his beliefs was an example of regression to the mean.

Taking one last look at the data in case I missed something, I bucketed the reliever season-pairs into 10 groups and calculated the mean WAR overperformance in each group. Group 1 lost the largest amount of gmLI in year 2, whereas Group 10 gained the most. The following chart shows that in Year 3, all deciles experienced a similar overperformance relative to their projections:

```{r}
bayes_gmli_change <- reliever_trust_changes %>%
  mutate(gmli_change_bucket_year_1_2 = ntile(gmli_diff, 10)) %>%
  group_by(gmli_change_bucket_year_1_2) %>%
  summarize(mean_war_overperformance = mean(war_diff_year_after_trust_change, na.rm = TRUE))

#8409 total entries

ggplot(bayes_gmli_change, aes(reorder(as.character(gmli_change_bucket_year_1_2), gmli_change_bucket_year_1_2),
                              mean_war_overperformance)) + geom_bar(stat="identity", fill="#8e001c") + fgt + 
  labs(x="gmLI Decile\n(1 = Large Drop in gmLI, 10 = Large Gain in gmLI)", y="Mean WAR Overperformance") + 
  ggtitle("Changes in Reliever Trust from Y1 - Y2 don't Affect Relief Performance in Y3")

```

These groups are mostly the same, but we see the same trend: relievers who gain the most gmLI in Year 2 tend to overperform their WAR projections by the least amount in Year 3. The effect can't be due to age, since the projections take that into account. 

I am struck by the fact that all groups outperform their projections, on average. I suspect this fact has more to do with the projections themselves and doesn't mean there's a hidden pattern here we're not seeing. If anyone has suggestions for other projection mechanisms that would be suitable here, let me know in the comments.

CONCLUSION

So, Sam Dyson can rest easy. 



...







take this phenomenon to be simple regression to the mean. would have outperformed expectations regardless; it just so happens that in Y1 they were on the receiving end of some bad luck or other uncontrollable factor and were punished as if they'd lost some essential skill.

Writing this paragraph made me think of Sam Dyson, who struggled mightily to begin the 2017 season to the tune of a 10.80 ERA before getting DFA'd by the Rangers. Dyson's gmLI dropped from 1.83 in 2016 to 1.40 in 2017, as he was removed from the closer's role before being removed from the team.   



Another way to 





account for these changes you have to project the player's WAR in Year 3 and subtract that projection from their actual WAR.

Simply looking at WAR overperformance itself doesn't do the trick either. 




Selection bias comes into play here. 

Using WAR projections allows me to remove a 'batters faced' threshold. In my last article this was 150 batters in a season; for this article, the gloves are off. 

But some selection bias still remains. Ultimate

As we saw in my last article, a player could lose or gain gmLI through no fault of his own. Kevin Gregg gained gmLI in 2013 by virtue of switching to a worse team who could afford to care less about his performance; conversely, Luis Sanches lost gmLI in 1985 when his team acquired Donnie Moore. 

Using projected WAR eliminates some of the selection bias, but not all. By removing a minimum 'batters-faced' number, we can get more at the heart of a play





Lower deciles include decreases in gmLI, while higher deciles include increases in gmLI. No matter the direction of the gmLI change, relievers do a bit better than what's expected of them.

In fact it seems the relievers who experience a decrease in trust (deciles 1 - 3) outperform their WAR projections the most. This may be because a relievers who gets demoted really is struggling due to factors outside their control and will experience positive regression to the mean.  





this study is:

-reliever's gmLI in year n - gmLI the year before
take actual WAR In year 3 and subtract projected WAR in year 3



makes sense but we have to be careful. we could just be seeing managers rewarding good performers with increased leverage roles and simultaneously demoting poor performers from higher-leverage roles.




INTRO

"The best way to find out if you can trust somebody is to trust them." -- Ernest Hemingway

"Having another person's trust is more powerful than all other management techniques put together." -- Linus Torvalds

FIND ONE MORE.


METHODOLOGY

I used FanGraphs' gmLI stat [http://www.fangraphs.com/library/misc/li/] to gauge the level of trust each reliever inspired in their manager. gmLI is the leverage index when a reliever enters the game. High gmLIs indicate the manager is trusting the reliver to get the team out of jams. Low gmLIs indicate the manager considers the reliever fit for only mop-up duty. Accordingly, closers often have the highest gmLI in the game.

This method isn't perfect; it doesn't account for fluctuations in overall gmLI. A lower gmLI could indicate not a loss of trust, but a year where the team needs fewer high-leverage innings overall. I decided against accounting for this because leverage is still leverage; every team has them, and managers aren't thinking about league average when deciding when to insert a reliever into the game. They're thinking only: who can give me the best chance of putting up a goose egg? (Full disclosure: I'm not and never have been a manager.)

With each reliever's gmLI in hand (no pun intended),  computed year-to-year differences for relivers who met the following criteria:

-- Started fewer than 50% of their games in both seasons
-- Faced at least 150 batters in each season

These criteria removed guys like Jimmy Key, who entered the league as a reliever, had a distinguished career as a starter, then ended his career in the bullpen again. These criteria also removed guys like Derrick Turnbow who were injured or ineffective for some intervening seasons. Lacking a way to project their gmLI for that year, removing them is okay.

When talking about a reliever gaining or losing the trust of his manager, the reliever's performance probably is the dominant factor. But there are others. A change in managers could bring about a different evaluation of the reliever in question. The reliever could've changed teams. And of course, the team could've changed out other relievers, making the guy in question look better by comparison.


COUNTING DOWN THE TOP THREE GAINERS

KEVIN GREGG, 2012 - 2013: +1.33 gmLI

Gregg's gmLI increased here because different teams have different needs. A playoff-bound team like the 2012 Orioles needed every save locked down as tightly as possible, especially since the franchise hadn't sniffed the postseason since 1997. Gregg couldn't provide that, so the team DFA'd him late in the year in favor of Jim Johnson. But the 96-loss 2013 Cubs didn't care much who was in the closer's role. They just needed a guy to eat innings, and Gregg provided that value just fine. Gregg was mostly the same pitcher in both years, but becoming the Cubs' closer in 2013 increased his gmLI from 0.48 to 1.81.

BILL CAUDILL, 1981 - 1982, +1.35 gmLI

Here's another team-changer. Caudill was a high-strikeout, high-walk reliever for the Cubs from 1979 - 1980. His 1980 season was particularly nice, pitching over 127 innings with a FIP- of 91 and an ERA- of 56. But in 1981 he lost some of his mojo, recording a FIP- of 123 with an ERA- of 156. Looking back, his 1980 was fueled by a crazy-low .260 BABIP and a crazy-high 84.3% strand rate. In 1981 those numbers regressed to .320 and 65.2% respectively, leading to a mid-career-low usage of 0.93 gmLI. His gmLI was lower only in his first and last seasons in the majors.

Caudill wasn't _that_ terrible, but in the early 80's baseball decision makers didn't know about regression to the mean, so the Cubs traded him to the Yankees, who turned him around to the Mariners. Caudill responded with an excellent season, recording a 63 FIP- and 56 ERA- in high-leverage spots for the Mariners (2.28 gmLI).

Fun fact: Caudill was Scott Boras' first client.

MIKE TIMLIN, 1994 - 1995: +1.40 gmLI

What makes Timlin's feat more impressive is that he didn't change teams or managers in these years. Cito Gaston and the Toronto Blue Jays employed and therefore evaluated Timlin in both years. What changed is that Timlin became a better pitcher. In 1994 Timlin pitched poorly with runners on base, strandeing only 67.9% of baserunners. He also struggled with command, walking 11.2% of batters. In 1995 he cut his walk rate by 1.5 percentage points while keeping an above-average strikeout rate, leading to a much nicer K-BB% and a 79.1% strand rate. Gaston noticed the increase in Timlin's effectiveness and used him in higher-leverage spots, causing Timlin's gmLI to jump from 0.69 in 1994 to 2.10 in 1995.

The funny part is that despite being a better pitcher overall in 1995, Timlin actually hurt his team more that year. His WPA decreased from -0.13 in 1994 to -0.62 in 1995. Oh well; if he ever feels sad about this fact, he can just polish his four World Series rings.

COUNTING DOWN THE TOP THREE DECLINERS

Not everyone gets handed the keys to the kingdom. Some guys get the keys taken away from them after they tramp mud all over the rug, knock over a lamp, and start a fire in the kitchen. So it goes with these three guys, the top three year-to-year decliners in gmLI since 1974.

Donne Wall, 2000 - 2001: -1.38 gmLI

Wall spent 1998 - 2000 as a trustworthy member of the San Diego Padres, averaging at least a 1.50 gmLI each year with a 2.92 ERA in his time there. Unfortunately he may be best remembered by Yankees fans. In Game 1 of the 1998 World Series, Chuck Knoblauch hit a game-tying three-run home run of Wall to knot the score at 5.

Following the 2000 season, the Padres traded Wall to the Mets, who were fresh off their World Series loss to the Yankees. Wall pitched well for the Mets; better, in fact, than he'd pitched for the Padres the previous year. But his Clutch score of -2.46, and his HR/9 of 1.69, indicates why new manager Bobby Valentine lost faith in Wall.

Wall started the season terribly, allowing three runs in two innings. He worked a few scoreless games before another two-run, two-inning performance on April 24th in Milwaukee. His next appearance was fine, but on April 29th against the Cardinals Wall allowed six hits, three walks, and four runs in 1.2 innings. He got torched again on May 11th against the Giants: two walks and one run in 0.1 innings. Overall he recorded five meltdowns against zero shutdowns as his gmLI dropped from 1.75 in San Diego to 0.37 in Flushing.  

Jordan Walden, 2011 - 2012: -1.423 gmLI

Walden burst onto the scene in 2010 with a 100 MPH heater and a 24.6 K-BB%. In 2011 the Angels made him their closer, replacing Fernando Rodney, and he rewarded them with an 83 xFIP- season, averaging a 2.167 gmLI in the process. At age 23, he seemed to be baseball's next great reliever, although his high 10.5% walk rate was perhaps alarming, and he tied for the major league lead in blown saves with 10.

Walden opened 2012 with an 8.31 ERA in his first six games, the sixth one ending in his first blown save of the season. Two days later Mike Scioscia announced Walden had lost the closer job. Walden finished the season with an 83 xFIP-, albeit in much lower-leverage work as his gmLI fell to 0.72. If it's any consolation, on the same day Scioscia announced Walden's demotion, he also announced the promotion of some guy named Mike Trout.

Luis Sanchez, 1984 - 1985: -1.427 gmLI

Score another one for the Angels. Sanchez was the team's primary closer in 1984 and he pitched okay, recording a 100 FIP- with a 2.11 gmLI. Prior to the 1985 season though, the team acquired Donnie Moore to be their closer. Manager John McNamara also left for Boston and was replaced by former Angels skipper Gene Mauch. Under Mauch, and having been replaced by Moore, Sanchez fell into setup and middle-relief duty and saw his FIP- rise to 115 even as his gmLI declined to 0.68. 1985 was his last year in baseball.     
MORE GUYS

The following graphs show you more names than I could write about here:

```{r}
increased_trust <- reliever_trust_changes %>%
  head(20)

ggplot(increased_trust, aes(reorder(display, gmli_diff), gmli_diff)) + geom_bar(stat="identity", fill = "#8e001c") + coord_flip() + fgt +
  ggtitle("Relievers Who Gained the Most Trust Year-to-Year, 1974 - 2016") +
  labs(x="", y="Change in Mean gmLI")
```

```{r}
decreased_trust <- reliever_trust_changes %>%
  tail(20)

ggplot(decreased_trust, aes(reorder(display, gmli_diff), gmli_diff)) + geom_bar(stat="identity", fill="#8e001c") + coord_flip() + fgt + 
  ggtitle("Relievers Who Lost the Most Trust Year-to-Year, 1974 - 2016") +
  labs(x="", y="Change in Mean gmLI")
```

CLOSING THOUGHTS

I'm happy 





Kevin Gregg's spent 2012 with the Baltimore Orioles who surprisingly won 93 games and the AL Wild Card game, advancing to the playoffs for the first time since 1997. But Gregg wasn't a key member of the team. He'd begun his stint with the Orioles the year before in 2011, but by the end of the year Jim Johnson was the team's primary closer. In 2012 manager Buck Showalter used Gregg mostly in mop-up situations, leading to an unimpressive 0.48 gmLI.

The team designated him for assignment in September 2012 whereupon he was signed by the Los Angeles Dodgers on a minor-league deal. Gregg opted out after not making the major-league roster in April and was picked up by the then-rebuilding Chicago Cubs. He became that team's primary closer, leading to a mean gmLI of 1.81. The team would finish 66-96, so a closer to them was just a guy to eat innings, and Gregg did just that. He bounced around to a few minor-league deals after the season, but never pitched in the majors again.






Counting down the 

Since 1974, the following pitchers inspired the largest, quickest increases in trust year-to-year:




From 1994 - 1995 Mike Timlin was on the 



